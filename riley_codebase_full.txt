=== RILEY PLATFORM: MASTER CODEBASE DUMP ===
=== GENERATED FOR EXECUTIVE REVIEW ===


==================================================
FILE: fastapi-backend/app/main.py
==================================================
import os
from contextlib import asynccontextmanager
from pathlib import Path

from anyio import CapacityLimiter, to_thread
from fastapi import FastAPI, Request, Depends
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from fastapi.staticfiles import StaticFiles
from app.routers import chat, files, search, campaign
from app.dependencies.auth import verify_clerk_token
from app.services.graph import GraphService
from app.services.qdrant import vector_service
from app.core.config import get_settings


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Manage application lifespan: startup and shutdown events."""
    # Startup: Initialize Neo4j connection and store in app.state
    app.state.graph = GraphService()

    # Startup: Log Qdrant connection mode
    settings = get_settings()
    if settings.QDRANT_URL:
        # Sanitize URL for logging (remove API key if accidentally included)
        sanitized_url = settings.QDRANT_URL.split("?")[0]  # Remove query params
        print(f"âœ… Qdrant: URL mode ({sanitized_url})")
    else:
        print(f"âœ… Qdrant: host/port mode ({settings.QDRANT_HOST}:{settings.QDRANT_PORT})")

    # Startup: Ensure Qdrant collections exist (non-destructive).
    # NOTE: Use scripts/reset_qdrant_collections.py for one-time destructive reset to fix dim mismatch.
    try:
        await vector_service.ensure_collections()
    except Exception as exc:
        # Don't hard-crash app startup; surface clearly so deploy logs explain Qdrant issues.
        print(f"âš ï¸ Qdrant collection ensure failed: {exc}")
    
    # Ensure static directory exists for file uploads
    static_dir = Path("static")
    static_dir.mkdir(exist_ok=True)
    
    # Increase thread pool capacity for high-concurrency I/O
    # This prevents request queuing and thread starvation under load
    limiter = to_thread.current_default_thread_limiter()
    if isinstance(limiter, CapacityLimiter):
        limiter.total_tokens = 100
    
    yield
    # Shutdown: Close Neo4j connection
    if hasattr(app.state, "graph") and app.state.graph:
        await app.state.graph.close()


app = FastAPI(lifespan=lifespan)

# CORS: Read allowed origins from environment variable
def get_allowed_origins() -> list[str]:
    """Parse ALLOWED_ORIGINS from environment variable.
    
    Reads comma-separated list of origins from ALLOWED_ORIGINS env var.
    If not set, defaults to localhost origins for development.
    
    Returns:
        List of allowed origin strings (sanitized and deduplicated)
    """
    default_origins = ["http://localhost:3000", "http://127.0.0.1:3000"]
    
    allowed_origins_env = os.getenv("ALLOWED_ORIGINS")
    if not allowed_origins_env:
        return default_origins
    
    # Parse: split on commas, strip whitespace, drop empty strings
    origins = [
        origin.strip()
        for origin in allowed_origins_env.split(",")
        if origin.strip()
    ]
    
    # If parsing resulted in empty list, fall back to defaults
    if not origins:
        return default_origins
    
    return origins

# Get and log allowed origins
allowed_origins = get_allowed_origins()
print(f"âœ… CORS: Allowed origins: {', '.join(allowed_origins)}")

# CORS: Configure middleware with environment-driven origins
app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,  # Production-safe: read from ALLOWED_ORIGINS env var
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# CRITICAL: This puts the search route at /api/v1/search
# All /api/v1/* routes require Clerk JWT authentication
app.include_router(search.router, prefix="/api/v1", dependencies=[Depends(verify_clerk_token)])
# CRITICAL: This puts the chat route at /api/v1/chat
app.include_router(chat.router, prefix="/api/v1", dependencies=[Depends(verify_clerk_token)])
# CRITICAL: This puts the files route at /api/v1/files/{tenant_id}
app.include_router(files.router, prefix="/api/v1", dependencies=[Depends(verify_clerk_token)])
# CRITICAL: This puts the campaign route at /api/v1/campaign/{tenant_id}
app.include_router(campaign.router, prefix="/api/v1", dependencies=[Depends(verify_clerk_token)])

# Ensure static directory exists BEFORE mounting (required for Cloud Run)
# This must happen synchronously at module load time, not in lifespan
Path("static").mkdir(parents=True, exist_ok=True)

# Mount static file directory for serving uploaded files
app.mount("/static", StaticFiles(directory="static"), name="static")


@app.get("/")
async def root():
    return {"status": "Riley Doorman Online"}


@app.get("/healthz")
async def healthz():
    """Health check endpoint for Cloud Run smoke tests and uptime monitoring.
    
    This endpoint requires no authentication and does not call external services.
    Returns a simple status to indicate the service is running.
    """
    return {"status": "ok"}


@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    """Global exception handler to catch unhandled errors.
    
    This prevents the frontend from seeing raw Internal Server Errors
    and provides a user-friendly error message while logging the actual error.
    """
    print(f"ðŸ”¥ UNHANDLED ERROR: {exc}")
    return JSONResponse(
        status_code=500,
        content={"detail": "System encountered an error. Engineering has been notified."},
    )

==================================================
FILE: fastapi-backend/app/routers/chat.py
==================================================
import asyncio
from typing import Any, Dict, List, Literal, Optional

import google.generativeai as genai  # Still needed for GenerativeModel (chat responses)
from typing import Dict
from fastapi import APIRouter, BackgroundTasks, HTTPException, Query, Depends, Request
from fastapi.concurrency import run_in_threadpool
from pydantic import BaseModel, Field
from qdrant_client.http.models import Filter, FieldCondition, MatchValue
from tenacity import retry, stop_after_attempt, wait_exponential

from app.core.config import get_settings
from app.core.personas import get_persona_context  # CRITICAL: Preserve for Board Demo
from app.dependencies.auth import verify_clerk_token, check_tenant_membership
from app.dependencies.graph_dep import get_graph, get_graph_optional
from app.services.genai_client import get_genai_client
from app.services.graph import GraphService
from app.services.qdrant import vector_service


def _extract_user_id_from_session(session_id: str) -> str:
    """Extract user_id from session_id format: session_{tenantId}_{userId}_{timestamp}
    
    Args:
        session_id: Session ID in format session_{tenantId}_{userId}_{timestamp}
        
    Returns:
        User ID extracted from session_id, or "anonymous" if parsing fails
    """
    try:
        if session_id and session_id.startswith("session_"):
            parts = session_id.split("_")
            if len(parts) >= 3:
                return parts[2]  # user_id is the third part
    except Exception:
        pass
    return "anonymous"


router = APIRouter()


class ChatRequest(BaseModel):
    query: str = Field(..., max_length=2000, description="User query text (max 2000 characters)")
    tenant_id: str = Field(..., max_length=50, description="Tenant/client identifier (max 50 characters)")
    mode: Literal["fast", "deep"] = "fast"  # 'fast' = Gemini 2.5 Flash, 'deep' = Gemini 2.5 Pro
    session_id: Optional[str] = Field(None, description="Optional session ID for chat memory")
    user_display_name: Optional[str] = Field(None, description="User's display name for personalization (username, firstName, or email)")


class ChatResponse(BaseModel):
    response: str
    model_used: str
    sources_count: int


class MessageSchema(BaseModel):
    """Schema for a chat message in history."""
    role: str = Field(..., description="Message role: 'user' or 'model'")
    content: str = Field(..., description="Message content text")


class RenameRequest(BaseModel):
    """Schema for renaming a chat session."""
    title: str = Field(..., max_length=200, description="New title for the session (max 200 characters)")


def _get_embedding_model() -> None:
    """Configure the Google Generative AI client with the current API key.
    
    NOTE: This is still needed for GenerativeModel (chat responses).
    Embeddings now use the shared genai_client.
    """
    settings = get_settings()
    if not settings.GOOGLE_API_KEY:
        raise RuntimeError("GOOGLE_API_KEY is not configured.")

    genai.configure(api_key=settings.GOOGLE_API_KEY)


def embed_query_text(text: str) -> List[float]:
    """Embed the query text using Gemini text embeddings.
    
    Uses the new google-genai SDK via the shared client.
    This function is synchronous and should be run in a threadpool.
    """
    settings = get_settings()
    model_name = settings.EMBEDDING_MODEL
    
    try:
        # Get client (lazy initialization)
        client = get_genai_client()
        # Use the shared client to generate embedding
        response = client.models.embed_content(
            model=model_name,
            contents=text
        )
        
        # Extract embedding vector from response
        if not response.embeddings or len(response.embeddings) == 0:
            raise RuntimeError(
                f"Embedding response did not contain any embeddings for model '{model_name}'."
            )
        
        embedding = response.embeddings[0].values
        if not isinstance(embedding, list):
            raise RuntimeError(
                f"Embedding response did not contain a valid vector for model '{model_name}'."
            )
        
        return embedding
    except RuntimeError:
        # Re-raise RuntimeError as-is
        raise
    except Exception as exc:
        error_msg = (
            f"Query embedding failed using model '{model_name}': {exc}"
        )
        raise RuntimeError(error_msg) from exc


async def _embed_query_text(content: str) -> List[float]:
    """Embed the query text using Gemini text embeddings with retry logic.
    
    Wraps embed_query_text in a threadpool for async execution.
    """
    settings = get_settings()
    model_name = settings.EMBEDDING_MODEL

    try:
        # Run blocking GenAI call in threadpool to avoid blocking event loop
        return await run_in_threadpool(embed_query_text, content)
    except RuntimeError:
        # Re-raise RuntimeError as-is
        raise
    except Exception as exc:
        error_msg = (
            f"Query embedding failed using model '{model_name}': {exc}"
        )
        raise RuntimeError(error_msg) from exc


def _get_text_for_rag(payload: Dict[str, Any], settings: Any) -> str:
    """Extract appropriate text for RAG context from a payload.
    
    STANDARDIZED BEHAVIOR:
    - For images with valid OCR: returns FULL ocr_text (already capped at OCR_MAX_CHARS, not truncated to 1000)
    - For non-images: returns FULL content field (capped at MAX_CHARS_TOTAL=20k during ingestion)
    - Falls back to content_preview only if content is missing (backward compatibility)
    
    For images with OCR, uses OCR text if:
    - ai_enabled == True
    - ocr_status == "complete"
    - ocr_confidence >= OCR_MIN_CONFIDENCE
    
    Args:
        payload: Qdrant point payload dictionary
        settings: Application settings (for OCR_MIN_CONFIDENCE)
        
    Returns:
        Text content to use in RAG context (full text, not truncated to 1000 chars)
    """
    # Check if this is an image with valid OCR
    file_type = payload.get("file_type") or payload.get("type", "")
    is_image = file_type.lower() in ("png", "jpg", "jpeg", "webp", "tiff")
    
    if is_image:
        ai_enabled = payload.get("ai_enabled", False)
        ocr_status = payload.get("ocr_status", "not_requested")
        ocr_confidence = payload.get("ocr_confidence")
        ocr_text = payload.get("ocr_text")
        
        # Use OCR text if all conditions are met (return FULL OCR text, already capped at OCR_MAX_CHARS)
        # DO NOT truncate to 1000 chars here - use the full OCR text for better RAG context
        if (ai_enabled and 
            ocr_status == "complete" and 
            ocr_text and
            (ocr_confidence is None or ocr_confidence >= settings.OCR_MIN_CONFIDENCE)):
            return ocr_text  # Return full OCR text (already capped at OCR_MAX_CHARS=8000)
    
    # Default: use FULL content field (not preview) for RAG
    # content field stores full extracted text (capped at MAX_CHARS_TOTAL=20k during ingestion)
    # content_preview is only for UI display (first 1000 chars)
    # Fall back to content_preview only if content is missing (backward compatibility)
    return payload.get("content") or payload.get("content_preview") or "No preview available."


def _format_rag_context(
    private_results: List[Dict[str, Any]], 
    global_results: List[Dict[str, Any]],
    graph_results: str = "",
    file_manifest: Optional[List[str]] = None
) -> str:
    """Format retrieved documents into a context string for the LLM with citations.
    
    Includes both vector search results, graph search results, and file manifest.
    Uses OCR text for images when appropriate (ai_enabled=True, ocr_status=complete, confidence>=threshold).
    """
    from app.core.config import get_settings
    settings = get_settings()
    
    context_parts: List[str] = []

    # Format File Manifest (Available files in the campaign)
    if file_manifest and len(file_manifest) > 0:
        context_parts.append("### ðŸ“‚ FILE MANIFEST (Assets in this Campaign)")
        context_parts.append("The following files are available in the secure vault. If the user asks about one, acknowledge it exists:")
        for filename in file_manifest:
            context_parts.append(f"- {filename}")
        context_parts.append("")  # Blank line

    # Format Graph Results (Golden Set - Structured Campaigns)
    if graph_results:
        context_parts.append("### ðŸ•¸ï¸ KNOWLEDGE GRAPH HITS")
        context_parts.append(graph_results)
        context_parts.append("")  # Blank line

    # Format Internal Campaign Data (Private Results - Vectors)
    if private_results:
        context_parts.append("### ðŸ“„ DOCUMENT ARCHIVE (Campaign-Specific)")
        for result in private_results:
            payload = result.get("payload", {})
            filename = payload.get("filename", "Unknown Document")
            # Use _get_text_for_rag which returns full content (not preview) for RAG context
            # For images: returns full ocr_text if OCR is complete and allowed
            # For non-images: returns full content field (capped at MAX_CHARS_TOTAL)
            rag_text = _get_text_for_rag(payload, settings)

            context_parts.append(
                f"[[Source: {filename}]]\n"
                f"Content: {rag_text}\n"
            )

    # Format Firm-Wide Knowledge (Global Results - Vectors)
    if global_results:
        context_parts.append("\n### ðŸ“„ DOCUMENT ARCHIVE (Firm-Wide)")
        for result in global_results:
            payload = result.get("payload", {})
            filename = payload.get("filename", "Unknown Document")
            # Use _get_text_for_rag which returns full content (not preview) for RAG context
            # For images: returns full ocr_text if OCR is complete and allowed
            # For non-images: returns full content field (capped at MAX_CHARS_TOTAL)
            rag_text = _get_text_for_rag(payload, settings)

            context_parts.append(
                f"[[Source: {filename}]]\n"
                f"Content: {rag_text}\n"
            )

    return "\n".join(context_parts)


def _get_model_name(mode: Literal["fast", "deep"]) -> str:
    """Return the Gemini 2.5 model name based on the mode."""
    if mode == "fast":
        return "gemini-2.5-flash"
    return "gemini-2.5-pro"


@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10)
)
def _generate_content_with_retry(model: genai.GenerativeModel, prompt: str) -> Any:
    """Synchronous wrapper for model.generate_content with retry logic."""
    return model.generate_content(prompt)


@router.post("/chat", response_model=ChatResponse)
async def chat(
    request: ChatRequest,
    background_tasks: BackgroundTasks,
    http_request: Request,
    current_user: Dict = Depends(verify_clerk_token),
    graph: Optional[GraphService] = Depends(get_graph_optional)
) -> ChatResponse:
    """Chat endpoint with RAG and model routing for tenant-isolated queries.
    
    Supports two modes:
    - Global Mode (tenant_id == "global"): Searches ONLY Global Knowledge Base (Tier 1)
    - Campaign Mode (tenant_id != "global"): Searches Client Silo (Tier 2) + Global (Tier 1)
    
    SECURITY: Tenant membership is enforced after parsing the request body.
    """
    # Verify tenant membership (tenant_id comes from request body)
    user_id = current_user.get("id", "unknown")
    await check_tenant_membership(user_id, request.tenant_id, http_request)
    
    # Log user_id + tenant_id for every request
    print(f"Chat request: user_id={user_id}, tenant_id={request.tenant_id}")
    
    settings = get_settings()

    # Step A: Embed the query
    try:
        query_vector = await _embed_query_text(request.query)
    except RuntimeError as exc:
        raise HTTPException(status_code=500, detail=f"Embedding failed: {exc}") from exc

    # Step B: Parallel Hybrid RAG - Graph + Vector Search
    private_results: List[Dict[str, Any]] = []
    global_results: List[Dict[str, Any]] = []
    graph_results = ""
    file_manifest: List[str] = []  # File manifest for Campaign Mode
    
    if request.tenant_id == "global":
        # Global Mode: Search TIER_1 for Firm Documents (files with is_global=True) + Graph
        # DO NOT search Tier 2 in global mode - Firm Documents live in Tier 1
        try:
            # Parallel execution: Graph and Vector searches
            tasks = []
            if graph:
                tasks.append(graph.search_campaigns_fuzzy(request.query))
            
            # Search Tier 1 with is_global=True filter for Firm Documents
            global_filter = Filter(
                must=[
                    FieldCondition(
                        key="is_global",
                        match=MatchValue(value=True),
                    )
                ]
            )
            
            vector_task = vector_service.search_global(
                collection_name=settings.QDRANT_COLLECTION_TIER_1,
                query_vector=query_vector,
                limit=40 if request.mode == "deep" else 20,
                filter=global_filter,  # SECURITY: Always filter by is_global=True
            )
            tasks.append(vector_task)
            
            # Execute in parallel
            results = await asyncio.gather(*tasks, return_exceptions=True)
            
            # Extract results
            if graph and len(results) > 0:
                graph_result = results[0]
                if isinstance(graph_result, str):
                    graph_results = graph_result
                else:
                    graph_results = ""
            else:
                graph_results = ""
            
            vector_result = results[-1] if results else []
            if isinstance(vector_result, list):
                global_results = vector_result
            else:
                global_results = []
        except Exception as exc:
            raise HTTPException(
                status_code=500, detail=f"Global search failed: {exc}"
            ) from exc
    else:
        # Campaign Mode: Search Tier 2 (Client Silo) + Tier 1 (Global) + Graph + File Manifest
        private_limit = 40 if request.mode == "deep" else 10
        global_limit = 20 if request.mode == "deep" else 5

        # Fetch File Manifest (list of available files in the campaign)
        file_manifest: List[str] = []
        try:
            file_list = await vector_service.list_tenant_files(
                collection_name=settings.QDRANT_COLLECTION_TIER_2,
                tenant_id=request.tenant_id,
                limit=50,
            )
            # Extract just the filenames
            file_manifest = [file.get("filename", "Unknown") for file in file_list if file.get("filename")]
        except Exception as exc:
            # If file listing fails, continue without manifest
            print(f"Warning: Failed to fetch file manifest: {exc}")
            file_manifest = []

        # Parallel execution: Graph and Vector searches
        tasks = []
        if graph:
            tasks.append(graph.search_campaigns_fuzzy(request.query))
        
        # Campaign Mode: Search Tier 2 with client_id filter AND ai_enabled=true
        tasks.append(vector_service.search_silo(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            query_vector=query_vector,
            tenant_id=request.tenant_id,
            limit=private_limit,
            require_ai_enabled=True,  # CRITICAL: Only retrieve files with AI Memory enabled
        ))
        
        # Search Tier 1 with is_global=True filter (never unfiltered)
        global_filter = Filter(
            must=[
                FieldCondition(
                    key="is_global",
                    match=MatchValue(value=True),
                )
            ]
        )
        
        tasks.append(vector_service.search_global(
            collection_name=settings.QDRANT_COLLECTION_TIER_1,
            query_vector=query_vector,
            limit=global_limit,
            filter=global_filter,  # SECURITY: Always filter by is_global=True
        ))
        
        # Execute all searches in parallel
        try:
            results = await asyncio.gather(*tasks, return_exceptions=True)
            
            # Extract results (handle exceptions gracefully)
            if graph and len(results) > 0:
                graph_result = results[0]
                if isinstance(graph_result, str):
                    graph_results = graph_result
                else:
                    graph_results = ""
            else:
                graph_results = ""
            
            private_result = results[1] if len(results) > 1 else []
            if isinstance(private_result, list):
                private_results = private_result
            else:
                private_results = []
            
            global_result = results[2] if len(results) > 2 else []
            if isinstance(global_result, list):
                global_results = global_result
            else:
                global_results = []
        except Exception as exc:
            # If parallel execution fails, try sequential as fallback
            if graph:
                try:
                    graph_results = await graph.search_campaigns_fuzzy(request.query)
                except:
                    graph_results = ""
            try:
                private_results = await vector_service.search_silo(
                    collection_name=settings.QDRANT_COLLECTION_TIER_2,
                    query_vector=query_vector,
                    tenant_id=request.tenant_id,
                    limit=private_limit,
                    require_ai_enabled=True,  # CRITICAL: Only retrieve files with AI Memory enabled
                )
            except:
                private_results = []
            try:
                global_filter = Filter(
                    must=[
                        FieldCondition(
                            key="is_global",
                            match=MatchValue(value=True),
                        )
                    ]
                )
                global_results = await vector_service.search_global(
                    collection_name=settings.QDRANT_COLLECTION_TIER_1,
                    query_vector=query_vector,
                    limit=global_limit,
                    filter=global_filter,  # SECURITY: Always filter by is_global=True
                )
            except:
                global_results = []

    # Step C: Fetch chat history if session_id provided
    chat_history: List[Dict[str, str]] = []
    if request.session_id and graph:
        try:
            # Extract user_id from session_id (format: session_{tenantId}_{userId}_{timestamp})
            user_id = _extract_user_id_from_session(request.session_id)
            chat_history = await graph.get_chat_history(
                session_id=request.session_id,
                tenant_id=request.tenant_id,
                user_id=user_id,
                limit=6
            )
        except Exception as exc:
            chat_history = []

    # Step D: Format context (includes Graph + Vector results + File Manifest)
    has_context = (
        (private_results and len(private_results) > 0) or
        (global_results and len(global_results) > 0) or
        (graph_results and len(graph_results) > 0) or
        (file_manifest and len(file_manifest) > 0)
    )
    context = _format_rag_context(private_results, global_results, graph_results, file_manifest)
    total_sources = len(private_results) + len(global_results) + (1 if graph_results else 0)

    # Step E: Build system prompt with persona injection and formatting rules
    mode_instruction = (
        "Provide comprehensive strategic analysis with deep insights and connections."
    ) if request.mode == "deep" else (
        "Provide a concise, actionable summary."
    )

    # Get persona context (CRITICAL for Board Demo)
    persona_context = get_persona_context()

    empty_context_instruction = ""
    if not has_context:
        empty_context_instruction = """
IMPORTANT: The context below is empty. Do NOT say "I don't know" or "I don't have information."
Instead, say: "I'm looking through the files, but I don't see that specific detail yet. However, based on standard RALLY strategy, we usually..." 
Provide helpful guidance based on campaign strategy best practices, even if the specific data isn't in the files.
"""

    # Get user display name for personalization (fallback to "there" if not provided)
    user_display_name = request.user_display_name or "there"
    
    system_prompt = f"""You are Riley, a Senior Strategist at RALLY.
You speak in a **High-Bandwidth, Low-Density** style.

YOUR ROLE:
You work alongside {user_display_name} in a Campaign Workspace setting. You're warm, professional, confident, and proactive. You think strategically and connect dots that others might miss.

YOUR TONE:
Confident, collaborative, and punchy. Use bolding to highlight **key metrics** or **names**.
- Use "We" instead of "You" (e.g., "We should consider..." not "You should consider...")
- Speak like a trusted colleague who's been in the trenches
- Get straight to the pointâ€”no fluff

STRATEGIC PERSONA RECOGNITION (CRITICAL):
Refer to this list of Strategic Archetypes: {persona_context}
Treat them as VIP audiences. If the user mentions a Persona (like "Passive Patty" or "Skeptical Sam"), analyze their specific psychographics, motivations, and messaging needs. These personas represent distinct audience segments with unique characteristics.

CITATION PROTOCOL:
- **ALWAYS cite your sources explicitly** using the format: `[[Source: Filename.pdf]]`
- When you reference information from the context, include the source citation inline
- Example: "According to the Q3 report [[Source: Q3_Report_2024.pdf]], we saw a 15% increase..."
- **If the answer is NOT in the context provided, explicitly admit it**: "I don't see that specific information in the available documents. However, based on standard RALLY strategy..."

FORMATTING RULES (NON-NEGOTIABLE - SCANNABLE OUTPUT):
1. **SHORT HEADINGS WITH EMOJIS:** Always use `###` (h3) for section headers with required emojis. Keep header text concise (3-5 words max).
   - Examples: `### ðŸ§  Strategic Context`, `### ðŸ”Ž Key Insights`, `### ðŸš€ Next Moves`
2. **BULLET LISTS REQUIRED:** Key Insights and Next Moves MUST be formatted as bullet lists, not paragraphs:
   - Correct: `### ðŸ”Ž Key Insights\n- **Insight 1:** Description.\n- **Insight 2:** Description.`
   - Incorrect: `### Key Insights\nParagraph format with multiple sentences...`
3. **AGGRESSIVE SPACING:** You MUST put a blank line between every single paragraph, list item, and section.
4. **REAL LISTS:** When listing items (like attributes, steps, or insights), you MUST use Markdown bullet points:
   - Correct: `- **Attribute Name:** The description.`
   - Incorrect: `Attribute Name: The description.`
5. **INDENTATION:** Never write a list item without the `- ` prefix.
6. **AVOID DENSE PARAGRAPHS:** Keep paragraphs to 1-2 sentences max. Use bullet lists instead of long paragraphs unless the user specifically asks for detailed prose.
7. **STRUCTURE RULE:** Use Markdown Headers (###) for sections. ALWAYS put TWO blank lines between sections.

RESPONSE TEMPLATE (MANDATORY FORMAT):
EVERY response MUST follow this exact structure. No exceptions.

Start with a direct answer (1-2 sentences max).

Then ALWAYS include these three sections in this exact order:

### ðŸ§  Strategic Context
1-2 sentences explaining why this matters and connections to campaign goals.

### ðŸ”Ž Key Insights
MUST be formatted as a bullet list:
- **Insight 1:** Description with citation `[[Source: ...]]` if applicable.
- **Insight 2:** Description with citation `[[Source: ...]]` if applicable.
- **Insight 3:** Description with citation `[[Source: ...]]` if applicable.

If no documents were retrieved, include ONE bullet: `- No documents retrieved from the archive for this query.`

### ðŸš€ Next Moves
MUST be formatted as a bullet list:
- **Action 1:** Specific actionable recommendation.
- **Action 2:** Specific actionable recommendation.
- **Action 3:** Specific actionable recommendation.

CRITICAL FORMATTING RULES:
- Use EXACTLY these emojis: ðŸ§  for Strategic Context, ðŸ”Ž for Key Insights, ðŸš€ for Next Moves
- Put a blank line (`\n\n`) between EVERY section
- Strategic Context: 1-2 sentences only (no dense paragraphs)
- Key Insights and Next Moves: ALWAYS bullet lists, never paragraphs
- If you have no insights, still include the section with: `- No specific insights available.`

PLACEHOLDER TOKEN PROHIBITION:
- **NEVER output placeholder tokens** like `[User Name]`, `[Filename]`, or `[[Source: ...]]` unless you are actually citing a real source from the context.
- Only use `[[Source: Filename.pdf]]` when you are referencing information that was actually retrieved from the Document Archive.
- If no sources were used, do not include citation placeholders.

DATA SOURCES (TWO MEMORY BANKS):
You have access to two memory banks:

1. **ðŸ•¸ï¸ KNOWLEDGE GRAPH (The Golden Set):** Structured campaign data from Neo4j. This contains campaign names, descriptions, and relationships. Use this to identify project names and campaign structures.

2. **ðŸ“„ DOCUMENT ARCHIVE (The Archive):** Raw documents from vector search. This contains detailed content, messaging, research, and tactical information. Use this for specific details, quotes, and evidence.

**CRITICAL INSTRUCTION:** 
- If the Graph is empty, rely entirely on the Archive.
- If the Graph has results, use it to identify campaign names, then use the Archive for details.
- Always cite sources from the Archive using `[[Source: Filename.pdf]]`.

**FILE MANIFEST AWARENESS:**
- If the user asks about a file listed in the **FILE MANIFEST**, acknowledge that you see it.
- If the specific content wasn't retrieved in the **DOCUMENT ARCHIVE** section, tell the user: "I see [Filename] in the vault. Ask me a specific question about its contents so I can retrieve the details."
- Never claim a file doesn't exist if it's in the FILE MANIFEST.

{empty_context_instruction}
{mode_instruction}

Context Data:
{context if has_context else "[No specific data found in files yet]"}
"""

    # Format chat history
    history_context = ""
    if chat_history:
        history_context = "\n\n=== Previous Conversation ===\n"
        for msg in chat_history:
            role_label = "User" if msg["role"] == "user" else "Riley"
            history_context += f"{role_label}: {msg['content']}\n"
    
    system_prompt += history_context
    system_prompt += f"\nUser Question: {request.query}"

    # Step F: Generate response (Non-blocking with threadpool)
    model_name = _get_model_name(request.mode)
    _get_embedding_model()  # Ensure API key is configured

    try:
        model = genai.GenerativeModel(model_name)
        # Run blocking GenAI call in threadpool with retry logic to avoid blocking event loop
        response = await run_in_threadpool(
            _generate_content_with_retry,
            model,
            system_prompt,
        )
        
        # Extract text from response
        response_text = ""
        if hasattr(response, "text"):
            response_text = response.text
        elif hasattr(response, "candidates") and response.candidates:
            candidate = response.candidates[0]
            if hasattr(candidate, "content") and hasattr(candidate.content, "parts"):
                response_text = " ".join(
                    part.text for part in candidate.content.parts if hasattr(part, "text")
                )
        
        if not response_text:
            raise RuntimeError("Failed to extract text from model response.")

    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Model generation failed ({model_name}): {exc}",
        ) from exc

    # Step G: Save messages to Neo4j using background tasks (non-blocking)
    if request.session_id and graph:
        # Extract user_id from session_id (format: session_{tenantId}_{userId}_{timestamp})
        user_id = _extract_user_id_from_session(request.session_id)
        
        background_tasks.add_task(
            graph.save_message,
            request.session_id,
            "user",
            request.query,
            request.tenant_id,
            user_id,
        )
        background_tasks.add_task(
            graph.save_message,
            request.session_id,
            "model",
            response_text,
            request.tenant_id,
            user_id,
        )

    return ChatResponse(
        response=response_text,
        model_used=model_name,
        sources_count=total_sources,
    )


@router.get("/chat/history/{session_id}", response_model=List[MessageSchema])
async def get_chat_session_history(
    session_id: str,
    tenant_id: str = Query(..., description="Tenant/client identifier for scope isolation"),
    graph: GraphService = Depends(get_graph)
) -> List[MessageSchema]:
    """Retrieve chat history for a specific session.
    
    SECURITY: Requires tenant_id to enforce scope isolation.
    Only returns messages for the specified tenant and user.
    """
    try:
        # Extract user_id from session_id (format: session_{tenantId}_{userId}_{timestamp})
        user_id = _extract_user_id_from_session(session_id)
        history = await graph.get_chat_history(
            session_id=session_id,
            tenant_id=tenant_id,
            user_id=user_id,
            limit=10
        )
        return [MessageSchema(**msg) for msg in history]
    except Exception as exc:
        raise HTTPException(
            status_code=500, detail=f"Failed to get chat history: {exc}"
        ) from exc


@router.delete("/chat/history/{session_id}")
async def clear_chat_history(
    session_id: str,
    tenant_id: str = Query(..., description="Tenant/client identifier for scope isolation"),
    graph: GraphService = Depends(get_graph)
) -> Dict[str, str]:
    """Clear chat history for a session.
    
    Deletes all messages and the session node from Neo4j.
    This endpoint matches the frontend path: DELETE /api/v1/chat/history/{session_id}
    
    SECURITY: Requires tenant_id to enforce scope isolation.
    Only deletes sessions for the specified tenant and user.
    """
    try:
        # Extract user_id from session_id (format: session_{tenantId}_{userId}_{timestamp})
        user_id = _extract_user_id_from_session(session_id)
        await graph.clear_chat_history(
            session_id=session_id,
            tenant_id=tenant_id,
            user_id=user_id
        )
        return {
            "status": "success",
            "message": f"Chat history cleared for session {session_id}"
        }
    except Exception as exc:
        print(f"Error clearing chat history: {exc}")
        raise HTTPException(
            status_code=500, detail=f"Failed to clear chat history: {str(exc)}"
        ) from exc


@router.patch("/sessions/{session_id}")
async def rename_session(
    session_id: str,
    tenant_id: str = Query(..., description="Tenant/client identifier for scope isolation"),
    request: RenameRequest = ...,
    graph: GraphService = Depends(get_graph)
) -> Dict[str, str]:
    """Rename a chat session.
    
    Updates the title of an existing chat session in Neo4j.
    
    SECURITY: Requires tenant_id to enforce scope isolation.
    Only updates sessions for the specified tenant and user.
    
    Args:
        session_id: Unique identifier for the chat session
        tenant_id: Tenant/client identifier for scope isolation
        request: RenameRequest containing the new title
        
    Returns:
        Dictionary with status and updated title
    """
    try:
        # Extract user_id from session_id (format: session_{tenantId}_{userId}_{timestamp})
        user_id = _extract_user_id_from_session(session_id)
        updated_title = await graph.update_session_title(
            session_id=session_id,
            tenant_id=tenant_id,
            user_id=user_id,
            title=request.title
        )
        return {
            "status": "success",
            "title": updated_title
        }
    except ValueError as exc:
        raise HTTPException(
            status_code=404, detail=str(exc)
        ) from exc
    except Exception as exc:
        print(f"Error renaming session {session_id}: {exc}")
        raise HTTPException(
            status_code=500, detail=f"Failed to rename session: {str(exc)}"
        ) from exc


==================================================
FILE: fastapi-backend/app/routers/campaign.py
==================================================
from typing import Dict, List, Optional
from fastapi import APIRouter, HTTPException, Depends, Query, status
from pydantic import BaseModel, Field

from app.dependencies.auth import verify_tenant_access, verify_clerk_token
from app.dependencies.graph_dep import get_graph
from app.services.graph import GraphService
from app.services.qdrant import vector_service
from app.services.storage import StorageService
from app.services.clerk_directory import find_user_by_email


router = APIRouter()


class CreateCampaignRequest(BaseModel):
    name: str = Field(..., max_length=200, description="Campaign name")
    description: Optional[str] = Field(None, max_length=1000, description="Campaign description")


class CampaignResponse(BaseModel):
    id: str
    name: str
    description: Optional[str] = None
    role: str


class CampaignsListResponse(BaseModel):
    campaigns: List[CampaignResponse]


class TerminationResponse(BaseModel):
    status: str
    message: str
    files_deleted: int


class PostMessageRequest(BaseModel):
    content: str = Field(..., max_length=2000, description="Message content (max 2000 characters)")


class TeamMessageResponse(BaseModel):
    id: str
    content: str
    timestamp: str
    author_id: str


class TeamMessagesResponse(BaseModel):
    messages: List[TeamMessageResponse]


class AddMemberRequest(BaseModel):
    email: str = Field(..., description="Email address of the user to add")
    role: str = Field(..., description="Role to assign: 'Member' or 'Lead'")


class MemberResponse(BaseModel):
    id: str
    email: str
    role: str


class MembersListResponse(BaseModel):
    members: List[MemberResponse]


@router.post("/campaigns", response_model=CampaignResponse)
async def create_campaign(
    request: CreateCampaignRequest,
    current_user: Dict = Depends(verify_clerk_token),
    graph: GraphService = Depends(get_graph)
) -> CampaignResponse:
    """Create a new campaign and add the current user as Lead member.
    
    The creator is automatically added as a member with role "Lead".
    Returns the created campaign with the user's role.
    """
    user_id = current_user.get("id", "unknown")
    
    try:
        campaign = await graph.create_campaign(
            name=request.name,
            description=request.description,
            user_id=user_id
        )
        return CampaignResponse(**campaign)
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to create campaign: {exc}"
        ) from exc


@router.get("/campaigns", response_model=CampaignsListResponse)
async def get_campaigns(
    current_user: Dict = Depends(verify_clerk_token),
    graph: GraphService = Depends(get_graph)
) -> CampaignsListResponse:
    """Get all campaigns that the current user is a member of.
    
    Returns a list of campaigns with the user's role in each campaign.
    """
    user_id = current_user.get("id", "unknown")
    
    try:
        campaigns = await graph.get_user_campaigns(user_id)
        return CampaignsListResponse(
            campaigns=[CampaignResponse(**camp) for camp in campaigns]
        )
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to retrieve campaigns: {exc}"
        ) from exc


@router.delete("/campaign/{tenant_id}", response_model=TerminationResponse)
async def terminate_campaign(
    tenant_id: str,
    current_user: Dict = Depends(verify_tenant_access)
) -> TerminationResponse:
    """
    Permanently delete a campaign and ALL its associated data.
    
    The Ghostbuster Protocol:
    1. Security: Prevents deleting "global" tenant
    2. Vector Wipe: Deletes all Qdrant vectors for the tenant
    3. Storage Wipe: Deletes all GCS files for the tenant
    
    This is an irreversible action. Use archive for soft delete.
    """
    # Log user_id + tenant_id for every request
    user_id = current_user.get("id", "unknown")
    print(f"Terminate campaign request: user_id={user_id}, tenant_id={tenant_id}")
    
    # Security: Prevent deleting global tenant
    if tenant_id == "global":
        raise HTTPException(
            status_code=403,
            detail="Cannot terminate 'global' tenant. This is a protected system tenant."
        )
    
    try:
        # Step 1: Get all file URLs from Qdrant before deletion
        file_urls = await vector_service.delete_tenant_data(tenant_id)
        
        # Step 2: Delete all files from GCS
        if file_urls:
            await StorageService.delete_batch(file_urls)
        
        return TerminationResponse(
            status="success",
            message=f"Campaign {tenant_id} terminated successfully. All data has been permanently deleted.",
            files_deleted=len(file_urls)
        )
    except ValueError as exc:
        raise HTTPException(
            status_code=400,
            detail=str(exc)
        ) from exc
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to terminate campaign: {exc}"
        ) from exc


@router.get("/campaigns/{id}/chat", response_model=TeamMessagesResponse)
async def get_team_messages(
    id: str,
    since: Optional[str] = Query(None, description="ISO timestamp - only return messages after this time"),
    limit: int = Query(50, ge=1, le=100, description="Maximum number of messages to return"),
    current_user: Dict = Depends(verify_tenant_access),
    graph: GraphService = Depends(get_graph)
) -> TeamMessagesResponse:
    """Get team messages for a campaign.
    
    SECURITY: Requires authentication and campaign membership (enforced by verify_tenant_access).
    The tenant_id is extracted from the path parameter {id}.
    
    Args:
        id: Campaign ID (extracted from path)
        since: Optional ISO timestamp - only return messages after this time
        limit: Maximum number of messages to return (1-100, default: 50)
        current_user: Authenticated user (from verify_tenant_access)
        
    Returns:
        List of team messages ordered chronologically (oldest -> newest)
    """
    try:
        messages = await graph.get_team_messages(
            campaign_id=id,
            limit=limit,
            since=since
        )
        
        return TeamMessagesResponse(
            messages=[TeamMessageResponse(**msg) for msg in messages]
        )
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to retrieve team messages: {exc}"
        ) from exc


@router.post("/campaigns/{id}/chat", response_model=TeamMessageResponse)
async def post_team_message(
    id: str,
    request: PostMessageRequest,
    current_user: Dict = Depends(verify_tenant_access),
    graph: GraphService = Depends(get_graph)
) -> TeamMessageResponse:
    """Post a team message to a campaign.
    
    SECURITY: Requires authentication and campaign membership (enforced by verify_tenant_access).
    The tenant_id is extracted from the path parameter {id}.
    Author identity is derived from the verified current_user, not from request body.
    
    Args:
        id: Campaign ID (extracted from path)
        request: Message content
        current_user: Authenticated user (from verify_tenant_access)
        
    Returns:
        Created message object
    """
    try:
        message = await graph.post_team_message(
            campaign_id=id,
            user=current_user,
            content=request.content
        )
        
        return TeamMessageResponse(**message)
    except ValueError as exc:
        raise HTTPException(
            status_code=400,
            detail=str(exc)
        ) from exc
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to post team message: {exc}"
        ) from exc


@router.get("/campaigns/{id}/members", response_model=MembersListResponse)
async def get_campaign_members(
    id: str,
    current_user: Dict = Depends(verify_tenant_access),
    graph: GraphService = Depends(get_graph)
) -> MembersListResponse:
    """Get all members of a campaign.
    
    SECURITY: Requires authentication and campaign membership (enforced by verify_tenant_access).
    The tenant_id is extracted from the path parameter {id}.
    
    Args:
        id: Campaign ID (extracted from path)
        current_user: Authenticated user (from verify_tenant_access)
        
    Returns:
        List of campaign members with their roles
    """
    try:
        members = await graph.list_campaign_members(campaign_id=id)
        return MembersListResponse(
            members=[MemberResponse(**member) for member in members]
        )
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to retrieve campaign members: {exc}"
        ) from exc


@router.post("/campaigns/{id}/members", response_model=MembersListResponse)
async def add_campaign_member(
    id: str,
    request: AddMemberRequest,
    current_user: Dict = Depends(verify_tenant_access),
    graph: GraphService = Depends(get_graph)
) -> MembersListResponse:
    """Add a member to a campaign.
    
    SECURITY: 
    - Requires authentication and campaign membership (enforced by verify_tenant_access)
    - Additional authorization: requester must be Lead for this campaign (403 otherwise)
    - Resolves target user by email using Clerk directory
    - Returns 404 if user not found in Clerk
    
    Args:
        id: Campaign ID (extracted from path)
        request: Member addition request with email and role
        current_user: Authenticated user (from verify_tenant_access)
        
    Returns:
        Updated list of campaign members
    """
    user_id = current_user.get("id", "unknown")
    
    # Validate role
    if request.role not in ["Member", "Lead"]:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Role must be 'Member' or 'Lead'"
        )
    
    # Check if requester is Lead
    try:
        requester_role = await graph.get_member_role(user_id, id)
        if requester_role != "Lead":
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Only Lead members can add members to a campaign"
            )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to check requester role: {exc}"
        ) from exc
    
    # Resolve user by email using Clerk
    try:
        clerk_user = find_user_by_email(request.email)
        if not clerk_user:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="User not found, ask them to sign up first"
            )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail=f"Failed to resolve user by email: {exc}"
        ) from exc
    
    # Add member to campaign
    try:
        await graph.add_campaign_member(
            campaign_id=id,
            target_user_id=clerk_user["id"],
            target_email=clerk_user["email"],
            role=request.role
        )
    except ValueError as exc:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=str(exc)
        ) from exc
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to add member: {exc}"
        ) from exc
    
    # Return updated member list
    try:
        members = await graph.list_campaign_members(campaign_id=id)
        return MembersListResponse(
            members=[MemberResponse(**member) for member in members]
        )
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to retrieve updated members: {exc}"
        ) from exc


@router.delete("/campaigns/{id}/members/{user_id}", response_model=MembersListResponse)
async def remove_campaign_member(
    id: str,
    user_id: str,
    current_user: Dict = Depends(verify_tenant_access),
    graph: GraphService = Depends(get_graph)
) -> MembersListResponse:
    """Remove a member from a campaign.
    
    SECURITY:
    - Requires authentication and campaign membership (enforced by verify_tenant_access)
    - Additional authorization: requester must be Lead for this campaign (403 otherwise)
    
    Args:
        id: Campaign ID (extracted from path)
        user_id: ID of the user to remove
        current_user: Authenticated user (from verify_tenant_access)
        
    Returns:
        Updated list of campaign members
    """
    requester_id = current_user.get("id", "unknown")
    
    # Check if requester is Lead
    try:
        requester_role = await graph.get_member_role(requester_id, id)
        if requester_role != "Lead":
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Only Lead members can remove members from a campaign"
            )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to check requester role: {exc}"
        ) from exc
    
    # Remove member from campaign
    try:
        await graph.remove_campaign_member(
            campaign_id=id,
            target_user_id=user_id
        )
    except ValueError as exc:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail=str(exc)
        ) from exc
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to remove member: {exc}"
        ) from exc
    
    # Return updated member list
    try:
        members = await graph.list_campaign_members(campaign_id=id)
        return MembersListResponse(
            members=[MemberResponse(**member) for member in members]
        )
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Failed to retrieve updated members: {exc}"
        ) from exc


==================================================
FILE: fastapi-backend/app/routers/files.py
==================================================
import logging
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, List, Optional

from fastapi import APIRouter, HTTPException, UploadFile, Form, Query, Depends
from pydantic import BaseModel
from qdrant_client.http.models import Filter, FieldCondition, MatchValue

from app.core.config import get_settings
from app.dependencies.auth import verify_tenant_access
from app.services.ocr import run_ocr, is_image_ext
from app.services.qdrant import vector_service
from app.services.ingestion import process_upload, delete_file, untag_file, _generate_embedding
from app.services.storage import StorageService
from qdrant_client.http.models import PointStruct

logger = logging.getLogger(__name__)


router = APIRouter()


class FileItem(BaseModel):
    id: str
    filename: str
    type: str
    year: int | None = None


class FilesResponse(BaseModel):
    files: List[FileItem]


class UploadResponse(BaseModel):
    id: str
    url: str
    filename: str
    type: str


class FileListItem(BaseModel):
    name: str
    url: str
    type: str
    date: str
    size: str
    tags: List[str] = []
    id: str  # Qdrant point ID (required)
    ai_enabled: Optional[bool] = None
    ocr_enabled: Optional[bool] = None
    ocr_status: Optional[str] = None
    ocr_confidence: Optional[float] = None
    ocr_extracted_at: Optional[str] = None
    preview_url: Optional[str] = None
    preview_type: Optional[str] = None
    preview_status: Optional[str] = None


class FileListResponse(BaseModel):
    files: List[FileListItem]


class RenameRequest(BaseModel):
    old_name: str
    new_name: str


class RenameResponse(BaseModel):
    status: str
    new_url: str
    new_name: str


class UntagRequest(BaseModel):
    tag: str


class UpdateTagsRequest(BaseModel):
    tags: List[str]


class AssignRequest(BaseModel):
    assignee: str
    status: str  # "needs_review" or "in_review"


class PromoteRequest(BaseModel):
    is_golden: bool


class AIEnabledRequest(BaseModel):
    ai_enabled: bool


class DeleteResponse(BaseModel):
    status: str
    message: str


@router.get("/files/{tenant_id}", response_model=FilesResponse)
async def get_tenant_files(
    tenant_id: str,
    current_user: Dict = Depends(verify_tenant_access)
) -> FilesResponse:
    """Get list of files for a specific tenant from the vector database.
    
    SECURITY: Tenant membership is enforced via verify_tenant_access dependency.
    """
    settings = get_settings()

    try:
        files = await vector_service.list_tenant_files(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            tenant_id=tenant_id,
            limit=20,
        )
    except Exception as exc:
        raise HTTPException(
            status_code=500, detail=f"Failed to retrieve files: {exc}"
        ) from exc

    # Convert to response model
    file_items = [
        FileItem(
            id=file.get("id", ""),
            filename=file.get("filename", "Unknown"),
            type=file.get("type", ""),
            year=file.get("year"),
        )
        for file in files
    ]

    return FilesResponse(files=file_items)


@router.get("/list", response_model=FileListResponse)
async def list_files(
    tenant_id: str = Query(..., description="Tenant/client ID to filter files, or 'global' for firm archive"),
    current_user: Dict = Depends(verify_tenant_access)
) -> FileListResponse:
    """
    List files from Qdrant filtered by tenant_id (source of truth).
    
    Special case: If tenant_id == "global", returns files from the Firm Archive (Tier 1)
    that have been explicitly promoted with is_global=True flag.
    
    Returns a list of file objects with metadata including name, URL, type, date, size, and tags.
    Files are retrieved from Qdrant with strict tenant isolation.
    File URLs point to GCS public URLs.
    
    SECURITY: This endpoint enforces tenant isolation. Only files belonging to the specified tenant_id are returned.
    For global requests, only files with is_global=True are returned (ignoring client_id filters).
    """
    # Log user_id + tenant_id for every request
    user_id = current_user.get("id", "unknown")
    print(f"List files request: user_id={user_id}, tenant_id={tenant_id}")
    
    settings = get_settings()
    
    # Enforce tenant_id requirement
    if not tenant_id or not tenant_id.strip():
        raise HTTPException(
            status_code=400,
            detail="tenant_id is required for file listing. Cannot perform unfiltered query."
        )
    
    files = []
    
    try:
        # Special handling for global archive
        if tenant_id == "global":
            # Query Tier 1 collection for global files
            global_files = await vector_service.list_global_files(
                collection_name=settings.QDRANT_COLLECTION_TIER_1,
                limit=1000,
            )
            
            # Convert to FileListItem format
            for file_data in global_files:
                filename = file_data.get("filename")
                if not filename:
                    continue
                
                # Determine file type from extension or payload
                extension = Path(filename).suffix.lower().lstrip(".")
                file_type = file_data.get("type") or extension or "unknown"
                
                files.append(FileListItem(
                    id=file_data.get("id", ""),
                    name=filename,
                    url=file_data.get("url", ""),
                    type=file_type,
                    date=file_data.get("promoted_at", datetime.now().isoformat()),
                    size="Unknown",  # Global files may not have size
                    tags=[],  # Global files don't have tags
                    ai_enabled=file_data.get("ai_enabled"),
                    ocr_enabled=file_data.get("ocr_enabled"),
                    ocr_status=file_data.get("ocr_status"),
                    ocr_confidence=file_data.get("ocr_confidence"),
                    ocr_extracted_at=file_data.get("ocr_extracted_at"),
                ))
        else:
            # Standard tenant-scoped query (Tier 2)
            # Create tenant filter for strict isolation
            tenant_filter = Filter(
                must=[
                    FieldCondition(
                        key="client_id",
                        match=MatchValue(value=tenant_id)
                    )
                ]
            )
            
            # Scroll points from Qdrant filtered by tenant_id (source of truth)
            scroll_result = await vector_service.client.scroll(
                collection_name=settings.QDRANT_COLLECTION_TIER_2,
                scroll_filter=tenant_filter,  # SECURITY: Always use tenant filter
                limit=1000,  # Get all files for this tenant
                with_payload=True,
                with_vectors=False,
            )
            
            # Process each Qdrant point
            for point in scroll_result[0]:
                payload = point.payload or {}
                filename = payload.get("filename")
                
                if not filename:
                    continue  # Skip points without filename
                
                # Get upload date from payload, fallback to current time for old files
                file_date = payload.get("upload_date", datetime.now().isoformat())
                
                # Get file size from payload, fallback to "Unknown" for old files
                size_str = payload.get("size", "Unknown")
                
                # Determine file type from extension or payload
                extension = Path(filename).suffix.lower().lstrip(".")
                file_type = payload.get("type") or extension or "unknown"
                
                files.append(FileListItem(
                    id=str(point.id),  # UUID from Qdrant
                    name=filename,
                    url=payload.get("url", ""),  # GCS public URL from payload
                    type=file_type,
                    date=file_date,
                    size=size_str,
                    tags=payload.get("tags", []),
                    ai_enabled=payload.get("ai_enabled"),
                    ocr_enabled=payload.get("ocr_enabled"),
                    ocr_status=payload.get("ocr_status"),
                    ocr_confidence=payload.get("ocr_confidence"),
                    ocr_extracted_at=payload.get("ocr_extracted_at"),
                ))
        
        # Sort by date (newest first)
        files.sort(key=lambda x: x.date, reverse=True)
        
    except Exception as exc:
        # If Qdrant query fails, return empty list
        print(f"Error fetching files from Qdrant: {exc}")
        return FileListResponse(files=[])
    
    return FileListResponse(files=files)


@router.post("/upload", response_model=UploadResponse)
async def upload_file(
    file: UploadFile,
    tenant_id: str = Form(...),
    tags: str = Form(""),  # Comma-separated tags
    overwrite: bool = Query(False, description="Overwrite existing file if it exists"),
    current_user: Dict = Depends(verify_tenant_access)
) -> UploadResponse:
    """
    Upload a file, process it, and index it in Qdrant.
    
    The file is saved to the static directory, text is extracted (for PDFs),
    an embedding is generated, and the file is indexed in Qdrant.
    
    If a file with the same name exists and overwrite=False, returns 409 Conflict.
    """
    # Log user_id + tenant_id for every request
    user_id = current_user.get("id", "unknown")
    print(f"Upload file request: user_id={user_id}, tenant_id={tenant_id}")
    
    settings = get_settings()

    # Hard server-side file size limit (prevents memory/OCR/ingestion failures)
    max_bytes = int(settings.MAX_UPLOAD_MB) * 1024 * 1024

    # If client provided size metadata, enforce immediately
    file_size = getattr(file, "size", None)
    if isinstance(file_size, int) and file_size > max_bytes:
        raise HTTPException(
            status_code=413,
            detail=f"File exceeds maximum allowed size ({settings.MAX_UPLOAD_MB}MB). Please compress or split.",
        )

    # Always enforce by reading in chunks (covers missing/incorrect size metadata)
    total = 0
    try:
        while True:
            chunk = await file.read(1024 * 1024)  # 1MB chunks
            if not chunk:
                break
            total += len(chunk)
            if total > max_bytes:
                raise HTTPException(
                    status_code=413,
                    detail=f"File exceeds maximum allowed size ({settings.MAX_UPLOAD_MB}MB). Please compress or split.",
                )
    finally:
        # Reset stream for downstream ingestion
        await file.seek(0)

    # Parse comma-separated tags
    tag_list = [tag.strip() for tag in tags.split(",") if tag.strip()] if tags else []
    
    try:
        result = await process_upload(
            file=file,
            tenant_id=tenant_id,
            tags=tag_list,
            overwrite=overwrite
        )
        return UploadResponse(**result)
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Upload failed: {exc}"
        ) from exc


@router.post("/files/rename", response_model=RenameResponse)
async def rename_file(
    request: RenameRequest,
    tenant_id: str = Query(..., description="Tenant/client ID that owns this file"),
    current_user: Dict = Depends(verify_tenant_access)
) -> RenameResponse:
    """
    Rename a file in GCS by updating the filename in Qdrant metadata.
    
    Note: This updates the filename in Qdrant but does not rename the actual file in GCS.
    For Beta phase, we update metadata only. Full rename would require copying blob in GCS.
    
    Validates that the extension is preserved to prevent file corruption.
    """
    settings = get_settings()
    
    # Validate extension preservation
    old_ext = Path(request.old_name).suffix.lower()
    new_ext = Path(request.new_name).suffix.lower()
    
    if old_ext != new_ext:
        raise HTTPException(
            status_code=400,
            detail=f"Cannot change file extension. Original: {old_ext}, New: {new_ext}"
        )
    
    try:
        # Find file by old name in Qdrant
        tenant_filter = Filter(
            must=[
                FieldCondition(
                    key="filename",
                    match=MatchValue(value=request.old_name)
                )
            ]
        )
        
        scroll_result = await vector_service.client.scroll(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            scroll_filter=tenant_filter,
            limit=1,
            with_payload=True,
            with_vectors=False,
        )
        
        if not scroll_result[0]:
            raise HTTPException(
                status_code=404,
                detail=f"File '{request.old_name}' not found in Qdrant"
            )
        
        point = scroll_result[0][0]
        file_id = str(point.id)
        current_payload = point.payload or {}
        current_url = current_payload.get("url", "")
        
        # Update filename in Qdrant payload
        # Note: The GCS URL remains the same, only the display name changes
        await vector_service.client.set_payload(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            payload={"filename": request.new_name},
            points=[file_id]
        )
        
        return RenameResponse(
            status="success",
            new_url=current_url,  # GCS URL doesn't change
            new_name=request.new_name
        )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to rename file: {exc}"
        ) from exc


@router.delete("/files/{file_id}", response_model=DeleteResponse)
async def delete_file_endpoint(
    file_id: str,
    tenant_id: str = Query(..., description="Tenant/client ID that owns this file"),
    current_user: Dict = Depends(verify_tenant_access)
) -> DeleteResponse:
    """
    Permanently delete a file from disk, Qdrant, and all workstreams.
    
    This is an irreversible action that removes the file completely.
    
    SECURITY: Tenant membership is enforced via verify_tenant_access dependency.
    """
    settings = get_settings()
    
    try:
        await delete_file(
            file_id=file_id,
            collection_name=settings.QDRANT_COLLECTION_TIER_2
        )
        return DeleteResponse(
            status="success",
            message=f"File {file_id} deleted successfully"
        )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to delete file: {exc}"
        ) from exc


@router.patch("/files/{file_id}/untag", response_model=DeleteResponse)
async def untag_file_endpoint(
    file_id: str,
    request: UntagRequest,
    tenant_id: str = Query(..., description="Tenant/client ID that owns this file"),
    current_user: Dict = Depends(verify_tenant_access)
) -> DeleteResponse:
    """
    Remove a specific tag from a file (local delete from a workstream).
    
    This removes the file from the current view (e.g., Messaging) by removing
    the tag, but keeps the file in the vault and other workstreams.
    
    If tag is "*" or "all", removes all tags from the file.
    """
    settings = get_settings()
    
    try:
        if request.tag == "*" or request.tag.lower() == "all":
            # Clear all tags
            await untag_file(
                file_id=file_id,
                tag=None,  # None means clear all
                collection_name=settings.QDRANT_COLLECTION_TIER_2
            )
            return DeleteResponse(
                status="success",
                message=f"All tags removed from file {file_id}"
            )
        else:
            await untag_file(
                file_id=file_id,
                tag=request.tag,
                collection_name=settings.QDRANT_COLLECTION_TIER_2
            )
            return DeleteResponse(
                status="success",
                message=f"Tag '{request.tag}' removed from file {file_id}"
            )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to untag file: {exc}"
        ) from exc


@router.put("/files/{file_id}/tags", response_model=DeleteResponse)
async def update_tags_endpoint(
    file_id: str,
    request: UpdateTagsRequest,
    tenant_id: str = Query(..., description="Tenant/client ID that owns this file"),
    current_user: Dict = Depends(verify_tenant_access)
) -> DeleteResponse:
    """
    Update the tags for a file.
    
    This replaces the entire tags list with the provided tags array.
    """
    settings = get_settings()
    
    try:
        # Update tags in Qdrant
        await vector_service.client.set_payload(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            payload={"tags": request.tags},
            points=[file_id]
        )
        
        return DeleteResponse(
            status="success",
            message=f"Tags updated for file {file_id}"
        )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to update tags: {exc}"
        ) from exc


@router.patch("/files/{file_id}/assign", response_model=DeleteResponse)
async def assign_file_endpoint(
    file_id: str,
    request: AssignRequest,
    tenant_id: str = Query(..., description="Tenant/client ID that owns this file"),
    current_user: Dict = Depends(verify_tenant_access)
) -> DeleteResponse:
    """
    Assign a file to a reviewer and update its status.
    
    This updates the file's status and adds the assignee to the file's metadata.
    """
    settings = get_settings()
    
    try:
        # Get current payload
        points = await vector_service.client.retrieve(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            ids=[file_id]
        )
        
        if not points:
            raise HTTPException(status_code=404, detail=f"File {file_id} not found")
        
        current_payload = points[0].payload or {}
        
        # Update payload with assignee and status
        updated_payload = {
            **current_payload,
            "status": request.status,
            "assignee": request.assignee,
            "assigned_to": current_payload.get("assigned_to", []) + [request.assignee] if request.assignee not in current_payload.get("assigned_to", []) else current_payload.get("assigned_to", [])
        }
        
        # Update Qdrant payload
        await vector_service.client.set_payload(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            payload=updated_payload,
            points=[file_id]
        )
        
        return DeleteResponse(
            status="success",
            message=f"File {file_id} assigned to {request.assignee} with status {request.status}"
        )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to assign file: {exc}"
        ) from exc


@router.post("/files/{file_id}/archive", response_model=DeleteResponse)
async def promote_to_archive(
    file_id: str,
    request: PromoteRequest,
    tenant_id: str = Query(..., description="Tenant/client ID that owns this file"),
    current_user: Dict = Depends(verify_tenant_access)
) -> DeleteResponse:
    """
    Promote a file from the Private Client Silo (Tier 2) to the Global Firm Archive (Tier 1).
    
    This makes the document visible to the entire firm via Global Riley without violating
    tenant security for non-shared files. The file is copied to Tier 1 with optional
    "Golden Standard" weighting for high-priority learning.
    """
    # Log user_id for every request
    user_id = current_user.get("id", "unknown")
    print(f"Promote to archive request: user_id={user_id}, file_id={file_id}")
    
    try:
        await vector_service.promote_to_global(
            file_id=file_id,
            is_golden=request.is_golden
        )
        
        golden_text = " (marked as Golden Standard)" if request.is_golden else ""
        return DeleteResponse(
            status="success",
            message=f"File {file_id} promoted to Global Archive{golden_text}"
        )
    except ValueError as exc:
        raise HTTPException(
            status_code=404,
            detail=str(exc)
        ) from exc
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to promote file: {exc}"
        ) from exc


@router.patch("/files/{file_id}/ai_enabled", response_model=DeleteResponse)
async def toggle_ai_enabled(
    file_id: str,
    request: AIEnabledRequest,
    tenant_id: str = Query(..., description="Tenant/client ID that owns this file"),
    current_user: Dict = Depends(verify_tenant_access)
) -> DeleteResponse:
    """
    Toggle the AI Memory (ai_enabled) flag for a file.
    
    This controls whether the file is included in RAG searches for the campaign.
    Files with ai_enabled=false are excluded from vector search results.
    
    Args:
        file_id: The Qdrant point ID (UUID) of the file
        request: AIEnabledRequest containing the new ai_enabled boolean value
    
    Returns:
        DeleteResponse with status and message
    """
    settings = get_settings()
    
    try:
        # Verify file exists in Tier 2
        points = await vector_service.client.retrieve(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            ids=[file_id],
            with_payload=True,
            with_vectors=False,
        )
        
        if not points:
            raise HTTPException(
                status_code=404,
                detail=f"File with ID {file_id} not found in Qdrant"
            )
        
        # Update ai_enabled flag in Qdrant payload
        await vector_service.client.set_payload(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            payload={"ai_enabled": request.ai_enabled},
            points=[file_id]
        )
        
        status_text = "enabled" if request.ai_enabled else "disabled"
        return DeleteResponse(
            status="success",
            message=f"AI Memory {status_text} for file {file_id}"
        )
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to update ai_enabled: {exc}"
        ) from exc


class OCRResponse(BaseModel):
    status: str
    message: str
    ocr_text: Optional[str] = None
    ocr_confidence: Optional[float] = None
    ocr_language: Optional[str] = None
    ocr_status: str


# SINGLE SOURCE OF TRUTH: Only ONE OCR endpoint exists in the codebase
# This endpoint handles: cache check, queued status, GCS download, OCR execution,
# payload merge, ai_enabled=True auto-flip, vector embedding update, and upsert.
@router.post("/files/{file_id}/ocr", response_model=OCRResponse)
async def request_ocr(
    file_id: str,
    collection: str = Query(..., description="Collection name: 'tier_1' or 'tier_2'"),
    tenant_id: str = Query(..., description="Tenant/client ID that owns this file"),
    current_user: Dict = Depends(verify_tenant_access)
) -> OCRResponse:
    """
    Request OCR processing for an image file.
    
    SINGLE SOURCE OF TRUTH: This is the ONLY OCR endpoint in the codebase.
    
    Behavior:
    1. Validates system-wide OCR is enabled
    2. Checks if OCR is already complete (returns cached result immediately)
    3. Sets status to "queued" and persists
    4. Downloads file bytes from GCS
    5. Runs OCR extraction
    6. On success:
       - Merges OCR fields into existing payload (preserves all existing fields)
       - Sets ai_enabled=True automatically
       - Generates new embedding from OCR text (truncated to 9000 chars)
       - Upserts PointStruct with NEW vector and MERGED payload
    7. On failure: Sets ocr_status="failed" and stores error
    
    OCR only runs if:
    1. System-wide OCR is enabled (OCR_ENABLED_SYSTEMWIDE=True)
    2. File is an image type
    3. OCR hasn't already been completed (uses cached result if available)
    
    Args:
        file_id: The Qdrant point ID (UUID) of the file
        collection: Collection name - 'tier_1' for global archive, 'tier_2' for campaign assets
    
    Returns:
        OCRResponse with OCR status and extracted text (if successful)
    """
    settings = get_settings()
    
    # Validate system-wide OCR is enabled
    if not settings.OCR_ENABLED_SYSTEMWIDE:
        raise HTTPException(
            status_code=403,
            detail="OCR is not enabled system-wide. Contact administrator to enable OCR."
        )
    
    # Strict validation: collection must be exactly "tier_1" or "tier_2"
    if collection not in ("tier_1", "tier_2"):
        raise HTTPException(
            status_code=400,
            detail=f"collection must be 'tier_1' or 'tier_2', got: {collection}"
        )
    
    # Determine collection name
    collection_name = (
        settings.QDRANT_COLLECTION_TIER_1 if collection == "tier_1"
        else settings.QDRANT_COLLECTION_TIER_2
    )
    
    try:
        # Retrieve the file point
        points = await vector_service.client.retrieve(
            collection_name=collection_name,
            ids=[file_id],
            with_payload=True,
            with_vectors=False,
        )
        
        if not points:
            raise HTTPException(
                status_code=404,
                detail=f"File with ID {file_id} not found in collection {collection_name}"
            )
        
        point = points[0]
        payload = point.payload or {}
        filename = payload.get("filename", "unknown")
        
        # Check if file is an image
        if not is_image_ext(filename):
            raise HTTPException(
                status_code=400,
                detail=f"OCR is only available for image files. File '{filename}' is not an image."
            )
        
        # Check if OCR is already complete (return cached result)
        ocr_status = payload.get("ocr_status", "not_requested")
        if ocr_status == "complete" and payload.get("ocr_text"):
            return OCRResponse(
                status="success",
                message="OCR text retrieved from cache",
                ocr_text=payload.get("ocr_text"),
                ocr_confidence=payload.get("ocr_confidence"),
                ocr_language=payload.get("ocr_language"),
                ocr_status="complete"
            )
        
        # Set status to queued
        await vector_service.client.set_payload(
            collection_name=collection_name,
            payload={
                "ocr_enabled": True,
                "ocr_status": "queued",
                "ocr_error": None,
            },
            points=[file_id]
        )
        
        # Get file content from GCS
        file_url = payload.get("url")
        if not file_url:
            raise HTTPException(
                status_code=404,
                detail=f"File URL not found for ID {file_id}"
            )
        
        # Download file from GCS
        file_content = await StorageService.download_file(file_url)
        
        # Perform OCR
        try:
            ocr_result = await run_ocr(file_content, max_chars=settings.OCR_MAX_CHARS)
            
            # Update payload with OCR results
            ocr_extracted_at = datetime.now().isoformat()
            
            # Merge OCR fields into existing payload (preserve all existing fields)
            merged_payload = payload.copy()
            merged_payload.update({
                "ocr_enabled": True,
                "ocr_status": "complete",
                "ocr_text": ocr_result["text"],
                "ocr_confidence": ocr_result["confidence"],
                "ocr_language": ocr_result["language"],
                "ocr_extracted_at": ocr_extracted_at,
                "ocr_error": None,
                # Automatically enable AI Memory after successful OCR
                "ai_enabled": True,
                # Update content_preview to show OCR text preview
                "content_preview": ocr_result["text"][:1000],
            })
            
            # Generate new embedding from OCR text for improved retrieval
            # Truncate to 9000 chars (same as ingestion) for embedding
            ocr_text_for_embedding = ocr_result["text"][:9000]
            new_vector = await _generate_embedding(ocr_text_for_embedding)
            
            # Update the point with new vector and merged payload
            updated_point = PointStruct(
                id=file_id,
                vector=new_vector,
                payload=merged_payload
            )
            
            await vector_service.client.upsert(
                collection_name=collection_name,
                points=[updated_point]
            )
            
            return OCRResponse(
                status="success",
                message="OCR completed successfully and vector embedding updated",
                ocr_text=ocr_result["text"],
                ocr_confidence=ocr_result["confidence"],
                ocr_language=ocr_result["language"],
                ocr_status="complete"
            )
            
        except ImportError as e:
            error_msg = f"OCR dependencies not installed: {str(e)}"
            await vector_service.client.set_payload(
                collection_name=collection_name,
                payload={
                    "ocr_status": "failed",
                    "ocr_error": error_msg,
                },
                points=[file_id]
            )
            raise HTTPException(
                status_code=500,
                detail=error_msg
            ) from e
        except Exception as e:
            error_msg = f"OCR processing failed: {str(e)}"
            logger.error(f"OCR failed for file {file_id}: {e}")
            await vector_service.client.set_payload(
                collection_name=collection_name,
                payload={
                    "ocr_status": "failed",
                    "ocr_error": error_msg,
                },
                points=[file_id]
            )
            raise HTTPException(
                status_code=500,
                detail=error_msg
            ) from e
            
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to process OCR request: {exc}"
        ) from exc



==================================================
FILE: fastapi-backend/app/routers/search.py
==================================================
from typing import Any, Dict, List

from fastapi import APIRouter, HTTPException, Depends, Request
from fastapi.concurrency import run_in_threadpool
from pydantic import BaseModel, Field

from app.core.config import get_settings
from app.dependencies.auth import verify_clerk_token, check_tenant_membership
from app.services.genai_client import get_genai_client
from app.services.qdrant import vector_service


router = APIRouter()


class SearchRequest(BaseModel):
    query_text: str = Field(..., max_length=2000, description="Search query text (max 2000 characters)")
    tenant_id: str = Field(..., max_length=50, description="Tenant/client identifier (max 50 characters)")


class SearchResponse(BaseModel):
    results: List[Dict[str, Any]]


def _embed_query_text_sync(text: str) -> List[float]:
    """Embed the query text using Gemini text embeddings.
    
    Uses the new google-genai SDK via the shared client.
    This function is synchronous and should be run in a threadpool.
    """
    settings = get_settings()
    model_name = settings.EMBEDDING_MODEL
    
    try:
        # Get client (lazy initialization)
        client = get_genai_client()
        # Use the shared client to generate embedding
        response = client.models.embed_content(
            model=model_name,
            contents=text
        )
        
        # Extract embedding vector from response
        if not response.embeddings or len(response.embeddings) == 0:
            raise RuntimeError(
                f"Embedding response did not contain any embeddings for model '{model_name}'."
            )
        
        embedding = response.embeddings[0].values
        if not isinstance(embedding, list):
            raise RuntimeError(
                f"Embedding response did not contain a valid vector for model '{model_name}'."
            )
        
        return embedding
    except RuntimeError:
        # Re-raise RuntimeError as-is
        raise
    except Exception as exc:
        error_msg = (
            f"Query embedding failed using model '{model_name}': {exc}"
        )
        raise RuntimeError(error_msg) from exc


async def _embed_query_text(content: str) -> List[float]:
    """Embed the query text using Gemini text embeddings.

    Wraps _embed_query_text_sync in a threadpool for async execution.
    """
    try:
        # Run blocking GenAI call in threadpool to avoid blocking event loop
        return await run_in_threadpool(_embed_query_text_sync, content)
    except RuntimeError:
        # Re-raise RuntimeError as-is
        raise
    except Exception as exc:
        settings = get_settings()
        model_name = settings.EMBEDDING_MODEL
        error_msg = (
            f"Query embedding failed using model '{model_name}': {exc}"
        )
        raise RuntimeError(error_msg) from exc


@router.post("/search", response_model=SearchResponse)
async def search(
    request: SearchRequest,
    http_request: Request,
    current_user: Dict = Depends(verify_clerk_token)
) -> SearchResponse:
    """Search tenant-scoped vectors using a natural language query.
    
    SECURITY: Tenant membership is enforced after parsing the request body.
    """
    # Verify tenant membership (tenant_id comes from request body)
    user_id = current_user.get("id", "unknown")
    await check_tenant_membership(user_id, request.tenant_id, http_request)
    
    try:
        query_vector = await _embed_query_text(request.query_text)
    except RuntimeError as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Embedding generation failed: {exc}"
        ) from exc
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Unexpected error during embedding: {exc}"
        ) from exc

    settings = get_settings()

    results = await vector_service.search_silo(
        collection_name=settings.QDRANT_COLLECTION_TIER_2,
        query_vector=query_vector,
        tenant_id=request.tenant_id,
    )

    return SearchResponse(results=results)





==================================================
FILE: fastapi-backend/app/services/graph.py
==================================================
import uuid
from datetime import datetime
from typing import Any, Dict, List, Optional

from neo4j import AsyncGraphDatabase

from app.core.config import get_settings


class GraphService:
    """Service responsible for Neo4j graph database operations.

    Provides graph query capabilities to understand relationships
    between clients, campaigns, assets, and staff.
    """

    def __init__(self, driver: Optional[Any] = None) -> None:
        settings = get_settings()

        self._driver = driver or AsyncGraphDatabase.driver(
            settings.NEO4J_URI,
            auth=(settings.NEO4J_USER, settings.NEO4J_PASSWORD),
        )

    @property
    def driver(self) -> Any:
        """Return the Neo4j driver instance."""
        return self._driver

    async def close(self) -> None:
        """Close the Neo4j driver connection."""
        if self._driver:
            await self._driver.close()

    async def get_client_structure(self, client_id: str) -> Dict[str, Any]:
        """Retrieve the structure of a client including campaigns and assets.

        This allows Riley to "look up" exactly what campaigns belong to a client ID,
        solving the semantic mapping problem.

        Args:
            client_id: The unique identifier for the client.

        Returns:
            Dictionary containing:
                - ClientName: Name of the client
                - Campaigns: List of campaign names
                - AssetCount: Total number of assets across all campaigns

        Raises:
            Exception: If the query fails or client is not found.
        """
        cypher_query = """
        MATCH (c:Client {id: $client_id})-[:RUNS_CAMPAIGN]->(cmp:Campaign)
        OPTIONAL MATCH (cmp)-[:HAS_ASSET]->(a:Asset)
        RETURN c.name as ClientName, collect(cmp.name) as Campaigns, count(a) as AssetCount
        """

        async with self._driver.session() as session:
            result = await session.run(cypher_query, client_id=client_id)
            record = await result.single()

            if not record:
                return {
                    "ClientName": None,
                    "Campaigns": [],
                    "AssetCount": 0,
                }

            return {
                "ClientName": record["ClientName"],
                "Campaigns": record["Campaigns"] or [],
                "AssetCount": record["AssetCount"] or 0,
            }

    async def save_message(
        self, session_id: str, role: str, content: str, tenant_id: str, user_id: str
    ) -> None:
        """Save a chat message to Neo4j.
        
        Creates or merges a ChatSession node with tenant and user scoping, and links a Message node to it.
        Schema: (Session:ChatSession {id: "...", tenant_id: "...", user_id: "..."}) <-[:BELONGS_TO]- (Message:Message {role: "...", content: "...", timestamp: "..."})
        
        SECURITY: The MERGE includes tenant_id and user_id to prevent cross-tenant/user memory mixing.
        
        Args:
            session_id: Unique identifier for the chat session
            role: Message role ("user" or "model")
            content: Message content text
            tenant_id: Tenant/client identifier for scope isolation
            user_id: User identifier for scope isolation
        """
        async with self._driver.session() as session:
            query = """
            MERGE (s:ChatSession {
                id: $session_id,
                tenant_id: $tenant_id,
                user_id: $user_id
            })
            ON CREATE SET s.created_at = datetime()
            CREATE (m:Message {
                role: $role,
                content: $content,
                timestamp: datetime()
            })
            CREATE (m)-[:BELONGS_TO]->(s)
            """
            
            await session.run(
                query,
                session_id=session_id,
                tenant_id=tenant_id,
                user_id=user_id,
                role=role,
                content=content,
            )

    async def get_chat_history(
        self, session_id: str, tenant_id: str, user_id: str, limit: int = 10
    ) -> List[Dict[str, str]]:
        """Retrieve chat history for a session.
        
        Gets the last N messages ordered by timestamp DESC, then reverses
        to return in chronological order (oldest -> newest).
        
        SECURITY: MATCH includes tenant_id and user_id to prevent cross-scope memory access.
        Never returns messages across different tenants or users.
        
        Args:
            session_id: Unique identifier for the chat session
            tenant_id: Tenant/client identifier for scope isolation
            user_id: User identifier for scope isolation
            limit: Maximum number of messages to retrieve (default: 10)
            
        Returns:
            List of message dicts with 'role' and 'content' keys, ordered chronologically
        """
        async with self._driver.session() as session:
            query = """
            MATCH (m:Message)-[:BELONGS_TO]->(s:ChatSession {
                id: $session_id,
                tenant_id: $tenant_id,
                user_id: $user_id
            })
            RETURN m.role as role, m.content as content, toString(m.timestamp) as timestamp
            ORDER BY m.timestamp DESC
            LIMIT $limit
            """
            
            result = await session.run(
                query,
                session_id=session_id,
                tenant_id=tenant_id,
                user_id=user_id,
                limit=limit
            )
            
            messages = []
            async for record in result:
                messages.append({
                    "role": record["role"],
                    "content": record["content"],
                })
            
            # Reverse to get chronological order (oldest -> newest)
            messages.reverse()
            return messages

    async def search_campaigns_fuzzy(self, query: str) -> str:
        """Search campaigns in the graph using fuzzy matching on name and description.
        
        Removes common stop words and searches for campaigns that contain the query terms.
        This is the "Golden Set" - structured campaign data from the graph.
        
        Args:
            query: The search query string
            
        Returns:
            Formatted string summary of matching campaigns, or empty string if none found
        """
        # Remove common stop words
        stop_words = {"have", "we", "done", "the", "a", "an", "and", "or", "but", "in", "on", "at", "to", "for", "of", "with", "by", "is", "are", "was", "were", "be", "been", "being"}
        query_terms = [word.lower() for word in query.split() if word.lower() not in stop_words and len(word) > 2]
        
        if not query_terms:
            return ""
        
        # Use the first meaningful term for search
        search_term = query_terms[0]
        
        try:
            async with self._driver.session() as session:
                cypher_query = """
                MATCH (c:Campaign)
                WHERE toLower(c.name) CONTAINS $term OR toLower(c.description) CONTAINS $term
                RETURN c.name as name, c.description as description
                LIMIT 3
                """
                
                result = await session.run(cypher_query, term=search_term)
                
                campaigns = []
                async for record in result:
                    name = record.get("name", "Unknown Campaign")
                    description = record.get("description", "No description")
                    campaigns.append(f"Campaign: '{name}' ({description})")
                
                if campaigns:
                    return "Graph found: " + " | ".join(campaigns)
                return ""
        except Exception as e:
            # Log error but return empty string to not break the flow
            print(f"Error searching campaigns in graph: {e}")
            return ""

    async def clear_chat_history(self, session_id: str, tenant_id: str, user_id: str) -> None:
        """Clear all messages for a chat session.
        
        Deletes the ChatSession node and all associated Message nodes using DETACH DELETE.
        This removes the session and all its relationships (links to messages).
        If the session doesn't exist, the query will simply match nothing (no error).
        
        SECURITY: MATCH includes tenant_id and user_id to prevent cross-scope deletion.
        Only deletes sessions that match all three criteria.
        
        Args:
            session_id: Unique identifier for the chat session to clear
            tenant_id: Tenant/client identifier for scope isolation
            user_id: User identifier for scope isolation
            
        Raises:
            Exception: If the deletion fails (wrapped in try/except by caller)
        """
        try:
            async with self._driver.session() as session:
                # Delete session and all its messages
                # DETACH DELETE removes the node and all its relationships
                # SECURITY: Only delete if all three match (prevents cross-scope deletion)
                query = """
                MATCH (s:ChatSession {
                    id: $session_id,
                    tenant_id: $tenant_id,
                    user_id: $user_id
                })-[r:BELONGS_TO]-(m:Message)
                DETACH DELETE s, m
                """
                
                result = await session.run(
                    query,
                    session_id=session_id,
                    tenant_id=tenant_id,
                    user_id=user_id
                )
                await result.consume()  # Ensure query executes
        except Exception as e:
            # Log error but don't crash - let the router handle it
            print(f"Error clearing chat history for session {session_id}: {e}")
            raise

    async def update_session_title(
        self, session_id: str, tenant_id: str, user_id: str, title: str
    ) -> str:
        """Update the title of a chat session.
        
        SECURITY: MATCH includes tenant_id and user_id to prevent cross-scope updates.
        Only updates sessions that match all three criteria.
        
        Args:
            session_id: Unique identifier for the chat session
            tenant_id: Tenant/client identifier for scope isolation
            user_id: User identifier for scope isolation
            title: New title for the session
            
        Returns:
            The updated title string
            
        Raises:
            ValueError: If the session is not found (doesn't match all three criteria)
            Exception: If the update fails
        """
        async with self._driver.session() as session:
            query = """
            MATCH (s:ChatSession {
                id: $id,
                tenant_id: $tenant_id,
                user_id: $user_id
            })
            SET s.title = $title
            RETURN s.title as title
            """
            
            result = await session.run(
                query,
                id=session_id,
                tenant_id=tenant_id,
                user_id=user_id,
                title=title
            )
            record = await result.single()
            
            if not record:
                raise ValueError(
                    f"Session {session_id} not found for tenant {tenant_id} and user {user_id}"
                )
            
            return record["title"]

    async def create_campaign(
        self, name: str, description: Optional[str], user_id: str
    ) -> Dict[str, Any]:
        """Create a new campaign and add the creator as Lead member.
        
        Generates a server-side UUID for the campaign_id and creates:
        - User node (if not exists)
        - Campaign node with metadata
        - MEMBER_OF relationship with role="Lead"
        
        Args:
            name: Campaign name
            description: Optional campaign description
            user_id: ID of the user creating the campaign
            
        Returns:
            Dictionary with campaign details: {id, name, description, role: "Lead"}
        """
        campaign_id = str(uuid.uuid4())
        
        async with self._driver.session() as session:
            query = """
            MERGE (u:User {id: $user_id})
            CREATE (c:Campaign {
                id: $campaign_id,
                name: $name,
                description: $description,
                created_at: datetime()
            })
            CREATE (u)-[:MEMBER_OF {
                role: "Lead",
                added_at: datetime()
            }]->(c)
            RETURN c.id as id, c.name as name, c.description as description
            """
            
            result = await session.run(
                query,
                user_id=user_id,
                campaign_id=campaign_id,
                name=name,
                description=description
            )
            record = await result.single()
            
            if not record:
                raise Exception("Failed to create campaign")
            
            return {
                "id": record["id"],
                "name": record["name"],
                "description": record.get("description"),
                "role": "Lead"
            }

    async def get_user_campaigns(self, user_id: str) -> List[Dict[str, Any]]:
        """Get all campaigns that a user is a member of.
        
        Args:
            user_id: ID of the user
            
        Returns:
            List of campaign dictionaries: [{id, name, description, role}, ...]
        """
        async with self._driver.session() as session:
            query = """
            MATCH (u:User {id: $user_id})-[r:MEMBER_OF]->(c:Campaign)
            RETURN c.id as id, c.name as name, c.description as description, r.role as role
            ORDER BY c.created_at DESC
            """
            
            result = await session.run(query, user_id=user_id)
            
            campaigns = []
            async for record in result:
                campaigns.append({
                    "id": record["id"],
                    "name": record["name"],
                    "description": record.get("description"),
                    "role": record["role"]
                })
            
            return campaigns

    async def check_membership(self, user_id: str, tenant_id: str) -> bool:
        """Check if a user is a member of a campaign (tenant).
        
        Special case: "global" tenant_id always returns True (launch behavior).
        
        Args:
            user_id: ID of the user
            tenant_id: Campaign/tenant ID to check membership for
            
        Returns:
            True if user is a member, False otherwise
        """
        # Special case: "global" tenant always allows access
        if tenant_id == "global":
            return True
        
        async with self._driver.session() as session:
            query = """
            MATCH (u:User {id: $user_id})-[:MEMBER_OF]->(c:Campaign {id: $tenant_id})
            RETURN count(u) > 0 as is_member
            """
            
            result = await session.run(query, user_id=user_id, tenant_id=tenant_id)
            record = await result.single()
            
            return record["is_member"] if record else False

    async def add_member(
        self,
        tenant_id: str,
        target_user_id: str,
        role: str,
        actor_user_id: str
    ) -> Dict[str, Any]:
        """Add a user as a member to a campaign.
        
        Note: Role enforcement (e.g., only Lead can add members) should be
        implemented at the router/endpoint level.
        
        Args:
            tenant_id: Campaign ID to add member to
            target_user_id: ID of the user to add
            role: Role to assign (e.g., "Member", "Lead")
            actor_user_id: ID of the user performing the action (for audit)
            
        Returns:
            Dictionary with membership details: {tenant_id, user_id, role}
            
        Raises:
            ValueError: If campaign doesn't exist
        """
        async with self._driver.session() as session:
            # First verify campaign exists
            check_query = """
            MATCH (c:Campaign {id: $tenant_id})
            RETURN c.id as id
            """
            check_result = await session.run(check_query, tenant_id=tenant_id)
            if not await check_result.single():
                raise ValueError(f"Campaign {tenant_id} not found")
            
            # Add member
            query = """
            MERGE (u:User {id: $target_user_id})
            MATCH (c:Campaign {id: $tenant_id})
            MERGE (u)-[r:MEMBER_OF]->(c)
            SET r.role = $role, r.added_at = datetime()
            RETURN c.id as tenant_id, u.id as user_id, r.role as role
            """
            
            result = await session.run(
                query,
                tenant_id=tenant_id,
                target_user_id=target_user_id,
                role=role
            )
            record = await result.single()
            
            if not record:
                raise Exception("Failed to add member")
            
            return {
                "tenant_id": record["tenant_id"],
                "user_id": record["user_id"],
                "role": record["role"]
            }

    async def post_team_message(
        self, campaign_id: str, user: Dict[str, Any], content: str
    ) -> Dict[str, Any]:
        """Post a team message to a campaign.
        
        Validates content (non-empty, max 2000 chars) and creates:
        - User node (if not exists)
        - TeamMessage node with content and timestamp
        - Relationships: (User)-[:SENT]->(Message)-[:POSTED_IN]->(Campaign)
        
        Args:
            campaign_id: Campaign ID to post message to
            user: User dictionary with "id" key (from auth)
            content: Message content (validated)
            
        Returns:
            Dictionary with message details: {id, content, timestamp (ISO string), author_id}
            
        Raises:
            ValueError: If content is empty or exceeds max length
        """
        # Validate content
        content = content.strip()
        if not content:
            raise ValueError("Message content cannot be empty")
        if len(content) > 2000:
            raise ValueError("Message content cannot exceed 2000 characters")
        
        user_id = user.get("id")
        if not user_id:
            raise ValueError("User ID is required")
        
        message_id = str(uuid.uuid4())
        
        async with self._driver.session() as session:
            query = """
            MATCH (c:Campaign {id: $campaign_id})
            MERGE (u:User {id: $user_id})
            CREATE (m:TeamMessage {
                id: $message_id,
                content: $content,
                timestamp: datetime()
            })
            CREATE (u)-[:SENT]->(m)-[:POSTED_IN]->(c)
            RETURN m.id as id, m.content as content, toString(m.timestamp) as timestamp, u.id as author_id
            """
            
            result = await session.run(
                query,
                campaign_id=campaign_id,
                user_id=user_id,
                message_id=message_id,
                content=content
            )
            record = await result.single()
            
            if not record:
                raise Exception("Failed to create team message")
            
            return {
                "id": record["id"],
                "content": record["content"],
                "timestamp": record["timestamp"],
                "author_id": record["author_id"]
            }

    async def get_team_messages(
        self, campaign_id: str, limit: int = 50, since: Optional[str] = None
    ) -> List[Dict[str, Any]]:
        """Get team messages for a campaign.
        
        Returns messages ordered by timestamp (newest first), then reversed
        to return in chronological order (oldest -> newest).
        
        Args:
            campaign_id: Campaign ID to get messages for
            limit: Maximum number of messages to return (default: 50)
            since: Optional ISO timestamp string - only return messages after this time
            
        Returns:
            List of message dictionaries: [{id, content, timestamp (ISO string), author_id}, ...]
            Ordered chronologically (oldest -> newest)
        """
        async with self._driver.session() as session:
            if since:
                # Parse ISO timestamp and use it in query
                # Neo4j datetime() can parse ISO 8601 strings directly
                query = """
                MATCH (c:Campaign {id: $campaign_id})<-[:POSTED_IN]-(m:TeamMessage)<-[:SENT]-(u:User)
                WHERE m.timestamp > datetime($since)
                RETURN m.id as id, m.content as content, toString(m.timestamp) as timestamp, 
                       u.id as author_id
                ORDER BY m.timestamp DESC
                LIMIT $limit
                """
                result = await session.run(
                    query,
                    campaign_id=campaign_id,
                    since=since,  # ISO 8601 string, e.g., "2024-01-01T12:00:00Z"
                    limit=limit
                )
            else:
                query = """
                MATCH (c:Campaign {id: $campaign_id})<-[:POSTED_IN]-(m:TeamMessage)<-[:SENT]-(u:User)
                RETURN m.id as id, m.content as content, toString(m.timestamp) as timestamp, 
                       u.id as author_id
                ORDER BY m.timestamp DESC
                LIMIT $limit
                """
                result = await session.run(
                    query,
                    campaign_id=campaign_id,
                    limit=limit
                )
            
            messages = []
            async for record in result:
                messages.append({
                    "id": record["id"],
                    "content": record["content"],
                    "timestamp": record["timestamp"],
                    "author_id": record.get("author_id", "unknown")
                })
            
            # Reverse to get chronological order (oldest -> newest)
            messages.reverse()
            return messages

    async def get_member_role(self, user_id: str, campaign_id: str) -> Optional[str]:
        """Get the role of a user in a campaign.
        
        Args:
            user_id: ID of the user
            campaign_id: ID of the campaign
            
        Returns:
            Role string ("Lead" or "Member") if user is a member, None otherwise
        """
        async with self._driver.session() as session:
            query = """
            MATCH (u:User {id: $user_id})-[r:MEMBER_OF]->(c:Campaign {id: $campaign_id})
            RETURN r.role as role
            """
            
            result = await session.run(query, user_id=user_id, campaign_id=campaign_id)
            record = await result.single()
            
            return record["role"] if record else None

    async def list_campaign_members(self, campaign_id: str) -> List[Dict[str, Any]]:
        """List all members of a campaign.
        
        Args:
            campaign_id: ID of the campaign
            
        Returns:
            List of member dictionaries: [{id, email, role}, ...]
        """
        async with self._driver.session() as session:
            query = """
            MATCH (u:User)-[r:MEMBER_OF]->(c:Campaign {id: $campaign_id})
            RETURN u.id as id, u.email as email, r.role as role
            ORDER BY r.role DESC, u.email ASC
            """
            
            result = await session.run(query, campaign_id=campaign_id)
            
            members = []
            async for record in result:
                members.append({
                    "id": record["id"],
                    "email": record.get("email", ""),
                    "role": record["role"]
                })
            
            return members

    async def add_campaign_member(
        self, campaign_id: str, target_user_id: str, target_email: str, role: str
    ) -> None:
        """Add a user as a member to a campaign.
        
        Creates or updates the User node and creates/updates the MEMBER_OF relationship.
        
        Args:
            campaign_id: ID of the campaign
            target_user_id: ID of the user to add
            target_email: Email of the user to add
            role: Role to assign ("Lead" or "Member")
            
        Raises:
            ValueError: If campaign doesn't exist
        """
        async with self._driver.session() as session:
            # First verify campaign exists
            check_query = """
            MATCH (c:Campaign {id: $campaign_id})
            RETURN c.id as id
            """
            check_result = await session.run(check_query, campaign_id=campaign_id)
            if not await check_result.single():
                raise ValueError(f"Campaign {campaign_id} not found")
            
            # Add or update member
            query = """
            MERGE (u:User {id: $target_user_id})
            SET u.email = $target_email
            MATCH (c:Campaign {id: $campaign_id})
            MERGE (u)-[r:MEMBER_OF]->(c)
            SET r.role = $role, r.added_at = datetime()
            """
            
            await session.run(
                query,
                campaign_id=campaign_id,
                target_user_id=target_user_id,
                target_email=target_email,
                role=role
            )

    async def remove_campaign_member(self, campaign_id: str, target_user_id: str) -> None:
        """Remove a user from a campaign.
        
        Deletes the MEMBER_OF relationship between the user and campaign.
        
        Args:
            campaign_id: ID of the campaign
            target_user_id: ID of the user to remove
            
        Raises:
            ValueError: If the membership relationship doesn't exist
        """
        async with self._driver.session() as session:
            query = """
            MATCH (u:User {id: $target_user_id})-[r:MEMBER_OF]->(c:Campaign {id: $campaign_id})
            DELETE r
            RETURN count(r) as deleted_count
            """
            
            result = await session.run(query, campaign_id=campaign_id, target_user_id=target_user_id)
            record = await result.single()
            
            if not record or record["deleted_count"] == 0:
                raise ValueError(f"User {target_user_id} is not a member of campaign {campaign_id}")


# Global service instance that can be imported by routers.
# Note: This will be initialized in main.py startup event.
graph_service: Optional[GraphService] = None



==================================================
FILE: fastapi-backend/app/services/storage.py
==================================================
"""Google Cloud Storage service for file uploads and management."""

import os
from typing import List, Optional
from urllib.parse import urlparse

from fastapi import HTTPException, UploadFile
from google.cloud import storage
from google.cloud.exceptions import GoogleCloudError

from app.core.config import get_settings


class StorageService:
    """Service for managing file uploads to Google Cloud Storage."""

    _client: Optional[storage.Client] = None

    @classmethod
    def _get_client(cls) -> storage.Client:
        """Get or create GCS client instance."""
        if cls._client is None:
            settings = get_settings()
            
            # Initialize client with credentials if provided
            if settings.GOOGLE_APPLICATION_CREDENTIALS:
                # Set environment variable for google-cloud-storage to use
                os.environ["GOOGLE_APPLICATION_CREDENTIALS"] = settings.GOOGLE_APPLICATION_CREDENTIALS
                cls._client = storage.Client()
            else:
                # Try to use default credentials (e.g., in GCP environment)
                try:
                    cls._client = storage.Client()
                except Exception as exc:
                    raise RuntimeError(
                        "GCS credentials not configured. Set GOOGLE_APPLICATION_CREDENTIALS "
                        "or ensure default credentials are available."
                    ) from exc
        
        return cls._client

    @classmethod
    async def upload_file(cls, file: UploadFile, filename: str) -> str:
        """Upload a file to GCS and return the public URL.
        
        Args:
            file: The uploaded file object
            filename: The filename to use in GCS (should be unique)
            
        Returns:
            Public URL to access the file (e.g., https://storage.googleapis.com/...)
            
        Raises:
            HTTPException: If upload fails
        """
        settings = get_settings()
        client = cls._get_client()
        bucket = client.bucket(settings.GCS_BUCKET_NAME)
        
        try:
            # Create blob
            blob = bucket.blob(filename)
            
            # Reset file pointer to beginning to ensure we read it all, 
            # in case it was read previously for text extraction.
            await file.seek(0)
            
            # Read file content
            file_content = await file.read()
            
            # Upload to GCS
            blob.upload_from_string(
                file_content,
                content_type=file.content_type or "application/octet-stream"
            )
            
            # REMOVED: blob.make_public() 
            # Reason: Buckets with 'Uniform Bucket-Level Access' do not allow per-file ACLs.
            # Access must be granted via the Google Cloud Console (IAM -> Grant 'allUsers' role 'Storage Object Viewer').
            
            # Return public URL
            return blob.public_url
            
        except GoogleCloudError as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Failed to upload file to GCS: {exc}"
            ) from exc
        except Exception as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Unexpected error during file upload: {exc}"
            ) from exc

    @classmethod
    async def upload_bytes(
        cls,
        object_name: str,
        data: bytes,
        content_type: str = "application/octet-stream",
    ) -> str:
        """Upload raw bytes to GCS and return the public URL."""
        settings = get_settings()
        client = cls._get_client()
        bucket = client.bucket(settings.GCS_BUCKET_NAME)

        try:
            blob = bucket.blob(object_name)
            blob.upload_from_string(data, content_type=content_type)
            return blob.public_url
        except GoogleCloudError as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Failed to upload bytes to GCS: {exc}",
            ) from exc
        except Exception as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Unexpected error during bytes upload: {exc}",
            ) from exc

    @classmethod
    async def generate_signed_url(cls, object_name: str, ttl_seconds: int) -> str:
        """Generate a signed URL for a GCS object."""
        from datetime import timedelta

        settings = get_settings()
        client = cls._get_client()
        bucket = client.bucket(settings.GCS_BUCKET_NAME)
        blob = bucket.blob(object_name)

        try:
            url = blob.generate_signed_url(expiration=timedelta(seconds=ttl_seconds))
            return url
        except GoogleCloudError as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Failed to generate signed URL for GCS object: {exc}",
            ) from exc
        except Exception as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Unexpected error during signed URL generation: {exc}",
            ) from exc

    @classmethod
    async def download_file(cls, file_url: str) -> bytes:
        """Download a file from GCS and return its content as bytes.
        
        Args:
            file_url: The public URL of the file in GCS
            
        Returns:
            File content as bytes
            
        Raises:
            HTTPException: If download fails
        """
        settings = get_settings()
        client = cls._get_client()
        
        try:
            # Parse the GCS URL to extract bucket and blob name
            # Format: https://storage.googleapis.com/bucket-name/blob-name
            # or: gs://bucket-name/blob-name
            from urllib.parse import urlparse
            
            parsed = urlparse(file_url)
            
            if parsed.scheme == "gs":
                # gs://bucket/path format
                bucket_name = parsed.netloc
                blob_name = parsed.path.lstrip("/")
            else:
                # https://storage.googleapis.com/bucket/path format
                # Extract bucket name from hostname or path
                if "storage.googleapis.com" in parsed.netloc:
                    # Path format: /bucket-name/blob-path
                    path_parts = parsed.path.lstrip("/").split("/", 1)
                    bucket_name = path_parts[0]
                    blob_name = path_parts[1] if len(path_parts) > 1 else ""
                else:
                    raise ValueError(f"Unsupported URL format: {file_url}")
            
            bucket = client.bucket(bucket_name)
            blob = bucket.blob(blob_name)
            
            # Download blob content
            file_content = blob.download_as_bytes()
            
            return file_content
            
        except GoogleCloudError as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Failed to download file from GCS: {exc}"
            ) from exc
        except Exception as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Unexpected error during file download: {exc}"
            ) from exc

    @classmethod
    async def delete_file(cls, file_url: str) -> None:
        """Delete a file from GCS by parsing the URL.
        
        Args:
            file_url: The public URL of the file to delete
            (e.g., https://storage.googleapis.com/bucket-name/filename.pdf)
            
        Raises:
            HTTPException: If deletion fails or file not found
        """
        settings = get_settings()
        client = cls._get_client()
        bucket = client.bucket(settings.GCS_BUCKET_NAME)
        
        try:
            # Parse filename from URL
            # URL format: https://storage.googleapis.com/bucket-name/filename.pdf
            parsed_url = urlparse(file_url)
            # Extract filename from path (remove leading slash)
            filename = parsed_url.path.lstrip("/")
            
            # Remove bucket name prefix if present in path
            if filename.startswith(settings.GCS_BUCKET_NAME + "/"):
                filename = filename[len(settings.GCS_BUCKET_NAME) + 1:]
            
            # Get blob and delete
            blob = bucket.blob(filename)
            
            if not blob.exists():
                raise HTTPException(
                    status_code=404,
                    detail=f"File not found in GCS: {filename}"
                )
            
            blob.delete()
            
        except HTTPException:
            raise
        except GoogleCloudError as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Failed to delete file from GCS: {exc}"
            ) from exc
        except Exception as exc:
            raise HTTPException(
                status_code=500,
                detail=f"Unexpected error during file deletion: {exc}"
            ) from exc

    @classmethod
    async def delete_batch(cls, file_urls: List[str]) -> None:
        """Delete multiple files from GCS in batch.
        
        Args:
            file_urls: List of public URLs of files to delete
            
        Raises:
            HTTPException: If any deletion fails (but continues with others)
        """
        errors: List[str] = []
        
        for file_url in file_urls:
            try:
                await cls.delete_file(file_url)
            except HTTPException as exc:
                # Collect errors but continue with other files
                errors.append(f"Failed to delete {file_url}: {exc.detail}")
            except Exception as exc:
                errors.append(f"Unexpected error deleting {file_url}: {str(exc)}")
        
        # If any errors occurred, raise an exception with all errors
        if errors:
            raise HTTPException(
                status_code=500,
                detail=f"Some files failed to delete: {'; '.join(errors)}"
            )

==================================================
FILE: fastapi-backend/app/services/ocr.py
==================================================
"""OCR service for extracting text from image files.

This module provides OCR functionality with caching and gating to ensure
OCR only runs when explicitly requested and results are cached in Qdrant.
"""
import io
import logging
from typing import Dict, Optional

from fastapi.concurrency import run_in_threadpool

logger = logging.getLogger(__name__)


def is_image_ext(filename: str) -> bool:
    """Check if a filename has an image extension.
    
    Args:
        filename: The filename to check
        
    Returns:
        True if the file is an image type (png, jpg, jpeg, webp, tiff)
    """
    if not filename:
        return False
    
    ext = filename.split(".")[-1].lower() if "." in filename else ""
    return ext in ("png", "jpg", "jpeg", "webp", "tiff")


def _compute_confidence_from_data(data: Dict) -> Optional[float]:
    """Compute average confidence from pytesseract image_to_data output.
    
    Args:
        data: Dictionary from pytesseract.image_to_data with output_type=dict
        
    Returns:
        Average confidence (0-100 scale, converted to 0-1), or None if unavailable
    """
    try:
        confidences = []
        if "conf" in data:
            for conf in data["conf"]:
                # pytesseract uses -1 for invalid confidence
                if isinstance(conf, (int, float)) and conf >= 0:
                    confidences.append(conf)
        
        if confidences:
            # pytesseract returns confidence as 0-100, convert to 0-1
            avg_conf = sum(confidences) / len(confidences) / 100.0
            return avg_conf
    except Exception as e:
        logger.warning(f"Failed to compute OCR confidence: {e}")
    
    return None


async def run_ocr(image_bytes: bytes, max_chars: int = 8000) -> Dict[str, Optional[str | float]]:
    """Run OCR on an image file and return extracted text with metadata.
    
    Args:
        image_bytes: The image file content as bytes
        max_chars: Maximum number of characters to extract (default: 8000)
        
    Returns:
        Dictionary with keys:
            - text: Extracted text (truncated to max_chars)
            - confidence: Average confidence score (0-1) or None
            - language: Detected language code or None
            
    Raises:
        ImportError: If required libraries are not installed
        Exception: If OCR processing fails
    """
    try:
        import pytesseract
        from PIL import Image
    except ImportError as e:
        missing = "pytesseract" if "pytesseract" in str(e) else "Pillow"
        logger.error(f"{missing} is not installed. Install with: pip install {missing.lower()}")
        raise ImportError(f"{missing} is required for OCR") from e
    
    def _perform_ocr():
        """Perform OCR synchronously."""
        # Open image from bytes
        image_file = io.BytesIO(image_bytes)
        image = Image.open(image_file)
        
        # Try to get confidence data (best-effort)
        confidence = None
        language = None
        
        try:
            # Attempt to get detailed data for confidence calculation
            # Use pytesseract.Output.DICT to get confidence scores
            try:
                data = pytesseract.image_to_data(image, output_type=pytesseract.Output.DICT)
                confidence = _compute_confidence_from_data(data)
            except Exception as e:
                logger.warning(f"Could not compute OCR confidence: {e}")
                confidence = None
            
            # Try to detect language (best-effort)
            # Default to "en" for now - could be enhanced with language detection
            language = "en"
        except Exception as e:
            logger.warning(f"Could not compute OCR metadata: {e}")
            confidence = None
            language = None
        
        # Extract text
        text = pytesseract.image_to_string(image)
        
        # Clean up text: strip and collapse whitespace
        lines = [line.strip() for line in text.splitlines()]
        lines = [line for line in lines if line]  # Remove empty lines
        text = "\n".join(lines)
        
        # Truncate to max_chars
        if len(text) > max_chars:
            text = text[:max_chars]
            logger.info(f"OCR text truncated to {max_chars} characters")
        
        return {
            "text": text,
            "confidence": confidence,
            "language": language,
        }
    
    # Run blocking OCR in threadpool
    return await run_in_threadpool(_perform_ocr)


==================================================
FILE: fastapi-backend/app/services/clerk_directory.py
==================================================
"""Clerk Directory Service for user resolution.

This module provides functionality to look up users in Clerk by email
using the Clerk Backend API.
"""

from typing import Dict, Optional

import requests
from fastapi import HTTPException, status

from app.core.config import get_settings


def find_user_by_email(email: str) -> Optional[Dict[str, str]]:
    """Find a user in Clerk by email address.
    
    Uses the Clerk Backend API to search for users by email.
    Returns minimal user information: id, email, first_name, last_name.
    
    Args:
        email: Email address to search for
        
    Returns:
        Dictionary with user information: {id, email, first_name, last_name}
        Returns None if user is not found
        
    Raises:
        HTTPException: If Clerk API request fails
    """
    settings = get_settings()
    secret_key = getattr(settings, "CLERK_SECRET_KEY", None)
    
    if not secret_key:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail="Clerk secret key not configured. Set CLERK_SECRET_KEY environment variable."
        )
    
    # Clerk Backend API endpoint for listing users
    api_url = "https://api.clerk.com/v1/users"
    
    headers = {
        "Authorization": f"Bearer {secret_key}",
        "Content-Type": "application/json"
    }
    
    # Search for users - Clerk API supports query parameter for email search
    # We'll use the query parameter if available, otherwise search through results
    params = {
        "query": email
    }
    
    try:
        response = requests.get(api_url, headers=headers, params=params, timeout=10)
        response.raise_for_status()
        
        data = response.json()
        users = data.get("data", [])
        
        # Find exact email match (case-insensitive)
        email_lower = email.lower()
        for user in users:
            email_addresses = user.get("email_addresses", [])
            for email_addr in email_addresses:
                user_email = email_addr.get("email_address", "").lower()
                if user_email == email_lower:
                    # Extract user information
                    return {
                        "id": user.get("id", ""),
                        "email": email_addr.get("email_address", ""),
                        "first_name": user.get("first_name", ""),
                        "last_name": user.get("last_name", "")
                    }
        
        # No exact match found
        return None
        
    except requests.exceptions.RequestException as exc:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail=f"Failed to query Clerk API: {exc}"
        ) from exc
    except Exception as exc:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Unexpected error querying Clerk: {exc}"
        ) from exc


==================================================
FILE: fastapi-backend/app/services/genai_client.py
==================================================
"""Shared Google Gemini client for embedding generation.

This module provides a lazy-initialized singleton client instance for all embedding operations
across the backend. Uses the new google-genai SDK (not the deprecated google.generativeai).

The client is initialized on first use, not at import time, to prevent Cloud Run boot loops
if GOOGLE_API_KEY is missing or there are transient API issues.
"""

from google import genai
from app.core.config import get_settings

# Lazy singleton pattern - client initialized on first use
_client = None


def get_genai_client():
    """Get or create the shared Google GenAI client instance.
    
    Uses lazy initialization to prevent import-time failures. The client is created
    on first use and cached for subsequent calls.
    
    Returns:
        genai.Client: The shared client instance
        
    Raises:
        RuntimeError: If GOOGLE_API_KEY is missing or invalid
    """
    global _client
    
    if _client is None:
        settings = get_settings()
        if not settings.GOOGLE_API_KEY:
            raise RuntimeError(
                "GOOGLE_API_KEY is missing. Set the GOOGLE_API_KEY environment variable."
            )
        
        try:
            _client = genai.Client(api_key=settings.GOOGLE_API_KEY)
        except Exception as exc:
            raise RuntimeError(
                f"Failed to initialize Google GenAI client: {exc}"
            ) from exc
    
    return _client


==================================================
FILE: fastapi-backend/app/services/preview.py
==================================================
"""Document preview generation service.

Generates read-only PDF previews for Office/HTML documents using LibreOffice.
"""

import asyncio
import os
import tempfile
from pathlib import Path
from typing import Final

from fastapi import HTTPException

from app.core.config import get_settings


OFFICE_EXTENSIONS: Final[set[str]] = {
    "doc",
    "docx",
    "xls",
    "xlsx",
    "ppt",
    "pptx",
    "html",
    "htm",
}


def is_office_or_html(filename: str) -> bool:
    """Return True if the filename looks like an Office or HTML document."""
    ext = Path(filename).suffix.lower().lstrip(".")
    return ext in OFFICE_EXTENSIONS


async def generate_pdf_preview(file_bytes: bytes, filename: str) -> bytes:
    """Generate a PDF preview for an Office/HTML document using LibreOffice.

    Workflow:
    - Write the incoming bytes to a temp file with the correct extension.
    - Run `soffice --headless --convert-to pdf --outdir /tmp <input>`.
    - Read the resulting PDF bytes.
    - Clean up temp files.

    Raises HTTPException(500) on failure with a clear message.
    """
    settings = get_settings()

    # Enforce preview size limit separately from upload size
    max_preview_bytes = int(getattr(settings, "PREVIEW_MAX_MB", 25)) * 1024 * 1024
    if len(file_bytes) > max_preview_bytes:
        raise HTTPException(
            status_code=500,
            detail=f"Preview generation skipped: file exceeds preview limit ({settings.PREVIEW_MAX_MB}MB).",
        )

    ext = Path(filename).suffix or ""
    if not ext:
        # Default to .docx if extension missing but still requested
        ext = ".docx"

    # Use a dedicated temp directory so we can clean up easily
    with tempfile.TemporaryDirectory(prefix="riley_preview_") as tmpdir:
        input_path = Path(tmpdir) / f"source{ext}"
        output_path = Path(tmpdir) / "source.pdf"

        # Write input bytes
        input_path.write_bytes(file_bytes)

        # Build LibreOffice command
        cmd = [
            "soffice",
            "--headless",
            "--nologo",
            "--nofirststartwizard",
            "--convert-to",
            "pdf",
            "--outdir",
            str(tmpdir),
            str(input_path),
        ]

        try:
            # Run with a hard timeout to avoid hanging
            proc = await asyncio.create_subprocess_exec(
                *cmd,
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE,
            )

            try:
                stdout, stderr = await asyncio.wait_for(proc.communicate(), timeout=30.0)
            except asyncio.TimeoutError:
                proc.kill()
                raise HTTPException(
                    status_code=500,
                    detail="Preview generation timed out while converting to PDF.",
                )

            if proc.returncode != 0:
                raise HTTPException(
                    status_code=500,
                    detail=(
                        "Preview generation failed via LibreOffice. "
                        f"Return code: {proc.returncode}. Stderr: {stderr.decode('utf-8', errors='ignore')[:500]}"
                    ),
                )

            if not output_path.exists():
                raise HTTPException(
                    status_code=500,
                    detail="Preview generation failed: output PDF not found.",
                )

            pdf_bytes = output_path.read_bytes()
            if not pdf_bytes:
                raise HTTPException(
                    status_code=500,
                    detail="Preview generation produced an empty PDF.",
                )

            return pdf_bytes

        except HTTPException:
            raise
        except FileNotFoundError:
            # soffice not installed or not in PATH
            raise HTTPException(
                status_code=500,
                detail=(
                    "Preview generation is not available: LibreOffice (soffice) is not installed. "
                    "Install it with 'apt-get update && apt-get install -y libreoffice'."
                ),
            )
        except Exception as exc:  # pragma: no cover - OS/LibreOffice edge cases
            raise HTTPException(
                status_code=500,
                detail=f"Unexpected error during preview generation: {exc}",
            )


==================================================
FILE: fastapi-backend/app/services/qdrant.py
==================================================
from datetime import datetime
from typing import Any, Dict, List, Sequence

from qdrant_client import AsyncQdrantClient
from qdrant_client.http import models
from qdrant_client.http.models import Filter, FieldCondition, MatchValue, PointStruct

from app.core.config import get_settings


class VectorService:
    """Service responsible for all Qdrant vector operations.

    All access is strictly tenant-scoped via Qdrant filters to preserve
    data sovereignty between clients.
    """

    def __init__(self, client: AsyncQdrantClient | None = None) -> None:
        settings = get_settings()

        if client:
            self._client = client
        elif settings.QDRANT_URL:
            # Qdrant Cloud mode: use URL and API key
            self._client = AsyncQdrantClient(
                url=settings.QDRANT_URL,
                api_key=settings.QDRANT_API_KEY,
            )
        else:
            # Local dev mode: use host and port
            self._client = AsyncQdrantClient(
                host=settings.QDRANT_HOST,
                port=settings.QDRANT_PORT,
            )

    @property
    def client(self) -> AsyncQdrantClient:
        return self._client

    async def ensure_collections(self) -> None:
        """Ensure Tier 1 and Tier 2 collections exist with the configured vector size.

        This does NOT delete or recreate collections. It only creates missing collections.
        Use `scripts/reset_qdrant_collections.py` for one-time destructive reset.
        """
        settings = get_settings()
        await self._ensure_collection(settings.QDRANT_COLLECTION_TIER_1)
        await self._ensure_collection(settings.QDRANT_COLLECTION_TIER_2)

    async def _ensure_collection(self, collection_name: str) -> None:
        """Create a collection if it doesn't exist, using the configured vector params."""
        settings = get_settings()

        # Map string setting to Qdrant Distance enum (default Cosine).
        distance_str = (settings.QDRANT_DISTANCE or "Cosine").strip().lower()
        distance = models.Distance.COSINE
        if distance_str == "dot":
            distance = models.Distance.DOT
        elif distance_str == "euclid":
            distance = models.Distance.EUCLID

        try:
            await self._client.get_collection(collection_name=collection_name)
            return  # exists
        except Exception:
            # If get_collection fails (not found / connection), attempt create. Any real errors
            # will still bubble up from create_collection.
            pass

        await self._client.create_collection(
            collection_name=collection_name,
            vectors_config=models.VectorParams(
                size=settings.EMBEDDING_DIM,
                distance=distance,
            ),
        )

    async def search_silo(
        self,
        collection_name: str,
        query_vector: Sequence[float],
        tenant_id: str,
        limit: int = 10,
        require_ai_enabled: bool = False,
    ) -> List[Any]:
        """Search tenant-scoped collection with strict isolation.
        
        SECURITY: This method MUST enforce tenant isolation. If tenant_id is missing
        or empty, a ValueError is raised to prevent cross-tenant data leaks.
        
        Args:
            collection_name: Name of the Qdrant collection to search
            query_vector: The query embedding vector
            tenant_id: Tenant/client ID to filter by (required)
            limit: Maximum number of results to return
            require_ai_enabled: If True, only return files where ai_enabled == true
        
        Returns:
            List of search results (points) as dictionaries
        """
        # Enforce tenant isolation - raise error if tenant_id is missing
        if not tenant_id or not tenant_id.strip():
            raise ValueError(
                "tenant_id is required for search_silo. Cannot perform unfiltered search."
            )
        
        # Construct tenant filter for strict isolation
        filter_conditions = [
                FieldCondition(
                    key="client_id",
                    match=MatchValue(value=tenant_id),
                )
            ]
        
        # Add ai_enabled filter if required
        if require_ai_enabled:
            filter_conditions.append(
                FieldCondition(
                    key="ai_enabled",
                    match=MatchValue(value=True),
                )
            )
        
        tenant_filter = Filter(must=filter_conditions)

        search_result = await self._client.search(
            collection_name=collection_name,
            query_vector=query_vector,
            query_filter=tenant_filter,  # SECURITY: Always use tenant filter
            limit=limit,
            with_payload=True,  # Ensure payload (including filename) is returned
        )

        return [point.dict() for point in search_result]

    async def search_global(
        self,
        collection_name: str,
        query_vector: Sequence[float],
        limit: int = 5,
        filter: Filter | None = None,
    ) -> List[Any]:
        """Search a collection with an explicit filter (required for security).

        This method is used for searching global firm knowledge collections.
        
        SECURITY: This method NEVER allows unfiltered searches. A filter must be provided
        to prevent accidental data leaks. For global searches, use is_global=True filter.
        
        Args:
            collection_name: Name of the Qdrant collection to search
            query_vector: The query embedding vector
            limit: Maximum number of results to return
            filter: REQUIRED Filter object to apply (e.g., is_global=True for Tier 1)
        
        Returns:
            List of search results (points) as dictionaries
        
        Raises:
            ValueError: If filter is None (unfiltered searches are not allowed)
        """
        # SECURITY: Never allow unfiltered searches
        if filter is None:
            raise ValueError(
                "search_global requires an explicit filter. Unfiltered searches are not allowed. "
                "For global files, use Filter with is_global=True condition."
            )
        
        search_result = await self._client.search(
            collection_name=collection_name,
            query_vector=query_vector,
            query_filter=filter,  # SECURITY: Always use explicit filter
            limit=limit,
            with_payload=True,  # Ensure payload (including filename) is returned
        )

        return [point.dict() for point in search_result]

    async def list_tenant_files(
        self,
        collection_name: str,
        tenant_id: str,
        limit: int = 20,
    ) -> List[Dict[str, Any]]:
        """List all files for a specific tenant from the collection.

        Uses Qdrant's scroll API with a filter to retrieve all points
        matching the tenant_id, then extracts file metadata.

        Special handling: If tenant_id == "global", filters by is_global=True
        instead of client_id to retrieve files from the global archive.

        Args:
            collection_name: Name of the Qdrant collection to query.
            tenant_id: The tenant/client ID to filter by, or "global" for global archive.
            limit: Maximum number of files to return (default: 20).

        Returns:
            List of dictionaries containing:
                - id: Point ID
                - filename: File name from payload
                - type: File type/extension from payload
                - year: Year from payload (if available)
        """
        # Special handling for global archive
        if tenant_id == "global":
            # Filter by is_global flag (do NOT filter by client_id)
            tenant_filter = Filter(
                must=[
                    FieldCondition(
                        key="is_global",
                        match=MatchValue(value=True),
                    )
                ]
            )
        else:
            # Standard tenant-scoped filter
            tenant_filter = Filter(
                must=[
                    FieldCondition(
                        key="client_id",
                        match=MatchValue(value=tenant_id),
                    )
                ]
            )

        # Use scroll to get all matching points
        scroll_result = await self._client.scroll(
            collection_name=collection_name,
            scroll_filter=tenant_filter,
            limit=limit,
            with_payload=True,
        )

        files = []
        for point in scroll_result[0]:  # scroll_result is a tuple: (points, next_page_offset)
            payload = point.payload or {}
            filename = payload.get("filename") or payload.get("name", "Unknown")
            file_type = payload.get("type") or payload.get("file_type", "")
            year = payload.get("year")

            files.append({
                "id": str(point.id),
                "filename": filename,
                "type": file_type,
                "year": year,
                "ai_enabled": payload.get("ai_enabled"),
                "ocr_enabled": payload.get("ocr_enabled"),
                "ocr_status": payload.get("ocr_status"),
                "ocr_confidence": payload.get("ocr_confidence"),
                "ocr_extracted_at": payload.get("ocr_extracted_at"),
                "preview_url": payload.get("preview_url"),
                "preview_type": payload.get("preview_type"),
                "preview_status": payload.get("preview_status"),
            })

        return files

    async def list_global_files(
        self,
        collection_name: str,
        limit: int = 1000,
    ) -> List[Dict[str, Any]]:
        """List all global files from the collection (Tier 1 - Global Firm Archive).
        
        Returns files that have been promoted to the global archive (have is_golden
        or promoted_at fields, or are in the global collection without client_id).

        Args:
            collection_name: Name of the Qdrant collection to query (should be Tier 1).
            limit: Maximum number of files to return (default: 1000).

        Returns:
            List of dictionaries containing:
                - id: Point ID
                - filename: File name from payload
                - type: File type/extension from payload
                - url: File URL
                - is_golden: Whether marked as golden standard
                - promoted_at: Promotion timestamp
                - client_id: Original campaign ID (if preserved)
        """
        # Filter for files marked as global (is_global=True)
        # This ensures we only get files that were explicitly promoted
        global_filter = Filter(
            must=[
                FieldCondition(
                    key="is_global",
                    match=MatchValue(value=True),
                )
            ]
        )

        # Use scroll to get all matching points
        scroll_result = await self._client.scroll(
            collection_name=collection_name,
            scroll_filter=global_filter,
            limit=limit,
            with_payload=True,
            with_vectors=False,  # Don't need vectors for listing
        )

        files = []
        for point in scroll_result[0]:  # scroll_result is a tuple: (points, next_page_offset)
            payload = point.payload or {}
            filename = payload.get("filename") or payload.get("name", "Unknown")
            file_type = payload.get("type") or payload.get("file_type", "")
            
            files.append({
                "id": str(point.id),
                "filename": filename,
                "type": file_type,
                "url": payload.get("url", ""),
                "is_golden": payload.get("is_golden", False),
                "promoted_at": payload.get("promoted_at"),
                "client_id": payload.get("client_id"),  # Original campaign ID
                "ai_enabled": payload.get("ai_enabled"),
                "ocr_enabled": payload.get("ocr_enabled"),
                "ocr_status": payload.get("ocr_status"),
                "ocr_confidence": payload.get("ocr_confidence"),
                "ocr_extracted_at": payload.get("ocr_extracted_at"),
                "preview_url": payload.get("preview_url"),
                "preview_type": payload.get("preview_type"),
                "preview_status": payload.get("preview_status"),
            })

        return files

    async def promote_to_global(self, file_id: str, is_golden: bool) -> None:
        """Promote a file from Tier 2 (Private Client Silo) to Tier 1 (Global Firm Archive).
        
        This copies a high-value document from the private client collection to the global
        collection, allowing "Global Riley" to learn from it without violating tenant security.
        
        Args:
            file_id: The UUID of the file point in Tier 2 collection.
            is_golden: Whether to mark this as a "Golden Standard" (high priority learning).
        
        Raises:
            ValueError: If the file is not found in Tier 2.
        """
        settings = get_settings()
        
        # Step 1: Fetch the point from Tier 2
        points = await self._client.retrieve(
            collection_name=settings.QDRANT_COLLECTION_TIER_2,
            ids=[file_id],
            with_payload=True,
            with_vectors=True,
        )
        
        if not points:
            raise ValueError(f"File {file_id} not found in Tier 2 collection")
        
        point = points[0]
        original_payload = point.payload or {}
        
        # Step 2: Prepare the new payload for Tier 1
        # Copy existing payload and modify for global archive
        new_payload = original_payload.copy()
        
        # Add/Update golden standard flag
        new_payload["is_golden"] = is_golden
        
        # Add promotion timestamp
        new_payload["promoted_at"] = datetime.now().isoformat()
        
        # Mark as global file (CRITICAL for retrieval)
        new_payload["is_global"] = True
        
        # Remove tenant-specific fields or set to "global"
        # Remove client_id to ensure it's truly global (or set to "global" if needed for tracking)
        if "client_id" in new_payload:
            # Option 1: Remove it completely (truly global)
            del new_payload["client_id"]
            # Option 2: Set to "global" for tracking (uncomment if preferred)
            # new_payload["client_id"] = "global"
        
        # Step 3: Upsert into Tier 1 with the same file_id (for tracking)
        global_point = PointStruct(
            id=file_id,  # Use same ID for tracking
            vector=point.vector,  # Use the same vector
            payload=new_payload
        )
        
        await self._client.upsert(
            collection_name=settings.QDRANT_COLLECTION_TIER_1,
            points=[global_point]
        )

    async def delete_tenant_data(self, tenant_id: str) -> List[str]:
        """Delete all data for a tenant from Qdrant and return list of file URLs.
        
        This is used for campaign termination - permanently removes all vectors
        associated with a tenant from Tier 2 collection.
        
        Args:
            tenant_id: The tenant/client ID to delete data for.
            
        Returns:
            List of file URLs from the deleted points' payloads.
            
        Raises:
            ValueError: If tenant_id is "global" (protected) or empty.
        """
        # Security: Prevent deleting global tenant
        if tenant_id == "global" or not tenant_id or not tenant_id.strip():
            raise ValueError(f"Cannot delete data for tenant_id '{tenant_id}'. Protected tenant.")
        
        settings = get_settings()
        
        # Create filter for tenant_id
        tenant_filter = Filter(
            must=[
                FieldCondition(
                    key="client_id",
                    match=MatchValue(value=tenant_id),
                )
            ]
        )
        
        # Collect all file URLs before deletion
        file_urls: List[str] = []
        offset = None
        
        # Scroll through all points for this tenant
        while True:
            scroll_result = await self._client.scroll(
                collection_name=settings.QDRANT_COLLECTION_TIER_2,
                scroll_filter=tenant_filter,
                limit=100,  # Process in batches
                offset=offset,
                with_payload=True,
                with_vectors=False,
            )
            
            points = scroll_result[0]
            if not points:
                break
            
            # Extract file URLs from payloads
            for point in points:
                payload = point.payload or {}
                url = payload.get("url")
                if url:
                    file_urls.append(url)
            
            # Get next offset
            offset = scroll_result[1]
            if offset is None:
                break
        
        # Delete all points for this tenant
        if file_urls:
            # Get all point IDs to delete
            point_ids: List[str] = []
            offset = None
            
            while True:
                scroll_result = await self._client.scroll(
                    collection_name=settings.QDRANT_COLLECTION_TIER_2,
                    scroll_filter=tenant_filter,
                    limit=100,
                    offset=offset,
                    with_payload=False,
                    with_vectors=False,
                )
                
                points = scroll_result[0]
                if not points:
                    break
                
                point_ids.extend([str(point.id) for point in points])
                
                offset = scroll_result[1]
                if offset is None:
                    break
            
            # Delete all points
            if point_ids:
                await self._client.delete(
                    collection_name=settings.QDRANT_COLLECTION_TIER_2,
                    points_selector=models.PointIdsList(
                        points=point_ids
                    )
                )
        
        return file_urls


# Global service instance that can be imported by routers.
vector_service = VectorService()





==================================================
FILE: fastapi-backend/app/services/ingestion.py
==================================================
import io
import logging
import uuid
from datetime import datetime
from typing import List, Optional

from fastapi import UploadFile, HTTPException
from fastapi.concurrency import run_in_threadpool
from qdrant_client.http.models import PointStruct

from app.core.config import get_settings
from app.services.genai_client import get_genai_client
from app.services.ocr import is_image_ext
from app.services.preview import is_office_or_html, generate_pdf_preview
from app.services.qdrant import vector_service
from app.services.storage import StorageService

# Configure logging
logger = logging.getLogger(__name__)

# Constants for text extraction limits
MAX_CHARS_TOTAL = 20_000
CONTENT_PREVIEW_LENGTH = 1_000
XLSX_MAX_SHEETS = 3
XLSX_MAX_ROWS = 100
XLSX_MAX_COLS = 25
PPTX_MAX_SLIDES = 50


def _format_file_size(size_bytes: int) -> str:
    """Format file size in bytes to human-readable string.
    
    Args:
        size_bytes: File size in bytes
        
    Returns:
        Formatted string like "5.2 MB" or "1.5 KB"
    """
    if size_bytes < 1024:
        return f"{size_bytes} B"
    elif size_bytes < 1024 * 1024:
        return f"{size_bytes / 1024:.1f} KB"
    else:
        return f"{size_bytes / (1024 * 1024):.1f} MB"




async def extract_text(
    file_bytes: bytes, filename: str
) -> str:
    """Router function to extract text from various file types.
    
    Note: OCR is NOT performed during extraction. OCR must be explicitly
    requested via the dedicated POST /files/{file_id}/ocr endpoint.
    
    Args:
        file_bytes: File content as bytes
        filename: Original filename (used to determine file type)
        
    Returns:
        Extracted text string, truncated to MAX_CHARS_TOTAL
        Returns "[Binary file â€” no text extracted]" on failure
    """
    # Normalize file extension
    file_ext = filename.split(".")[-1].lower() if "." in filename else ""
    
    try:
        if file_ext == "pdf":
            return await _extract_text_from_pdf(file_bytes)
        elif file_ext == "docx":
            return await _extract_text_from_docx(file_bytes)
        elif file_ext == "doc":
            return await _extract_text_from_doc(file_bytes)
        elif file_ext == "pptx":
            return await _extract_text_from_pptx(file_bytes)
        elif file_ext == "xlsx":
            return await _extract_text_from_xlsx(file_bytes)
        elif file_ext in ("html", "htm"):
            return await _extract_text_from_html(file_bytes)
        elif file_ext in ("png", "jpg", "jpeg", "webp", "tiff"):
            # OCR is never performed during extraction - must use dedicated endpoint
            return await _extract_text_from_image(file_bytes, enable_ocr=False)
        else:
            return f"File: {filename}"
    except Exception as exc:
        logger.warning(f"Text extraction failed for {filename}: {type(exc).__name__}: {exc}")
        return "[Binary file â€” no text extracted]"


async def _extract_text_from_pdf(file_content: bytes) -> str:
    """Extract text from a PDF file using pypdf from file content in memory."""
    try:
        from pypdf import PdfReader
        
        def _read_pdf():
            pdf_file = io.BytesIO(file_content)
            reader = PdfReader(pdf_file)
            text = ""
            for page in reader.pages:
                text += page.extract_text() + "\n"
            # Cap at MAX_CHARS_TOTAL
            if len(text) > MAX_CHARS_TOTAL:
                text = text[:MAX_CHARS_TOTAL]
            return text
        
        # Run blocking I/O in threadpool
        return await run_in_threadpool(_read_pdf)
    except ImportError:
        logger.error("pypdf is not installed. Install with: pip install pypdf")
        return "[PDF extraction unavailable â€” pypdf not installed]"
    except Exception as exc:
        logger.warning(f"PDF extraction failed: {exc}")
        return "[Binary file â€” no text extracted]"


async def _extract_text_from_docx(file_content: bytes) -> str:
    """Extract text from a DOCX file using python-docx from file content in memory.
    
    Args:
        file_content: The DOCX file content as bytes
        
    Returns:
        Extracted text, capped at 20,000 characters
        
    Raises:
        HTTPException: If extraction fails or library is not installed
    """
    try:
        from docx import Document
        
        def _read_docx():
            docx_file = io.BytesIO(file_content)
            doc = Document(docx_file)
            text_parts = []
            
            # Extract text from all paragraphs
            for paragraph in doc.paragraphs:
                if paragraph.text.strip():
                    text_parts.append(paragraph.text.strip())
            
            # Join paragraphs with newlines
            text = "\n".join(text_parts)
            
            # Cap at MAX_CHARS_TOTAL
            if len(text) > MAX_CHARS_TOTAL:
                text = text[:MAX_CHARS_TOTAL]
            
            return text
        
        # Run blocking I/O in threadpool
        return await run_in_threadpool(_read_docx)
    except ImportError:
        logger.error("python-docx is not installed. Install with: pip install python-docx")
        return "[DOCX extraction unavailable â€” python-docx not installed]"
    except Exception as exc:
        logger.warning(f"DOCX extraction failed: {exc}")
        return "[Binary file â€” no text extracted]"


async def _extract_text_from_xlsx(file_content: bytes) -> str:
    """Extract text from an XLSX file using openpyxl from file content in memory.
    
    Processes up to 3 sheets, 100 rows per sheet, and 25 columns per row.
    Values are joined as CSV-style text.
    
    Args:
        file_content: The XLSX file content as bytes
        
    Returns:
        Extracted text, capped at 20,000 characters
        
    Raises:
        HTTPException: If extraction fails or library is not installed
    """
    try:
        from openpyxl import load_workbook
        
        def _read_xlsx():
            xlsx_file = io.BytesIO(file_content)
            workbook = load_workbook(xlsx_file, data_only=True)
            text_parts = []
            
            # Process up to XLSX_MAX_SHEETS sheets
            sheet_count = 0
            for sheet_name in workbook.sheetnames:
                if sheet_count >= XLSX_MAX_SHEETS:
                    break
                
                sheet = workbook[sheet_name]
                sheet_text_parts = []
                
                # Process up to XLSX_MAX_ROWS rows
                for row_idx, row in enumerate(sheet.iter_rows(values_only=True)):
                    if row_idx >= XLSX_MAX_ROWS:
                        break
                    
                    # Process up to XLSX_MAX_COLS columns per row
                    row_values = []
                    for col_idx, cell_value in enumerate(row):
                        if col_idx >= XLSX_MAX_COLS:
                            break
                        
                        # Convert cell value to string, handling None
                        if cell_value is not None:
                            row_values.append(str(cell_value))
                        else:
                            row_values.append("")
                    
                    # Join row values as CSV-style (comma-separated)
                    if any(row_values):  # Only add non-empty rows
                        sheet_text_parts.append(",".join(row_values))
                
                # Add sheet content with sheet name header
                if sheet_text_parts:
                    text_parts.append(f"Sheet: {sheet_name}")
                    text_parts.extend(sheet_text_parts)
                
                sheet_count += 1
            
            # Join all text parts with newlines
            text = "\n".join(text_parts)
            
            # Cap at MAX_CHARS_TOTAL
            if len(text) > MAX_CHARS_TOTAL:
                text = text[:MAX_CHARS_TOTAL]
            
            return text
        
        # Run blocking I/O in threadpool
        return await run_in_threadpool(_read_xlsx)
    except ImportError:
        logger.error("openpyxl is not installed. Install with: pip install openpyxl")
        return "[XLSX extraction unavailable â€” openpyxl not installed]"
    except Exception as exc:
        logger.warning(f"XLSX extraction failed: {exc}")
        return "[Binary file â€” no text extracted]"


async def _extract_text_from_doc(file_content: bytes) -> str:
    """Extract text from a DOC file using textract (legacy binary format).
    
    Args:
        file_content: The DOC file content as bytes
        
    Returns:
        Extracted text, capped at MAX_CHARS_TOTAL
    """
    try:
        import textract
        
        def _read_doc():
            doc_file = io.BytesIO(file_content)
            # textract can work with BytesIO
            text = textract.process(doc_file, extension='doc', encoding='utf-8')
            if isinstance(text, bytes):
                text = text.decode('utf-8', errors='ignore')
            # Cap at MAX_CHARS_TOTAL
            if len(text) > MAX_CHARS_TOTAL:
                text = text[:MAX_CHARS_TOTAL]
            return text
        
        # Run blocking I/O in threadpool
        return await run_in_threadpool(_read_doc)
    except ImportError:
        logger.error("textract is not installed. Install with: pip install textract")
        return "[DOC extraction unavailable â€” textract not installed]"
    except Exception as exc:
        logger.warning(f"DOC extraction failed: {exc}")
        return "[Binary file â€” no text extracted]"


async def _extract_text_from_pptx(file_content: bytes) -> str:
    """Extract text from a PPTX file using python-pptx.
    
    Processes up to PPTX_MAX_SLIDES slides, extracting text from shapes.
    
    Args:
        file_content: The PPTX file content as bytes
        
    Returns:
        Extracted text, capped at MAX_CHARS_TOTAL
    """
    try:
        from pptx import Presentation
        
        def _read_pptx():
            pptx_file = io.BytesIO(file_content)
            prs = Presentation(pptx_file)
            text_parts = []
            
            # Process up to PPTX_MAX_SLIDES slides
            for slide_idx, slide in enumerate(prs.slides):
                if slide_idx >= PPTX_MAX_SLIDES:
                    break
                
                slide_text_parts = []
                
                # Extract text from all shapes in the slide
                for shape in slide.shapes:
                    if hasattr(shape, "text") and shape.text:
                        slide_text_parts.append(shape.text.strip())
                
                # Add slide content with slide number header
                if slide_text_parts:
                    text_parts.append(f"Slide {slide_idx + 1}:")
                    text_parts.extend(slide_text_parts)
            
            # Join all text parts with newlines
            text = "\n".join(text_parts)
            
            # Cap at MAX_CHARS_TOTAL
            if len(text) > MAX_CHARS_TOTAL:
                text = text[:MAX_CHARS_TOTAL]
            
            return text
        
        # Run blocking I/O in threadpool
        return await run_in_threadpool(_read_pptx)
    except ImportError:
        logger.error("python-pptx is not installed. Install with: pip install python-pptx")
        return "[PPTX extraction unavailable â€” python-pptx not installed]"
    except Exception as exc:
        logger.warning(f"PPTX extraction failed: {exc}")
        return "[Binary file â€” no text extracted]"


async def _extract_text_from_html(file_content: bytes) -> str:
    """Extract text from an HTML file using BeautifulSoup.
    
    Strips scripts, styles, and other non-content elements.
    
    Args:
        file_content: The HTML file content as bytes
        
    Returns:
        Extracted text, capped at MAX_CHARS_TOTAL
    """
    try:
        from bs4 import BeautifulSoup
        
        def _read_html():
            html_file = io.BytesIO(file_content)
            soup = BeautifulSoup(html_file, 'html.parser')
            
            # Remove script and style elements
            for script in soup(["script", "style"]):
                script.decompose()
            
            # Get text and clean up whitespace
            text = soup.get_text()
            # Clean up multiple newlines and spaces
            lines = [line.strip() for line in text.splitlines()]
            lines = [line for line in lines if line]  # Remove empty lines
            text = "\n".join(lines)
            
            # Cap at MAX_CHARS_TOTAL
            if len(text) > MAX_CHARS_TOTAL:
                text = text[:MAX_CHARS_TOTAL]
            
            return text
        
        # Run blocking I/O in threadpool
        return await run_in_threadpool(_read_html)
    except ImportError:
        logger.error("beautifulsoup4 is not installed. Install with: pip install beautifulsoup4")
        return "[HTML extraction unavailable â€” beautifulsoup4 not installed]"
    except Exception as exc:
        logger.warning(f"HTML extraction failed: {exc}")
        return "[Binary file â€” no text extracted]"


async def _extract_text_from_image(file_content: bytes, enable_ocr: bool = False) -> str:
    """Extract text from an image file using OCR (if enabled).
    
    NOTE: This function is deprecated in favor of the OCR service.
    For images, we now return placeholder text and handle OCR separately.
    
    Args:
        file_content: The image file content as bytes
        enable_ocr: If True, perform OCR using pytesseract (deprecated)
        
    Returns:
        Placeholder text - OCR is handled separately via OCR endpoint
    """
    # Images should not have OCR run during upload
    # OCR is handled via dedicated endpoint
    return "[Image file â€” OCR not requested]"


async def _generate_embedding(text: str) -> List[float]:
    """Generate an embedding vector for the given text using Google Gemini.
    
    This function is used for:
    - Initial file upload embeddings
    - OCR re-embedding after OCR completes (in files.py OCR endpoint)
    
    Uses the new google-genai SDK via the shared client.
    """
    settings = get_settings()
    model_name = settings.EMBEDDING_MODEL
    
    def _embed_sync(truncated_text: str) -> List[float]:
        """Synchronous embedding function to run in threadpool."""
        try:
            # Get client (lazy initialization)
            client = get_genai_client()
            # Use the shared client to generate embedding
            response = client.models.embed_content(
                model=model_name,
                contents=truncated_text
            )
            
            # Extract embedding vector from response
            if not response.embeddings or len(response.embeddings) == 0:
                raise RuntimeError(
                    f"Embedding response did not contain any embeddings for model '{model_name}'."
                )
            
            embedding = response.embeddings[0].values
            if not isinstance(embedding, list):
                raise RuntimeError(
                    f"Embedding response did not contain a valid vector for model '{model_name}'."
                )
            
            return embedding
        except RuntimeError:
            # Re-raise RuntimeError as-is
            raise
        except Exception as exc:
            error_msg = (
                f"Embedding failed using model '{model_name}': {exc}"
            )
            logger.error(error_msg)
            raise RuntimeError(error_msg) from exc
    
    try:
        # Truncate text to 9000 characters to avoid token limits
        truncated_text = text[:9000]
        
        # Run blocking GenAI call in threadpool to avoid blocking event loop
        return await run_in_threadpool(_embed_sync, truncated_text)
    except RuntimeError:
        # Re-raise RuntimeError as-is
        raise
    except Exception as exc:
        error_msg = (
            f"Embedding failed using model '{model_name}': {exc}"
        )
        logger.error(error_msg)
        raise HTTPException(
            status_code=500,
            detail=error_msg
        ) from exc


async def process_upload(
    file: UploadFile,
    tenant_id: str,
    tags: List[str],
    overwrite: bool = False
) -> dict:
    """
    Process an uploaded file: upload to GCS, extract text, vectorize, and index in Qdrant.
    
    STANDARDIZED CONTENT STORAGE (SINGLE SOURCE OF TRUTH):
    - payload["content"]: FULL extracted text (capped at MAX_CHARS_TOTAL=20,000) for RAG
    - payload["content_preview"]: First 1000 chars for UI display
    - For images: content = "[Image file â€” OCR not requested]" (placeholder)
    
    This ensures RAG has access to full text, not just 1000 chars.
    
    Args:
        file: The uploaded file
        tenant_id: Tenant/client identifier for data isolation
        tags: List of tags associated with the file
        overwrite: If True, replace existing file with same name. If False, raise 409 on conflict.
        Note: OCR is NOT performed during upload. OCR must be explicitly
        requested via the dedicated POST /files/{file_id}/ocr endpoint.
        
    Returns:
        Dictionary containing:
            - id: The UUID of the indexed document
            - url: The public GCS URL to access the file
            - filename: The original filename
            - type: The file type/extension
    """
    settings = get_settings()
    
    # Generate unique filename
    if file.filename:
        # Use original filename but make it unique with UUID prefix to avoid collisions
        file_extension = "." + file.filename.split(".")[-1] if "." in file.filename else ""
        base_name = file.filename.rsplit(".", 1)[0] if "." in file.filename else file.filename
        unique_filename = f"{uuid.uuid4()}_{base_name}{file_extension}"
    else:
        # Generate unique filename if no filename provided
        file_extension = ""
        unique_filename = f"{uuid.uuid4()}{file_extension}"
    
    try:
        # Read file content into memory for text extraction
        file_content = await file.read()
        
        # Calculate file size and upload date before upload
        file_size = len(file_content)
        size_str = _format_file_size(file_size)
        upload_date = datetime.now().isoformat()
        
        # Extract text using the router function
        file_type = file.filename.split(".")[-1].lower() if file.filename else "unknown"
        filename = file.filename or "unknown"
        is_image = is_image_ext(filename)
        
        # Extract text (OCR is never performed during upload - must use dedicated endpoint)
        text = await extract_text(file_content, filename)
        
        # Ensure text doesn't exceed MAX_CHARS_TOTAL (safety check)
        if len(text) > MAX_CHARS_TOTAL:
            text = text[:MAX_CHARS_TOTAL]
        
        # Rewind file stream before uploading to GCS
        await file.seek(0)
        
        # Upload original to GCS
        file_url = await StorageService.upload_file(file, unique_filename)

        # Optional: generate and upload PDF preview for Office/HTML documents
        preview_url: Optional[str] = None
        preview_type: Optional[str] = None
        preview_status: str = "not_requested"
        preview_error: Optional[str] = None

        if settings.ENABLE_PREVIEW_GENERATION and is_office_or_html(filename):
            preview_status = "queued"
            try:
                pdf_bytes = await generate_pdf_preview(file_content, filename)

                # Use point_id-based name so previews are stable per document
                preview_object_name = f"{settings.PREVIEW_BUCKET_PATH_PREFIX}/{point_id}.pdf"

                # Upload preview PDF
                preview_public_url = await StorageService.upload_bytes(
                    preview_object_name,
                    pdf_bytes,
                    content_type="application/pdf",
                )

                # Optionally sign the preview URL
                if settings.SIGN_PREVIEW_URLS:
                    preview_url = await StorageService.generate_signed_url(
                        preview_object_name,
                        settings.PREVIEW_URL_TTL_SECONDS,
                    )
                else:
                    preview_url = preview_public_url

                preview_type = "pdf"
                preview_status = "complete"
                preview_error = None
            except HTTPException as exc:
                # Controlled failure - record status and let upload succeed
                preview_status = "failed"
                preview_error = exc.detail if isinstance(exc.detail, str) else str(exc.detail)
            except Exception as exc:
                preview_status = "failed"
                preview_error = str(exc)
        
        # Generate embedding
        if text.strip():
            vector = await _generate_embedding(text)
        else:
            # If no text extracted, generate a minimal embedding from filename
            # This ensures we can still index the file even without extractable text
            fallback_text = f"File: {file.filename or 'unknown'}"
            vector = await _generate_embedding(fallback_text)
        
        # Prepare Qdrant payload
        point_id = str(uuid.uuid4())
        
        # Determine ai_enabled based on file type
        # Default: pdf, docx, doc, pptx, xlsx, html -> ai_enabled = true
        # Images -> ai_enabled = false by default (conservative, requires explicit OCR)
        # All other file types -> ai_enabled = false
        # Special case: .doc files that fail extraction get ai_enabled = false
        ai_enabled_file_types = {"pdf", "docx", "doc", "pptx", "xlsx", "html", "htm"}
        image_types = {"png", "jpg", "jpeg", "webp", "tiff"}
        
        # Check if .doc extraction failed (returns fallback string)
        doc_extraction_failed = (
            file_type == "doc" and 
            (text.startswith("[DOC extraction unavailable") or 
             text.startswith("[Binary file â€” no text extracted]"))
        )
        
        if doc_extraction_failed:
            ai_enabled = False
            logger.warning(
                f"DOC extraction failed for {filename}; "
                f"ai_enabled set to False. Recommend converting to .docx format."
            )
        elif file_type in ai_enabled_file_types:
            ai_enabled = True
        elif file_type in image_types:
            ai_enabled = False  # Images default to false, require explicit OCR + ai_enabled toggle
        else:
            ai_enabled = False
        
        # Initialize OCR fields for images (or any file type for consistency)
        ocr_enabled = False
        ocr_status = "not_requested"
        ocr_text: Optional[str] = None
        ocr_confidence: Optional[float] = None
        ocr_language: Optional[str] = None
        ocr_error: Optional[str] = None
        ocr_extracted_at: Optional[str] = None
        
        # For images, set OCR fields even if not requested
        if is_image:
            ocr_status = "not_requested"
        
        # Prepare content fields:
        # - content: full extracted text (capped at MAX_CHARS_TOTAL) for RAG
        # - content_preview: first 1000 chars for UI display
        content_full = text  # Already capped at MAX_CHARS_TOTAL
        content_preview = text[:CONTENT_PREVIEW_LENGTH]
        
        # For images, keep placeholder in content
        if is_image:
            content_full = "[Image file â€” OCR not requested]"
            content_preview = content_full
        
        # Determine collection and payload flags based on tenant_id
        # Global uploads (tenant_id == "global") -> Tier 1 with is_global=True
        # Campaign uploads (tenant_id != "global") -> Tier 2 with client_id=tenant_id, is_global=False
        is_global_upload = tenant_id == "global"
        
        if is_global_upload:
            # Global archive: Tier 1, is_global=True, no client_id
            target_collection = settings.QDRANT_COLLECTION_TIER_1
            is_global_flag = True
            client_id_value = None  # Don't set client_id for global files
        else:
            # Campaign upload: Tier 2, is_global=False, client_id=tenant_id
            target_collection = settings.QDRANT_COLLECTION_TIER_2
            is_global_flag = False
            client_id_value = tenant_id
        
        payload = {
            "filename": file.filename or "unknown",
            "file_type": file_type,  # Normalized extension
            "type": file_type,  # Keep for backward compatibility
            "url": file_url,  # GCS public URL
            "is_global": is_global_flag,  # Critical flag for collection routing
            "tags": tags,
            "content": content_full,  # FULL TEXT for RAG (capped at MAX_CHARS_TOTAL)
            "content_preview": content_preview,  # Preview for UI (first 1000 chars)
            "size": size_str,  # Human-readable file size (e.g., "5.2 MB")
            "size_bytes": file_size,  # Raw size in bytes for sorting/filtering
            "upload_date": upload_date,  # ISO format timestamp
            "uploaded_at": upload_date,  # Alias for consistency
            "ai_enabled": ai_enabled,  # AI Memory toggle
            # Preview fields (read-only PDF previews for Office/HTML)
            "preview_url": preview_url,
            "preview_type": preview_type,
            "preview_status": preview_status,
            "preview_error": preview_error,
            # OCR fields (always included for consistency, especially for images)
            "ocr_enabled": ocr_enabled,
            "ocr_status": ocr_status,
            "ocr_text": ocr_text,
            "ocr_confidence": ocr_confidence,
            "ocr_language": ocr_language,
            "ocr_error": ocr_error,
            "ocr_extracted_at": ocr_extracted_at,
        }
        
        # Only set client_id for campaign uploads (not global)
        if client_id_value is not None:
            payload["client_id"] = client_id_value
        
        # Create Qdrant point
        point = PointStruct(
            id=point_id,
            vector=vector,
            payload=payload
        )
        
        # Upsert into Qdrant with collection routing based on tenant_id
        await vector_service.client.upsert(
            collection_name=target_collection,
            points=[point]
        )
        
        # Log collection routing for debugging
        logger.info(
            f"UPSERT collection={target_collection} tenant_id={tenant_id} id={point_id} "
            f"is_global={is_global_flag}"
        )
        
        return {
            "id": point_id,
            "url": file_url,
            "filename": file.filename or "unknown",
            "type": file_type,
        }
        
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to process upload: {exc}"
        ) from exc


async def delete_file(file_id: str, collection_name: str) -> None:
    """
    Permanently delete a file from GCS and Qdrant.
    
    Args:
        file_id: The Qdrant point ID (UUID) of the file to delete
        collection_name: Name of the Qdrant collection
        
    Raises:
        HTTPException: If file not found or deletion fails
    """
    # Retrieve the point to get file metadata
    try:
        points = await vector_service.client.retrieve(
            collection_name=collection_name,
            ids=[file_id],
            with_payload=True,
            with_vectors=False
        )
        
        if not points:
            raise HTTPException(
                status_code=404,
                detail=f"File with ID {file_id} not found in Qdrant"
            )
        
        point = points[0]
        payload = point.payload or {}
        file_url = payload.get("url")
        
        if not file_url:
            raise HTTPException(
                status_code=404,
                detail=f"File URL not found for ID {file_id}"
            )
        
        # Delete file from GCS
        try:
            await StorageService.delete_file(file_url)
        except HTTPException as exc:
            # If file not found in GCS, log but continue with Qdrant deletion
            # (file might have been manually deleted from GCS)
            if exc.status_code == 404:
                pass  # Continue with Qdrant deletion
            else:
                raise
        
        # Delete point from Qdrant
        await vector_service.client.delete(
            collection_name=collection_name,
            points_selector=[file_id]
        )
        
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to delete file: {exc}"
        ) from exc


async def untag_file(file_id: str, tag: str | None, collection_name: str) -> None:
    """
    Remove a specific tag from a file's metadata in Qdrant, or clear all tags.
    
    Args:
        file_id: The Qdrant point ID (UUID) of the file
        tag: The tag to remove (e.g., "Messaging", "Research"). If None, clears all tags.
        collection_name: Name of the Qdrant collection
        
    Raises:
        HTTPException: If file not found or update fails
    """
    # Retrieve the point to get current payload
    try:
        points = await vector_service.client.retrieve(
            collection_name=collection_name,
            ids=[file_id],
            with_payload=True,
            with_vectors=False
        )
        
        if not points:
            raise HTTPException(
                status_code=404,
                detail=f"File with ID {file_id} not found in Qdrant"
            )
        
        point = points[0]
        payload = point.payload or {}
        current_tags = payload.get("tags", [])
        
        # If tag is None, clear all tags
        if tag is None:
            updated_tags = []
        else:
            # Remove the specific tag if it exists
            if isinstance(current_tags, list) and tag in current_tags:
                updated_tags = [t for t in current_tags if t != tag]
            else:
                # Tag doesn't exist, but that's okay - just return success
                return
        
        # Update the payload with the new tags list
        await vector_service.client.set_payload(
            collection_name=collection_name,
            payload={"tags": updated_tags},
            points=[file_id]
        )
        
    except HTTPException:
        raise
    except Exception as exc:
        raise HTTPException(
            status_code=500,
            detail=f"Failed to untag file: {exc}"
        ) from exc



==================================================
FILE: fastapi-backend/app/dependencies/auth.py
==================================================
"""Clerk JWT authentication dependency for FastAPI.

This module provides JWT verification for Clerk-authenticated requests.
It supports both CLERK_JWKS_URL and CLERK_ISSUER environment variables.
"""

import base64
import json
from typing import Dict, Optional

import jwt
import requests
from cachetools import TTLCache
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives.asymmetric import rsa
from fastapi import Depends, HTTPException, Request, status
from fastapi.security import HTTPAuthorizationCredentials, HTTPBearer

from app.core.config import get_settings

# JWKS cache with 10-minute TTL
_jwks_cache: TTLCache = TTLCache(maxsize=10, ttl=600)  # 10 minutes = 600 seconds

# HTTP Bearer token security scheme
# auto_error=False allows OPTIONS preflight requests to proceed without Authorization header
http_bearer = HTTPBearer(auto_error=False)


def _get_jwks_url() -> str:
    """Determine JWKS URL from environment variables.
    
    Priority:
    1. CLERK_JWKS_URL (if set, use directly)
    2. CLERK_ISSUER (if set, derive: {issuer}/.well-known/jwks.json)
    3. Raise RuntimeError if neither is set
    
    Returns:
        JWKS URL string
        
    Raises:
        RuntimeError: If neither CLERK_JWKS_URL nor CLERK_ISSUER is set
    """
    settings = get_settings()
    
    # Check for direct JWKS URL
    jwks_url = getattr(settings, "CLERK_JWKS_URL", None)
    if jwks_url:
        return jwks_url
    
    # Check for issuer and derive JWKS URL
    issuer = getattr(settings, "CLERK_ISSUER", None)
    if issuer:
        # Remove trailing slash if present
        issuer = issuer.rstrip("/")
        return f"{issuer}/.well-known/jwks.json"
    
    # Neither is set - fail closed
    raise RuntimeError(
        "Clerk authentication not configured: "
        "Set either CLERK_JWKS_URL or CLERK_ISSUER environment variable"
    )


def _fetch_jwks(jwks_url: str) -> Dict:
    """Fetch JWKS from the given URL with caching.
    
    Args:
        jwks_url: URL to fetch JWKS from
        
    Returns:
        JWKS dictionary
        
    Raises:
        HTTPException: If JWKS fetch fails
    """
    # Check cache first
    cache_key = jwks_url
    if cache_key in _jwks_cache:
        return _jwks_cache[cache_key]
    
    # Fetch from URL
    try:
        response = requests.get(jwks_url, timeout=5)
        response.raise_for_status()
        jwks = response.json()
        
        # Cache the result
        _jwks_cache[cache_key] = jwks
        return jwks
    except requests.RequestException as exc:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail=f"Failed to fetch JWKS: {exc}"
        ) from exc


def _get_signing_key(jwks: Dict, kid: str) -> Optional[Dict]:
    """Get the signing key from JWKS by key ID.
    
    Args:
        jwks: JWKS dictionary
        kid: Key ID from JWT header
        
    Returns:
        Key dictionary or None if not found
    """
    for key in jwks.get("keys", []):
        if key.get("kid") == kid:
            return key
    return None


async def verify_clerk_token(
    request: Request,
    credentials: Optional[HTTPAuthorizationCredentials] = Depends(HTTPBearer(auto_error=False))
) -> Dict:
    """Verify Clerk JWT token and return user information.
    
    This dependency:
    1. Bypasses authentication for OPTIONS preflight requests (returns minimal user dict)
    2. Extracts the Bearer token from Authorization header
    3. Determines JWKS URL from environment variables
    4. Fetches and caches JWKS
    5. Decodes JWT header to get key ID (kid)
    6. Selects the correct key from JWKS
    7. Verifies JWT signature, expiration, and issuer
    8. Returns user information dictionary
    
    Args:
        request: FastAPI Request object to check method for OPTIONS preflight
        credentials: HTTP Bearer token credentials from Authorization header (None for OPTIONS)
        
    Returns:
        Dictionary with:
        - "id": User ID (sub claim) or "preflight" for OPTIONS requests
        - "email": User email (email claim, if present) or None for OPTIONS
        - "raw": Full decoded JWT claims or empty dict for OPTIONS
        
    Raises:
        HTTPException(401): If token is invalid, expired, or missing (non-OPTIONS requests)
        HTTPException(503): If JWKS cannot be fetched
        RuntimeError: If Clerk configuration is missing
        
    Manual Test:
        OPTIONS /api/v1/campaigns with headers:
        - Origin: http://localhost:3000
        - Access-Control-Request-Method: POST
        - Access-Control-Request-Headers: authorization,content-type
        Should return 200 (not 400/401) with CORS headers.
    """
    # CORS preflight bypass: OPTIONS requests don't require authentication
    # The CORS middleware will handle the preflight response with proper headers
    if request.method == "OPTIONS":
        return {"id": "preflight", "email": None}
    
    # For non-OPTIONS requests, credentials must be provided
    if credentials is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Not authenticated"
        )
    
    token = credentials.credentials
    
    try:
        # Step 1: Decode JWT header to get kid (without verification)
        unverified_header = jwt.get_unverified_header(token)
        kid = unverified_header.get("kid")
        if not kid:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="JWT missing key ID (kid) in header"
            )
        
        # Step 2: Get JWKS URL
        jwks_url = _get_jwks_url()
        
        # Step 3: Fetch JWKS (with caching)
        jwks = _fetch_jwks(jwks_url)
        
        # Step 4: Get signing key
        signing_key = _get_signing_key(jwks, kid)
        if not signing_key:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail=f"Signing key not found for kid: {kid}"
            )
        
        # Step 5: Decode and verify JWT
        # Convert JWK to RSA public key for PyJWT
        try:
            # Extract RSA components from JWK
            n = base64.urlsafe_b64decode(signing_key["n"] + "==")
            e = base64.urlsafe_b64decode(signing_key["e"] + "==")
            
            # Convert to integers
            n_int = int.from_bytes(n, "big")
            e_int = int.from_bytes(e, "big")
            
            # Build RSA public key
            public_key = rsa.RSAPublicNumbers(e_int, n_int).public_key(default_backend())
        except (KeyError, ValueError) as exc:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail=f"Invalid JWK format: {exc}"
            ) from exc
        
        # Get issuer for verification
        settings = get_settings()
        issuer = getattr(settings, "CLERK_ISSUER", None)
        if not issuer:
            # Try to derive from JWKS URL
            if jwks_url.endswith("/.well-known/jwks.json"):
                issuer = jwks_url[:-23]  # Remove "/.well-known/jwks.json"
        
        # Verify JWT
        try:
            decoded = jwt.decode(
                token,
                public_key,
                algorithms=["RS256"],
                issuer=issuer,
                options={
                    "verify_signature": True,
                    "verify_exp": True,
                    "verify_iss": bool(issuer),
                }
            )
        except jwt.ExpiredSignatureError:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="JWT token has expired"
            )
        except jwt.InvalidIssuerError:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="JWT token issuer is invalid"
            )
        except jwt.InvalidSignatureError:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="JWT token signature is invalid"
            )
        except jwt.DecodeError as exc:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail=f"JWT token decode failed: {exc}"
            )
        
        # Step 6: Return user information
        return {
            "id": decoded.get("sub", ""),
            "email": decoded.get("email", ""),
            "raw": decoded
        }
        
    except HTTPException:
        # Re-raise HTTP exceptions
        raise
    except RuntimeError:
        # Re-raise configuration errors
        raise
    except Exception as exc:
        # Catch-all for any other errors
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail=f"Token verification failed: {exc}"
        ) from exc


def extract_tenant_id(request: Request) -> Optional[str]:
    """Extract tenant_id from request using standardized priority.
    
    Priority order:
    1. Query parameter: request.query_params.get("tenant_id")
    2. Path parameter: request.path_params.get("tenant_id")
    3. Path parameter: request.path_params.get("id") (for /campaigns/{id}/... routes)
    4. JSON body: Attempt to parse request body (only if not already consumed)
    
    Note: For JSON body extraction, this function tries to read the body stream.
    If the body has already been consumed by FastAPI's automatic parsing, it may not
    be available. In such cases, endpoints should pass tenant_id explicitly or
    extract it from the parsed Pydantic model.
    
    Args:
        request: FastAPI Request object
        
    Returns:
        tenant_id string if found, None otherwise
    """
    # Priority 1: Query parameter
    tenant_id = request.query_params.get("tenant_id")
    if tenant_id:
        return tenant_id
    
    # Priority 2: Path parameter "tenant_id"
    tenant_id = request.path_params.get("tenant_id")
    if tenant_id:
        return tenant_id
    
    # Priority 3: Path parameter "id" (for /campaigns/{id}/... routes)
    tenant_id = request.path_params.get("id")
    if tenant_id:
        return tenant_id
    
    # Priority 3: JSON body (if content type is JSON and body is available)
    content_type = request.headers.get("content-type", "")
    if "application/json" in content_type:
        try:
            # Check if body is in request state (FastAPI may cache it)
            if hasattr(request.state, "body") and isinstance(request.state.body, dict):
                tenant_id = request.state.body.get("tenant_id")
                if tenant_id:
                    return tenant_id
        except Exception:
            # If body parsing fails, continue
            pass
    
    return None


async def verify_tenant_access(
    request: Request,
    user: Dict = Depends(verify_clerk_token),
    tenant_id: Optional[str] = None
) -> Dict:
    """Verify user has access to the tenant_id in the request.
    
    This dependency:
    1. Uses provided tenant_id if given, otherwise extracts from request (query or path)
    2. If tenant_id is None, returns user (endpoint not tenant-scoped)
    3. If tenant_id is "global", allows access (launch behavior)
    4. Otherwise, checks membership in Neo4j
    5. Raises 403 if user is not a member
    
    Note: For POST requests with JSON bodies, the endpoint should extract tenant_id
    from the parsed body and pass it explicitly, since FastAPI parses the body
    after dependencies are resolved.
    
    Args:
        request: FastAPI Request object
        user: User dictionary from verify_clerk_token
        tenant_id: Optional explicit tenant_id (for body params)
        
    Returns:
        User dictionary (same as verify_clerk_token output)
        
    Raises:
        HTTPException(403): If user is not a member of the tenant
    """
    # Use provided tenant_id or extract from request
    if tenant_id is None:
        tenant_id = extract_tenant_id(request)
    
    # If no tenant_id, endpoint is not tenant-scoped - allow access
    if tenant_id is None:
        return user
    
    # Get graph service from app.state
    from app.services.graph import GraphService
    graph: GraphService = getattr(request.app.state, "graph", None)
    
    if graph is None:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail="Graph service not initialized"
        )
    
    # Check membership
    is_member = await graph.check_membership(user["id"], tenant_id)
    
    if not is_member:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail=f"Access denied to campaign {tenant_id}. You are not a member of this campaign."
        )
    
    return user


async def check_tenant_membership(user_id: str, tenant_id: str, request: Request) -> None:
    """Helper function to check tenant membership after body is parsed.
    
    Use this in endpoints where tenant_id comes from the request body
    and you need to verify membership after parsing.
    
    Args:
        user_id: User ID to check
        tenant_id: Tenant ID to check membership for
        request: FastAPI Request object to access app.state
        
    Raises:
        HTTPException(403): If user is not a member of the tenant
    """
    from app.services.graph import GraphService
    graph: GraphService = getattr(request.app.state, "graph", None)
    
    if graph is None:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail="Graph service not initialized"
        )
    
    is_member = await graph.check_membership(user_id, tenant_id)
    
    if not is_member:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail=f"Access denied to campaign {tenant_id}. You are not a member of this campaign."
        )


==================================================
FILE: fastapi-backend/app/dependencies/graph_dep.py
==================================================
from typing import Optional
from fastapi import Request, HTTPException, status
from app.services.graph import GraphService


async def get_graph(request: Request) -> GraphService:
    """Dependency injection for GraphService.
    
    Retrieves the GraphService instance from app.state, which is initialized
    during application startup. This ensures all workers use the same initialized
    service instance.
    
    Args:
        request: FastAPI request object containing app.state
        
    Returns:
        GraphService instance
        
    Raises:
        HTTPException(503): If GraphService is not initialized
    """
    gs = getattr(request.app.state, "graph", None)
    if gs is None:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail="Graph service not initialized"
        )
    return gs


async def get_graph_optional(request: Request) -> Optional[GraphService]:
    """Optional dependency injection for GraphService.
    
    Returns None if GraphService is not initialized, instead of raising an exception.
    Use this for endpoints where graph functionality is optional.
    
    Args:
        request: FastAPI request object containing app.state
        
    Returns:
        GraphService instance or None if not initialized
    """
    return getattr(request.app.state, "graph", None)


==================================================
FILE: fastapi-backend/app/dependencies/__init__.py
==================================================
# Dependencies module for FastAPI dependency injection


==================================================
FILE: fastapi-backend/app/core/config.py
==================================================
from functools import lru_cache
from typing import Optional

from dotenv import load_dotenv
from pydantic_settings import BaseSettings, SettingsConfigDict


# Load environment variables from a local .env file if present.
load_dotenv()


class Settings(BaseSettings):
    """Application configuration loaded from environment variables.

    This configuration is designed for a multi-tenant, high-security environment.
    """

    # Qdrant configuration
    # For Qdrant Cloud: set QDRANT_URL (e.g., "https://xxx-xxx-xxx.qdrant.io") and QDRANT_API_KEY
    # For local dev: leave QDRANT_URL=None and use QDRANT_HOST/QDRANT_PORT
    QDRANT_URL: Optional[str] = None
    QDRANT_API_KEY: Optional[str] = None
    QDRANT_HOST: str = "localhost"  # Fallback for local dev
    QDRANT_PORT: int = 6333  # Fallback for local dev

    # Global firm knowledge collection (Tier 1 - no filters)
    QDRANT_COLLECTION_TIER_1: str = "riley_production_v1"

    # Private client data collection (Tier 2 - tenant-filtered)
    QDRANT_COLLECTION_TIER_2: str = "riley_campaigns"

    # Neo4j Graph Database configuration
    NEO4J_URI: str = "bolt://localhost:7687"
    NEO4J_USER: str = "neo4j"
    NEO4J_PASSWORD: str = "password"

    # Google Gemini / Generative AI
    GOOGLE_API_KEY: Optional[str] = None
    EMBEDDING_MODEL: str = "models/gemini-embedding-001"  # Supported Gemini embedding model
    EMBEDDING_DIM: int = 3072  # gemini-embedding-001 outputs 3072-d vectors

    # Qdrant vector configuration
    # NOTE: Keep as a string for env override; code maps to qdrant_client Distance enum.
    QDRANT_DISTANCE: str = "Cosine"

    # Google Cloud Storage configuration
    GCS_BUCKET_NAME: str = "riley-assets-riley-ai-479422"
    GOOGLE_APPLICATION_CREDENTIALS: Optional[str] = None  # Path to GCP service account JSON

    # OCR configuration
    OCR_ENABLED_SYSTEMWIDE: bool = False  # Master switch for OCR functionality
    OCR_MIN_CONFIDENCE: float = 0.50  # Minimum confidence threshold (0-1)
    OCR_MAX_CHARS: int = 8000  # Maximum characters to extract from OCR

    # Upload limits (server-side hard cap)
    MAX_UPLOAD_MB: int = 25

    # Preview generation configuration (Office/HTML -> PDF)
    ENABLE_PREVIEW_GENERATION: bool = True
    PREVIEW_MAX_MB: int = 25
    PREVIEW_BUCKET_PATH_PREFIX: str = "previews"
    SIGN_PREVIEW_URLS: bool = True
    PREVIEW_URL_TTL_SECONDS: int = 3600

    # Clerk JWT authentication configuration
    # Either CLERK_JWKS_URL (direct JWKS endpoint) or CLERK_ISSUER (to derive JWKS URL)
    CLERK_JWKS_URL: Optional[str] = None
    CLERK_ISSUER: Optional[str] = None
    
    # Clerk Backend API secret key (for user directory lookups)
    CLERK_SECRET_KEY: Optional[str] = None

    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore",
    )


@lru_cache(maxsize=1)
def get_settings() -> Settings:
    """Return a cached Settings instance so configuration is read once."""
    return Settings()





==================================================
FILE: fastapi-backend/app/core/personas.py
==================================================
# Strategic Personas for Rally Campaigns
# These are Archetypes, not real people.

RALLY_PERSONAS = [
    "Conservative Catherine",
    "Unbothered Ursula & Ulysses",
    "Empathetic Eric",
    "Active Ava",
    "Skeptical Sam",
    "Passive Patty",
    "Supporter Spencer",
    "Advocate Angie",
    "Legislator Brian (State Level)",
    "Secretary of Education Michelle (State Level)",
    "Mayor Michael (Local Level)",
    "Superintendent James (District Level)",
    "District Administrator Jennifer (District Level)",
    "Educator Christina (Educator)",
    "Foundation CEO Sarah (Philanthropoid)",
    "Program Director Emily (Philanthropoid)",
    "Philanthropist Chuck (Philantropist)",
    "National Housing Advocate Monica",
    "National Education Advocate Chris",
    "Federal Policymaker David",
    "Governor Charlie",
    "Policymaker Jeff (Federal Level)",
    "Legislator Margaret (State Level)",
    "District Administrator Daniel (District Level)",
    "Philanthropist Chuck Harvey", 
    "Equity Forward Salesperson Benjamin Pattton",
    "Concerned Californians",
    "Unbothered Ulysses",
    "Unbothered Ursula",
    "Empathetic Eric",
    "Active Ava"
]

def get_persona_context() -> str:
    """Format personas for System Prompt Injection."""
    return ", ".join(RALLY_PERSONAS)


==================================================
FILE: fastapi-backend/scripts/purge_tags.py
==================================================
"""Purge Script: Remove ALL Persona labels from Neo4j.

This script removes the :Persona label from all nodes in the database.
Use this to reset the data state before running the Intelligent Tagger.
"""

import asyncio
import sys
from pathlib import Path

# Add parent directory to path to allow imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from neo4j import AsyncGraphDatabase

from app.core.config import get_settings


async def purge_persona_tags():
    """Remove all Persona labels from Neo4j nodes."""
    settings = get_settings()
    
    # Connect to Neo4j
    driver = AsyncGraphDatabase.driver(
        settings.NEO4J_URI,
        auth=(settings.NEO4J_USER, settings.NEO4J_PASSWORD),
    )
    
    try:
        print(f"Connected to Neo4j at {settings.NEO4J_URI}")
        print("Purging all Persona labels...\n")
        
        async with driver.session() as session:
            # Remove Persona label from all nodes
            purge_query = """
            MATCH (n:Persona)
            REMOVE n:Persona
            RETURN count(n) as RemovedCount
            """
            
            result = await session.run(purge_query)
            record = await result.single()
            removed_count = record["RemovedCount"] if record else 0
            
            print(f"âœ… PURGE COMPLETE. Removed labels from {removed_count} nodes.")
        
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        raise
    finally:
        await driver.close()
        print("\nConnection closed.")


if __name__ == "__main__":
    asyncio.run(purge_persona_tags())


==================================================
FILE: fastapi-backend/scripts/intelligent_tagger.py
==================================================
"""Intelligent Tagger: Semantic graph tagging for Persona nodes.

This script uses Gemini AI to intelligently tag nodes as :Persona only if they
represent Strategic Audiences, filtering out noise like files, addresses, and tools.
"""

import asyncio
import json
import os
import re
import sys
from pathlib import Path
from typing import List, Set

import google.generativeai as genai
from neo4j import AsyncGraphDatabase
from tqdm import tqdm

# Add parent directory to path to allow imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from app.core.config import get_settings

# Try to import RALLY_PERSONAS, fallback to hardcoded list if import fails
try:
    from app.core.personas import RALLY_PERSONAS
except ImportError:
    print("Warning: Could not import RALLY_PERSONAS from app.core.personas. Using fallback list.")
    RALLY_PERSONAS = [
        "Unbothered Ursula & Ulysses",
        "Empathetic Eric",
        "Active Ava",
        "Skeptical Sam",
        "Passive Patty",
        "Supporter Spencer",
        "Advocate Angie",
        "Legislator Brian (State Level)",
        "Secretary of Education Michelle (State Level)",
        "Mayor Michael (Local Level)",
        "Superintendent James (District Level)",
        "District Administrator Jennifer (District Level)",
        "Educator Christina (Educator)",
        "Foundation CEO Sarah (Philanthropoid)",
        "Program Director Emily (Philanthropoid)",
        "Philanthropist Chuck (Philantropist)",
        "National Housing Advocate Monica",
        "National Education Advocate Chris",
        "Federal Policymaker David",
        "Governor Charlie",
        "Education Personnel",
        "Decision Makers and Policy Makers",
        "Media",
        "Parents",
        "Gen Z",
        "Thoughtleaders and Advocates",
        "Policymaker Jeff (Federal Level)",
        "Legislator Margaret (State Level)",
        "District Administrator Daniel (District Level)",
        "Philanthropist Chuck Harvey",
        "Equity Forward Salesperson Benjamin Pattton",
        "Concerned Californians",
        "Mental Health Specialist",
        "The Field",
        "The Media",
        "Unbothered",
        "Empathetic",
        "Advocates",
        "Unaware + Unbothered",
    ]


def extract_json_from_response(text: str) -> List[str]:
    """Extract JSON array from Gemini response, handling markdown code blocks."""
    # Try to find JSON in markdown code blocks
    json_match = re.search(r'```(?:json)?\s*(\[.*?\])', text, re.DOTALL)
    if json_match:
        json_str = json_match.group(1)
    else:
        # Try to find JSON array directly
        json_match = re.search(r'(\[.*?\])', text, re.DOTALL)
        if json_match:
            json_str = json_match.group(1)
        else:
            # Fallback: try to parse the whole text
            json_str = text.strip()
    
    try:
        parsed = json.loads(json_str)
        if isinstance(parsed, list):
            return [str(item) for item in parsed]
        return []
    except json.JSONDecodeError:
        # If JSON parsing fails, try to extract quoted strings
        quoted_strings = re.findall(r'"([^"]+)"', text)
        return quoted_strings if quoted_strings else []


async def collect_candidates(driver, personas: List[str]) -> Set[str]:
    """Step A: Collect candidate node names using fuzzy matching."""
    print("Step A: Collecting candidate nodes...")
    candidates: Set[str] = set()
    
    async with driver.session() as session:
        for persona_name in tqdm(personas, desc="Searching personas"):
            query = """
            MATCH (n)
            WHERE toLower(n.name) CONTAINS toLower($persona_name)
            RETURN DISTINCT n.name as Name
            """
            
            result = await session.run(query, persona_name=persona_name)
            async for record in result:
                name = record.get("Name")
                if name:
                    candidates.add(name)
    
    print(f"Found {len(candidates)} unique candidate nodes.\n")
    return candidates


async def validate_with_gemini(candidates: List[str], api_key: str) -> List[str]:
    """Step B: Use Gemini to validate which candidates are actual personas."""
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel("gemini-2.5-flash-lite")
    
    prompt = """You are a Data Cleanliness Expert for a Political Campaign graph.
Review this list of node names. Identify which ones are **Strategic Personas / Target Audiences** (groups of people) and which are **Noise** (Files, Addresses, Events, Tools).

Rules:
- KEEP: 'Passive Patty', 'The Media', 'Gen Z', 'Parents'.
- DISCARD: 'Policy.pdf', '10 La Media Dr', 'Social Media Training', 'Meeting Notes'.

Return ONLY a JSON list of strings for the names to KEEP.

Node names to review:
""" + "\n".join(f"- {name}" for name in candidates)
    
    try:
        response = model.generate_content(prompt)
        response_text = response.text if hasattr(response, "text") else str(response)
        validated = extract_json_from_response(response_text)
        return validated
    except Exception as e:
        print(f"Error calling Gemini: {e}")
        return []


async def tag_validated_nodes(driver, validated_names: List[str]) -> int:
    """Step C: Tag validated nodes with :Persona label."""
    print("\nStep C: Tagging validated nodes...")
    total_tagged = 0
    
    async with driver.session() as session:
        for name in tqdm(validated_names, desc="Tagging nodes"):
            query = """
            MATCH (n)
            WHERE n.name = $approved_name
            SET n:Persona
            RETURN count(n) as count
            """
            
            result = await session.run(query, approved_name=name)
            record = await result.single()
            count = record["count"] if record else 0
            total_tagged += count
    
    return total_tagged


async def intelligent_tagger():
    """Main function: Run the intelligent tagging pipeline."""
    settings = get_settings()
    
    # Validate API key
    api_key = settings.GOOGLE_API_KEY or os.getenv("GOOGLE_API_KEY")
    if not api_key:
        raise RuntimeError("GOOGLE_API_KEY is not configured. Set it in .env or environment variables.")
    
    # Connect to Neo4j
    driver = AsyncGraphDatabase.driver(
        settings.NEO4J_URI,
        auth=(settings.NEO4J_USER, settings.NEO4J_PASSWORD),
    )
    
    try:
        print("=" * 60)
        print("INTELLIGENT PERSONA TAGGER")
        print("=" * 60)
        print(f"Connected to Neo4j at {settings.NEO4J_URI}")
        print(f"Using Gemini API for validation\n")
        
        # Step A: Collect candidates
        candidates = await collect_candidates(driver, RALLY_PERSONAS)
        
        if not candidates:
            print("No candidates found. Exiting.")
            return
        
        # Step B: Batch validation with Gemini
        print("Step B: Validating candidates with Gemini AI...")
        candidates_list = list(candidates)
        batch_size = 20
        all_validated: List[str] = []
        
        # Process in batches
        for i in tqdm(range(0, len(candidates_list), batch_size), desc="Processing batches"):
            batch = candidates_list[i:i + batch_size]
            validated_batch = await validate_with_gemini(batch, api_key)
            all_validated.extend(validated_batch)
        
        print(f"\nGemini validated {len(all_validated)} out of {len(candidates)} candidates.")
        
        # Step C: Tag validated nodes
        total_tagged = await tag_validated_nodes(driver, all_validated)
        
        # Summary
        print("\n" + "=" * 60)
        print("SUMMARY")
        print("=" * 60)
        print(f"Analyzed {len(candidates)} candidates.")
        print(f"Tagged {total_tagged} validated personas.")
        print("=" * 60)
        
    except Exception as e:
        print(f"\nError: {e}", file=sys.stderr)
        raise
    finally:
        await driver.close()
        print("\nConnection closed.")


if __name__ == "__main__":
    asyncio.run(intelligent_tagger())


==================================================
FILE: fastapi-backend/scripts/reset_qdrant_collections.py
==================================================
"""One-time destructive reset of Qdrant Tier 1 & Tier 2 collections.

This deletes and recreates the configured collections with the configured embedding dimension.

SAFETY:
- Requires either `--force` OR environment variable `QDRANT_RESET_CONFIRM=YES`.

Usage:
  QDRANT_RESET_CONFIRM=YES python -m scripts.reset_qdrant_collections
  python -m scripts.reset_qdrant_collections --force
"""

from __future__ import annotations

import argparse
import os
import sys

from qdrant_client import QdrantClient
from qdrant_client.http import models

from app.core.config import get_settings


def _confirm_or_exit(force: bool) -> None:
    if force:
        return
    if os.getenv("QDRANT_RESET_CONFIRM") == "YES":
        return

    print("Refusing to reset Qdrant collections without explicit confirmation.")
    print("")
    print("To proceed, set:")
    print("  QDRANT_RESET_CONFIRM=YES")
    print("or pass:")
    print("  --force")
    print("")
    print("Example:")
    print("  QDRANT_RESET_CONFIRM=YES python -m scripts.reset_qdrant_collections")
    sys.exit(1)


def main() -> None:
    parser = argparse.ArgumentParser(description="Reset Qdrant collections (DELETES DATA).")
    parser.add_argument(
        "--force",
        action="store_true",
        help="Actually delete and recreate collections (dangerous).",
    )
    args = parser.parse_args()
    _confirm_or_exit(args.force)

    settings = get_settings()

    distance_str = (settings.QDRANT_DISTANCE or "Cosine").strip().lower()
    distance = models.Distance.COSINE
    if distance_str == "dot":
        distance = models.Distance.DOT
    elif distance_str == "euclid":
        distance = models.Distance.EUCLID

    client = QdrantClient(
        host=settings.QDRANT_HOST,
        port=settings.QDRANT_PORT,
    )

    for name in (settings.QDRANT_COLLECTION_TIER_1, settings.QDRANT_COLLECTION_TIER_2):
        # Delete if exists
        try:
            client.get_collection(name)
            client.delete_collection(name)
        except Exception:
            pass

        # Create fresh
        client.create_collection(
            collection_name=name,
            vectors_config=models.VectorParams(
                size=settings.EMBEDDING_DIM,
                distance=distance,
            ),
        )

        print(f"Deleted {name} (if existed), created with dim={settings.EMBEDDING_DIM}")

    print("")
    print("Done.")
    print("If the API is running, restart it to ensure it reconnects cleanly.")


if __name__ == "__main__":
    main()



==================================================
FILE: fastapi-backend/scripts/verify_tags.py
==================================================
"""Verification Script: Audit the quality of AI-powered Persona tagging.

This script verifies that the intelligent tagger correctly kept "Signal" (Strategic Personas)
and rejected "Noise" (Files, Addresses, Tools).
"""

import asyncio
import re
import sys
from pathlib import Path

# Add parent directory to path to allow imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from neo4j import AsyncGraphDatabase

from app.core.config import get_settings


async def verify_tags():
    """Verify the quality of Persona tags in Neo4j."""
    settings = get_settings()
    
    # Connect to Neo4j
    driver = AsyncGraphDatabase.driver(
        settings.NEO4J_URI,
        auth=(settings.NEO4J_USER, settings.NEO4J_PASSWORD),
    )
    
    try:
        print("=" * 60)
        print("PERSONA TAG VERIFICATION REPORT")
        print("=" * 60)
        print(f"Connected to Neo4j at {settings.NEO4J_URI}\n")
        
        async with driver.session() as session:
            # Check 1: The Media Test
            print("CHECK 1: The Media Test")
            print("-" * 60)
            print("Verifying Media personas are abstract concepts, not addresses/files...\n")
            
            media_query = """
            MATCH (n:Persona)
            WHERE n.name CONTAINS 'Media'
            RETURN n.name
            ORDER BY n.name
            """
            
            result = await session.run(media_query)
            media_nodes = []
            async for record in result:
                name = record.get("n.name")
                if name:
                    media_nodes.append(name)
            
            if media_nodes:
                print(f"Found {len(media_nodes)} Media-related Persona node(s):")
                for idx, name in enumerate(media_nodes, 1):
                    # Flag potential issues
                    is_file = name.endswith(('.pdf', '.docx', '.xlsx', '.txt', '.doc', '.xls'))
                    is_address = bool(re.match(r'^\d+', name)) if name else False
                    status = ""
                    if is_file:
                        status = " âš ï¸  FILE"
                    elif is_address:
                        status = " âš ï¸  ADDRESS"
                    else:
                        status = " âœ“"
                    print(f"  {idx:2d}. {name}{status}")
            else:
                print("  No Media-related Persona nodes found.")
            
            print()
            
            # Check 2: The File Test
            print("CHECK 2: The File Test")
            print("-" * 60)
            print("Checking for Persona nodes with file extensions...\n")
            
            file_query = """
            MATCH (n:Persona)
            WHERE n.name ENDS WITH '.pdf' OR 
                  n.name ENDS WITH '.docx' OR 
                  n.name ENDS WITH '.xlsx' OR
                  n.name ENDS WITH '.pptx' OR
                  n.name ENDS WITH '.txt' OR
                  n.name ENDS WITH '.doc' OR
                  n.name ENDS WITH '.xls' OR
                  n.name ENDS WITH '.csv'
            RETURN count(n) as count
            """
            
            result = await session.run(file_query)
            record = await result.single()
            file_count = record["count"] if record else 0
            
            if file_count == 0:
                print(f"âœ“ PASS: {file_count} file nodes incorrectly tagged as Persona.")
            else:
                print(f"âœ— FAIL: {file_count} file node(s) incorrectly tagged as Persona.")
                # Get sample of file nodes
                file_sample_query = """
                MATCH (n:Persona)
                WHERE n.name ENDS WITH '.pdf' OR 
                      n.name ENDS WITH '.docx' OR 
                      n.name ENDS WITH '.xlsx' OR
                      n.name ENDS WITH '.pptx' OR
                      n.name ENDS WITH '.txt' OR
                      n.name ENDS WITH '.doc' OR
                      n.name ENDS WITH '.xls' OR
                      n.name ENDS WITH '.csv'
                RETURN n.name
                LIMIT 10
                """
                result = await session.run(file_sample_query)
                print("\n  Sample of incorrectly tagged files:")
                async for record in result:
                    name = record.get("n.name")
                    if name:
                        print(f"    - {name}")
            
            print()
            
            # Check 3: The Address Test
            print("CHECK 3: The Address Test")
            print("-" * 60)
            print("Checking for Persona nodes starting with numbers (addresses/dates)...\n")
            
            address_query = """
            MATCH (n:Persona)
            WHERE n.name =~ '^[0-9].*'
            RETURN n.name
            ORDER BY n.name
            """
            
            result = await session.run(address_query)
            address_nodes = []
            async for record in result:
                name = record.get("n.name")
                if name:
                    address_nodes.append(name)
            
            address_count = len(address_nodes)
            if address_count == 0:
                print(f"âœ“ PASS: {address_count} address/date nodes incorrectly tagged as Persona.")
            else:
                print(f"âš  WARNING: {address_count} address/date node(s) incorrectly tagged as Persona.")
                print("\n  Incorrectly tagged addresses/dates:")
                for idx, name in enumerate(address_nodes[:10], 1):  # Show first 10
                    print(f"    {idx}. {name}")
                if address_count > 10:
                    print(f"    ... and {address_count - 10} more")
            
            print()
            
            # Check 4: The Sample
            print("CHECK 4: Random Sample (Quality Spot-Check)")
            print("-" * 60)
            print("20 random Persona nodes for manual review:\n")
            
            sample_query = """
            MATCH (n:Persona)
            WITH n, rand() as r
            ORDER BY r
            LIMIT 20
            RETURN n.name as name
            ORDER BY name
            """
            
            result = await session.run(sample_query)
            sample_nodes = []
            async for record in result:
                name = record.get("name")
                if name:
                    sample_nodes.append(name)
            
            if sample_nodes:
                for idx, name in enumerate(sample_nodes, 1):
                    # Quick quality indicators
                    is_file = name.endswith(('.pdf', '.docx', '.xlsx', '.txt', '.doc', '.xls', '.csv', '.pptx'))
                    is_address = bool(re.match(r'^\d+', name)) if name else False
                    is_tool = any(term in name.lower() for term in ['toolkit', 'plan', 'tracker', 'brief', 'training'])
                    
                    status = ""
                    if is_file:
                        status = " âš ï¸  FILE"
                    elif is_address:
                        status = " âš ï¸  ADDRESS"
                    elif is_tool:
                        status = " âš ï¸  TOOL"
                    else:
                        status = " âœ“"
                    
                    print(f"  {idx:2d}. {name}{status}")
            else:
                print("  No Persona nodes found.")
            
            print()
            
            # Summary Statistics
            print("SUMMARY STATISTICS")
            print("-" * 60)
            
            total_query = """
            MATCH (n:Persona)
            RETURN count(n) as total
            """
            
            result = await session.run(total_query)
            record = await result.single()
            total_personas = record["total"] if record else 0
            
            print(f"Total Persona nodes: {total_personas}")
            print(f"File pollution: {file_count} ({'âœ“ PASS' if file_count == 0 else 'âœ— FAIL'})")
            print(f"Address pollution: {address_count} ({'âœ“ PASS' if address_count == 0 else 'âš  WARNING'})")
            print(f"Media nodes: {len(media_nodes)}")
            
            if total_personas > 0:
                pollution_rate = ((file_count + address_count) / total_personas) * 100
                print(f"\nOverall pollution rate: {pollution_rate:.1f}%")
                if pollution_rate == 0:
                    print("âœ“ EXCELLENT: No pollution detected!")
                elif pollution_rate < 1:
                    print("âœ“ GOOD: Minimal pollution detected.")
                elif pollution_rate < 5:
                    print("âš  ACCEPTABLE: Some pollution detected.")
                else:
                    print("âœ— POOR: Significant pollution detected.")
            
            print()
            print("=" * 60)
            print("VERIFICATION COMPLETE")
            print("=" * 60)
        
    except Exception as e:
        print(f"\nError: {e}", file=sys.stderr)
        raise
    finally:
        await driver.close()
        print("\nConnection closed.")


if __name__ == "__main__":
    asyncio.run(verify_tags())


==================================================
FILE: next-frontend/next.config.mjs
==================================================
import path from "path";

const nextConfig = {
  /* config options here */
  reactStrictMode: true,
  webpack: (config) => {
    config.resolve.alias = {
      ...config.resolve.alias,
      "@app": path.resolve(process.cwd(), "src"),
    };
    return config;
  },
};

export default nextConfig;


==================================================
FILE: next-frontend/README.md
==================================================
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/pages/api-reference/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `pages/index.tsx`. The page auto-updates as you edit the file.

[API routes](https://nextjs.org/docs/pages/building-your-application/routing/api-routes) can be accessed on [http://localhost:3000/api/hello](http://localhost:3000/api/hello). This endpoint can be edited in `pages/api/hello.ts`.

The `pages/api` directory is mapped to `/api/*`. Files in this directory are treated as [API routes](https://nextjs.org/docs/pages/building-your-application/routing/api-routes) instead of React pages.

This project uses [`next/font`](https://nextjs.org/docs/pages/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn-pages-router) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/pages/building-your-application/deploying) for more details.


==================================================
FILE: next-frontend/postcss.config.mjs
==================================================
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;


==================================================
FILE: next-frontend/package.json
==================================================
{
  "name": "next-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "vercel-build": "next build"
  },
  "dependencies": {
    "@clerk/nextjs": "^6.36.7",
    "@clerk/themes": "^2.4.47",
    "@cyntler/react-doc-viewer": "^1.17.1",
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@radix-ui/react-popover": "^1.1.15",
    "@tailwindcss/typography": "^0.5.19",
    "clsx": "^2.1.1",
    "framer-motion": "^12.23.26",
    "lucide-react": "^0.562.0",
    "next": "14.2.25",
    "next-themes": "^0.4.6",
    "react": "18.2.0",
    "react-dom": "18.2.0",
    "react-markdown": "^10.1.0",
    "remark-breaks": "^4.0.0",
    "styled-components": "^6.1.19",
    "tailwind-merge": "^3.4.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^8",
    "eslint-config-next": "14.2.25",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}


==================================================
FILE: next-frontend/next-env.d.ts
==================================================
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.


==================================================
FILE: next-frontend/tsconfig.json
==================================================
{
  "compilerOptions": {
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@app/*": [
        "src/*"
      ]
    },
    "target": "ES2017"
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}



==================================================
FILE: next-frontend/tsconfig.tsbuildinfo
==================================================
{"fileNames":["./node_modules/typescript/lib/lib.es5.d.ts","./node_modules/typescript/lib/lib.es2015.d.ts","./node_modules/typescript/lib/lib.es2016.d.ts","./node_modules/typescript/lib/lib.es2017.d.ts","./node_modules/typescript/lib/lib.es2018.d.ts","./node_modules/typescript/lib/lib.es2019.d.ts","./node_modules/typescript/lib/lib.es2020.d.ts","./node_modules/typescript/lib/lib.es2021.d.ts","./node_modules/typescript/lib/lib.es2022.d.ts","./node_modules/typescript/lib/lib.es2023.d.ts","./node_modules/typescript/lib/lib.es2024.d.ts","./node_modules/typescript/lib/lib.esnext.d.ts","./node_modules/typescript/lib/lib.dom.d.ts","./node_modules/typescript/lib/lib.dom.iterable.d.ts","./node_modules/typescript/lib/lib.es2015.core.d.ts","./node_modules/typescript/lib/lib.es2015.collection.d.ts","./node_modules/typescript/lib/lib.es2015.generator.d.ts","./node_modules/typescript/lib/lib.es2015.iterable.d.ts","./node_modules/typescript/lib/lib.es2015.promise.d.ts","./node_modules/typescript/lib/lib.es2015.proxy.d.ts","./node_modules/typescript/lib/lib.es2015.reflect.d.ts","./node_modules/typescript/lib/lib.es2015.symbol.d.ts","./node_modules/typescript/lib/lib.es2015.symbol.wellknown.d.ts","./node_modules/typescript/lib/lib.es2016.array.include.d.ts","./node_modules/typescript/lib/lib.es2016.intl.d.ts","./node_modules/typescript/lib/lib.es2017.arraybuffer.d.ts","./node_modules/typescript/lib/lib.es2017.date.d.ts","./node_modules/typescript/lib/lib.es2017.object.d.ts","./node_modules/typescript/lib/lib.es2017.sharedmemory.d.ts","./node_modules/typescript/lib/lib.es2017.string.d.ts","./node_modules/typescript/lib/lib.es2017.intl.d.ts","./node_modules/typescript/lib/lib.es2017.typedarrays.d.ts","./node_modules/typescript/lib/lib.es2018.asyncgenerator.d.ts","./node_modules/typescript/lib/lib.es2018.asynciterable.d.ts","./node_modules/typescript/lib/lib.es2018.intl.d.ts","./node_modules/typescript/lib/lib.es2018.promise.d.ts","./node_modules/typescript/lib/lib.es2018.regexp.d.ts","./node_modules/typescript/lib/lib.es2019.array.d.ts","./node_modules/typescript/lib/lib.es2019.object.d.ts","./node_modules/typescript/lib/lib.es2019.string.d.ts","./node_modules/typescript/lib/lib.es2019.symbol.d.ts","./node_modules/typescript/lib/lib.es2019.intl.d.ts","./node_modules/typescript/lib/lib.es2020.bigint.d.ts","./node_modules/typescript/lib/lib.es2020.date.d.ts","./node_modules/typescript/lib/lib.es2020.promise.d.ts","./node_modules/typescript/lib/lib.es2020.sharedmemory.d.ts","./node_modules/typescript/lib/lib.es2020.string.d.ts","./node_modules/typescript/lib/lib.es2020.symbol.wellknown.d.ts","./node_modules/typescript/lib/lib.es2020.intl.d.ts","./node_modules/typescript/lib/lib.es2020.number.d.ts","./node_modules/typescript/lib/lib.es2021.promise.d.ts","./node_modules/typescript/lib/lib.es2021.string.d.ts","./node_modules/typescript/lib/lib.es2021.weakref.d.ts","./node_modules/typescript/lib/lib.es2021.intl.d.ts","./node_modules/typescript/lib/lib.es2022.array.d.ts","./node_modules/typescript/lib/lib.es2022.error.d.ts","./node_modules/typescript/lib/lib.es2022.intl.d.ts","./node_modules/typescript/lib/lib.es2022.object.d.ts","./node_modules/typescript/lib/lib.es2022.string.d.ts","./node_modules/typescript/lib/lib.es2022.regexp.d.ts","./node_modules/typescript/lib/lib.es2023.array.d.ts","./node_modules/typescript/lib/lib.es2023.collection.d.ts","./node_modules/typescript/lib/lib.es2023.intl.d.ts","./node_modules/typescript/lib/lib.es2024.arraybuffer.d.ts","./node_modules/typescript/lib/lib.es2024.collection.d.ts","./node_modules/typescript/lib/lib.es2024.object.d.ts","./node_modules/typescript/lib/lib.es2024.promise.d.ts","./node_modules/typescript/lib/lib.es2024.regexp.d.ts","./node_modules/typescript/lib/lib.es2024.sharedmemory.d.ts","./node_modules/typescript/lib/lib.es2024.string.d.ts","./node_modules/typescript/lib/lib.esnext.array.d.ts","./node_modules/typescript/lib/lib.esnext.collection.d.ts","./node_modules/typescript/lib/lib.esnext.intl.d.ts","./node_modules/typescript/lib/lib.esnext.disposable.d.ts","./node_modules/typescript/lib/lib.esnext.promise.d.ts","./node_modules/typescript/lib/lib.esnext.decorators.d.ts","./node_modules/typescript/lib/lib.esnext.iterator.d.ts","./node_modules/typescript/lib/lib.esnext.float16.d.ts","./node_modules/typescript/lib/lib.esnext.error.d.ts","./node_modules/typescript/lib/lib.esnext.sharedmemory.d.ts","./node_modules/typescript/lib/lib.decorators.d.ts","./node_modules/typescript/lib/lib.decorators.legacy.d.ts","./node_modules/next/dist/styled-jsx/types/css.d.ts","./node_modules/@types/react/global.d.ts","./node_modules/@types/react/node_modules/csstype/index.d.ts","./node_modules/@types/prop-types/index.d.ts","./node_modules/@types/react/index.d.ts","./node_modules/next/dist/styled-jsx/types/index.d.ts","./node_modules/next/dist/styled-jsx/types/macro.d.ts","./node_modules/next/dist/styled-jsx/types/style.d.ts","./node_modules/next/dist/styled-jsx/types/global.d.ts","./node_modules/next/dist/shared/lib/amp.d.ts","./node_modules/next/amp.d.ts","./node_modules/@types/node/compatibility/disposable.d.ts","./node_modules/@types/node/compatibility/indexable.d.ts","./node_modules/@types/node/compatibility/iterators.d.ts","./node_modules/@types/node/compatibility/index.d.ts","./node_modules/@types/node/globals.typedarray.d.ts","./node_modules/@types/node/buffer.buffer.d.ts","./node_modules/@types/node/globals.d.ts","./node_modules/@types/node/web-globals/abortcontroller.d.ts","./node_modules/@types/node/web-globals/domexception.d.ts","./node_modules/@types/node/web-globals/events.d.ts","./node_modules/buffer/index.d.ts","./node_modules/undici-types/header.d.ts","./node_modules/undici-types/readable.d.ts","./node_modules/undici-types/file.d.ts","./node_modules/undici-types/fetch.d.ts","./node_modules/undici-types/formdata.d.ts","./node_modules/undici-types/connector.d.ts","./node_modules/undici-types/client.d.ts","./node_modules/undici-types/errors.d.ts","./node_modules/undici-types/dispatcher.d.ts","./node_modules/undici-types/global-dispatcher.d.ts","./node_modules/undici-types/global-origin.d.ts","./node_modules/undici-types/pool-stats.d.ts","./node_modules/undici-types/pool.d.ts","./node_modules/undici-types/handlers.d.ts","./node_modules/undici-types/balanced-pool.d.ts","./node_modules/undici-types/agent.d.ts","./node_modules/undici-types/mock-interceptor.d.ts","./node_modules/undici-types/mock-agent.d.ts","./node_modules/undici-types/mock-client.d.ts","./node_modules/undici-types/mock-pool.d.ts","./node_modules/undici-types/mock-errors.d.ts","./node_modules/undici-types/proxy-agent.d.ts","./node_modules/undici-types/env-http-proxy-agent.d.ts","./node_modules/undici-types/retry-handler.d.ts","./node_modules/undici-types/retry-agent.d.ts","./node_modules/undici-types/api.d.ts","./node_modules/undici-types/interceptors.d.ts","./node_modules/undici-types/util.d.ts","./node_modules/undici-types/cookies.d.ts","./node_modules/undici-types/patch.d.ts","./node_modules/undici-types/websocket.d.ts","./node_modules/undici-types/eventsource.d.ts","./node_modules/undici-types/filereader.d.ts","./node_modules/undici-types/diagnostics-channel.d.ts","./node_modules/undici-types/content-type.d.ts","./node_modules/undici-types/cache.d.ts","./node_modules/undici-types/index.d.ts","./node_modules/@types/node/web-globals/fetch.d.ts","./node_modules/@types/node/assert.d.ts","./node_modules/@types/node/assert/strict.d.ts","./node_modules/@types/node/async_hooks.d.ts","./node_modules/@types/node/buffer.d.ts","./node_modules/@types/node/child_process.d.ts","./node_modules/@types/node/cluster.d.ts","./node_modules/@types/node/console.d.ts","./node_modules/@types/node/constants.d.ts","./node_modules/@types/node/crypto.d.ts","./node_modules/@types/node/dgram.d.ts","./node_modules/@types/node/diagnostics_channel.d.ts","./node_modules/@types/node/dns.d.ts","./node_modules/@types/node/dns/promises.d.ts","./node_modules/@types/node/domain.d.ts","./node_modules/@types/node/events.d.ts","./node_modules/@types/node/fs.d.ts","./node_modules/@types/node/fs/promises.d.ts","./node_modules/@types/node/http.d.ts","./node_modules/@types/node/http2.d.ts","./node_modules/@types/node/https.d.ts","./node_modules/@types/node/inspector.generated.d.ts","./node_modules/@types/node/module.d.ts","./node_modules/@types/node/net.d.ts","./node_modules/@types/node/os.d.ts","./node_modules/@types/node/path.d.ts","./node_modules/@types/node/perf_hooks.d.ts","./node_modules/@types/node/process.d.ts","./node_modules/@types/node/punycode.d.ts","./node_modules/@types/node/querystring.d.ts","./node_modules/@types/node/readline.d.ts","./node_modules/@types/node/readline/promises.d.ts","./node_modules/@types/node/repl.d.ts","./node_modules/@types/node/sea.d.ts","./node_modules/@types/node/stream.d.ts","./node_modules/@types/node/stream/promises.d.ts","./node_modules/@types/node/stream/consumers.d.ts","./node_modules/@types/node/stream/web.d.ts","./node_modules/@types/node/string_decoder.d.ts","./node_modules/@types/node/test.d.ts","./node_modules/@types/node/timers.d.ts","./node_modules/@types/node/timers/promises.d.ts","./node_modules/@types/node/tls.d.ts","./node_modules/@types/node/trace_events.d.ts","./node_modules/@types/node/tty.d.ts","./node_modules/@types/node/url.d.ts","./node_modules/@types/node/util.d.ts","./node_modules/@types/node/v8.d.ts","./node_modules/@types/node/vm.d.ts","./node_modules/@types/node/wasi.d.ts","./node_modules/@types/node/worker_threads.d.ts","./node_modules/@types/node/zlib.d.ts","./node_modules/@types/node/index.d.ts","./node_modules/next/dist/server/get-page-files.d.ts","./node_modules/@types/react/canary.d.ts","./node_modules/@types/react/experimental.d.ts","./node_modules/@types/react-dom/index.d.ts","./node_modules/@types/react-dom/canary.d.ts","./node_modules/@types/react-dom/experimental.d.ts","./node_modules/next/dist/compiled/webpack/webpack.d.ts","./node_modules/next/dist/server/config.d.ts","./node_modules/next/dist/lib/load-custom-routes.d.ts","./node_modules/next/dist/shared/lib/image-config.d.ts","./node_modules/next/dist/build/webpack/plugins/subresource-integrity-plugin.d.ts","./node_modules/next/dist/server/body-streams.d.ts","./node_modules/next/dist/server/future/route-kind.d.ts","./node_modules/next/dist/server/future/route-definitions/route-definition.d.ts","./node_modules/next/dist/server/future/route-matches/route-match.d.ts","./node_modules/next/dist/client/components/app-router-headers.d.ts","./node_modules/next/dist/server/request-meta.d.ts","./node_modules/next/dist/server/lib/revalidate.d.ts","./node_modules/next/dist/server/config-shared.d.ts","./node_modules/next/dist/server/base-http/index.d.ts","./node_modules/next/dist/server/api-utils/index.d.ts","./node_modules/next/dist/server/node-environment.d.ts","./node_modules/next/dist/server/require-hook.d.ts","./node_modules/next/dist/server/node-polyfill-crypto.d.ts","./node_modules/next/dist/lib/page-types.d.ts","./node_modules/next/dist/build/analysis/get-page-static-info.d.ts","./node_modules/next/dist/build/webpack/loaders/get-module-build-info.d.ts","./node_modules/next/dist/build/webpack/plugins/middleware-plugin.d.ts","./node_modules/next/dist/server/render-result.d.ts","./node_modules/next/dist/server/future/helpers/i18n-provider.d.ts","./node_modules/next/dist/server/web/next-url.d.ts","./node_modules/next/dist/compiled/@edge-runtime/cookies/index.d.ts","./node_modules/next/dist/server/web/spec-extension/cookies.d.ts","./node_modules/next/dist/server/web/spec-extension/request.d.ts","./node_modules/next/dist/server/web/spec-extension/fetch-event.d.ts","./node_modules/next/dist/server/web/spec-extension/response.d.ts","./node_modules/next/dist/server/web/types.d.ts","./node_modules/next/dist/lib/setup-exception-listeners.d.ts","./node_modules/next/dist/lib/constants.d.ts","./node_modules/next/dist/build/index.d.ts","./node_modules/next/dist/build/webpack/plugins/pages-manifest-plugin.d.ts","./node_modules/next/dist/shared/lib/router/utils/route-regex.d.ts","./node_modules/next/dist/shared/lib/router/utils/route-matcher.d.ts","./node_modules/next/dist/shared/lib/router/utils/parse-url.d.ts","./node_modules/next/dist/server/base-http/node.d.ts","./node_modules/next/dist/server/font-utils.d.ts","./node_modules/next/dist/build/webpack/plugins/flight-manifest-plugin.d.ts","./node_modules/next/dist/server/future/route-modules/route-module.d.ts","./node_modules/next/dist/shared/lib/deep-readonly.d.ts","./node_modules/next/dist/server/load-components.d.ts","./node_modules/next/dist/shared/lib/router/utils/middleware-route-matcher.d.ts","./node_modules/next/dist/build/webpack/plugins/next-font-manifest-plugin.d.ts","./node_modules/next/dist/server/future/route-definitions/locale-route-definition.d.ts","./node_modules/next/dist/server/future/route-definitions/pages-route-definition.d.ts","./node_modules/next/dist/shared/lib/mitt.d.ts","./node_modules/next/dist/client/with-router.d.ts","./node_modules/next/dist/client/router.d.ts","./node_modules/next/dist/client/route-loader.d.ts","./node_modules/next/dist/client/page-loader.d.ts","./node_modules/next/dist/shared/lib/bloom-filter.d.ts","./node_modules/next/dist/shared/lib/router/router.d.ts","./node_modules/next/dist/shared/lib/router-context.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/loadable-context.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/loadable.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/image-config-context.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/hooks-client-context.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/head-manager-context.shared-runtime.d.ts","./node_modules/next/dist/server/future/route-definitions/app-page-route-definition.d.ts","./node_modules/next/dist/shared/lib/modern-browserslist-target.d.ts","./node_modules/next/dist/shared/lib/constants.d.ts","./node_modules/next/dist/build/webpack/loaders/metadata/types.d.ts","./node_modules/next/dist/build/page-extensions-type.d.ts","./node_modules/next/dist/build/webpack/loaders/next-app-loader.d.ts","./node_modules/next/dist/server/lib/app-dir-module.d.ts","./node_modules/next/dist/server/response-cache/types.d.ts","./node_modules/next/dist/server/response-cache/index.d.ts","./node_modules/next/dist/server/lib/incremental-cache/index.d.ts","./node_modules/next/dist/client/components/hooks-server-context.d.ts","./node_modules/next/dist/server/app-render/dynamic-rendering.d.ts","./node_modules/next/dist/client/components/static-generation-async-storage-instance.d.ts","./node_modules/next/dist/client/components/static-generation-async-storage.external.d.ts","./node_modules/next/dist/server/web/spec-extension/adapters/request-cookies.d.ts","./node_modules/next/dist/server/async-storage/draft-mode-provider.d.ts","./node_modules/next/dist/server/web/spec-extension/adapters/headers.d.ts","./node_modules/next/dist/client/components/request-async-storage-instance.d.ts","./node_modules/next/dist/client/components/request-async-storage.external.d.ts","./node_modules/next/dist/server/app-render/create-error-handler.d.ts","./node_modules/next/dist/server/app-render/app-render.d.ts","./node_modules/next/dist/shared/lib/server-inserted-html.shared-runtime.d.ts","./node_modules/next/dist/shared/lib/amp-context.shared-runtime.d.ts","./node_modules/next/dist/server/future/route-modules/app-page/vendored/contexts/entrypoints.d.ts","./node_modules/next/dist/server/future/route-modules/app-page/module.compiled.d.ts","./node_modules/@types/react/jsx-runtime.d.ts","./node_modules/next/dist/client/components/error-boundary.d.ts","./node_modules/next/dist/client/components/router-reducer/create-initial-router-state.d.ts","./node_modules/next/dist/client/components/app-router.d.ts","./node_modules/next/dist/client/components/layout-router.d.ts","./node_modules/next/dist/client/components/render-from-template-context.d.ts","./node_modules/next/dist/client/components/action-async-storage-instance.d.ts","./node_modules/next/dist/client/components/action-async-storage.external.d.ts","./node_modules/next/dist/client/components/client-page.d.ts","./node_modules/next/dist/client/components/search-params.d.ts","./node_modules/next/dist/client/components/not-found-boundary.d.ts","./node_modules/next/dist/server/app-render/rsc/preloads.d.ts","./node_modules/next/dist/server/app-render/rsc/postpone.d.ts","./node_modules/next/dist/server/app-render/rsc/taint.d.ts","./node_modules/next/dist/server/app-render/entry-base.d.ts","./node_modules/next/dist/build/templates/app-page.d.ts","./node_modules/next/dist/server/future/route-modules/app-page/module.d.ts","./node_modules/next/dist/server/lib/builtin-request-context.d.ts","./node_modules/next/dist/server/app-render/types.d.ts","./node_modules/next/dist/client/components/router-reducer/fetch-server-response.d.ts","./node_modules/next/dist/client/components/router-reducer/router-reducer-types.d.ts","./node_modules/next/dist/shared/lib/app-router-context.shared-runtime.d.ts","./node_modules/next/dist/server/future/route-modules/pages/vendored/contexts/entrypoints.d.ts","./node_modules/next/dist/server/future/route-modules/pages/module.compiled.d.ts","./node_modules/next/dist/build/templates/pages.d.ts","./node_modules/next/dist/server/future/route-modules/pages/module.d.ts","./node_modules/next/dist/server/render.d.ts","./node_modules/next/dist/server/future/route-definitions/pages-api-route-definition.d.ts","./node_modules/next/dist/server/future/route-matches/pages-api-route-match.d.ts","./node_modules/next/dist/server/future/route-matchers/route-matcher.d.ts","./node_modules/next/dist/server/future/route-matcher-providers/route-matcher-provider.d.ts","./node_modules/next/dist/server/future/route-matcher-managers/route-matcher-manager.d.ts","./node_modules/next/dist/server/future/normalizers/normalizer.d.ts","./node_modules/next/dist/server/future/normalizers/locale-route-normalizer.d.ts","./node_modules/next/dist/server/future/normalizers/request/pathname-normalizer.d.ts","./node_modules/next/dist/server/future/normalizers/request/suffix.d.ts","./node_modules/next/dist/server/future/normalizers/request/rsc.d.ts","./node_modules/next/dist/server/future/normalizers/request/prefix.d.ts","./node_modules/next/dist/server/future/normalizers/request/postponed.d.ts","./node_modules/next/dist/server/future/normalizers/request/action.d.ts","./node_modules/next/dist/server/future/normalizers/request/prefetch-rsc.d.ts","./node_modules/next/dist/server/future/normalizers/request/next-data.d.ts","./node_modules/next/dist/server/base-server.d.ts","./node_modules/next/dist/server/image-optimizer.d.ts","./node_modules/next/dist/server/next-server.d.ts","./node_modules/next/dist/lib/coalesced-function.d.ts","./node_modules/next/dist/server/lib/router-utils/types.d.ts","./node_modules/next/dist/trace/types.d.ts","./node_modules/next/dist/trace/trace.d.ts","./node_modules/next/dist/trace/shared.d.ts","./node_modules/next/dist/trace/index.d.ts","./node_modules/next/dist/build/load-jsconfig.d.ts","./node_modules/next/dist/build/webpack-config.d.ts","./node_modules/next/dist/build/webpack/plugins/define-env-plugin.d.ts","./node_modules/next/dist/build/swc/index.d.ts","./node_modules/next/dist/server/dev/parse-version-info.d.ts","./node_modules/next/dist/server/dev/hot-reloader-types.d.ts","./node_modules/next/dist/telemetry/storage.d.ts","./node_modules/next/dist/server/lib/types.d.ts","./node_modules/next/dist/server/lib/render-server.d.ts","./node_modules/next/dist/server/lib/router-server.d.ts","./node_modules/next/dist/shared/lib/router/utils/path-match.d.ts","./node_modules/next/dist/server/lib/router-utils/filesystem.d.ts","./node_modules/next/dist/server/lib/router-utils/setup-dev-bundler.d.ts","./node_modules/next/dist/server/lib/dev-bundler-service.d.ts","./node_modules/next/dist/server/dev/static-paths-worker.d.ts","./node_modules/next/dist/server/dev/next-dev-server.d.ts","./node_modules/next/dist/server/next.d.ts","./node_modules/next/dist/lib/metadata/types/alternative-urls-types.d.ts","./node_modules/next/dist/lib/metadata/types/extra-types.d.ts","./node_modules/next/dist/lib/metadata/types/metadata-types.d.ts","./node_modules/next/dist/lib/metadata/types/manifest-types.d.ts","./node_modules/next/dist/lib/metadata/types/opengraph-types.d.ts","./node_modules/next/dist/lib/metadata/types/twitter-types.d.ts","./node_modules/next/dist/lib/metadata/types/metadata-interface.d.ts","./node_modules/next/types/index.d.ts","./node_modules/next/dist/shared/lib/html-context.shared-runtime.d.ts","./node_modules/@next/env/dist/index.d.ts","./node_modules/next/dist/shared/lib/utils.d.ts","./node_modules/next/dist/pages/_app.d.ts","./node_modules/next/app.d.ts","./node_modules/next/dist/server/web/spec-extension/unstable-cache.d.ts","./node_modules/next/dist/server/web/spec-extension/revalidate.d.ts","./node_modules/next/dist/server/web/spec-extension/unstable-no-store.d.ts","./node_modules/next/cache.d.ts","./node_modules/next/dist/shared/lib/runtime-config.external.d.ts","./node_modules/next/config.d.ts","./node_modules/next/dist/pages/_document.d.ts","./node_modules/next/document.d.ts","./node_modules/next/dist/shared/lib/dynamic.d.ts","./node_modules/next/dynamic.d.ts","./node_modules/next/dist/pages/_error.d.ts","./node_modules/next/error.d.ts","./node_modules/next/dist/shared/lib/head.d.ts","./node_modules/next/head.d.ts","./node_modules/next/dist/client/components/draft-mode.d.ts","./node_modules/next/dist/client/components/headers.d.ts","./node_modules/next/headers.d.ts","./node_modules/next/dist/shared/lib/get-img-props.d.ts","./node_modules/next/dist/client/image-component.d.ts","./node_modules/next/dist/shared/lib/image-external.d.ts","./node_modules/next/image.d.ts","./node_modules/next/dist/client/link.d.ts","./node_modules/next/link.d.ts","./node_modules/next/dist/client/components/redirect-status-code.d.ts","./node_modules/next/dist/client/components/redirect.d.ts","./node_modules/next/dist/client/components/not-found.d.ts","./node_modules/next/dist/client/components/navigation.react-server.d.ts","./node_modules/next/dist/client/components/navigation.d.ts","./node_modules/next/navigation.d.ts","./node_modules/next/router.d.ts","./node_modules/next/dist/client/script.d.ts","./node_modules/next/script.d.ts","./node_modules/next/dist/server/web/spec-extension/user-agent.d.ts","./node_modules/next/dist/compiled/@edge-runtime/primitives/url.d.ts","./node_modules/next/dist/server/web/spec-extension/image-response.d.ts","./node_modules/next/dist/compiled/@vercel/og/satori/index.d.ts","./node_modules/next/dist/compiled/@vercel/og/emoji/index.d.ts","./node_modules/next/dist/compiled/@vercel/og/types.d.ts","./node_modules/next/server.d.ts","./node_modules/next/types/global.d.ts","./node_modules/next/types/compiled.d.ts","./node_modules/next/index.d.ts","./node_modules/next/image-types/global.d.ts","./next-env.d.ts","./node_modules/csstype/index.d.ts","./node_modules/@clerk/shared/dist/runtime/index-CxV4BKo8.d.mts","./node_modules/@clerk/shared/dist/runtime/pathMatcher-DPyXUfC9.d.mts","./node_modules/@clerk/shared/dist/runtime/pathMatcher.d.mts","./node_modules/@clerk/shared/dist/types/index.d.mts","./node_modules/@clerk/types/src/index.d.mts","./node_modules/@clerk/nextjs/dist/types/server/routeMatcher.d.ts","./node_modules/@clerk/shared/dist/runtime/telemetry.d.mts","./node_modules/@clerk/backend/dist/api/resources/Enums.d.ts","./node_modules/@clerk/backend/dist/api/resources/JSON.d.ts","./node_modules/@clerk/backend/dist/api/resources/ActorToken.d.ts","./node_modules/@clerk/backend/dist/api/request.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/AbstractApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/ActorTokenApi.d.ts","./node_modules/@clerk/backend/dist/api/resources/AccountlessApplication.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/AccountlessApplicationsAPI.d.ts","./node_modules/@clerk/backend/dist/api/resources/AllowlistIdentifier.d.ts","./node_modules/@clerk/backend/dist/api/resources/DeletedObject.d.ts","./node_modules/@clerk/backend/dist/api/resources/Deserializer.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/AllowlistIdentifierApi.d.ts","./node_modules/@clerk/backend/dist/api/resources/APIKey.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/APIKeysApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/BetaFeaturesApi.d.ts","./node_modules/@clerk/backend/dist/api/resources/BlocklistIdentifier.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/BlocklistIdentifierApi.d.ts","./node_modules/@clerk/backend/dist/api/resources/Session.d.ts","./node_modules/@clerk/backend/dist/api/resources/Client.d.ts","./node_modules/@clerk/backend/dist/api/resources/HandshakePayload.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/ClientApi.d.ts","./node_modules/@clerk/backend/dist/api/resources/CnameTarget.d.ts","./node_modules/@clerk/backend/dist/api/resources/Domain.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/DomainApi.d.ts","./node_modules/@clerk/backend/dist/api/resources/Cookies.d.ts","./node_modules/@clerk/backend/dist/api/resources/Email.d.ts","./node_modules/@clerk/backend/dist/api/resources/IdentificationLink.d.ts","./node_modules/@clerk/backend/dist/api/resources/Verification.d.ts","./node_modules/@clerk/backend/dist/api/resources/EmailAddress.d.ts","./node_modules/@clerk/backend/dist/api/resources/ExternalAccount.d.ts","./node_modules/@clerk/backend/dist/api/resources/IdPOAuthAccessToken.d.ts","./node_modules/@clerk/backend/dist/api/resources/Instance.d.ts","./node_modules/@clerk/backend/dist/api/resources/InstanceRestrictions.d.ts","./node_modules/@clerk/backend/dist/api/resources/InstanceSettings.d.ts","./node_modules/@clerk/backend/dist/api/resources/Invitation.d.ts","./node_modules/@clerk/backend/dist/api/resources/Machine.d.ts","./node_modules/@clerk/backend/dist/api/resources/MachineScope.d.ts","./node_modules/@clerk/backend/dist/api/resources/MachineSecretKey.d.ts","./node_modules/@clerk/backend/dist/api/resources/M2MToken.d.ts","./node_modules/@clerk/backend/dist/api/resources/JwtTemplate.d.ts","./node_modules/@clerk/backend/dist/api/resources/OauthAccessToken.d.ts","./node_modules/@clerk/backend/dist/api/resources/OAuthApplication.d.ts","./node_modules/@clerk/backend/dist/api/resources/Organization.d.ts","./node_modules/@clerk/backend/dist/api/resources/OrganizationDomain.d.ts","./node_modules/@clerk/backend/dist/api/resources/OrganizationInvitation.d.ts","./node_modules/@clerk/backend/dist/api/resources/OrganizationMembership.d.ts","./node_modules/@clerk/backend/dist/api/resources/OrganizationSettings.d.ts","./node_modules/@clerk/backend/dist/api/resources/PhoneNumber.d.ts","./node_modules/@clerk/backend/dist/api/resources/ProxyCheck.d.ts","./node_modules/@clerk/backend/dist/api/resources/RedirectUrl.d.ts","./node_modules/@clerk/backend/dist/api/resources/SamlConnection.d.ts","./node_modules/@clerk/backend/dist/api/resources/SamlAccount.d.ts","./node_modules/@clerk/backend/dist/api/resources/SignInTokens.d.ts","./node_modules/@clerk/backend/dist/api/resources/SignUpAttempt.d.ts","./node_modules/@clerk/backend/dist/api/resources/SMSMessage.d.ts","./node_modules/@clerk/backend/dist/api/resources/TestingToken.d.ts","./node_modules/@clerk/backend/dist/api/resources/Token.d.ts","./node_modules/@clerk/backend/dist/api/resources/Web3Wallet.d.ts","./node_modules/@clerk/backend/dist/api/resources/User.d.ts","./node_modules/@clerk/backend/dist/api/resources/WaitlistEntry.d.ts","./node_modules/@clerk/backend/dist/api/resources/Feature.d.ts","./node_modules/@clerk/backend/dist/api/resources/CommercePlan.d.ts","./node_modules/@clerk/backend/dist/api/resources/CommerceSubscriptionItem.d.ts","./node_modules/@clerk/backend/dist/api/resources/CommerceSubscription.d.ts","./node_modules/@clerk/backend/dist/api/resources/Webhooks.d.ts","./node_modules/@clerk/backend/dist/api/resources/index.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/EmailAddressApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/IdPOAuthAccessTokenApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/InstanceApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/InvitationApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/util-types.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/MachineApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/M2MTokenApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/JwksApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/JwtTemplatesApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/OrganizationApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/OAuthApplicationsApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/PhoneNumberApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/ProxyCheckApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/RedirectUrlApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/SamlConnectionApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/SessionApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/SignInTokenApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/SignUpApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/TestingTokenApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/UserApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/WaitlistEntryApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/WebhookApi.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/index.d.ts","./node_modules/@clerk/backend/dist/api/endpoints/BillingApi.d.ts","./node_modules/@clerk/backend/dist/api/factory.d.ts","./node_modules/@clerk/backend/dist/api/index.d.ts","./node_modules/@clerk/backend/dist/errors.d.ts","./node_modules/@clerk/backend/dist/tokens/clerkUrl.d.ts","./node_modules/@clerk/backend/dist/tokens/clerkRequest.d.ts","./node_modules/@clerk/shared/dist/runtime/pathToRegexp.d.mts","./node_modules/@clerk/backend/dist/tokens/tokenTypes.d.ts","./node_modules/@clerk/backend/dist/tokens/authObjects.d.ts","./node_modules/@clerk/backend/dist/jwt/types.d.ts","./node_modules/@clerk/backend/dist/jwt/verifyJwt.d.ts","./node_modules/@clerk/backend/dist/jwt/signJwt.d.ts","./node_modules/@clerk/backend/dist/jwt/index.d.ts","./node_modules/@clerk/backend/dist/tokens/keys.d.ts","./node_modules/@clerk/backend/dist/tokens/verify.d.ts","./node_modules/@clerk/backend/dist/tokens/types.d.ts","./node_modules/@clerk/backend/dist/tokens/authenticateContext.d.ts","./node_modules/@clerk/backend/dist/tokens/authStatus.d.ts","./node_modules/@clerk/backend/dist/tokens/request.d.ts","./node_modules/@clerk/backend/dist/tokens/factory.d.ts","./node_modules/@clerk/backend/dist/index.d.ts","./node_modules/@clerk/nextjs/dist/types/server/clerkClient.d.ts","./node_modules/@clerk/backend/dist/constants.d.ts","./node_modules/@clerk/backend/dist/createRedirect.d.ts","./node_modules/@clerk/backend/dist/util/decorateObjectWithResources.d.ts","./node_modules/@clerk/shared/dist/runtime/authorization-errors.d.mts","./node_modules/@clerk/backend/dist/tokens/machine.d.ts","./node_modules/@clerk/backend/dist/internal.d.ts","./node_modules/@clerk/nextjs/dist/types/utils/debugLogger.d.ts","./node_modules/@clerk/nextjs/dist/types/server/types.d.ts","./node_modules/@clerk/nextjs/dist/types/server/data/getAuthDataFromRequest.d.ts","./node_modules/@clerk/nextjs/dist/types/server/createGetAuth.d.ts","./node_modules/@clerk/nextjs/dist/types/server/buildClerkProps.d.ts","./node_modules/@clerk/nextjs/dist/types/server/protect.d.ts","./node_modules/@clerk/nextjs/dist/types/app-router/server/auth.d.ts","./node_modules/@clerk/nextjs/dist/types/app-router/server/currentUser.d.ts","./node_modules/@clerk/nextjs/dist/types/server/content-security-policy.d.ts","./node_modules/@clerk/nextjs/dist/types/server/clerkMiddleware.d.ts","./node_modules/@clerk/nextjs/dist/types/server/index.d.ts","./src/middleware.ts","./src/lib/api.ts","./src/lib/personas.ts","./src/lib/types.ts","./node_modules/@clerk/clerk-react/dist/types-CFOQkf-D.d.mts","./node_modules/@clerk/clerk-react/dist/useAuth-BfjxAfMb.d.mts","./node_modules/@clerk/shared/dist/runtime/apiUrlFromPublishableKey-BMA_oB1l.d.mts","./node_modules/@clerk/shared/dist/runtime/browser-CwBluoYn.d.mts","./node_modules/@clerk/shared/dist/runtime/color-BZerM-0q.d.mts","./node_modules/@clerk/shared/dist/runtime/constants-UOcJjdve.d.mts","./node_modules/@clerk/shared/dist/runtime/date-DIGfFkoy.d.mts","./node_modules/@clerk/shared/dist/runtime/deprecated-BRApxWmG.d.mts","./node_modules/@clerk/shared/dist/runtime/deriveState-B_FJqEg_.d.mts","./node_modules/@clerk/shared/dist/runtime/devBrowser-DGNGESpp.d.mts","./node_modules/@clerk/shared/dist/runtime/error-CHhvPzCh.d.mts","./node_modules/@clerk/shared/dist/runtime/file-BgHDMp4o.d.mts","./node_modules/@clerk/shared/dist/runtime/getEnvVariable-58tQPflG.d.mts","./node_modules/@clerk/shared/dist/runtime/handleValueOrFn-2pqr_dC8.d.mts","./node_modules/@clerk/shared/dist/runtime/index-Dd9r-3AL.d.mts","./node_modules/@clerk/shared/dist/runtime/isomorphicAtob-DqIxJQZE.d.mts","./node_modules/@clerk/shared/dist/runtime/isomorphicBtoa-Cu4s1rFu.d.mts","./node_modules/@clerk/shared/dist/runtime/keys-DfnxTLxv.d.mts","./node_modules/@clerk/shared/dist/runtime/loadClerkJsScript-D5IkwUru.d.mts","./node_modules/@clerk/shared/dist/runtime/loadScript-C6SUcPSp.d.mts","./node_modules/@clerk/shared/dist/runtime/localStorageBroadcastChannel-CNmeXxpW.d.mts","./node_modules/@clerk/shared/dist/runtime/poller-I92Dozmd.d.mts","./node_modules/@clerk/shared/dist/runtime/proxy-CTzlL3aE.d.mts","./node_modules/@clerk/shared/dist/runtime/underscore-D90CHGGe.d.mts","./node_modules/@clerk/shared/dist/runtime/url-Ty-8oURg.d.mts","./node_modules/@clerk/shared/dist/runtime/versionSelector-Btv3m_NV.d.mts","./node_modules/@clerk/shared/dist/runtime/object-CgEEf_DM.d.mts","./node_modules/@clerk/shared/dist/runtime/logger-CFsSyN6O.d.mts","./node_modules/@clerk/shared/dist/runtime/index-D_rS0fDT.d.mts","./node_modules/@clerk/shared/dist/runtime/netlifyCacheHandler-DaSimV39.d.mts","./node_modules/@clerk/shared/dist/runtime/index-CoUVmp_Q.d.mts","./node_modules/dequal/index.d.ts","./node_modules/@clerk/shared/dist/runtime/react/index.d.mts","./node_modules/@clerk/clerk-react/dist/index.d.mts","./node_modules/@clerk/shared/dist/runtime/error.d.mts","./node_modules/@clerk/shared/dist/runtime/loadClerkJsScript.d.mts","./node_modules/@clerk/clerk-react/dist/internal.d.mts","./node_modules/@clerk/nextjs/dist/types/client-boundary/controlComponents.d.ts","./node_modules/@clerk/nextjs/dist/types/client-boundary/uiComponents.d.ts","./node_modules/@clerk/clerk-react/dist/errors.d.mts","./node_modules/@clerk/nextjs/dist/types/client-boundary/PromisifiedAuthProvider.d.ts","./node_modules/@clerk/nextjs/dist/types/client-boundary/hooks.d.ts","./node_modules/@clerk/nextjs/dist/types/types.d.ts","./node_modules/@clerk/nextjs/dist/types/app-router/server/ClerkProvider.d.ts","./node_modules/@clerk/nextjs/dist/types/app-router/server/controlComponents.d.ts","./node_modules/@clerk/nextjs/dist/types/components.server.d.ts","./node_modules/@clerk/nextjs/dist/types/index.d.ts","./src/lib/useCampaignName.ts","./src/lib/utils.ts","./node_modules/next-themes/dist/index.d.ts","./src/app/providers.tsx","./node_modules/lucide-react/dist/lucide-react.d.ts","./node_modules/motion-utils/dist/index.d.ts","./node_modules/motion-dom/dist/index.d.ts","./node_modules/framer-motion/dist/types.d-CQ4vRM6h.d.ts","./node_modules/framer-motion/dist/types/index.d.ts","./src/components/layout/GlobalRileyOrb.tsx","./src/components/layout/GridBackground.tsx","./node_modules/@clerk/themes/dist/defaultFoundations-BIF9oq59.d.ts","./node_modules/@clerk/themes/dist/createTheme.d.ts","./node_modules/@clerk/themes/dist/themes/dark.d.ts","./node_modules/@clerk/themes/dist/themes/shadesOfPurple.d.ts","./node_modules/@clerk/themes/dist/themes/neobrutalism.d.ts","./node_modules/@clerk/themes/dist/themes/shadcn.d.ts","./node_modules/@clerk/themes/dist/themes/simple.d.ts","./node_modules/@clerk/themes/dist/index.d.ts","./src/app/layout.tsx","./src/components/campaign/CampaignBucketCard.tsx","./src/components/layout/GlobalMenu.tsx","./src/components/dashboard/OpsDock.tsx","./src/components/dashboard/CreateCampaignModal.tsx","./node_modules/@cyntler/react-doc-viewer/dist/i18n.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/store/actions.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/store/mainStateReducer.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/utils/fileLoaders.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/models.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/DocViewer.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/bmp/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/html/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/jpg/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/msdoc/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/pdf/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/png/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/tiff/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/txt/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/csv/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/gif/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/video/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/webp/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/renderers/index.d.ts","./node_modules/@cyntler/react-doc-viewer/dist/index.d.ts","./src/components/ui/DocumentViewer.tsx","./src/components/dashboard/GlobalDocsList.tsx","./src/components/dashboard/CampaignDirectory.tsx","./src/components/ui/Greeting.tsx","./src/app/page.tsx","./src/app/(auth)/layout.tsx","./src/app/(auth)/sign-in/page.tsx","./src/app/(auth)/sign-up/page.tsx","./src/app/campaign/layout.tsx","./src/components/layout/CampaignSidebar.tsx","./src/app/campaign/[id]/layout.tsx","./src/app/campaign/[id]/page.tsx","./node_modules/@radix-ui/react-context/dist/index.d.mts","./node_modules/@radix-ui/react-primitive/dist/index.d.mts","./node_modules/@radix-ui/react-dismissable-layer/dist/index.d.mts","./node_modules/@radix-ui/react-focus-scope/dist/index.d.mts","./node_modules/@radix-ui/react-arrow/dist/index.d.mts","./node_modules/@radix-ui/rect/dist/index.d.mts","./node_modules/@radix-ui/react-popper/dist/index.d.mts","./node_modules/@radix-ui/react-portal/dist/index.d.mts","./node_modules/@radix-ui/react-popover/dist/index.d.mts","./src/components/campaign/AssetRow.tsx","./src/components/campaign/RenameAssetModal.tsx","./src/components/campaign/DeleteFileModal.tsx","./src/components/campaign/PromoteModal.tsx","./src/app/campaign/[id]/assets/page.tsx","./src/app/campaign/[id]/chat/page.tsx","./node_modules/@types/unist/index.d.ts","./node_modules/@types/hast/index.d.ts","./node_modules/vfile-message/lib/index.d.ts","./node_modules/vfile-message/index.d.ts","./node_modules/vfile/lib/index.d.ts","./node_modules/vfile/index.d.ts","./node_modules/unified/lib/callable-instance.d.ts","./node_modules/trough/lib/index.d.ts","./node_modules/trough/index.d.ts","./node_modules/unified/lib/index.d.ts","./node_modules/unified/index.d.ts","./node_modules/@types/mdast/index.d.ts","./node_modules/mdast-util-to-hast/lib/state.d.ts","./node_modules/mdast-util-to-hast/lib/footer.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/blockquote.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/break.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/code.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/delete.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/emphasis.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/footnote-reference.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/heading.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/html.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/image-reference.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/image.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/inline-code.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/link-reference.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/link.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/list-item.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/list.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/paragraph.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/root.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/strong.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/table.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/table-cell.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/table-row.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/text.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/thematic-break.d.ts","./node_modules/mdast-util-to-hast/lib/handlers/index.d.ts","./node_modules/mdast-util-to-hast/lib/index.d.ts","./node_modules/mdast-util-to-hast/index.d.ts","./node_modules/remark-rehype/lib/index.d.ts","./node_modules/remark-rehype/index.d.ts","./node_modules/react-markdown/lib/index.d.ts","./node_modules/react-markdown/index.d.ts","./node_modules/remark-breaks/lib/index.d.ts","./node_modules/remark-breaks/index.d.ts","./src/components/ui/TypewriterMarkdown.tsx","./src/components/campaign/RileyContextChat.tsx","./src/app/campaign/[id]/media/page.tsx","./node_modules/@dnd-kit/utilities/dist/hooks/useCombinedRefs.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/useEvent.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/useIsomorphicLayoutEffect.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/useInterval.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/useLatestValue.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/useLazyMemo.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/useNodeRef.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/usePrevious.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/useUniqueId.d.ts","./node_modules/@dnd-kit/utilities/dist/hooks/index.d.ts","./node_modules/@dnd-kit/utilities/dist/adjustment.d.ts","./node_modules/@dnd-kit/utilities/dist/coordinates/types.d.ts","./node_modules/@dnd-kit/utilities/dist/coordinates/getEventCoordinates.d.ts","./node_modules/@dnd-kit/utilities/dist/coordinates/index.d.ts","./node_modules/@dnd-kit/utilities/dist/css.d.ts","./node_modules/@dnd-kit/utilities/dist/event/hasViewportRelativeCoordinates.d.ts","./node_modules/@dnd-kit/utilities/dist/event/isKeyboardEvent.d.ts","./node_modules/@dnd-kit/utilities/dist/event/isTouchEvent.d.ts","./node_modules/@dnd-kit/utilities/dist/event/index.d.ts","./node_modules/@dnd-kit/utilities/dist/execution-context/canUseDOM.d.ts","./node_modules/@dnd-kit/utilities/dist/execution-context/getOwnerDocument.d.ts","./node_modules/@dnd-kit/utilities/dist/execution-context/getWindow.d.ts","./node_modules/@dnd-kit/utilities/dist/execution-context/index.d.ts","./node_modules/@dnd-kit/utilities/dist/focus/findFirstFocusableNode.d.ts","./node_modules/@dnd-kit/utilities/dist/focus/index.d.ts","./node_modules/@dnd-kit/utilities/dist/type-guards/isDocument.d.ts","./node_modules/@dnd-kit/utilities/dist/type-guards/isHTMLElement.d.ts","./node_modules/@dnd-kit/utilities/dist/type-guards/isNode.d.ts","./node_modules/@dnd-kit/utilities/dist/type-guards/isSVGElement.d.ts","./node_modules/@dnd-kit/utilities/dist/type-guards/isWindow.d.ts","./node_modules/@dnd-kit/utilities/dist/type-guards/index.d.ts","./node_modules/@dnd-kit/utilities/dist/types.d.ts","./node_modules/@dnd-kit/utilities/dist/index.d.ts","./node_modules/@dnd-kit/core/dist/types/coordinates.d.ts","./node_modules/@dnd-kit/core/dist/types/direction.d.ts","./node_modules/@dnd-kit/core/dist/utilities/algorithms/types.d.ts","./node_modules/@dnd-kit/core/dist/utilities/algorithms/closestCenter.d.ts","./node_modules/@dnd-kit/core/dist/utilities/algorithms/closestCorners.d.ts","./node_modules/@dnd-kit/core/dist/utilities/algorithms/rectIntersection.d.ts","./node_modules/@dnd-kit/core/dist/utilities/algorithms/pointerWithin.d.ts","./node_modules/@dnd-kit/core/dist/utilities/algorithms/helpers.d.ts","./node_modules/@dnd-kit/core/dist/utilities/algorithms/index.d.ts","./node_modules/@dnd-kit/core/dist/sensors/pointer/AbstractPointerSensor.d.ts","./node_modules/@dnd-kit/core/dist/sensors/pointer/PointerSensor.d.ts","./node_modules/@dnd-kit/core/dist/sensors/pointer/index.d.ts","./node_modules/@dnd-kit/core/dist/sensors/types.d.ts","./node_modules/@dnd-kit/core/dist/sensors/useSensor.d.ts","./node_modules/@dnd-kit/core/dist/sensors/useSensors.d.ts","./node_modules/@dnd-kit/core/dist/sensors/mouse/MouseSensor.d.ts","./node_modules/@dnd-kit/core/dist/sensors/mouse/index.d.ts","./node_modules/@dnd-kit/core/dist/sensors/touch/TouchSensor.d.ts","./node_modules/@dnd-kit/core/dist/sensors/touch/index.d.ts","./node_modules/@dnd-kit/core/dist/sensors/keyboard/types.d.ts","./node_modules/@dnd-kit/core/dist/sensors/keyboard/KeyboardSensor.d.ts","./node_modules/@dnd-kit/core/dist/sensors/keyboard/defaults.d.ts","./node_modules/@dnd-kit/core/dist/sensors/keyboard/index.d.ts","./node_modules/@dnd-kit/core/dist/sensors/index.d.ts","./node_modules/@dnd-kit/core/dist/types/events.d.ts","./node_modules/@dnd-kit/core/dist/types/other.d.ts","./node_modules/@dnd-kit/core/dist/types/react.d.ts","./node_modules/@dnd-kit/core/dist/types/rect.d.ts","./node_modules/@dnd-kit/core/dist/types/index.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useAutoScroller.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useCachedNode.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useSyntheticListeners.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useCombineActivators.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useDroppableMeasuring.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useInitialValue.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useInitialRect.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useRect.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useRectDelta.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useResizeObserver.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useScrollableAncestors.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useScrollIntoViewIfNeeded.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useScrollOffsets.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useScrollOffsetsDelta.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useSensorSetup.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useRects.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useWindowRect.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/useDragOverlayMeasuring.d.ts","./node_modules/@dnd-kit/core/dist/hooks/utilities/index.d.ts","./node_modules/@dnd-kit/core/dist/store/constructors.d.ts","./node_modules/@dnd-kit/core/dist/store/types.d.ts","./node_modules/@dnd-kit/core/dist/store/actions.d.ts","./node_modules/@dnd-kit/core/dist/store/context.d.ts","./node_modules/@dnd-kit/core/dist/store/reducer.d.ts","./node_modules/@dnd-kit/core/dist/store/index.d.ts","./node_modules/@dnd-kit/core/dist/components/Accessibility/types.d.ts","./node_modules/@dnd-kit/core/dist/components/Accessibility/Accessibility.d.ts","./node_modules/@dnd-kit/core/dist/components/Accessibility/components/RestoreFocus.d.ts","./node_modules/@dnd-kit/core/dist/components/Accessibility/components/index.d.ts","./node_modules/@dnd-kit/core/dist/components/Accessibility/defaults.d.ts","./node_modules/@dnd-kit/core/dist/components/Accessibility/index.d.ts","./node_modules/@dnd-kit/core/dist/utilities/coordinates/constants.d.ts","./node_modules/@dnd-kit/core/dist/utilities/coordinates/distanceBetweenPoints.d.ts","./node_modules/@dnd-kit/core/dist/utilities/coordinates/getRelativeTransformOrigin.d.ts","./node_modules/@dnd-kit/core/dist/utilities/coordinates/index.d.ts","./node_modules/@dnd-kit/core/dist/utilities/rect/adjustScale.d.ts","./node_modules/@dnd-kit/core/dist/utilities/rect/getRectDelta.d.ts","./node_modules/@dnd-kit/core/dist/utilities/rect/rectAdjustment.d.ts","./node_modules/@dnd-kit/core/dist/utilities/rect/getRect.d.ts","./node_modules/@dnd-kit/core/dist/utilities/rect/getWindowClientRect.d.ts","./node_modules/@dnd-kit/core/dist/utilities/rect/Rect.d.ts","./node_modules/@dnd-kit/core/dist/utilities/rect/index.d.ts","./node_modules/@dnd-kit/core/dist/utilities/other/noop.d.ts","./node_modules/@dnd-kit/core/dist/utilities/other/index.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/getScrollableAncestors.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/getScrollableElement.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/getScrollCoordinates.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/getScrollDirectionAndSpeed.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/getScrollElementRect.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/getScrollOffsets.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/getScrollPosition.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/documentScrollingElement.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/isScrollable.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/scrollIntoViewIfNeeded.d.ts","./node_modules/@dnd-kit/core/dist/utilities/scroll/index.d.ts","./node_modules/@dnd-kit/core/dist/utilities/index.d.ts","./node_modules/@dnd-kit/core/dist/modifiers/types.d.ts","./node_modules/@dnd-kit/core/dist/modifiers/applyModifiers.d.ts","./node_modules/@dnd-kit/core/dist/modifiers/index.d.ts","./node_modules/@dnd-kit/core/dist/components/DndContext/types.d.ts","./node_modules/@dnd-kit/core/dist/components/DndContext/DndContext.d.ts","./node_modules/@dnd-kit/core/dist/components/DndContext/index.d.ts","./node_modules/@dnd-kit/core/dist/components/DndMonitor/types.d.ts","./node_modules/@dnd-kit/core/dist/components/DndMonitor/context.d.ts","./node_modules/@dnd-kit/core/dist/components/DndMonitor/useDndMonitor.d.ts","./node_modules/@dnd-kit/core/dist/components/DndMonitor/useDndMonitorProvider.d.ts","./node_modules/@dnd-kit/core/dist/components/DndMonitor/index.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/components/AnimationManager/AnimationManager.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/components/AnimationManager/index.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/components/NullifiedContextProvider/NullifiedContextProvider.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/components/NullifiedContextProvider/index.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/components/PositionedOverlay/PositionedOverlay.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/components/PositionedOverlay/index.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/components/index.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/hooks/useDropAnimation.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/hooks/useKey.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/hooks/index.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/DragOverlay.d.ts","./node_modules/@dnd-kit/core/dist/components/DragOverlay/index.d.ts","./node_modules/@dnd-kit/core/dist/components/index.d.ts","./node_modules/@dnd-kit/core/dist/hooks/useDraggable.d.ts","./node_modules/@dnd-kit/core/dist/hooks/useDndContext.d.ts","./node_modules/@dnd-kit/core/dist/hooks/useDroppable.d.ts","./node_modules/@dnd-kit/core/dist/hooks/index.d.ts","./node_modules/@dnd-kit/core/dist/index.d.ts","./node_modules/@dnd-kit/sortable/dist/types/disabled.d.ts","./node_modules/@dnd-kit/sortable/dist/types/data.d.ts","./node_modules/@dnd-kit/sortable/dist/types/strategies.d.ts","./node_modules/@dnd-kit/sortable/dist/types/type-guard.d.ts","./node_modules/@dnd-kit/sortable/dist/types/index.d.ts","./node_modules/@dnd-kit/sortable/dist/components/SortableContext.d.ts","./node_modules/@dnd-kit/sortable/dist/components/index.d.ts","./node_modules/@dnd-kit/sortable/dist/hooks/types.d.ts","./node_modules/@dnd-kit/sortable/dist/hooks/useSortable.d.ts","./node_modules/@dnd-kit/sortable/dist/hooks/defaults.d.ts","./node_modules/@dnd-kit/sortable/dist/hooks/index.d.ts","./node_modules/@dnd-kit/sortable/dist/strategies/horizontalListSorting.d.ts","./node_modules/@dnd-kit/sortable/dist/strategies/rectSorting.d.ts","./node_modules/@dnd-kit/sortable/dist/strategies/rectSwapping.d.ts","./node_modules/@dnd-kit/sortable/dist/strategies/verticalListSorting.d.ts","./node_modules/@dnd-kit/sortable/dist/strategies/index.d.ts","./node_modules/@dnd-kit/sortable/dist/sensors/keyboard/sortableKeyboardCoordinates.d.ts","./node_modules/@dnd-kit/sortable/dist/sensors/keyboard/index.d.ts","./node_modules/@dnd-kit/sortable/dist/sensors/index.d.ts","./node_modules/@dnd-kit/sortable/dist/utilities/arrayMove.d.ts","./node_modules/@dnd-kit/sortable/dist/utilities/arraySwap.d.ts","./node_modules/@dnd-kit/sortable/dist/utilities/getSortedRects.d.ts","./node_modules/@dnd-kit/sortable/dist/utilities/isValidIndex.d.ts","./node_modules/@dnd-kit/sortable/dist/utilities/itemsEqual.d.ts","./node_modules/@dnd-kit/sortable/dist/utilities/normalizeDisabled.d.ts","./node_modules/@dnd-kit/sortable/dist/utilities/index.d.ts","./node_modules/@dnd-kit/sortable/dist/index.d.ts","./src/components/campaign/KanbanBoard.tsx","./src/components/campaign/AssignmentModal.tsx","./src/app/campaign/[id]/messaging/page.tsx","./src/app/campaign/[id]/pitch/page.tsx","./src/app/campaign/[id]/research/page.tsx","./src/components/chat/RileyStudio.tsx","./src/app/campaign/[id]/riley/page.tsx","./src/app/campaign/[id]/strategy/page.tsx","./src/app/riley/page.tsx","./src/components/TypewriterMarkdown.tsx","./src/components/ChatInterface.tsx","./src/components/KnowledgeBasket.tsx","./src/components/RileyAssistant.tsx","./src/components/SearchInterface.tsx","./src/components/ui/NotificationBell.tsx","./src/components/ui/RileyOrb.tsx","./src/components/layout/Shell.tsx","./src/components/layout/ShootingStars.tsx","./src/components/ui/ScrambleText.tsx","./.next/types/app/page.ts","./.next/types/app/(auth)/layout.ts","./.next/types/app/(auth)/sign-in/page.ts","./.next/types/app/(auth)/sign-up/page.ts","./.next/types/app/campaign/layout.ts","./.next/types/app/campaign/[id]/layout.ts","./.next/types/app/campaign/[id]/page.ts","./.next/types/app/campaign/[id]/assets/page.ts","./.next/types/app/campaign/[id]/chat/page.ts","./.next/types/app/campaign/[id]/media/page.ts","./.next/types/app/campaign/[id]/messaging/page.ts","./.next/types/app/campaign/[id]/pitch/page.ts","./.next/types/app/campaign/[id]/research/page.ts","./.next/types/app/campaign/[id]/riley/page.ts","./.next/types/app/campaign/[id]/strategy/page.ts","./.next/types/app/riley/page.ts","./node_modules/@types/ms/index.d.ts","./node_modules/@types/debug/index.d.ts","./node_modules/@types/estree/index.d.ts","./node_modules/@types/estree-jsx/index.d.ts","./node_modules/@types/json5/index.d.ts","./node_modules/@types/mustache/index.d.ts","./node_modules/@types/papaparse/index.d.ts","./node_modules/@types/stylis/index.d.ts"],"fileIdsList":[[99,146,361,648],[99,146,361,649],[99,146,361,650],[99,146,361,668],[99,146,361,669],[99,146,361,653],[99,146,361,718],[99,146,361,895],[99,146,361,654],[99,146,361,896],[99,146,361,897],[99,146,361,899],[99,146,361,900],[99,146,361,651],[99,146,361,647],[99,146,361,901],[99,146,409,410],[99,146,416,424,429,430,432],[99,146,423],[99,146,424,426],[99,146,422,424],[99,146,417,424,428,429,430],[99,146,424],[99,146,417,424,430,481,482,483],[99,146,417,424,429,430,435],[99,146,417,424,430,438,439],[99,146,424,429,430,442],[99,146,424,485],[99,146,424,451,452,466],[99,146,417,420,424,430,454],[99,146,421,424],[99,146,417,424,485],[99,146,424,458],[99,146,417,424,430,455,456,457,490],[99,146,417,424,430,461,485,490],[99,146,417,420,424,430,485,490],[99,146,424,430,469],[99,146,417,424,430,485,490],[99,146,417,424,430,437,444,476],[99,146,424,472],[99,146,424,473],[99,146,424,475],[99,146,417,420,424,429,430,479,490],[99,146,424,425,427,431,433,434,436,440,443,486,487,488,489,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507],[99,146],[99,146,423,508,509],[99,146,485,510],[99,146,417],[99,146,421],[99,146,420,421],[99,146,417,421,437],[99,146,416,421,480],[99,146,417,421,482],[99,146,417,421,481],[99,146,421,441],[99,146,421,446,447],[99,146,421,447],[99,146,417,421],[99,146,417,420],[99,146,420,421,447],[99,146,420,421,485],[99,146,421,447,470],[99,146,417,420,421],[99,146,421,448,449,467,471,477],[99,146,420,421,454],[99,146,417,420,421,422,426,428,429,432,435,437,438,441,442,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484],[99,146,417,419,421,484,485,511,517,523,524,528],[99,146,514,516,517,523,524,526,527,528,531,532,533,534,535],[99,146,417,519,520],[99,146,518],[99,146,516],[99,146,417,512,518],[99,146,417,511,516,524,525],[99,146,417,512,516,517,524,525],[99,146,514,524],[99,146,513],[99,146,511,524,526,527],[99,146,516,524],[99,146,516,524,526],[99,146,417,511,515,516,517,523],[99,146,416,511,512,516,518,521,522],[99,146,511,517],[99,146,586],[87,99,146,416,552,553,584],[87,99,146,416,552,553,586,587],[87,99,146,416],[87,99,146,416,552],[87,99,146,417,594],[99,146,396,529,536,542],[87,99,146,417,585],[99,146,417,529],[99,146,585,588],[99,146,585,591,592],[87,99,146,585],[99,146,595,596],[99,146,589,590,593,597],[99,146,529,538],[99,146,529],[99,146,406,529,536,538,543,545],[99,146,417,529,536,538,539],[99,146,417,529,536,537,538],[99,146,418,529,530,536,540,541,543,544,546],[99,146,417,529,536],[99,146,390,406,415,417],[99,146,160,215,406,409],[99,146,417,585],[99,146,413],[99,146,413,562],[99,146,412],[99,146,413,570],[99,146,413,414],[87,99,146,413,414,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583],[99,146,416,610],[99,146,416],[99,146,416,610,611,612,613,614,615,616],[87,99,146,623,627],[99,146,623,626,627,628,641],[87,99,146,625,626],[99,146,642],[99,146,629,630,631,632,633,634,635,636,637,638,639,640],[99,146,627],[99,146,623,624,642],[87,99,146,806],[99,146,808],[99,146,806],[99,146,806,807,809,810],[99,146,805],[87,99,146,751,775,780,799,811,836,839,840],[99,146,840,841],[99,146,780,799],[87,99,146,843],[99,146,843,844,845,846],[99,146,780],[99,146,843],[87,99,146,839,854,857],[87,99,146,780],[99,146,848],[87,99,146],[99,146,850],[87,99,146,751,780],[99,146,852],[99,146,849,851,853],[99,146,855,856],[99,146,751,780,805,842],[99,146,857,858],[99,146,811,842,847,859],[99,146,799,861,862,863],[87,99,146,805],[87,99,146,751,780,799,805],[87,99,146,780,805],[99,146,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798],[99,146,780,805],[99,146,775,783],[99,146,780,801],[99,146,730,780],[99,146,751],[99,146,775],[99,146,865],[99,146,775,780,805,836,839,860,864],[99,146,751,837],[99,146,837,838],[99,146,751,780,805],[99,146,763,764,765,766,768,770,774],[99,146,764,771],[99,146,771],[99,146,771,772,773],[99,146,764,780],[87,99,146,763,764],[99,146,767],[87,99,146,761,764],[99,146,761,762],[99,146,769],[87,99,146,760,763,780,805],[99,146,764],[87,99,146,801],[99,146,801,802,803,804],[99,146,801,802],[87,99,146,751,760,780,799,800,802,860],[99,146,752,760,775,780,805],[99,146,752,753,776,777,778,779],[87,99,146,751],[99,146,754],[99,146,754,780],[99,146,754,755,756,757,758,759],[99,146,812,813,814],[99,146,760,815,822,824,835],[99,146,823],[99,146,779],[99,146,751,780],[99,146,816,817,818,819,820,821],[99,146,825,826,827,828,829,830,831,832,833,834],[87,99,146,865,870],[99,146,871],[99,146,873],[99,146,873,874,875],[99,146,751,865],[87,99,146,751,799,865,870,873],[99,146,870,872,876,881,884,891],[99,146,883],[99,146,882],[99,146,870],[99,146,877,878,879,880],[99,146,866,867,868,869],[99,146,865,867],[99,146,885,886,887,888,889,890],[99,146,730],[99,146,730,731],[99,146,734,735,736],[99,146,738,739,740],[99,146,742],[99,146,719,720,721,722,723,724,725,726,727],[99,146,728,729,732,733,737,741,743,749,750],[99,146,744,745,746,747,748],[87,99,146,656],[87,99,146,655,656,657,658,661,662],[87,99,146,655,656,659,660],[99,146,928],[99,146,930,931],[99,146,670],[99,143,146],[99,145,146],[146],[99,146,151,179],[99,146,147,152,157,165,176,187],[99,146,147,148,157,165],[94,95,96,99,146],[99,146,149,188],[99,146,150,151,158,166],[99,146,151,176,184],[99,146,152,154,157,165],[99,145,146,153],[99,146,154,155],[99,146,156,157],[99,145,146,157],[99,146,157,158,159,176,187],[99,146,157,158,159,172,176,179],[99,146,154,157,160,165,176,187],[99,146,157,158,160,161,165,176,184,187],[99,146,160,162,176,184,187],[97,98,99,100,101,102,103,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193],[99,146,157,163],[99,146,164,187,192],[99,146,154,157,165,176],[99,146,166],[99,146,167],[99,145,146,168],[99,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193],[99,146,170],[99,146,171],[99,146,157,172,173],[99,146,172,174,188,190],[99,146,157,176,177,179],[99,146,178,179],[99,146,176,177],[99,146,179],[99,146,180],[99,143,146,176,181],[99,146,157,182,183],[99,146,182,183],[99,146,151,165,176,184],[99,146,185],[99,146,165,186],[99,146,160,171,187],[99,146,151,188],[99,146,176,189],[99,146,164,190],[99,146,191],[99,141,146],[99,141,146,157,159,168,176,179,187,190,192],[99,146,176,193],[99,146,176,194],[87,99,146,198,199,200],[87,99,146,198,199],[87,91,99,146,197,362,405],[87,91,99,146,196,362,405],[84,85,86,99,146],[87,99,146,605],[87,99,146,287,604,605,606],[99,146,671,681,682,683,707,708,709],[99,146,671,682,709],[99,146,671,681,682,709],[99,146,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706],[99,146,671,675,681,683,709],[99,146,604],[92,99,146],[99,146,366],[99,146,368,369,370],[99,146,372],[99,146,203,213,219,221,362],[99,146,203,210,212,215,233],[99,146,213],[99,146,213,215,340],[99,146,268,286,301,408],[99,146,310],[99,146,203,213,220,254,264,337,338,408],[99,146,220,408],[99,146,213,264,265,266,408],[99,146,213,220,254,408],[99,146,408],[99,146,203,220,221,408],[99,146,294],[99,145,146,194,293],[87,99,146,287,288,289,307,308],[87,99,146,287],[99,146,277],[99,146,276,278,382],[87,99,146,287,288,305],[99,146,283,308,394],[99,146,392,393],[99,146,227,391],[99,146,280],[99,145,146,194,227,243,276,277,278,279],[87,99,146,305,307,308],[99,146,305,307],[99,146,305,306,308],[99,146,171,194],[99,146,275],[99,145,146,194,212,214,271,272,273,274],[87,99,146,204,385],[87,99,146,187,194],[87,99,146,220,252],[87,99,146,220],[99,146,250,255],[87,99,146,251,365],[87,91,99,146,160,194,196,197,362,403,404],[99,146,362],[99,146,202],[99,146,355,356,357,358,359,360],[99,146,357],[87,99,146,251,287,365],[87,99,146,287,363,365],[87,99,146,287,365],[99,146,160,194,214,365],[99,146,160,194,211,212,223,241,243,275,280,281,303,305],[99,146,272,275,280,288,290,291,292,294,295,296,297,298,299,300,408],[99,146,273],[87,99,146,171,194,212,213,241,243,244,246,271,303,304,308,362,408],[99,146,160,194,214,215,227,228,276],[99,146,160,194,213,215],[99,146,160,176,194,211,214,215],[99,146,160,171,187,194,211,212,213,214,215,220,223,224,234,235,237,240,241,243,244,245,246,270,271,304,305,313,315,318,320,323,325,326,327,328],[99,146,160,176,194],[99,146,203,204,205,211,212,362,365,408],[99,146,160,176,187,194,208,339,341,342,408],[99,146,171,187,194,208,211,214,231,235,237,238,239,244,271,318,329,331,337,351,352],[99,146,213,217,271],[99,146,211,213],[99,146,224,319],[99,146,321,322],[99,146,321],[99,146,319],[99,146,321,324],[99,146,207,208],[99,146,207,247],[99,146,207],[99,146,209,224,317],[99,146,316],[99,146,208,209],[99,146,209,314],[99,146,208],[99,146,303],[99,146,160,194,211,223,242,262,268,282,285,302,305],[99,146,256,257,258,259,260,261,283,284,308,363],[99,146,312],[99,146,160,194,211,223,242,248,309,311,313,362,365],[99,146,160,187,194,204,211,213,270],[99,146,267],[99,146,160,194,345,350],[99,146,234,243,270,365],[99,146,333,337,351,354],[99,146,160,217,337,345,346,354],[99,146,203,213,234,245,348],[99,146,160,194,213,220,245,332,333,343,344,347,349],[99,146,195,241,242,243,362,365],[99,146,160,171,187,194,209,211,212,214,217,222,223,231,234,235,237,238,239,240,244,246,270,271,315,329,330,365],[99,146,160,194,211,213,217,331,353],[99,146,160,194,212,214],[87,99,146,160,171,194,202,204,211,212,215,223,240,241,243,244,246,312,362,365],[99,146,160,171,187,194,206,209,210,214],[99,146,207,269],[99,146,160,194,207,212,223],[99,146,160,194,213,224],[99,146,160,194],[99,146,227],[99,146,226],[99,146,228],[99,146,213,225,227,231],[99,146,213,225,227],[99,146,160,194,206,213,214,220,228,229,230],[87,99,146,305,306,307],[99,146,263],[87,99,146,204],[87,99,146,237],[87,99,146,195,240,243,246,362,365],[99,146,204,385,386],[87,99,146,255],[87,99,146,171,187,194,202,249,251,253,254,365],[99,146,214,220,237],[99,146,236],[87,99,146,158,160,171,194,202,255,264,362,363,364],[83,87,88,89,90,99,146,196,197,362,405],[99,146,151],[99,146,334,335,336],[99,146,334],[99,146,374],[99,146,376],[99,146,378],[99,146,380],[99,146,383],[99,146,387],[91,93,99,146,362,367,371,373,375,377,379,381,384,388,390,396,397,399,406,407,408],[99,146,389],[99,146,395],[99,146,251],[99,146,398],[99,145,146,228,229,230,231,400,401,402,405],[99,146,194],[87,91,99,146,160,162,171,194,196,197,198,200,202,215,354,361,365,405],[99,146,712],[87,99,146,671,680,709,711],[99,146,714],[99,146,681,709],[99,146,709,710],[99,146,671,675,680,681,709],[99,146,677],[99,113,117,146,187],[99,113,146,176,187],[99,108,146],[99,110,113,146,184,187],[99,146,165,184],[99,108,146,194],[99,110,113,146,165,187],[99,105,106,109,112,146,157,176,187],[99,113,120,146],[99,105,111,146],[99,113,134,135,146],[99,109,113,146,179,187,194],[99,134,146,194],[99,107,108,146,194],[99,113,146],[99,107,108,109,110,111,112,113,114,115,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,135,136,137,138,139,140,146],[99,113,128,146],[99,113,120,121,146],[99,111,113,121,122,146],[99,112,146],[99,105,108,113,146],[99,113,117,121,122,146],[99,117,146],[99,111,113,116,146,187],[99,105,110,113,120,146],[99,146,176],[99,108,113,134,146,192,194],[99,146,675,679],[99,146,670,675,676,678,680],[99,146,672],[99,146,673,674],[99,146,670,673,675],[99,146,598],[87,99,146,396,549,551,598,603,643,664,665,666,667],[87,99,146,396,549,598,599,600,603],[87,99,146,600,652],[87,99,146,396,549,551,598,600,603,643,717],[87,99,146,396,549,551,598,603,643,717,893,894],[99,146,396,600,603],[99,146,396,599,898],[99,146,409,598,600,602,608,609,617],[87,99,146,549,598,619,620,621,622,645,646],[99,146,601],[99,146,390,603,898],[87,99,146,549,550,598,600,603,902],[87,99,146,549,598,600,603],[87,99,146,600,603],[87,99,146,713],[87,99,146,549,551,598,600,603,663],[87,99,146,390,600,601,603,607],[87,99,146,551,600,603],[87,99,146,551,600,603,643,751,865,892],[87,99,146,600,603,607],[87,99,146,549,598,600,603,713,716],[87,99,146,549,598,600,603,713,715,716],[87,99,146,390,549,551,598,600,603,607,619,644],[87,99,146,549,598,600,603,607],[87,99,146,549,551,598,600,603,643],[99,146,390,600,603],[87,99,146,390,396,598,600,603],[87,99,146,396,598,600,601,603,607],[87,99,146,396,607],[87,99,146,390,396,600,603,607,903,907,908],[87,99,146,601],[87,99,146,551,600,603,607,642],[87,99,146,598],[87,99,146,600],[87,99,146,713,715],[87,99,146,549,598],[99,146,547]],"fileInfos":[{"version":"c430d44666289dae81f30fa7b2edebf186ecc91a2d4c71266ea6ae76388792e1","affectsGlobalScope":true,"impliedFormat":1},{"version":"45b7ab580deca34ae9729e97c13cfd999df04416a79116c3bfb483804f85ded4","impliedFormat":1},{"version":"3facaf05f0c5fc569c5649dd359892c98a85557e3e0c847964caeb67076f4d75","impliedFormat":1},{"version":"e44bb8bbac7f10ecc786703fe0a6a4b952189f908707980ba8f3c8975a760962","impliedFormat":1},{"version":"5e1c4c362065a6b95ff952c0eab010f04dcd2c3494e813b493ecfd4fcb9fc0d8","impliedFormat":1},{"version":"68d73b4a11549f9c0b7d352d10e91e5dca8faa3322bfb77b661839c42b1ddec7","impliedFormat":1},{"version":"5efce4fc3c29ea84e8928f97adec086e3dc876365e0982cc8479a07954a3efd4","impliedFormat":1},{"version":"feecb1be483ed332fad555aff858affd90a48ab19ba7272ee084704eb7167569","impliedFormat":1},{"version":"ee7bad0c15b58988daa84371e0b89d313b762ab83cb5b31b8a2d1162e8eb41c2","impliedFormat":1},{"version":"27bdc30a0e32783366a5abeda841bc22757c1797de8681bbe81fbc735eeb1c10","impliedFormat":1},{"version":"8fd575e12870e9944c7e1d62e1f5a73fcf23dd8d3a321f2a2c74c20d022283fe","impliedFormat":1},{"version":"2ab096661c711e4a81cc464fa1e6feb929a54f5340b46b0a07ac6bbf857471f0","impliedFormat":1},{"version":"080941d9f9ff9307f7e27a83bcd888b7c8270716c39af943532438932ec1d0b9","affectsGlobalScope":true,"impliedFormat":1},{"version":"2e80ee7a49e8ac312cc11b77f1475804bee36b3b2bc896bead8b6e1266befb43","affectsGlobalScope":true,"impliedFormat":1},{"version":"c57796738e7f83dbc4b8e65132f11a377649c00dd3eee333f672b8f0a6bea671","affectsGlobalScope":true,"impliedFormat":1},{"version":"dc2df20b1bcdc8c2d34af4926e2c3ab15ffe1160a63e58b7e09833f616efff44","affectsGlobalScope":true,"impliedFormat":1},{"version":"515d0b7b9bea2e31ea4ec968e9edd2c39d3eebf4a2d5cbd04e88639819ae3b71","affectsGlobalScope":true,"impliedFormat":1},{"version":"0559b1f683ac7505ae451f9a96ce4c3c92bdc71411651ca6ddb0e88baaaad6a3","affectsGlobalScope":true,"impliedFormat":1},{"version":"0dc1e7ceda9b8b9b455c3a2d67b0412feab00bd2f66656cd8850e8831b08b537","affectsGlobalScope":true,"impliedFormat":1},{"version":"ce691fb9e5c64efb9547083e4a34091bcbe5bdb41027e310ebba8f7d96a98671","affectsGlobalScope":true,"impliedFormat":1},{"version":"8d697a2a929a5fcb38b7a65594020fcef05ec1630804a33748829c5ff53640d0","affectsGlobalScope":true,"impliedFormat":1},{"version":"4ff2a353abf8a80ee399af572debb8faab2d33ad38c4b4474cff7f26e7653b8d","affectsGlobalScope":true,"impliedFormat":1},{"version":"fb0f136d372979348d59b3f5020b4cdb81b5504192b1cacff5d1fbba29378aa1","affectsGlobalScope":true,"impliedFormat":1},{"version":"d15bea3d62cbbdb9797079416b8ac375ae99162a7fba5de2c6c505446486ac0a","affectsGlobalScope":true,"impliedFormat":1},{"version":"68d18b664c9d32a7336a70235958b8997ebc1c3b8505f4f1ae2b7e7753b87618","affectsGlobalScope":true,"impliedFormat":1},{"version":"eb3d66c8327153d8fa7dd03f9c58d351107fe824c79e9b56b462935176cdf12a","affectsGlobalScope":true,"impliedFormat":1},{"version":"38f0219c9e23c915ef9790ab1d680440d95419ad264816fa15009a8851e79119","affectsGlobalScope":true,"impliedFormat":1},{"version":"69ab18c3b76cd9b1be3d188eaf8bba06112ebbe2f47f6c322b5105a6fbc45a2e","affectsGlobalScope":true,"impliedFormat":1},{"version":"a680117f487a4d2f30ea46f1b4b7f58bef1480456e18ba53ee85c2746eeca012","affectsGlobalScope":true,"impliedFormat":1},{"version":"2f11ff796926e0832f9ae148008138ad583bd181899ab7dd768a2666700b1893","affectsGlobalScope":true,"impliedFormat":1},{"version":"4de680d5bb41c17f7f68e0419412ca23c98d5749dcaaea1896172f06435891fc","affectsGlobalScope":true,"impliedFormat":1},{"version":"954296b30da6d508a104a3a0b5d96b76495c709785c1d11610908e63481ee667","affectsGlobalScope":true,"impliedFormat":1},{"version":"ac9538681b19688c8eae65811b329d3744af679e0bdfa5d842d0e32524c73e1c","affectsGlobalScope":true,"impliedFormat":1},{"version":"0a969edff4bd52585473d24995c5ef223f6652d6ef46193309b3921d65dd4376","affectsGlobalScope":true,"impliedFormat":1},{"version":"9e9fbd7030c440b33d021da145d3232984c8bb7916f277e8ffd3dc2e3eae2bdb","affectsGlobalScope":true,"impliedFormat":1},{"version":"811ec78f7fefcabbda4bfa93b3eb67d9ae166ef95f9bff989d964061cbf81a0c","affectsGlobalScope":true,"impliedFormat":1},{"version":"717937616a17072082152a2ef351cb51f98802fb4b2fdabd32399843875974ca","affectsGlobalScope":true,"impliedFormat":1},{"version":"d7e7d9b7b50e5f22c915b525acc5a49a7a6584cf8f62d0569e557c5cfc4b2ac2","affectsGlobalScope":true,"impliedFormat":1},{"version":"71c37f4c9543f31dfced6c7840e068c5a5aacb7b89111a4364b1d5276b852557","affectsGlobalScope":true,"impliedFormat":1},{"version":"576711e016cf4f1804676043e6a0a5414252560eb57de9faceee34d79798c850","affectsGlobalScope":true,"impliedFormat":1},{"version":"89c1b1281ba7b8a96efc676b11b264de7a8374c5ea1e6617f11880a13fc56dc6","affectsGlobalScope":true,"impliedFormat":1},{"version":"74f7fa2d027d5b33eb0471c8e82a6c87216223181ec31247c357a3e8e2fddc5b","affectsGlobalScope":true,"impliedFormat":1},{"version":"d6d7ae4d1f1f3772e2a3cde568ed08991a8ae34a080ff1151af28b7f798e22ca","affectsGlobalScope":true,"impliedFormat":1},{"version":"063600664504610fe3e99b717a1223f8b1900087fab0b4cad1496a114744f8df","affectsGlobalScope":true,"impliedFormat":1},{"version":"934019d7e3c81950f9a8426d093458b65d5aff2c7c1511233c0fd5b941e608ab","affectsGlobalScope":true,"impliedFormat":1},{"version":"52ada8e0b6e0482b728070b7639ee42e83a9b1c22d205992756fe020fd9f4a47","affectsGlobalScope":true,"impliedFormat":1},{"version":"3bdefe1bfd4d6dee0e26f928f93ccc128f1b64d5d501ff4a8cf3c6371200e5e6","affectsGlobalScope":true,"impliedFormat":1},{"version":"59fb2c069260b4ba00b5643b907ef5d5341b167e7d1dbf58dfd895658bda2867","affectsGlobalScope":true,"impliedFormat":1},{"version":"639e512c0dfc3fad96a84caad71b8834d66329a1f28dc95e3946c9b58176c73a","affectsGlobalScope":true,"impliedFormat":1},{"version":"368af93f74c9c932edd84c58883e736c9e3d53cec1fe24c0b0ff451f529ceab1","affectsGlobalScope":true,"impliedFormat":1},{"version":"af3dd424cf267428f30ccfc376f47a2c0114546b55c44d8c0f1d57d841e28d74","affectsGlobalScope":true,"impliedFormat":1},{"version":"995c005ab91a498455ea8dfb63aa9f83fa2ea793c3d8aa344be4a1678d06d399","affectsGlobalScope":true,"impliedFormat":1},{"version":"959d36cddf5e7d572a65045b876f2956c973a586da58e5d26cde519184fd9b8a","affectsGlobalScope":true,"impliedFormat":1},{"version":"965f36eae237dd74e6cca203a43e9ca801ce38824ead814728a2807b1910117d","affectsGlobalScope":true,"impliedFormat":1},{"version":"3925a6c820dcb1a06506c90b1577db1fdbf7705d65b62b99dce4be75c637e26b","affectsGlobalScope":true,"impliedFormat":1},{"version":"0a3d63ef2b853447ec4f749d3f368ce642264246e02911fcb1590d8c161b8005","affectsGlobalScope":true,"impliedFormat":1},{"version":"8cdf8847677ac7d20486e54dd3fcf09eda95812ac8ace44b4418da1bbbab6eb8","affectsGlobalScope":true,"impliedFormat":1},{"version":"8444af78980e3b20b49324f4a16ba35024fef3ee069a0eb67616ea6ca821c47a","affectsGlobalScope":true,"impliedFormat":1},{"version":"3287d9d085fbd618c3971944b65b4be57859f5415f495b33a6adc994edd2f004","affectsGlobalScope":true,"impliedFormat":1},{"version":"b4b67b1a91182421f5df999988c690f14d813b9850b40acd06ed44691f6727ad","affectsGlobalScope":true,"impliedFormat":1},{"version":"df83c2a6c73228b625b0beb6669c7ee2a09c914637e2d35170723ad49c0f5cd4","affectsGlobalScope":true,"impliedFormat":1},{"version":"436aaf437562f276ec2ddbee2f2cdedac7664c1e4c1d2c36839ddd582eeb3d0a","affectsGlobalScope":true,"impliedFormat":1},{"version":"8e3c06ea092138bf9fa5e874a1fdbc9d54805d074bee1de31b99a11e2fec239d","affectsGlobalScope":true,"impliedFormat":1},{"version":"87dc0f382502f5bbce5129bdc0aea21e19a3abbc19259e0b43ae038a9fc4e326","affectsGlobalScope":true,"impliedFormat":1},{"version":"b1cb28af0c891c8c96b2d6b7be76bd394fddcfdb4709a20ba05a7c1605eea0f9","affectsGlobalScope":true,"impliedFormat":1},{"version":"2fef54945a13095fdb9b84f705f2b5994597640c46afeb2ce78352fab4cb3279","affectsGlobalScope":true,"impliedFormat":1},{"version":"ac77cb3e8c6d3565793eb90a8373ee8033146315a3dbead3bde8db5eaf5e5ec6","affectsGlobalScope":true,"impliedFormat":1},{"version":"56e4ed5aab5f5920980066a9409bfaf53e6d21d3f8d020c17e4de584d29600ad","affectsGlobalScope":true,"impliedFormat":1},{"version":"4ece9f17b3866cc077099c73f4983bddbcb1dc7ddb943227f1ec070f529dedd1","affectsGlobalScope":true,"impliedFormat":1},{"version":"0a6282c8827e4b9a95f4bf4f5c205673ada31b982f50572d27103df8ceb8013c","affectsGlobalScope":true,"impliedFormat":1},{"version":"1c9319a09485199c1f7b0498f2988d6d2249793ef67edda49d1e584746be9032","affectsGlobalScope":true,"impliedFormat":1},{"version":"e3a2a0cee0f03ffdde24d89660eba2685bfbdeae955a6c67e8c4c9fd28928eeb","affectsGlobalScope":true,"impliedFormat":1},{"version":"811c71eee4aa0ac5f7adf713323a5c41b0cf6c4e17367a34fbce379e12bbf0a4","affectsGlobalScope":true,"impliedFormat":1},{"version":"51ad4c928303041605b4d7ae32e0c1ee387d43a24cd6f1ebf4a2699e1076d4fa","affectsGlobalScope":true,"impliedFormat":1},{"version":"60037901da1a425516449b9a20073aa03386cce92f7a1fd902d7602be3a7c2e9","affectsGlobalScope":true,"impliedFormat":1},{"version":"d4b1d2c51d058fc21ec2629fff7a76249dec2e36e12960ea056e3ef89174080f","affectsGlobalScope":true,"impliedFormat":1},{"version":"22adec94ef7047a6c9d1af3cb96be87a335908bf9ef386ae9fd50eeb37f44c47","affectsGlobalScope":true,"impliedFormat":1},{"version":"196cb558a13d4533a5163286f30b0509ce0210e4b316c56c38d4c0fd2fb38405","affectsGlobalScope":true,"impliedFormat":1},{"version":"73f78680d4c08509933daf80947902f6ff41b6230f94dd002ae372620adb0f60","affectsGlobalScope":true,"impliedFormat":1},{"version":"c5239f5c01bcfa9cd32f37c496cf19c61d69d37e48be9de612b541aac915805b","affectsGlobalScope":true,"impliedFormat":1},{"version":"8e7f8264d0fb4c5339605a15daadb037bf238c10b654bb3eee14208f860a32ea","affectsGlobalScope":true,"impliedFormat":1},{"version":"782dec38049b92d4e85c1585fbea5474a219c6984a35b004963b00beb1aab538","affectsGlobalScope":true,"impliedFormat":1},{"version":"0990a7576222f248f0a3b888adcb7389f957928ce2afb1cd5128169086ff4d29","impliedFormat":1},{"version":"eb5b19b86227ace1d29ea4cf81387279d04bb34051e944bc53df69f58914b788","affectsGlobalScope":true,"impliedFormat":1},{"version":"ac51dd7d31333793807a6abaa5ae168512b6131bd41d9c5b98477fc3b7800f9f","impliedFormat":1},{"version":"87d9d29dbc745f182683f63187bf3d53fd8673e5fca38ad5eaab69798ed29fbc","impliedFormat":1},{"version":"035312d4945d13efa134ae482f6dc56a1a9346f7ac3be7ccbad5741058ce87f3","affectsGlobalScope":true,"impliedFormat":1},{"version":"cc69795d9954ee4ad57545b10c7bf1a7260d990231b1685c147ea71a6faa265c","impliedFormat":1},{"version":"8bc6c94ff4f2af1f4023b7bb2379b08d3d7dd80c698c9f0b07431ea16101f05f","impliedFormat":1},{"version":"1b61d259de5350f8b1e5db06290d31eaebebc6baafd5f79d314b5af9256d7153","impliedFormat":1},{"version":"57194e1f007f3f2cbef26fa299d4c6b21f4623a2eddc63dfeef79e38e187a36e","impliedFormat":1},{"version":"0f6666b58e9276ac3a38fdc80993d19208442d6027ab885580d93aec76b4ef00","impliedFormat":1},{"version":"05fd364b8ef02fb1e174fbac8b825bdb1e5a36a016997c8e421f5fab0a6da0a0","impliedFormat":1},{"version":"70521b6ab0dcba37539e5303104f29b721bfb2940b2776da4cc818c07e1fefc1","affectsGlobalScope":true,"impliedFormat":1},{"version":"ab41ef1f2cdafb8df48be20cd969d875602483859dc194e9c97c8a576892c052","affectsGlobalScope":true,"impliedFormat":1},{"version":"d153a11543fd884b596587ccd97aebbeed950b26933ee000f94009f1ab142848","affectsGlobalScope":true,"impliedFormat":1},{"version":"21d819c173c0cf7cc3ce57c3276e77fd9a8a01d35a06ad87158781515c9a438a","impliedFormat":1},{"version":"98cffbf06d6bab333473c70a893770dbe990783904002c4f1a960447b4b53dca","affectsGlobalScope":true,"impliedFormat":1},{"version":"ba481bca06f37d3f2c137ce343c7d5937029b2468f8e26111f3c9d9963d6568d","affectsGlobalScope":true,"impliedFormat":1},{"version":"6d9ef24f9a22a88e3e9b3b3d8c40ab1ddb0853f1bfbd5c843c37800138437b61","affectsGlobalScope":true,"impliedFormat":1},{"version":"1db0b7dca579049ca4193d034d835f6bfe73096c73663e5ef9a0b5779939f3d0","affectsGlobalScope":true,"impliedFormat":1},{"version":"9798340ffb0d067d69b1ae5b32faa17ab31b82466a3fc00d8f2f2df0c8554aaa","affectsGlobalScope":true,"impliedFormat":1},{"version":"f26b11d8d8e4b8028f1c7d618b22274c892e4b0ef5b3678a8ccbad85419aef43","affectsGlobalScope":true,"impliedFormat":1},{"version":"8e9c23ba78aabc2e0a27033f18737a6df754067731e69dc5f52823957d60a4b6","impliedFormat":1},{"version":"5929864ce17fba74232584d90cb721a89b7ad277220627cc97054ba15a98ea8f","impliedFormat":1},{"version":"763fe0f42b3d79b440a9b6e51e9ba3f3f91352469c1e4b3b67bfa4ff6352f3f4","impliedFormat":1},{"version":"25c8056edf4314820382a5fdb4bb7816999acdcb929c8f75e3f39473b87e85bc","impliedFormat":1},{"version":"c464d66b20788266e5353b48dc4aa6bc0dc4a707276df1e7152ab0c9ae21fad8","impliedFormat":1},{"version":"78d0d27c130d35c60b5e5566c9f1e5be77caf39804636bc1a40133919a949f21","impliedFormat":1},{"version":"c6fd2c5a395f2432786c9cb8deb870b9b0e8ff7e22c029954fabdd692bff6195","impliedFormat":1},{"version":"1d6e127068ea8e104a912e42fc0a110e2aa5a66a356a917a163e8cf9a65e4a75","impliedFormat":1},{"version":"5ded6427296cdf3b9542de4471d2aa8d3983671d4cac0f4bf9c637208d1ced43","impliedFormat":1},{"version":"7f182617db458e98fc18dfb272d40aa2fff3a353c44a89b2c0ccb3937709bfb5","impliedFormat":1},{"version":"cadc8aced301244057c4e7e73fbcae534b0f5b12a37b150d80e5a45aa4bebcbd","impliedFormat":1},{"version":"385aab901643aa54e1c36f5ef3107913b10d1b5bb8cbcd933d4263b80a0d7f20","impliedFormat":1},{"version":"9670d44354bab9d9982eca21945686b5c24a3f893db73c0dae0fd74217a4c219","impliedFormat":1},{"version":"0b8a9268adaf4da35e7fa830c8981cfa22adbbe5b3f6f5ab91f6658899e657a7","impliedFormat":1},{"version":"11396ed8a44c02ab9798b7dca436009f866e8dae3c9c25e8c1fbc396880bf1bb","impliedFormat":1},{"version":"ba7bc87d01492633cb5a0e5da8a4a42a1c86270e7b3d2dea5d156828a84e4882","impliedFormat":1},{"version":"4893a895ea92c85345017a04ed427cbd6a1710453338df26881a6019432febdd","impliedFormat":1},{"version":"c21dc52e277bcfc75fac0436ccb75c204f9e1b3fa5e12729670910639f27343e","impliedFormat":1},{"version":"13f6f39e12b1518c6650bbb220c8985999020fe0f21d818e28f512b7771d00f9","impliedFormat":1},{"version":"9b5369969f6e7175740bf51223112ff209f94ba43ecd3bb09eefff9fd675624a","impliedFormat":1},{"version":"4fe9e626e7164748e8769bbf74b538e09607f07ed17c2f20af8d680ee49fc1da","impliedFormat":1},{"version":"24515859bc0b836719105bb6cc3d68255042a9f02a6022b3187948b204946bd2","impliedFormat":1},{"version":"ea0148f897b45a76544ae179784c95af1bd6721b8610af9ffa467a518a086a43","impliedFormat":1},{"version":"24c6a117721e606c9984335f71711877293a9651e44f59f3d21c1ea0856f9cc9","impliedFormat":1},{"version":"dd3273ead9fbde62a72949c97dbec2247ea08e0c6952e701a483d74ef92d6a17","impliedFormat":1},{"version":"405822be75ad3e4d162e07439bac80c6bcc6dbae1929e179cf467ec0b9ee4e2e","impliedFormat":1},{"version":"0db18c6e78ea846316c012478888f33c11ffadab9efd1cc8bcc12daded7a60b6","impliedFormat":1},{"version":"e61be3f894b41b7baa1fbd6a66893f2579bfad01d208b4ff61daef21493ef0a8","impliedFormat":1},{"version":"bd0532fd6556073727d28da0edfd1736417a3f9f394877b6d5ef6ad88fba1d1a","impliedFormat":1},{"version":"89167d696a849fce5ca508032aabfe901c0868f833a8625d5a9c6e861ef935d2","impliedFormat":1},{"version":"615ba88d0128ed16bf83ef8ccbb6aff05c3ee2db1cc0f89ab50a4939bfc1943f","impliedFormat":1},{"version":"a4d551dbf8746780194d550c88f26cf937caf8d56f102969a110cfaed4b06656","impliedFormat":1},{"version":"8bd86b8e8f6a6aa6c49b71e14c4ffe1211a0e97c80f08d2c8cc98838006e4b88","impliedFormat":1},{"version":"317e63deeb21ac07f3992f5b50cdca8338f10acd4fbb7257ebf56735bf52ab00","impliedFormat":1},{"version":"4732aec92b20fb28c5fe9ad99521fb59974289ed1e45aecb282616202184064f","impliedFormat":1},{"version":"2e85db9e6fd73cfa3d7f28e0ab6b55417ea18931423bd47b409a96e4a169e8e6","impliedFormat":1},{"version":"c46e079fe54c76f95c67fb89081b3e399da2c7d109e7dca8e4b58d83e332e605","impliedFormat":1},{"version":"bf67d53d168abc1298888693338cb82854bdb2e69ef83f8a0092093c2d562107","impliedFormat":1},{"version":"b52476feb4a0cbcb25e5931b930fc73cb6643fb1a5060bf8a3dda0eeae5b4b68","affectsGlobalScope":true,"impliedFormat":1},{"version":"e2677634fe27e87348825bb041651e22d50a613e2fdf6a4a3ade971d71bac37e","impliedFormat":1},{"version":"7394959e5a741b185456e1ef5d64599c36c60a323207450991e7a42e08911419","impliedFormat":1},{"version":"8c0bcd6c6b67b4b503c11e91a1fb91522ed585900eab2ab1f61bba7d7caa9d6f","impliedFormat":1},{"version":"8cd19276b6590b3ebbeeb030ac271871b9ed0afc3074ac88a94ed2449174b776","affectsGlobalScope":true,"impliedFormat":1},{"version":"696eb8d28f5949b87d894b26dc97318ef944c794a9a4e4f62360cd1d1958014b","impliedFormat":1},{"version":"3f8fa3061bd7402970b399300880d55257953ee6d3cd408722cb9ac20126460c","impliedFormat":1},{"version":"35ec8b6760fd7138bbf5809b84551e31028fb2ba7b6dc91d95d098bf212ca8b4","affectsGlobalScope":true,"impliedFormat":1},{"version":"5524481e56c48ff486f42926778c0a3cce1cc85dc46683b92b1271865bcf015a","impliedFormat":1},{"version":"68bd56c92c2bd7d2339457eb84d63e7de3bd56a69b25f3576e1568d21a162398","affectsGlobalScope":true,"impliedFormat":1},{"version":"3e93b123f7c2944969d291b35fed2af79a6e9e27fdd5faa99748a51c07c02d28","impliedFormat":1},{"version":"9d19808c8c291a9010a6c788e8532a2da70f811adb431c97520803e0ec649991","impliedFormat":1},{"version":"87aad3dd9752067dc875cfaa466fc44246451c0c560b820796bdd528e29bef40","impliedFormat":1},{"version":"4aacb0dd020eeaef65426153686cc639a78ec2885dc72ad220be1d25f1a439df","impliedFormat":1},{"version":"f0bd7e6d931657b59605c44112eaf8b980ba7f957a5051ed21cb93d978cf2f45","impliedFormat":1},{"version":"8db0ae9cb14d9955b14c214f34dae1b9ef2baee2fe4ce794a4cd3ac2531e3255","affectsGlobalScope":true,"impliedFormat":1},{"version":"15fc6f7512c86810273af28f224251a5a879e4261b4d4c7e532abfbfc3983134","impliedFormat":1},{"version":"58adba1a8ab2d10b54dc1dced4e41f4e7c9772cbbac40939c0dc8ce2cdb1d442","impliedFormat":1},{"version":"2fd4c143eff88dabb57701e6a40e02a4dbc36d5eb1362e7964d32028056a782b","impliedFormat":1},{"version":"714435130b9015fae551788df2a88038471a5a11eb471f27c4ede86552842bc9","impliedFormat":1},{"version":"855cd5f7eb396f5f1ab1bc0f8580339bff77b68a770f84c6b254e319bbfd1ac7","impliedFormat":1},{"version":"5650cf3dace09e7c25d384e3e6b818b938f68f4e8de96f52d9c5a1b3db068e86","impliedFormat":1},{"version":"1354ca5c38bd3fd3836a68e0f7c9f91f172582ba30ab15bb8c075891b91502b7","affectsGlobalScope":true,"impliedFormat":1},{"version":"27fdb0da0daf3b337c5530c5f266efe046a6ceb606e395b346974e4360c36419","impliedFormat":1},{"version":"2d2fcaab481b31a5882065c7951255703ddbe1c0e507af56ea42d79ac3911201","impliedFormat":1},{"version":"a192fe8ec33f75edbc8d8f3ed79f768dfae11ff5735e7fe52bfa69956e46d78d","impliedFormat":1},{"version":"ca867399f7db82df981d6915bcbb2d81131d7d1ef683bc782b59f71dda59bc85","affectsGlobalScope":true,"impliedFormat":1},{"version":"0e456fd5b101271183d99a9087875a282323e3a3ff0d7bcf1881537eaa8b8e63","affectsGlobalScope":true,"impliedFormat":1},{"version":"9e043a1bc8fbf2a255bccf9bf27e0f1caf916c3b0518ea34aa72357c0afd42ec","impliedFormat":1},{"version":"b4f70ec656a11d570e1a9edce07d118cd58d9760239e2ece99306ee9dfe61d02","impliedFormat":1},{"version":"3bc2f1e2c95c04048212c569ed38e338873f6a8593930cf5a7ef24ffb38fc3b6","impliedFormat":1},{"version":"6e70e9570e98aae2b825b533aa6292b6abd542e8d9f6e9475e88e1d7ba17c866","impliedFormat":1},{"version":"f9d9d753d430ed050dc1bf2667a1bab711ccbb1c1507183d794cc195a5b085cc","impliedFormat":1},{"version":"9eece5e586312581ccd106d4853e861aaaa1a39f8e3ea672b8c3847eedd12f6e","impliedFormat":1},{"version":"47ab634529c5955b6ad793474ae188fce3e6163e3a3fb5edd7e0e48f14435333","impliedFormat":1},{"version":"37ba7b45141a45ce6e80e66f2a96c8a5ab1bcef0fc2d0f56bb58df96ec67e972","impliedFormat":1},{"version":"45650f47bfb376c8a8ed39d4bcda5902ab899a3150029684ee4c10676d9fbaee","impliedFormat":1},{"version":"fad4e3c207fe23922d0b2d06b01acbfb9714c4f2685cf80fd384c8a100c82fd0","affectsGlobalScope":true,"impliedFormat":1},{"version":"74cf591a0f63db318651e0e04cb55f8791385f86e987a67fd4d2eaab8191f730","impliedFormat":1},{"version":"5eab9b3dc9b34f185417342436ec3f106898da5f4801992d8ff38ab3aff346b5","impliedFormat":1},{"version":"12ed4559eba17cd977aa0db658d25c4047067444b51acfdcbf38470630642b23","affectsGlobalScope":true,"impliedFormat":1},{"version":"f3ffabc95802521e1e4bcba4c88d8615176dc6e09111d920c7a213bdda6e1d65","impliedFormat":1},{"version":"ddc734b4fae82a01d247e9e342d020976640b5e93b4e9b3a1e30e5518883a060","impliedFormat":1},{"version":"ae56f65caf3be91108707bd8dfbccc2a57a91feb5daabf7165a06a945545ed26","impliedFormat":1},{"version":"a136d5de521da20f31631a0a96bf712370779d1c05b7015d7019a9b2a0446ca9","impliedFormat":1},{"version":"c3b41e74b9a84b88b1dca61ec39eee25c0dbc8e7d519ba11bb070918cfacf656","affectsGlobalScope":true,"impliedFormat":1},{"version":"4737a9dc24d0e68b734e6cfbcea0c15a2cfafeb493485e27905f7856988c6b29","affectsGlobalScope":true,"impliedFormat":1},{"version":"36d8d3e7506b631c9582c251a2c0b8a28855af3f76719b12b534c6edf952748d","impliedFormat":1},{"version":"1ca69210cc42729e7ca97d3a9ad48f2e9cb0042bada4075b588ae5387debd318","impliedFormat":1},{"version":"f5ebe66baaf7c552cfa59d75f2bfba679f329204847db3cec385acda245e574e","impliedFormat":1},{"version":"ed59add13139f84da271cafd32e2171876b0a0af2f798d0c663e8eeb867732cf","affectsGlobalScope":true,"impliedFormat":1},{"version":"05db535df8bdc30d9116fe754a3473d1b6479afbc14ae8eb18b605c62677d518","impliedFormat":1},{"version":"b1810689b76fd473bd12cc9ee219f8e62f54a7d08019a235d07424afbf074d25","impliedFormat":1},{"version":"8caa5c86be1b793cd5f599e27ecb34252c41e011980f7d61ae4989a149ff6ccc","impliedFormat":1},{"version":"f9fd93190acb1ffe0bc0fb395df979452f8d625071e9ffc8636e4dfb86ab2508","impliedFormat":1},{"version":"5f41fd8732a89e940c58ce22206e3df85745feb8983e2b4c6257fb8cbb118493","impliedFormat":1},{"version":"17ed71200119e86ccef2d96b73b02ce8854b76ad6bd21b5021d4269bec527b5f","impliedFormat":1},{"version":"1cfa8647d7d71cb03847d616bd79320abfc01ddea082a49569fda71ac5ece66b","impliedFormat":1},{"version":"bb7a61dd55dc4b9422d13da3a6bb9cc5e89be888ef23bbcf6558aa9726b89a1c","impliedFormat":1},{"version":"db6d2d9daad8a6d83f281af12ce4355a20b9a3e71b82b9f57cddcca0a8964a96","impliedFormat":1},{"version":"cfe4ef4710c3786b6e23dae7c086c70b4f4835a2e4d77b75d39f9046106e83d3","impliedFormat":1},{"version":"cbea99888785d49bb630dcbb1613c73727f2b5a2cf02e1abcaab7bcf8d6bf3c5","impliedFormat":1},{"version":"3a8bddb66b659f6bd2ff641fc71df8a8165bafe0f4b799cc298be5cd3755bb20","impliedFormat":1},{"version":"a86f82d646a739041d6702101afa82dcb935c416dd93cbca7fd754fd0282ce1f","impliedFormat":1},{"version":"2dad084c67e649f0f354739ec7df7c7df0779a28a4f55c97c6b6883ae850d1ce","impliedFormat":1},{"version":"fa5bbc7ab4130dd8cdc55ea294ec39f76f2bc507a0f75f4f873e38631a836ca7","impliedFormat":1},{"version":"df45ca1176e6ac211eae7ddf51336dc075c5314bc5c253651bae639defd5eec5","impliedFormat":1},{"version":"cf86de1054b843e484a3c9300d62fbc8c97e77f168bbffb131d560ca0474d4a8","impliedFormat":1},{"version":"196c960b12253fde69b204aa4fbf69470b26daf7a430855d7f94107a16495ab0","impliedFormat":1},{"version":"ee15ea5dd7a9fc9f5013832e5843031817a880bf0f24f37a29fd8337981aae07","impliedFormat":1},{"version":"bf24f6d35f7318e246010ffe9924395893c4e96d34324cde77151a73f078b9ad","impliedFormat":1},{"version":"805c5db07d4b131bede36cc2dbded64cc3c8e49594e53119f4442af183f97935","impliedFormat":1},{"version":"10595c7ff5094dd5b6a959ccb1c00e6a06441b4e10a87bc09c15f23755d34439","impliedFormat":1},{"version":"9620c1ff645afb4a9ab4044c85c26676f0a93e8c0e4b593aea03a89ccb47b6d0","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"a9af0e608929aaf9ce96bd7a7b99c9360636c31d73670e4af09a09950df97841","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"c86fe861cf1b4c46a0fb7d74dffe596cf679a2e5e8b1456881313170f092e3fa","impliedFormat":1},{"version":"08ed0b3f0166787f84a6606f80aa3b1388c7518d78912571b203817406e471da","impliedFormat":1},{"version":"47e5af2a841356a961f815e7c55d72554db0c11b4cba4d0caab91f8717846a94","impliedFormat":1},{"version":"65f43099ded6073336e697512d9b80f2d4fec3182b7b2316abf712e84104db00","impliedFormat":1},{"version":"f5f541902bf7ae0512a177295de9b6bcd6809ea38307a2c0a18bfca72212f368","impliedFormat":1},{"version":"b0decf4b6da3ebc52ea0c96095bdfaa8503acc4ac8e9081c5f2b0824835dd3bd","impliedFormat":1},{"version":"ca1b882a105a1972f82cc58e3be491e7d750a1eb074ffd13b198269f57ed9e1b","impliedFormat":1},{"version":"fc3e1c87b39e5ba1142f27ec089d1966da168c04a859a4f6aab64dceae162c2b","impliedFormat":1},{"version":"3b414b99a73171e1c4b7b7714e26b87d6c5cb03d200352da5342ab4088a54c85","impliedFormat":1},{"version":"61888522cec948102eba94d831c873200aa97d00d8989fdfd2a3e0ee75ec65a2","impliedFormat":1},{"version":"4e10622f89fea7b05dd9b52fb65e1e2b5cbd96d4cca3d9e1a60bb7f8a9cb86a1","impliedFormat":1},{"version":"74b2a5e5197bd0f2e0077a1ea7c07455bbea67b87b0869d9786d55104006784f","impliedFormat":1},{"version":"59bf32919de37809e101acffc120596a9e45fdbab1a99de5087f31fdc36e2f11","impliedFormat":1},{"version":"e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855","impliedFormat":1},{"version":"3c4b45e48c56c17fb44b3cab4e2a6c8f64c4fa2c0306fe27d33c52167c0b7fa7","impliedFormat":1},{"version":"c40c848daad198266370c1c72a7a8c3d18d2f50727c7859fcfefd3ff69a7f288","impliedFormat":1},{"version":"ac60bbee0d4235643cc52b57768b22de8c257c12bd8c2039860540cab1fa1d82","impliedFormat":1},{"version":"6428e6edd944ce6789afdf43f9376c1f2e4957eea34166177625aaff4c0da1a0","impliedFormat":1},{"version":"ada39cbb2748ab2873b7835c90c8d4620723aedf323550e8489f08220e477c7f","impliedFormat":1},{"version":"6e5f5cee603d67ee1ba6120815497909b73399842254fc1e77a0d5cdc51d8c9c","impliedFormat":1},{"version":"8dba67056cbb27628e9b9a1cba8e57036d359dceded0725c72a3abe4b6c79cd4","impliedFormat":1},{"version":"70f3814c457f54a7efe2d9ce9d2686de9250bb42eb7f4c539bd2280a42e52d33","impliedFormat":1},{"version":"154dd2e22e1e94d5bc4ff7726706bc0483760bae40506bdce780734f11f7ec47","impliedFormat":1},{"version":"ef61792acbfa8c27c9bd113f02731e66229f7d3a169e3c1993b508134f1a58e0","impliedFormat":1},{"version":"9c82171d836c47486074e4ca8e059735bf97b205e70b196535b5efd40cbe1bc5","impliedFormat":1},{"version":"0131e203d8560edb39678abe10db42564a068f98c4ebd1ed9ffe7279c78b3c81","impliedFormat":1},{"version":"f6404e7837b96da3ea4d38c4f1a3812c96c9dcdf264e93d5bdb199f983a3ef4b","impliedFormat":1},{"version":"c5426dbfc1cf90532f66965a7aa8c1136a78d4d0f96d8180ecbfc11d7722f1a5","impliedFormat":1},{"version":"65a15fc47900787c0bd18b603afb98d33ede930bed1798fc984d5ebb78b26cf9","impliedFormat":1},{"version":"9d202701f6e0744adb6314d03d2eb8fc994798fc83d91b691b75b07626a69801","impliedFormat":1},{"version":"de9d2df7663e64e3a91bf495f315a7577e23ba088f2949d5ce9ec96f44fba37d","impliedFormat":1},{"version":"c7af78a2ea7cb1cd009cfb5bdb48cd0b03dad3b54f6da7aab615c2e9e9d570c5","impliedFormat":1},{"version":"1ee45496b5f8bdee6f7abc233355898e5bf9bd51255db65f5ff7ede617ca0027","impliedFormat":1},{"version":"8b8f00491431fe82f060dfe8c7f2180a9fb239f3d851527db909b83230e75882","affectsGlobalScope":true,"impliedFormat":1},{"version":"db01d18853469bcb5601b9fc9826931cc84cc1a1944b33cad76fd6f1e3d8c544","affectsGlobalScope":true,"impliedFormat":1},{"version":"dba114fb6a32b355a9cfc26ca2276834d72fe0e94cd2c3494005547025015369","impliedFormat":1},{"version":"903e299a28282fa7b714586e28409ed73c3b63f5365519776bf78e8cf173db36","affectsGlobalScope":true,"impliedFormat":1},{"version":"fa6c12a7c0f6b84d512f200690bfc74819e99efae69e4c95c4cd30f6884c526e","impliedFormat":1},{"version":"f1c32f9ce9c497da4dc215c3bc84b722ea02497d35f9134db3bb40a8d918b92b","impliedFormat":1},{"version":"b73c319af2cc3ef8f6421308a250f328836531ea3761823b4cabbd133047aefa","affectsGlobalScope":true,"impliedFormat":1},{"version":"e433b0337b8106909e7953015e8fa3f2d30797cea27141d1c5b135365bb975a6","impliedFormat":1},{"version":"dd3900b24a6a8745efeb7ad27629c0f8a626470ac229c1d73f1fe29d67e44dca","impliedFormat":1},{"version":"ddff7fc6edbdc5163a09e22bf8df7bef75f75369ebd7ecea95ba55c4386e2441","impliedFormat":1},{"version":"106c6025f1d99fd468fd8bf6e5bda724e11e5905a4076c5d29790b6c3745e50c","impliedFormat":1},{"version":"ec29be0737d39268696edcec4f5e97ce26f449fa9b7afc2f0f99a86def34a418","impliedFormat":1},{"version":"aeab39e8e0b1a3b250434c3b2bb8f4d17bbec2a9dbce5f77e8a83569d3d2cbc2","impliedFormat":1},{"version":"ec6cba1c02c675e4dd173251b156792e8d3b0c816af6d6ad93f1a55d674591aa","impliedFormat":1},{"version":"b620391fe8060cf9bedc176a4d01366e6574d7a71e0ac0ab344a4e76576fcbb8","impliedFormat":1},{"version":"d729408dfde75b451530bcae944cf89ee8277e2a9df04d1f62f2abfd8b03c1e1","impliedFormat":1},{"version":"e15d3c84d5077bb4a3adee4c791022967b764dc41cb8fa3cfa44d4379b2c95f5","impliedFormat":1},{"version":"5f58e28cd22e8fc1ac1b3bc6b431869f1e7d0b39e2c21fbf79b9fa5195a85980","impliedFormat":1},{"version":"e1fc1a1045db5aa09366be2b330e4ce391550041fc3e925f60998ca0b647aa97","impliedFormat":1},{"version":"63533978dcda286422670f6e184ac516805a365fb37a086eeff4309e812f1402","impliedFormat":1},{"version":"43ba4f2fa8c698f5c304d21a3ef596741e8e85a810b7c1f9b692653791d8d97a","impliedFormat":1},{"version":"31fb49ef3aa3d76f0beb644984e01eab0ea222372ea9b49bb6533be5722d756c","impliedFormat":1},{"version":"33cd131e1461157e3e06b06916b5176e7a8ec3fce15a5cfe145e56de744e07d2","impliedFormat":1},{"version":"889ef863f90f4917221703781d9723278db4122d75596b01c429f7c363562b86","impliedFormat":1},{"version":"3556cfbab7b43da96d15a442ddbb970e1f2fc97876d055b6555d86d7ac57dae5","impliedFormat":1},{"version":"437751e0352c6e924ddf30e90849f1d9eb00ca78c94d58d6a37202ec84eb8393","impliedFormat":1},{"version":"48e8af7fdb2677a44522fd185d8c87deff4d36ee701ea003c6c780b1407a1397","impliedFormat":1},{"version":"d11308de5a36c7015bb73adb5ad1c1bdaac2baede4cc831a05cf85efa3cc7f2f","impliedFormat":1},{"version":"38e4684c22ed9319beda6765bab332c724103d3a966c2e5e1c5a49cf7007845f","impliedFormat":1},{"version":"f9812cfc220ecf7557183379531fa409acd249b9e5b9a145d0d52b76c20862de","affectsGlobalScope":true,"impliedFormat":1},{"version":"e650298721abc4f6ae851e60ae93ee8199791ceec4b544c3379862f81f43178c","impliedFormat":1},{"version":"2e4f37ffe8862b14d8e24ae8763daaa8340c0df0b859d9a9733def0eee7562d9","impliedFormat":1},{"version":"13283350547389802aa35d9f2188effaeac805499169a06ef5cd77ce2a0bd63f","impliedFormat":1},{"version":"680793958f6a70a44c8d9ae7d46b7a385361c69ac29dcab3ed761edce1c14ab8","impliedFormat":1},{"version":"6ac6715916fa75a1f7ebdfeacac09513b4d904b667d827b7535e84ff59679aff","impliedFormat":1},{"version":"42c169fb8c2d42f4f668c624a9a11e719d5d07dacbebb63cbcf7ef365b0a75b3","impliedFormat":1},{"version":"913ddbba170240070bd5921b8f33ea780021bdf42fbdfcd4fcb2691b1884ddde","impliedFormat":1},{"version":"b4e6d416466999ff40d3fe5ceb95f7a8bfb7ac2262580287ac1a8391e5362431","impliedFormat":1},{"version":"5fe23bd829e6be57d41929ac374ee9551ccc3c44cee893167b7b5b77be708014","impliedFormat":1},{"version":"0a626484617019fcfbfc3c1bc1f9e84e2913f1adb73692aa9075817404fb41a1","impliedFormat":1},{"version":"438c7513b1df91dcef49b13cd7a1c4720f91a36e88c1df731661608b7c055f10","impliedFormat":1},{"version":"cf185cc4a9a6d397f416dd28cca95c227b29f0f27b160060a95c0e5e36cda865","impliedFormat":1},{"version":"0086f3e4ad898fd7ca56bb223098acfacf3fa065595182aaf0f6c4a6a95e6fbd","impliedFormat":1},{"version":"efaa078e392f9abda3ee8ade3f3762ab77f9c50b184e6883063a911742a4c96a","impliedFormat":1},{"version":"54a8bb487e1dc04591a280e7a673cdfb272c83f61e28d8a64cf1ac2e63c35c51","impliedFormat":1},{"version":"021a9498000497497fd693dd315325484c58a71b5929e2bbb91f419b04b24cea","impliedFormat":1},{"version":"9385cdc09850950bc9b59cca445a3ceb6fcca32b54e7b626e746912e489e535e","impliedFormat":1},{"version":"2894c56cad581928bb37607810af011764a2f511f575d28c9f4af0f2ef02d1ab","impliedFormat":1},{"version":"0a72186f94215d020cb386f7dca81d7495ab6c17066eb07d0f44a5bf33c1b21a","impliedFormat":1},{"version":"84124384abae2f6f66b7fbfc03862d0c2c0b71b826f7dbf42c8085d31f1d3f95","impliedFormat":1},{"version":"63a8e96f65a22604eae82737e409d1536e69a467bb738bec505f4f97cce9d878","impliedFormat":1},{"version":"3fd78152a7031315478f159c6a5872c712ece6f01212c78ea82aef21cb0726e2","impliedFormat":1},{"version":"b01bd582a6e41457bc56e6f0f9de4cb17f33f5f3843a7cf8210ac9c18472fb0f","impliedFormat":1},{"version":"58b49e5c1def740360b5ae22ae2405cfac295fee74abd88d74ac4ea42502dc03","impliedFormat":1},{"version":"512fc15cca3a35b8dbbf6e23fe9d07e6f87ad03c895acffd3087ce09f352aad0","impliedFormat":1},{"version":"9a0946d15a005832e432ea0cd4da71b57797efb25b755cc07f32274296d62355","impliedFormat":1},{"version":"a52ff6c0a149e9f370372fc3c715d7f2beee1f3bab7980e271a7ab7d313ec677","impliedFormat":1},{"version":"fd933f824347f9edd919618a76cdb6a0c0085c538115d9a287fa0c7f59957ab3","impliedFormat":1},{"version":"6ac6715916fa75a1f7ebdfeacac09513b4d904b667d827b7535e84ff59679aff","impliedFormat":1},{"version":"6a1aa3e55bdc50503956c5cd09ae4cd72e3072692d742816f65c66ca14f4dfdd","impliedFormat":1},{"version":"ab75cfd9c4f93ffd601f7ca1753d6a9d953bbedfbd7a5b3f0436ac8a1de60dfa","impliedFormat":1},{"version":"f95180f03d827525ca4f990f49e17ec67198c316dd000afbe564655141f725cd","impliedFormat":1},{"version":"b73cbf0a72c8800cf8f96a9acfe94f3ad32ca71342a8908b8ae484d61113f647","impliedFormat":1},{"version":"bae6dd176832f6423966647382c0d7ba9e63f8c167522f09a982f086cd4e8b23","impliedFormat":1},{"version":"1364f64d2fb03bbb514edc42224abd576c064f89be6a990136774ecdd881a1da","impliedFormat":1},{"version":"c9958eb32126a3843deedda8c22fb97024aa5d6dd588b90af2d7f2bfac540f23","impliedFormat":1},{"version":"950fb67a59be4c2dbe69a5786292e60a5cb0e8612e0e223537784c731af55db1","impliedFormat":1},{"version":"e927c2c13c4eaf0a7f17e6022eee8519eb29ef42c4c13a31e81a611ab8c95577","impliedFormat":1},{"version":"07ca44e8d8288e69afdec7a31fa408ce6ab90d4f3d620006701d5544646da6aa","impliedFormat":1},{"version":"70246ad95ad8a22bdfe806cb5d383a26c0c6e58e7207ab9c431f1cb175aca657","impliedFormat":1},{"version":"f00f3aa5d64ff46e600648b55a79dcd1333458f7a10da2ed594d9f0a44b76d0b","impliedFormat":1},{"version":"772d8d5eb158b6c92412c03228bd9902ccb1457d7a705b8129814a5d1a6308fc","impliedFormat":1},{"version":"4e4475fba4ed93a72f167b061cd94a2e171b82695c56de9899275e880e06ba41","impliedFormat":1},{"version":"97c5f5d580ab2e4decd0a3135204050f9b97cd7908c5a8fbc041eadede79b2fa","impliedFormat":1},{"version":"c99a3a5f2215d5b9d735aa04cec6e61ed079d8c0263248e298ffe4604d4d0624","impliedFormat":1},{"version":"49b2375c586882c3ac7f57eba86680ff9742a8d8cb2fe25fe54d1b9673690d41","impliedFormat":1},{"version":"802e797bcab5663b2c9f63f51bdf67eff7c41bc64c0fd65e6da3e7941359e2f7","impliedFormat":1},{"version":"847e160d709c74cc714fbe1f99c41d3425b74cd47b1be133df1623cd87014089","impliedFormat":1},{"version":"3ecfccf916fea7c6c34394413b55eb70e817a73e39b4417d6573e523784e3f8e","impliedFormat":1},{"version":"5cdc27fbc5c166fc5c763a30ac21cbac9859dc5ba795d3230db6d4e52a1965bb","impliedFormat":1},{"version":"6459054aabb306821a043e02b89d54da508e3a6966601a41e71c166e4ea1474f","impliedFormat":1},{"version":"f416c9c3eee9d47ff49132c34f96b9180e50485d435d5748f0e8b72521d28d2e","impliedFormat":1},{"version":"05c97cddbaf99978f83d96de2d8af86aded9332592f08ce4a284d72d0952c391","impliedFormat":1},{"version":"14e5cdec6f8ae82dfd0694e64903a0a54abdfe37e1d966de3d4128362acbf35f","impliedFormat":1},{"version":"bbc183d2d69f4b59fd4dd8799ffdf4eb91173d1c4ad71cce91a3811c021bf80c","impliedFormat":1},{"version":"7b6ff760c8a240b40dab6e4419b989f06a5b782f4710d2967e67c695ef3e93c4","impliedFormat":1},{"version":"8dbc4134a4b3623fc476be5f36de35c40f2768e2e3d9ed437e0d5f1c4cd850f6","impliedFormat":1},{"version":"4e06330a84dec7287f7ebdd64978f41a9f70a668d3b5edc69d5d4a50b9b376bb","impliedFormat":1},{"version":"65bfa72967fbe9fc33353e1ac03f0480aa2e2ea346d61ff3ea997dfd850f641a","impliedFormat":1},{"version":"c06f0bb92d1a1a5a6c6e4b5389a5664d96d09c31673296cb7da5fe945d54d786","impliedFormat":1},{"version":"f974e4a06953682a2c15d5bd5114c0284d5abf8bc0fe4da25cb9159427b70072","impliedFormat":1},{"version":"872caaa31423f4345983d643e4649fb30f548e9883a334d6d1c5fff68ede22d4","impliedFormat":1},{"version":"94404c4a878fe291e7578a2a80264c6f18e9f1933fbb57e48f0eb368672e389c","impliedFormat":1},{"version":"5c1b7f03aa88be854bc15810bfd5bd5a1943c5a7620e1c53eddd2a013996343e","impliedFormat":1},{"version":"09dfc64fcd6a2785867f2368419859a6cc5a8d4e73cbe2538f205b1642eb0f51","impliedFormat":1},{"version":"bcf6f0a323653e72199105a9316d91463ad4744c546d1271310818b8cef7c608","impliedFormat":1},{"version":"01aa917531e116485beca44a14970834687b857757159769c16b228eb1e49c5f","impliedFormat":1},{"version":"351475f9c874c62f9b45b1f0dc7e2704e80dfd5f1af83a3a9f841f9dfe5b2912","impliedFormat":1},{"version":"ac457ad39e531b7649e7b40ee5847606eac64e236efd76c5d12db95bf4eacd17","impliedFormat":1},{"version":"187a6fdbdecb972510b7555f3caacb44b58415da8d5825d03a583c4b73fde4cf","impliedFormat":1},{"version":"d4c3250105a612202289b3a266bb7e323db144f6b9414f9dea85c531c098b811","impliedFormat":1},{"version":"95b444b8c311f2084f0fb51c616163f950fb2e35f4eaa07878f313a2d36c98a4","impliedFormat":1},{"version":"741067675daa6d4334a2dc80a4452ca3850e89d5852e330db7cb2b5f867173b1","impliedFormat":1},{"version":"f8acecec1114f11690956e007d920044799aefeb3cece9e7f4b1f8a1d542b2c9","impliedFormat":1},{"version":"178071ccd043967a58c5d1a032db0ddf9bd139e7920766b537d9783e88eb615e","impliedFormat":1},{"version":"3a17f09634c50cce884721f54fd9e7b98e03ac505889c560876291fcf8a09e90","impliedFormat":1},{"version":"32531dfbb0cdc4525296648f53b2b5c39b64282791e2a8c765712e49e6461046","impliedFormat":1},{"version":"0ce1b2237c1c3df49748d61568160d780d7b26693bd9feb3acb0744a152cd86d","impliedFormat":1},{"version":"e489985388e2c71d3542612685b4a7db326922b57ac880f299da7026a4e8a117","impliedFormat":1},{"version":"5cad4158616d7793296dd41e22e1257440910ea8d01c7b75045d4dfb20c5a41a","impliedFormat":1},{"version":"04d3aad777b6af5bd000bfc409907a159fe77e190b9d368da4ba649cdc28d39e","affectsGlobalScope":true,"impliedFormat":1},{"version":"74efc1d6523bd57eb159c18d805db4ead810626bc5bc7002a2c7f483044b2e0f","impliedFormat":1},{"version":"19252079538942a69be1645e153f7dbbc1ef56b4f983c633bf31fe26aeac32cd","impliedFormat":1},{"version":"bc11f3ac00ac060462597add171220aed628c393f2782ac75dd29ff1e0db871c","impliedFormat":1},{"version":"616775f16134fa9d01fc677ad3f76e68c051a056c22ab552c64cc281a9686790","impliedFormat":1},{"version":"65c24a8baa2cca1de069a0ba9fba82a173690f52d7e2d0f1f7542d59d5eb4db0","impliedFormat":1},{"version":"f9fe6af238339a0e5f7563acee3178f51db37f32a2e7c09f85273098cee7ec49","impliedFormat":1},{"version":"3b0b1d352b8d2e47f1c4df4fb0678702aee071155b12ef0185fce9eb4fa4af1e","impliedFormat":1},{"version":"77e71242e71ebf8528c5802993697878f0533db8f2299b4d36aa015bae08a79c","impliedFormat":1},{"version":"a344403e7a7384e0e7093942533d309194ad0a53eca2a3100c0b0ab4d3932773","impliedFormat":1},{"version":"b7fff2d004c5879cae335db8f954eb1d61242d9f2d28515e67902032723caeab","impliedFormat":1},{"version":"5f3dc10ae646f375776b4e028d2bed039a93eebbba105694d8b910feebbe8b9c","impliedFormat":1},{"version":"bb18bf4a61a17b4a6199eb3938ecfa4a59eb7c40843ad4a82b975ab6f7e3d925","impliedFormat":1},{"version":"4545c1a1ceca170d5d83452dd7c4994644c35cf676a671412601689d9a62da35","impliedFormat":1},{"version":"e9b6fc05f536dfddcdc65dbcf04e09391b1c968ab967382e48924f5cb90d88e1","impliedFormat":1},{"version":"a2d648d333cf67b9aeac5d81a1a379d563a8ffa91ddd61c6179f68de724260ff","impliedFormat":1},{"version":"2b664c3cc544d0e35276e1fb2d4989f7d4b4027ffc64da34ec83a6ccf2e5c528","impliedFormat":1},{"version":"a3f41ed1b4f2fc3049394b945a68ae4fdefd49fa1739c32f149d32c0545d67f5","impliedFormat":1},{"version":"3cd8f0464e0939b47bfccbb9bb474a6d87d57210e304029cd8eb59c63a81935d","impliedFormat":1},{"version":"47699512e6d8bebf7be488182427189f999affe3addc1c87c882d36b7f2d0b0e","impliedFormat":1},{"version":"3026abd48e5e312f2328629ede6e0f770d21c3cd32cee705c450e589d015ee09","impliedFormat":1},{"version":"8b140b398a6afbd17cc97c38aea5274b2f7f39b1ae5b62952cfe65bf493e3e75","impliedFormat":1},{"version":"7663d2c19ce5ef8288c790edba3d45af54e58c84f1b37b1249f6d49d962f3d91","impliedFormat":1},{"version":"5cce3b975cdb72b57ae7de745b3c5de5790781ee88bcb41ba142f07c0fa02e97","impliedFormat":1},{"version":"00bd6ebe607246b45296aa2b805bd6a58c859acecda154bfa91f5334d7c175c6","impliedFormat":1},{"version":"ad036a85efcd9e5b4f7dd5c1a7362c8478f9a3b6c3554654ca24a29aa850a9c5","impliedFormat":1},{"version":"fedebeae32c5cdd1a85b4e0504a01996e4a8adf3dfa72876920d3dd6e42978e7","impliedFormat":1},{"version":"0d28b974a7605c4eda20c943b3fa9ae16cb452c1666fc9b8c341b879992c7612","impliedFormat":1},{"version":"cdf21eee8007e339b1b9945abf4a7b44930b1d695cc528459e68a3adc39a622e","impliedFormat":1},{"version":"db036c56f79186da50af66511d37d9fe77fa6793381927292d17f81f787bb195","impliedFormat":1},{"version":"87ac2fb61e629e777f4d161dff534c2023ee15afd9cb3b1589b9b1f014e75c58","impliedFormat":1},{"version":"13c8b4348db91e2f7d694adc17e7438e6776bc506d5c8f5de9ad9989707fa3fe","impliedFormat":1},{"version":"3c1051617aa50b38e9efaabce25e10a5dd9b1f42e372ef0e8a674076a68742ed","impliedFormat":1},{"version":"07a3e20cdcb0f1182f452c0410606711fbea922ca76929a41aacb01104bc0d27","impliedFormat":1},{"version":"1de80059b8078ea5749941c9f863aa970b4735bdbb003be4925c853a8b6b4450","impliedFormat":1},{"version":"1d079c37fa53e3c21ed3fa214a27507bda9991f2a41458705b19ed8c2b61173d","impliedFormat":1},{"version":"4cd4b6b1279e9d744a3825cbd7757bbefe7f0708f3f1069179ad535f19e8ed2c","impliedFormat":1},{"version":"5835a6e0d7cd2738e56b671af0e561e7c1b4fb77751383672f4b009f4e161d70","impliedFormat":1},{"version":"c0eeaaa67c85c3bb6c52b629ebbfd3b2292dc67e8c0ffda2fc6cd2f78dc471e6","impliedFormat":1},{"version":"4b7f74b772140395e7af67c4841be1ab867c11b3b82a51b1aeb692822b76c872","impliedFormat":1},{"version":"27be6622e2922a1b412eb057faa854831b95db9db5035c3f6d4b677b902ab3b7","impliedFormat":1},{"version":"b95a6f019095dd1d48fd04965b50dfd63e5743a6e75478343c46d2582a5132bf","impliedFormat":99},{"version":"c2008605e78208cfa9cd70bd29856b72dda7ad89df5dc895920f8e10bcb9cd0a","impliedFormat":99},{"version":"b97cb5616d2ab82a98ec9ada7b9e9cabb1f5da880ec50ea2b8dc5baa4cbf3c16","impliedFormat":99},{"version":"d23df9ff06ae8bf1dcb7cc933e97ae7da418ac77749fecee758bb43a8d69f840","affectsGlobalScope":true,"impliedFormat":1},{"version":"040c71dde2c406f869ad2f41e8d4ce579cc60c8dbe5aa0dd8962ac943b846572","affectsGlobalScope":true,"impliedFormat":1},{"version":"3586f5ea3cc27083a17bd5c9059ede9421d587286d5a47f4341a4c2d00e4fa91","impliedFormat":1},{"version":"a6df929821e62f4719551f7955b9f42c0cd53c1370aec2dd322e24196a7dfe33","impliedFormat":1},{"version":"b789bf89eb19c777ed1e956dbad0925ca795701552d22e68fd130a032008b9f9","impliedFormat":1},"9dd9d642cdb87d4d5b3173217e0c45429b3e47a6f5cf5fb0ead6c644ec5fed01",{"version":"8a8eb4ebffd85e589a1cc7c178e291626c359543403d58c9cd22b81fab5b1fb9","impliedFormat":1},{"version":"601e6e8791aa14d2e01c632a442609a10012ead9d87f59d678048f909d05cbba","affectsGlobalScope":true,"impliedFormat":99},{"version":"27517df305a7c0e32a378ca09ff9ec2f11f6fa518d634c2862cb31667d25ae28","impliedFormat":99},{"version":"63870aa3d7a232be2cd30c7874cb075646335030cc5ca2cc831f95a84fe3a0b1","impliedFormat":99},{"version":"7d375955f8a18a61bd77d278b33256d51cbd93e99eb36b36ac72a3c79ca6cec3","affectsGlobalScope":true,"impliedFormat":99},{"version":"bc270b8f9fa72b1ad53281c341cf711a73e79aef4979f4239fdb01a627c621ac","impliedFormat":99},{"version":"0dfbd656b9d9847a1ac4cf7f79799143ecc651d4d252b4c1dc7b66aaefe54b9e","impliedFormat":1},{"version":"81340fc0a652b1296b70c018be03f42d01ba48a0fd2a16a6dee14e69c946fe1c","impliedFormat":99},{"version":"8a7d086eea5ffbc0afc88a9ec3afbd9084856505abb94d944708587286b2d5e6","impliedFormat":1},{"version":"46be9aa3aa70604d81820aec8d07c370157d89dd8563f35eb1759cb39c62f6d8","impliedFormat":1},{"version":"8a956d7f0c9ac568b925c6925e450e27d9f3ff0cc58ac38f788679775bdbcae7","impliedFormat":1},{"version":"42e6317f5ad893e4eeac3051f6f47db20da9731b11f54e9334f29d90ec586a50","impliedFormat":1},{"version":"54a4a54cf4d5e4667c477f8404acd7c7de7539a48df6a5d0f9bf68820fb7dc33","impliedFormat":1},{"version":"4cbedb71f1e9805dffc519f94d6b8a624ae1a98eb108763ffa087e9e03fbebbc","impliedFormat":1},{"version":"05ed13a7804a78927052dc0425f1a8fbf76775777274360f5360ebabfe0a1c0f","impliedFormat":1},{"version":"0ae4f263042d5f475bb3936045cda82f16705674a7f2d1a0a1159563544669bf","impliedFormat":1},{"version":"5218bc2b336986cdab39422240fd1d289182beeae9fa77cf704c6618f8a2cf3c","impliedFormat":1},{"version":"50fde69fb9248da80cdc1cea71e51b67d7688774d0df8388f29eaf7d0c1d379f","impliedFormat":1},{"version":"208be66e16cd901c2668fa3d7dc3be8622a7d0e41a030d22baa776d9fc686cf7","impliedFormat":1},{"version":"ae895b39b72787142df4b50d05fc8a0093b393f5ca1aa76d7a5fc2c0070b1c18","impliedFormat":1},{"version":"48ace46fdd3b96c16ff034e25bf42657bb4007e5fed7c6b689e16933455adec7","impliedFormat":1},{"version":"217c27af92822dba4d609486513d454f49e04e732c76a047fbbe2b2bf7f7784c","impliedFormat":1},{"version":"ed4eb88577187de083a8320c62e75ac487fb3f7ee48a93d5e86f13b41b70e3cd","impliedFormat":1},{"version":"ae7bf73219c02fb6d96a257ad558e7067bd9a9433b60e1e67bb7747c38b7c615","impliedFormat":1},{"version":"5c2598476e6162e54e8abe50d0a1b568372ac4bec620c99ba59e3ecf943a1c27","impliedFormat":1},{"version":"b60a5d79acb5044b2f61e7401808f30aff2ca6e92a49b744eabf5c462bfa3808","impliedFormat":1},{"version":"d6a27d59638f0efaabcf9a7038239fb0df8cccd142707b4c00ccaaf9220fdcae","impliedFormat":1},{"version":"4329ead0508c32010f99f517f1185a85989705047ad93fa8a4781024f4dc1216","impliedFormat":1},{"version":"669123db215436dc10ca38e9e5d4a0d57fc4dd76ee5bb58ed245e2b71dcb1597","impliedFormat":1},{"version":"a99e38b50dbc7c641727932d5764f464895435aa30995b053c6089b2075d8e9e","impliedFormat":1},{"version":"a3d19379db8ea52630a6c50a6bda3719d766935e75c63f07e705d420bf8fecd9","impliedFormat":1},{"version":"445c74538a6064587b21cbaf5dffe48b0edb7f6243e32c31a1c311f423551617","impliedFormat":1},{"version":"94fd8366c099da6849dc8ec0e14789462d1e58e193f55588601239c98cabcd4e","impliedFormat":1},{"version":"711383139752a21ee124b1c8ece5aac443bf2fdd479c93f5caef5fd883d4b1f7","impliedFormat":1},{"version":"2add0a929197f7eaf80b02c15ded27f2052abf5d1b49dfa1e38f1fe0f770bdd8","impliedFormat":1},{"version":"239676e1a3bcde66d9e730f40441fc8501ee9ce54dbaa2b4c2943f79dd7348b6","impliedFormat":1},{"version":"3932b32a6561e9fbb135ea39ffc4b7c4de7cec8416161d465c2a8dcdabc955c0","impliedFormat":1},{"version":"d8c6891c83db5fee6c1403225d0caca0e3a970645e9511ab9d978bba3245fc18","impliedFormat":1},{"version":"5a11fa0c64c7ce20a9038b1e4426c5cb18d5e905aba507c4ed462929cf71b1ef","impliedFormat":1},{"version":"aac76917395c306b07d90970211bc15f67aec46a3d6b6cb28cf00c733cb397ef","impliedFormat":1},{"version":"5aa7436c81fe9835bba85f35c3852383c622a13f63a8054937d8f1dbd7bf2969","impliedFormat":1},{"version":"09a301505d50211c9a3a9a253c9417532219b2f6a396cd05bebb13749cfb01a0","impliedFormat":1},{"version":"34600044cc0a34735045ca501ab2d5a7c52a769f364ac4eaecda5a9c2e456ba8","impliedFormat":1},{"version":"41234d9ef4f1bef00b34810c96b5b979536da520669053d4b6e899d6ea9b70e3","impliedFormat":1},{"version":"87ef0ae1085b46f69c4e2815579546012fa42f41428b9db0419377c55583e246","impliedFormat":1},{"version":"b9425db28792a72798372a68d255716d33b1acfeb837e1d49c95146f9e974887","impliedFormat":1},{"version":"d72e72d3d631497669dd636a9393ea30caabdd9843c1ee877ff644393a7a93d7","impliedFormat":1},{"version":"719c7d5f6344819c4c28b99cf34c4ba245ea5aa79521e8bbfb1db44a788c6d03","impliedFormat":1},{"version":"d4febaf058362f0289be83beec78c425a880df9455c25d89e0863bb500708578","impliedFormat":1},{"version":"961d20b47c7325e6aa132d729700353c3b0fa2f765ae3092082abb09150e2ba3","impliedFormat":1},{"version":"c65993955c34d1a6c583000a5a246e54a74d7be3937ae259e11bf7b29628daf6","impliedFormat":1},{"version":"829a9521f86d3b807bfa43ba0e2776b1d631be89ddcfe0facaecfcc2d8b90708","impliedFormat":1},{"version":"16978e386228248e706921d58d47801ac969a6151f7c3afb3c632d0367dd5ada","impliedFormat":1},{"version":"920071ff13103c91de1299489501e2b4e2cde3d035331695e16923b1698d48a8","impliedFormat":1},{"version":"a2c6227d6aae6e460510a01f48b807e2f8a1c1585353e14907d0d8d641496abe","impliedFormat":1},{"version":"b41202e140fb9f7bf282273badab863b5790dab2663f05809bcc8cef516c3cd0","impliedFormat":1},{"version":"3faa497606b49e2988ddbe69e6a70868cd8a104d0b0a75c963cd85a2ea02e7d1","impliedFormat":1},{"version":"3357e71991c9235f49545fce4ad5c75de2c9b8b835b53a4a48c4ac2cfb4ef452","impliedFormat":1},{"version":"e5b98076883555855ccb09bb01919cd01fcc61ed88e5f31fa049e0f9c377aa2f","impliedFormat":1},{"version":"a7f3de6fad27f83cee765518643bc4a5c5c394b0a17c5d162f602bb90b7119e8","impliedFormat":1},{"version":"8ae4c205d2e343a8d238f93edf14c624d3874c152cfbd1a21c92397785fcf6b1","impliedFormat":1},{"version":"e66eec8578977f2ad2e1cb0989475aebd36b7a9cb90c420d9565a6c9bd6ed72e","impliedFormat":1},{"version":"06fd676cf868e87dd7a01e4cae61bde610227b957f9273239e3618d8d8f92bf0","impliedFormat":1},{"version":"3397939464010c7f607269deaad3f6d2740962e5a1beedd30d0524fc608953c9","impliedFormat":1},{"version":"5ce93f5312a611abe23bed2c8c922b66748d3757b4e2571337169f3ba5f17919","impliedFormat":1},{"version":"5651a676b2a569b62fa6ea2f374e75aa4e18899cd60f1a6d35532e778e2e922c","impliedFormat":1},{"version":"b10ba92ca513aa0d311fd500e3e201a7b04d7222520ac6b00361404de8c3ebfd","impliedFormat":1},{"version":"761538c421707d90558d58d55c40f7ed2c5dd83a37f58e82842d077552b17ce8","impliedFormat":1},{"version":"7815b1e74c1ba05bd531b3f0432385a5c6cd00405b4b98aaa6bcbe43e6ae7dca","impliedFormat":1},{"version":"c5b1f63d118949a7786f51061553f7bd9ae4b74c33dc94667c1ddbeceb6904d9","impliedFormat":1},{"version":"294b80e3aaab13eb0b8b79f0142cf6e22f0f6495939b6e02297ec3036df35b46","impliedFormat":1},{"version":"1b440c7eee260ddd31199b7e3136cc0321d1a7366e2078832622b948f31ecc68","impliedFormat":1},{"version":"4ea39d23fc2157bc0b97f1547ca31e6ac52041a746eeff692e725f245f94a53c","impliedFormat":1},{"version":"f4a94e89d475faade55880b2875806a84647245c766bcda86b24ae676e857486","impliedFormat":1},{"version":"a126ce07ac3b7869b2ff8a647d10ed29d087c46ba24a533ddf52cf624399a368","impliedFormat":1},{"version":"c8ce9fbda94bd7e16376e2ce3be97ef9c696e7d051286ed95c7f87015a20618e","impliedFormat":1},{"version":"2d9722a92ce43af83747ef8b5370a78c754fe5d4a415ef7532ce7c362db4c3c6","impliedFormat":1},{"version":"9c305e54c5b24c32fb69aa7264c240d1f67faa152e8c9ed10491fd2bfcc4d6b6","impliedFormat":1},{"version":"a3c52152ba9d43c53a28318171d789c06d9533b6053c8df222d1690ca05c9c33","impliedFormat":1},{"version":"a8bbab71735e79781eed6524128e75f369f12215283bd4b4629de7afa9972f63","impliedFormat":1},{"version":"0906820c29a572417068e11cac52a6ea3a30d879c4ee08b597c75cc2843f17ba","impliedFormat":1},{"version":"68a5c7941e7c067b996579152fd44a7d97923535f75df6319ba37cb19bbaaee7","impliedFormat":1},{"version":"b1e459a383e13fe6dcabbed0893796cb696fd3928ee432e8b7ebd73725ddf639","impliedFormat":1},{"version":"523fe3a9476d5701a4162f83e6f07b16868cb1009df8b210ad2dad9ee439fdd6","impliedFormat":1},{"version":"d469a5a790f92021d10b8df35997a9bcc0ea1ff56ad1e5a22582ba962f946e01","impliedFormat":1},{"version":"e008a357040c555bd5fb2f7655c9142f8ecffb8ccf5797af4dc7422127353e76","impliedFormat":1},{"version":"fda0bf38e92b8cd1cffa78fda866995091fad5912085b337deeb927c9bdffe91","impliedFormat":1},{"version":"fad7a6a284e4004ae5716488513b321e75ba6f948408f26d4dd6958d47b50f1f","impliedFormat":1},{"version":"add58a9ef001a6e9032a0d5a27c878a4710c80d8450b69d861a9ba7a9e0f22e4","impliedFormat":1},{"version":"c70fb6238d514cb1f54b12fdfd3250a3e9bf70a7a8ec17dcd9a989fdb0046d87","impliedFormat":1},{"version":"55764e6222d050b39225ea0d2ed01aa53145217f7d0a0912901696a94cc84482","impliedFormat":1},{"version":"7305e277bf6a0127cfc68b020124baffd1a76fa191c423bb7256e87982d5a710","impliedFormat":1},{"version":"0f86e55ed81b5d66dbf846e7d1f5667737ebb31a10affdd4327d42eef79b15f4","impliedFormat":1},{"version":"2c0d5f8279f28cdef26467e27f45e3a19c7efb0ad9bb1db0e540bf452995e53a","impliedFormat":1},{"version":"512026bdd341d39a5eba9f6c7591b16b71f70bb28847f0e34ce40f13622b9292","impliedFormat":1},{"version":"e1e3a917861a1d1bf2704de9187e4e51759c815902aaa0089caf03e9b701121c","impliedFormat":1},{"version":"9a070110c45574b76bc9d51db5ee7aa9bd9c9b2c0a6e4f53bf16ac4ccc2e9575","impliedFormat":1},{"version":"b0d19b9741b1aa9644334811a484a559bf5f0ebb0f0c815bf0440a564c5435c4","impliedFormat":1},{"version":"63b3e8ad2442a3a110af69ee732c26b835db2fb32a343b559dc282526d8ad7df","impliedFormat":1},{"version":"a723115cbc32f0e3d08fcd1aafb8638fc0fb91004bec96383f52fa0fa040465d","impliedFormat":1},{"version":"a6f3d9ecc8b12d23aee8f348e2824042f586cb72d30aa7e9472745f80fe0e58e","impliedFormat":1},{"version":"0b94f5363e24016b541d2e95a801a199ffcf0a1993ef47a95f6283eb03f9ba25","impliedFormat":1},{"version":"14823c8cb7a6ebecfb95b88dec30cd58793e6e2c5f1a36d11b7c7c92b84a1f08","impliedFormat":1},{"version":"a1be10a2532560f5eb33f32381125be8e681310290f4951646be33dcc1a071b5","impliedFormat":99},{"version":"6cdc55c8c2f63bb664067ba78226de359c1101aee049d2bf3cb4b4788c40eacf","impliedFormat":1},{"version":"df202380727c1a02e948f30a8ea84ee86183c22923f53b71fb821ff60f85dbf6","impliedFormat":1},{"version":"acb487d815e5204442da16a139817494e2a3b7371afa57add9fc7acdb9926d26","impliedFormat":1},{"version":"c646646bcf101b28d4ad44ae485f45becec801f17acd3857ba5b85d44d1685e0","impliedFormat":1},{"version":"95a9fd0f297169b56d20943f6174414f42494e149f7b90cb4146fcb9d36080c8","impliedFormat":1},{"version":"225828d7f1318eaf5bedaa7de9b7ed4ddd4c80a3830d3c3ea19f1652801715f6","impliedFormat":1},{"version":"d2e9e82b05b2c31138dd7e49578fd6b939e069edac202856e9b48e94f68532c1","impliedFormat":1},{"version":"b8b825bc5cdb39b8b0b7521d3c9b2bfb1dcaa52b0a3078e451a3c8bfb924bdf4","impliedFormat":1},{"version":"60f04d9f28800f6ab9fec9cc2c85c601dc6f6e9d16c9565d15054bdee457c2d6","impliedFormat":1},{"version":"31a47c5fe657b0c20b88f2c61a25ddc1e46200a8e075068b9bdced18437654a5","impliedFormat":1},{"version":"9669a9611c40dccc84e2656bd560df6c5443605a39b90a799c3447530727ece8","impliedFormat":1},{"version":"1b4398c34098b5d2fbc7b80ff089684dd52eff3ae9b4b33cf177e8a7c4481d03","impliedFormat":1},{"version":"8746afd0ef72f0cef7af840295f128eaf8c4614459c6bf5615f0330f2e12d404","impliedFormat":1},{"version":"6a58e1b31ab4f7837b688b4af56c09ec191c311d61030819e5c7197cd362a8c4","impliedFormat":1},{"version":"b935bdbf37a8c16e6ec5f093f1e4a5e0bd1145b2a70a869ecdc7c362a4e781d0","impliedFormat":1},{"version":"327201e0d5c631b4821b87dd796f0cad3f8ce7086f7e5c0c7f367113df1f5247","impliedFormat":1},{"version":"6e3f0072111bc2ded5d941716f1a088cf5c10cac854e6bca3d6c02bf7f33fe3f","impliedFormat":1},{"version":"332f8330fedeb992225d79ff08e1f8b5d3c1ffe3123f35bb6e12b3556e718b37","impliedFormat":1},{"version":"7d5edae9f5d5366c8578a08e52af8ce223d6b05d2e3989b66fcbfb2bd1a3e3cf","impliedFormat":99},{"version":"8cb29f25d418a72f410b770ebdc24adae626f2e151b31acd8da4df37d30c0162","impliedFormat":1},{"version":"adf75d09b8989cefde0329a490d17291e0aa5cd46e13bae069a35633f6565670","impliedFormat":1},{"version":"46ef3b748b7e0406a8bffa7b9c957ce8d5633d6daa2e019fa533e68d534311fc","impliedFormat":1},{"version":"d336709d15f15bfd23e59056742214633afcd0f021692294d40df54f818febea","impliedFormat":1},{"version":"f8b834349691218fffbae8e8441e04bdfaaa1bf5e5a4c4adad527e2f9c9e57f8","impliedFormat":1},{"version":"9c3d66275a89530e1ffbddf4e173a9b812a69c1bd1bc7fd95d3ee002c3c38da7","impliedFormat":1},{"version":"6d4fa9b1155ce0d28c1c65733b1bb342890d0b1faa71e2ef6d8c5b8e9241c5c8","impliedFormat":1},{"version":"65d6dca1624e1bebad1df23be9896b96fab5208abcfcd552c4ce81a63f9929f9","impliedFormat":1},{"version":"1c1e4fc4ff686e71f044f694e74cc2d665563e3f57c39c8189c9fbaa7d672e0d","impliedFormat":1},{"version":"a186d9343a4232f264e17ebc8cfc04cb75158277ba7d8fac0afa0f9ab73cf9de","impliedFormat":1},{"version":"302811042fd9f6974c00201d2197e72c5b579eff97960c35f4798b03d600198c","impliedFormat":1},{"version":"0263c4ecb1ab25b41a55a054294317f0a9a072ff0b208cf5714abe1552439196","impliedFormat":1},{"version":"0005c8ec51c3b52ef35f2250b4068df89ef2e467a49d12f395b2e1a4fc93780a","impliedFormat":1},"05ecbd496d284f6dbb833a681b524725a83e442435ee7f3d435df14bee1926e9","81904aca944d398841463438a73799b31a56e418a5483bf41a1d060f1e53c1d8","f590b622dd82a5c51a0003940c4f216eb7877be847e9a0b4bd69e68d41e52186","6b07cc897b311038895cb3caa4a4d3fceb5242ac5455d5f26a8ca7809865b6f9",{"version":"ce01d8e0109fbfdbe72b6bd87cd35fe19473dfcb66d2024554e1c72f07380b51","affectsGlobalScope":true,"impliedFormat":99},{"version":"49c40ebf05452ce5d7aa04e5587894286681181f8dfe9b37cf2e33e6b9993a16","impliedFormat":99},{"version":"ce2dbae0db07712b1da52a5974aa618b3472d39de8cc10ef139c950df36b5252","impliedFormat":99},{"version":"8b78cf601eaa107d0cb40811e41228ad940c39c2dba5138521e4c6c7a745fe80","impliedFormat":99},{"version":"f393eb8c52b2d0188db937dd81c60a4fd3a5c4c4751a732fa0a0ead9060bdd1e","impliedFormat":99},{"version":"e69d094eed9c0fa018a9a5e5f267713e409fe452a4363f46d6137cea535708f2","impliedFormat":99},{"version":"5636ac003748aa4cb5ae667b34a4579322346bf8e31fa47216186cbe63eae29f","impliedFormat":99},{"version":"a69851bc1949ab1d24b09f08d2cc5921a1067223ec49f302ff7a3ad9957ffbce","impliedFormat":99},{"version":"3cf6eed22b3a81f1f0468ac95868e329689fcc247169b911572c25a0b4e2f254","impliedFormat":99},{"version":"ad7be5fea1f7f216303fcfdb1177499a36e9c01f4466726f48001f1084a7fb67","impliedFormat":99},{"version":"b737ecf384622fd49bfedff5d060c0a77ce25834c8f5472776ddba6b2d68f67a","impliedFormat":99},{"version":"5217895b717072b83aa27684e850979ca93698a6dcee803779d651e6ba832048","impliedFormat":99},{"version":"9aec72053378cd790962a539e03076c32e92f6b71a97867bd0d4ad5712ad3b49","impliedFormat":99},{"version":"1f45593173c170b424779367b608148ce2947c86f9b5ed7c5d072e88e11ab305","impliedFormat":99},{"version":"73db8c475d6700e23adb1ff5ba9aedc005a0f67090ecead302e0360a6da616c6","impliedFormat":99},{"version":"aeaed90abf3b3200891450507ff707c16f3408116050d92c0e7169ccb3bba708","impliedFormat":99},{"version":"6ede999974b5289f063467f6c41d3c4566b350e86dd8c3725fed5c94e491a268","impliedFormat":99},{"version":"83aeb4f3e9bf4311905e752780422be84bb6a111cf3b9a339e1e6cb6274f1220","impliedFormat":99},{"version":"148d264c8c0a22d1376cd2f6619faf5a49d320bc0f7fce2a4fa3bab9189be99b","impliedFormat":99},{"version":"eb1eece4482883fbaaee477cd203b424cb8783f9f066290585504ffd97267235","impliedFormat":99},{"version":"6d9ded3d89d21f4395b60bccc4339d1625a3b845d2d3fb6de7332e7d5d0fc2b1","impliedFormat":99},{"version":"08f09a44a88b06df40d9a21cf333ae7a4b36c79f7171cf1e09f82d507fb8a90a","impliedFormat":99},{"version":"6ed9cf6752a00ae66e113b6669378dc67120446bbd1fb89c81e84559ea228051","impliedFormat":99},{"version":"b0cf9e21298c628273469d98999b8b7e78d843df7a943f4ef52dd6ecf24e8443","impliedFormat":99},{"version":"ef53a12d3b9591ff135bbc1c0553f6de7d37cf7289032bbd8a0794893adee165","impliedFormat":99},{"version":"22a24f4486c4489db89d0977d19093a2bcd5ef965b42352a8398c1383f342e45","impliedFormat":99},{"version":"d00892dd983d0f34dcc221394c1941f28677bcacde4ffc7e67b6512c91ebc9a2","impliedFormat":99},{"version":"0f7f9a8058414f16d237aa527ff6792549a50e85cb99299d6f9b1999bf53021c","impliedFormat":99},{"version":"936ab0586971fd3526390f79a0739d8c1feaa5178483c3baea16acda840a71cd","impliedFormat":99},{"version":"62a8f6dc3fe4547a9ae29e8abc0082df80c86fc75b5522e89da074e0792d56cd","impliedFormat":99},{"version":"4f1bad288ada6326583a3e6a0a54d7627a03eac3b668adeea9dded12ac5656b8","impliedFormat":99},{"version":"41a5ae482e864a6128e6054e88f1c0e06884793f92aff5c67144fb02d2373079","impliedFormat":1},{"version":"288109629abbb6043fbb423ddaf3797ae82e63e1575f491f07a4c64d99096dd5","impliedFormat":99},{"version":"c62208f98efb972081241bc1d235654bf37f3ede374b14e3b637dc723de31620","impliedFormat":99},{"version":"3c46aecf40490231ab5678f1365628bc507884d4a1a997f614a75538e7bdbc2a","impliedFormat":99},{"version":"8ac31763883cfe2f754f88a2a9e64659694e2e3e084665c036cc5c36234d559e","impliedFormat":99},{"version":"d105d864b0a910c321d25af9451acbecda03bc06eb12412ef09b43e5f3bc984d","impliedFormat":99},{"version":"c7b04860c7b5c393382843dd198182e8d51100f39e912957c1aad5fe7f9d911c","impliedFormat":1},{"version":"0773a6d2fc4479ab341e6ae9f679262423099a64ab15cf38407475cf2905a829","impliedFormat":1},{"version":"57eebaeaf2e9cd554946c869e6666dab04d5e7a7a1161954fa83feaaf890af75","impliedFormat":99},{"version":"8aca09e8e334ce1d8bbe84066f6b3242d3a35c4a6b50416204b890fab5f31f1e","impliedFormat":1},{"version":"eae518fca08aceab9bb7d9d5e33c93402f2f815523ee5b12ee4b4fee49bbe1b7","impliedFormat":1},{"version":"ec21d75f8ef3b68e445ebb3ecc149f34bd7757f185f735a86b510a181561dfe7","impliedFormat":1},{"version":"504e7acb8e31d6c0a86d53411c8a19ef333f3dc3fbba51a34f688e26749eecbf","impliedFormat":1},{"version":"91dfc560ef785356cff4139bc40b767682cbea5b6cd713f173712b745dd11c32","impliedFormat":1},{"version":"e16f88602f853b0aa31192d984fdf82694c6f8d6bc58262f96fe2e0ba8c1b4d0","impliedFormat":1},{"version":"46377d879156d590e2abfeab3b6e3d420c6d8613a9fa3c71ca1e76d3b4d2de5d","impliedFormat":1},"a416553c02b7472542125c8de62035a1e2367fdcfb9cb84655085b0f66fd01b5","7e58540792cfbdc62333f07b510dbb7297486713828253ced36746593142eb44",{"version":"6c05d0fcee91437571513c404e62396ee798ff37a2d8bef2104accdc79deb9c0","impliedFormat":1},"350be08a887f80ac506b7f3cde85cdefa22ad81ad500b53f0a317f6c67a92199",{"version":"1fd7bfea6c425ce8ec33a7d92edae59f10bc09f86ae01658447509d09ca663f1","impliedFormat":1},{"version":"37c7961117708394f64361ade31a41f96cef7f2a6606300821c72438dd4abda3","impliedFormat":1},{"version":"658ae473fac24f0bff6dd79b75f3d8ef44954587e7506cb59d449c2b362ace1b","affectsGlobalScope":true,"impliedFormat":1},{"version":"64d4c41b11c1c817ddd39c4febdba05b560e4bdc4aef196ca48799b732ec8241","impliedFormat":1},{"version":"e4fdefba646eb133e52e30b00b3086f8849be02becb89c98b3ed4e873e40c8fc","impliedFormat":1},"000977ae7dd8a81b6b19bb728f1f4f991bad890d0731e4954843b8c2c8a981df","965a45ded1bc85495dab58a880ef90a52824e0fcd08f8b60d58fcc695cba4706",{"version":"580ceb322c8eb974de28346645d3d2a74789f95bbed1e8b2d49c30f84be461f7","impliedFormat":1},{"version":"84a810695afa53c64fc8d5ab6917106931107aaf0b8c37090451ce99026b2f0d","impliedFormat":1},{"version":"c88c5571ba8096a05c4ca3a43c4aa816c35e6b18204a11cd6784254c1d4d1c0f","impliedFormat":1},{"version":"3521724656139e916de05d6aed6715950d25dfca93a635cc137bed8ac7e5b325","impliedFormat":1},{"version":"d6434c0cfd4da771bc50eeadf7dc38aa0879219e269dbf7aa99a5350bd06ed81","impliedFormat":1},{"version":"5cf39fcbc606be7459a3cdd274b1b4287186b5cacdbf70a8d6151427936fbce4","impliedFormat":1},{"version":"db058268ec8577f140aee94d9077ad28a45dddc56ae0dd1afa76b0dc34593c80","impliedFormat":1},{"version":"b8e5b0c908b22a744a5094ca16f0643f473c3ca60bb3d0d3fb7cc5aa156d166c","impliedFormat":1},"a8661cf1c887e11801799bbbb4ef2d835d946192992fed14de0a3e6e175769d1","274f2aab48607179a8ff21e92b52d3c7f29ec86bb9903c9448c4b5f2ab59f163","c86968ad65e94e7be68f575417dc8da3d20bff6232f3d579ea5f595735887639","2813832da57103ef8eac8aefa6e4f82c84114ba8606230d309c5346b2c1a808a","5971ac27b5940a03f2a5d6ebbc67009f3ba27f7e0a54900f5bb9493a8afa8268",{"version":"6b8f09f339abe1f322f6055f1870c8edf5395896520b073f58f2dd5accbb503b","impliedFormat":99},{"version":"8fddb3666acf83add11be63b0fcb53f25e0455f37d6cc7ae5069e0cb20a69f24","impliedFormat":99},{"version":"b12cf84d485a80d9b8e15bdafb74eda414ecf4d14f827577cb0323212c39bdab","impliedFormat":99},{"version":"8f5cc5aed56f107d5340c5802d42504423f92851ce20185cd25826281a609fae","impliedFormat":99},{"version":"ba1b62ac3353f11a9db24241daafbb352ce32694212b54ba5f1b2551019c2449","impliedFormat":99},{"version":"331ec27f60245018470614bc39800379c4ababa9288a59b81432b85fced547cb","impliedFormat":99},{"version":"6011c16e0f6ae111e6e5425b009dc1a3f3c80ff5af466fd9620c9381e5e5406c","impliedFormat":99},{"version":"7739e2519c27c9a4bc6fe9d4ecef6d3229bf3b2a99c635fb1bb5bf334046c72f","impliedFormat":99},{"version":"36181dbc3c6afcc6c1d91d8df4b3d19dd367aea7a63422d0bbd71a6ac5070c9c","impliedFormat":99},{"version":"0f0590fa9cd9b504ff8ae79519d67c9432ed69e1212243ce6c095db06a9eb634","impliedFormat":99},{"version":"5ee4fd23c16f0d963879cd9eccffd5d6d0a576d3fc136322c351407a0ab22b96","impliedFormat":99},{"version":"e4a5f9d1510994b0b56cd56a55d6f2f70f0f6a8557299a33ec3d987eb9a15ae2","impliedFormat":99},{"version":"618ffb916797918d2e0b0dc9b654468598053660775f30c734eb84ffb53e7fbb","impliedFormat":99},{"version":"d82a6dba4758f823b97f5c4dbcbd972fea173a5ab7cea857f6dcbd4c1e7a4345","impliedFormat":99},{"version":"a2f9200df989dc877f97b67cf660126cc86bc58bf92cfe40f397851c5d1577d5","impliedFormat":99},{"version":"36181dbc3c6afcc6c1d91d8df4b3d19dd367aea7a63422d0bbd71a6ac5070c9c","impliedFormat":99},{"version":"626abd2680979c0ac67bfe5a30d4ea9175a152e6f0596faba49fcb642a2f899d","impliedFormat":99},{"version":"b0a7826574fa660ada40eb498a493ed88608c4de9e4f222a6b70bf62d0465473","impliedFormat":99},{"version":"ee4f50a577cd0edf60ad03857da9817101a35778082b39d8a9d7cf527a88aa6d","impliedFormat":99},{"version":"729030a4b9eeb9ee47c01812339e9696caf13c6b7e883e73350520adc9d9b989","impliedFormat":99},"643995270a96ae606a55fc8a18b414a36308b005c098e007efea802abcc05435","8ed99c42dbda432ed1b2a31a07766265e4c8576fb0f088a7b2a0740cd6f6eb7e","254fc73608ad9a4983b752e13d4967d835e1a2d7153f0a0fb14be314c5873221","9b70f613adcb349d9a16b5427d0c4d389bf511d9545f0fa11a70a68d1cbba33c","43f4f4645deca716d641a72593d5ad4826d3920a16bcd1fca4410d6d020e57fb","de0b94503454bf0a5e2e04c4723fea332a1713ccc269ec6ea46d6cc029d313a5","0a238c893501839090d88c3c76bb4adf37798050d0802b81069ecde187691189","8f9995c3985dbb66ad068cb82a59951b2d10fce4cc17de6c7c9911a9e479f6d6","6c1b1ecead60edebc9f096f15095d693f57215addcfaa6ae04cec8ff59c36f62","61295e840e21b72f11a352513ed37511d120586da45d7e15f9e1b7fd37dc8972","b70ed2a09c4f150e3cb582562d2108bb89a1b7df27256bfc64a831b5f5c88365","507409afc46d86b4371441dd7a99610ada796ef1710e8d85d7d1b84e8baf7922",{"version":"a9373d52584b48809ffd61d74f5b3dfd127da846e3c4ee3c415560386df3994b","impliedFormat":99},{"version":"caf4af98bf464ad3e10c46cf7d340556f89197aab0f87f032c7b84eb8ddb24d9","impliedFormat":99},{"version":"7ec047b73f621c526468517fea779fec2007dd05baa880989def59126c98ef79","impliedFormat":99},{"version":"8dd450de6d756cee0761f277c6dc58b0b5a66b8c274b980949318b8cad26d712","impliedFormat":99},{"version":"6b5f886fe41e2e767168e491fe6048398ed6439d44e006d9f51cc31265f08978","impliedFormat":99},{"version":"56a87e37f91f5625eb7d5f8394904f3f1e2a90fb08f347161dc94f1ae586bdd0","impliedFormat":99},{"version":"6b863463764ae572b9ada405bf77aac37b5e5089a3ab420d0862e4471051393b","impliedFormat":99},{"version":"904d6ad970b6bd825449480488a73d9b98432357ab38cf8d31ffd651ae376ff5","impliedFormat":99},{"version":"2535fc1a5fe64892783ff8f61321b181c24f824e688a4a05ae738da33466605b","impliedFormat":99},"87046563cee6f579e63ee29c9546d7ce67698c03492f29d1640196e155e05028","34326dd121e9f8366e6c10cf6a957601e79b33c407fe679ac954ad47ca48c221","69727446a7112a07361ba35cadd4aaac5c972857c2c6bffa2c94209e22d60fa2","ceb5e03a160aa407d6a5a282b462956f91212e2610c3004647b6d4cc547f29fc","3262e9f4fadc5ea1f6bec66848b18bb7151eac0c3f910c13538d1b69636749a6","8b8d4be50afb5fd42343bf4427003d52ac2da5c3e02aba2e186a63453d4056f4",{"version":"89121c1bf2990f5219bfd802a3e7fc557de447c62058d6af68d6b6348d64499a","impliedFormat":1},{"version":"79b4369233a12c6fa4a07301ecb7085802c98f3a77cf9ab97eee27e1656f82e6","impliedFormat":1},{"version":"2b37ba54ec067598bf912d56fcb81f6d8ad86a045c757e79440bdef97b52fe1b","impliedFormat":99},{"version":"1bc9dd465634109668661f998485a32da369755d9f32b5a55ed64a525566c94b","impliedFormat":99},{"version":"5702b3c2f5d248290ed99419d77ca1cc3e6c29db5847172377659c50e6303768","impliedFormat":99},{"version":"9764b2eb5b4fc0b8951468fb3dbd6cd922d7752343ef5fbf1a7cd3dfcd54a75e","impliedFormat":99},{"version":"1fc2d3fe8f31c52c802c4dee6c0157c5a1d1f6be44ece83c49174e316cf931ad","impliedFormat":99},{"version":"dc4aae103a0c812121d9db1f7a5ea98231801ed405bf577d1c9c46a893177e36","impliedFormat":99},{"version":"106d3f40907ba68d2ad8ce143a68358bad476e1cc4a5c710c11c7dbaac878308","impliedFormat":99},{"version":"42ad582d92b058b88570d5be95393cf0a6c09a29ba9aa44609465b41d39d2534","impliedFormat":99},{"version":"36e051a1e0d2f2a808dbb164d846be09b5d98e8b782b37922a3b75f57ee66698","impliedFormat":99},{"version":"d4a22007b481fe2a2e6bfd3a42c00cd62d41edb36d30fc4697df2692e9891fc8","impliedFormat":1},{"version":"9d62e577adb05f5aafed137e747b3a1b26f8dce7b20f350d22f6fb3255a3c0ed","impliedFormat":99},{"version":"7ed92bcef308af6e3925b3b61c83ad6157a03ff15c7412cf325f24042fe5d363","impliedFormat":99},{"version":"3da9062d0c762c002b7ab88187d72e1978c0224db61832221edc8f4eb0b54414","impliedFormat":99},{"version":"84dbf6af43b0b5ad42c01e332fddf4c690038248140d7c4ccb74a424e9226d4d","impliedFormat":99},{"version":"00884fc0ea3731a9ffecffcde8b32e181b20e1039977a8ae93ae5bce3ab3d245","impliedFormat":99},{"version":"0bd8b6493d9bf244afe133ccb52d32d293de8d08d15437cca2089beed5f5a6b5","impliedFormat":99},{"version":"7fc3099c95752c6e7b0ea215915464c7203e835fcd6878210f2ce4f0dcbbfe67","impliedFormat":99},{"version":"83b5499dbc74ee1add93aef162f7d44b769dcef3a74afb5f80c70f9a5ce77cc0","impliedFormat":99},{"version":"8bf8b772b38fc4da471248320f49a2219c363a9669938c720e0e0a5a2531eabf","impliedFormat":99},{"version":"7da6e8c98eacf084c961e039255f7ebb9d97a43377e7eee2695cb77fec640c66","impliedFormat":99},{"version":"0b5b064c5145a48cd3e2a5d9528c63f49bac55aa4bc5f5b4e68a160066401375","impliedFormat":99},{"version":"702ff40d28906c05d9d60b23e646c2577ad1cc7cd177d5c0791255a2eab13c07","impliedFormat":99},{"version":"49ff0f30d6e757d865ae0b422103f42737234e624815eee2b7f523240aa0c8f8","impliedFormat":99},{"version":"0389aacf0ffd49a877a46814a21a4770f33fc33e99951a1584de866c8e971993","impliedFormat":99},{"version":"5cb7a51cf151c1056b61f078cf80b811e19787d1f29a33a2a6e4bf00334bbc10","impliedFormat":99},{"version":"215aa8915d707f97ad511b7abbf7eda51d3a7048e9a656955cf0dda767ae7db0","impliedFormat":99},{"version":"0d689a717fbef83da07ab4de33f83db5cbcec9bc4e3b04edb106c538a50a0210","impliedFormat":99},{"version":"d00bc73e8d1f4137f2f6238bb3aa2bbdad8573658cc95920e2cdfa7ad491a8d8","impliedFormat":99},{"version":"e3667aa9f5245d1a99fb4a2a1ac48daf1429040c29cc0d262e3843f9ae3b9d65","impliedFormat":99},{"version":"08c0f3222b50ec2b534be1a59392660102549129246425d33ec43f35aa051dc6","impliedFormat":99},{"version":"612fb780f312e6bb3c40f3cb2b827ea7455b922198f651c799d844fdd44cf2e9","impliedFormat":99},{"version":"bcd98e8f44bc76e4fcb41e4b1a8bab648161a942653a3d1f261775a891d258de","impliedFormat":99},{"version":"5abaa19aa91bb4f63ea58154ada5d021e33b1f39aa026ca56eb95f13b12c497a","impliedFormat":99},{"version":"356a18b0c50f297fee148f4a2c64b0affd352cbd6f21c7b6bfa569d30622c693","impliedFormat":99},{"version":"5876027679fd5257b92eb55d62efee634358012b9f25c5711ad02b918e52c837","impliedFormat":99},{"version":"f5622423ee5642dcf2b92d71b37967b458e8df3cf90b468675ff9fddaa532a0f","impliedFormat":99},{"version":"70265bc75baf24ec0d61f12517b91ea711732b9c349fceef71a446c4ff4a247a","impliedFormat":99},{"version":"41a4b2454b2d3a13b4fc4ec57d6a0a639127369f87da8f28037943019705d619","impliedFormat":99},{"version":"e9b82ac7186490d18dffaafda695f5d975dfee549096c0bf883387a8b6c3ab5a","impliedFormat":99},{"version":"eed9b5f5a6998abe0b408db4b8847a46eb401c9924ddc5b24b1cede3ebf4ee8c","impliedFormat":99},{"version":"af85fde8986fdad68e96e871ae2d5278adaf2922d9879043b9313b18fae920b1","impliedFormat":99},{"version":"8a1f5d2f7cf4bf851cc9baae82056c3316d3c6d29561df28aff525556095554b","impliedFormat":99},{"version":"0a4887266484724ad58e26d79682ebb061781316f1ca2c3735d875debb5f1b96","impliedFormat":99},{"version":"c35294da7a7f5e0cfd7f8efd5c0b9cdd4af7355f54f0244347d634b048e54a8d","impliedFormat":99},"8ce17ae8dbf52fb2529c78fa22a1554df912a2abc7e9784f9cc5b212ada5fcb2","ea3ef6a1b7e2d4cc6414cc50efc9782abea5bc59e7b7b56de07153288a55d7ad","71fd3473c903e518a33f8d9867932bfade3d7dc3688715d91e5a733499558f7c",{"version":"dd332252bb45677533cd5553e0c35340cee4c485c90c63360f8e653901286a4f","impliedFormat":1},{"version":"dddde95f3dea44dc49c9095a861298e829122a54a3f56b3b815e615501e2ed16","impliedFormat":1},{"version":"794a88237c94d74302df12ebb02f521cf5389a5bf046a3fdbdd3afb21dc02511","impliedFormat":1},{"version":"66a08d30c55a7aefa847c1f5958924a3ef9bea6cd1c962a8ff1b2548f66a6ce0","impliedFormat":1},{"version":"0790ae78f92ab08c9d7e66b59733a185a9681be5d0dc90bd20ab5d84e54dcb86","impliedFormat":1},{"version":"1046cd42ec19e4fd038c803b4fc1aff31e51e6e48a6b8237a0240a11c1c27792","impliedFormat":1},{"version":"8f93c7e1084de38a142085c7f664b0eb463428601308fb51c68b25cb687e0887","impliedFormat":1},{"version":"83f69c968d32101f8690845f47bcae016cbea049e222a5946889eb3ae37e7582","impliedFormat":1},{"version":"59c3f3ed18de1c7f5927e0eafcdc0e545db88bfae4168695a89e38a85943a86d","impliedFormat":1},{"version":"32e6c27fd3ef2b1ddbf2bf833b2962d282eb07d9d9d3831ca7f4ff63937268e1","impliedFormat":1},{"version":"406ebb72aa8fdd9227bfce7a1b3e390e2c15b27f5da37ea9e3ed19c7fb78d298","impliedFormat":1},{"version":"197109f63a34b5f9379b2d7ba82fc091659d6878db859bd428ea64740cb06669","impliedFormat":1},{"version":"059871a743c0ca4ae511cbd1e356548b4f12e82bc805ab2e1197e15b5588d1c4","impliedFormat":1},{"version":"8ccefe3940a2fcb6fef502cdbc7417bb92a19620a848f81abc6caa146ab963e9","impliedFormat":1},{"version":"44d8ec73d503ae1cb1fd7c64252ffa700243b1b2cc0afe0674cd52fe37104d60","impliedFormat":1},{"version":"67ea5a827a2de267847bb6f1071a56431aa58a4c28f8af9b60d27d5dc87b7289","impliedFormat":1},{"version":"e33bb784508856827448a22947f2cac69e19bc6e9d6ef1c4f42295f7bd4ce293","impliedFormat":1},{"version":"383bb09bfeb8c6ef424c7fbce69ec7dc59b904446f8cfec838b045f0143ce917","impliedFormat":1},{"version":"83508492e3fc5977bc73e63541e92c5a137db076aafc59dcf63e9c6ad34061c7","impliedFormat":1},{"version":"ef064b9a331b7fc9fe0b368499c52623fb85d37d8972d5758edc26064189d14d","impliedFormat":1},{"version":"d64457d06ab06ad5e5f693123ee2f17594f00e6d5481517058569deac326fea0","impliedFormat":1},{"version":"e92ea29d716c5fe1977a34e447866d5cfbd94b3f648e3b9c550603fdae0e94fb","impliedFormat":1},{"version":"3d10f47c6b1e9225c68c140235657a0cdd4fc590c18faf87dcd003fd4e22c67f","impliedFormat":1},{"version":"13989f79ff8749a8756cac50f762f87f153e3fb1c35768cc6df15968ec1adb1a","impliedFormat":1},{"version":"e014c2f91e94855a52dd9fc88867ee641a7d795cfe37e6045840ecf93dab2e6b","impliedFormat":1},{"version":"74b9f867d1cc9f4e6122f81b59c77cbd6ff39f482fb16cffdc96e4cda1b5fdb1","impliedFormat":1},{"version":"7c8574cfc7cb15a86db9bf71a7dc7669593d7f62a68470adc01b05f246bd20ff","impliedFormat":1},{"version":"c8f49d91b2669bf9414dfc47089722168602e5f64e9488dbc2b6fe1a0f6688da","impliedFormat":1},{"version":"3abee758d3d415b3b7b03551f200766c3e5dd98bb1e4ff2c696dc6f0c5f93191","impliedFormat":1},{"version":"79bd7f60a080e7565186cfdfd84eac7781fc4e7b212ab4cd315b9288c93b7dc7","impliedFormat":1},{"version":"4a2f281330a7b5ed71ebc4624111a832cd6835f3f92ad619037d06b944398cf4","impliedFormat":1},{"version":"ea8130014cb8ee30621bf521f58d036bff3b9753b2f6bd090cc88ac15836d33c","impliedFormat":1},{"version":"c740d49c5a0ecc553ddfc14b7c550e6f5a2971be9ed6e4f2280b1f1fa441551d","impliedFormat":1},{"version":"886a56c6252e130f3e4386a6d3340cf543495b54c67522d21384ed6fb80b7241","impliedFormat":1},{"version":"4b7424620432be60792ede80e0763d4b7aab9fe857efc7bbdb374e8180f4092a","impliedFormat":1},{"version":"e407db365f801ee8a693eca5c21b50fefd40acafda5a1fa67f223800319f98a8","impliedFormat":1},{"version":"529660b3de2b5246c257e288557b2cfa5d5b3c8d2240fa55a4f36ba272b57d18","impliedFormat":1},{"version":"0f6646f9aba018d0a48b8df906cb05fa4881dc7f026f27ab21d26118e5aa15de","impliedFormat":1},{"version":"b3620fcf3dd90a0e6a07268553196b65df59a258fe0ec860dfac0169e0f77c52","impliedFormat":1},{"version":"08135e83e8d9e34bab71d0cf35b015c21d0fd930091b09706c6c9c0e766aca28","impliedFormat":1},{"version":"96e14f2fdc1e3a558462ada79368ed49b004efce399f76f084059d50121bb9a9","impliedFormat":1},{"version":"56f2ade178345811f0c6c4e63584696071b1bd207536dc12384494254bc1c386","impliedFormat":1},{"version":"e484786ef14e10d044e4b16b6214179c95741e89122ba80a7c93a7e00bf624b1","impliedFormat":1},{"version":"4763ce202300b838eb045923eaeb32d9cf86092eee956ca2d4e223cef6669b13","impliedFormat":1},{"version":"7cff5fff5d1a92ae954bf587e5c35987f88cacaa006e45331b3164c4e26369de","impliedFormat":1},{"version":"c276acedaadc846336bb51dd6f2031fdf7f299d0fae1ee5936ccba222e1470ef","impliedFormat":1},{"version":"426c3234f768c89ba4810896c1ee4f97708692727cfecba85712c25982e7232b","impliedFormat":1},{"version":"ee12dd75feac91bb075e2cb0760279992a7a8f5cf513b1cffaa935825e3c58be","impliedFormat":1},{"version":"3e51868ea728ceb899bbfd7a4c7b7ad6dd24896b66812ea35893e2301fd3b23f","impliedFormat":1},{"version":"781e8669b80a9de58083ca1f1c6245ef9fb04d98add79667e3ed70bde034dfd5","impliedFormat":1},{"version":"cfd35b460a1e77a73f218ebf7c4cd1e2eeeaf3fa8d0d78a0a314c6514292e626","impliedFormat":1},{"version":"452d635c0302a0e1c5108edebcca06fc704b2f8132123b1e98a5220afa61a965","impliedFormat":1},{"version":"bbe64c26d806764999b94fcd47c69729ba7b8cb0ca839796b9bb4d887f89b367","impliedFormat":1},{"version":"b87d65da85871e6d8c27038146044cffe40defd53e5113dbd198b8bce62c32db","impliedFormat":1},{"version":"c37712451f6a80cbf8abec586510e5ac5911cb168427b08bc276f10480667338","impliedFormat":1},{"version":"ecf02c182eec24a9a449997ccc30b5f1b65da55fd48cbfc2283bcfa8edc19091","impliedFormat":1},{"version":"0b2c6075fc8139b54e8de7bcb0bed655f1f6b4bf552c94c3ee0c1771a78dea73","impliedFormat":1},{"version":"49707726c5b9248c9bac86943fc48326f6ec44fe7895993a82c3e58fb6798751","impliedFormat":1},{"version":"a9679a2147c073267943d90a0a736f271e9171de8fbc9c378803dd4b921f5ed3","impliedFormat":1},{"version":"a8a2529eec61b7639cce291bfaa2dd751cac87a106050c3c599fccb86cc8cf7f","impliedFormat":1},{"version":"bfc46b597ca6b1f6ece27df3004985c84807254753aaebf8afabd6a1a28ed506","impliedFormat":1},{"version":"7fdee9e89b5a38958c6da5a5e03f912ac25b9451dc95d9c5e87a7e1752937f14","impliedFormat":1},{"version":"b8f3eafeaf04ba3057f574a568af391ca808bdcb7b031e35505dd857db13e951","impliedFormat":1},{"version":"30b38ae72b1169c4b0d6d84c91016a7f4c8b817bfe77539817eac099081ce05c","impliedFormat":1},{"version":"c9f17e24cb01635d6969577113be7d5307f7944209205cb7e5ffc000d27a8362","impliedFormat":1},{"version":"685ead6d773e6c63db1df41239c29971a8d053f2524bfabdef49b829ae014b9a","impliedFormat":1},{"version":"b7bdabcd93148ae1aecdc239b6459dfbe35beb86d96c4bd0aca3e63a10680991","impliedFormat":1},{"version":"e83cfc51d3a6d3f4367101bfdb81283222a2a1913b3521108dbaf33e0baf764a","impliedFormat":1},{"version":"95f397d5a1d9946ca89598e67d44a214408e8d88e76cf9e5aecbbd4956802070","impliedFormat":1},{"version":"74042eac50bc369a2ed46afdd7665baf48379cf1a659c080baec52cc4e7c3f13","impliedFormat":1},{"version":"1541765ce91d2d80d16146ca7c7b3978bd696dc790300a4c2a5d48e8f72e4a64","impliedFormat":1},{"version":"ec6acc4492c770e1245ade5d4b6822b3df3ba70cf36263770230eac5927cf479","impliedFormat":1},{"version":"4c39ee6ae1d2aeda104826dd4ce1707d3d54ac34549d6257bea5d55ace844c29","impliedFormat":1},{"version":"deb099454aabad024656e1fc033696d49a9e0994fc3210b56be64c81b59c2b20","impliedFormat":1},{"version":"80eec3c0a549b541de29d3e46f50a3857b0b90552efeeed90c7179aba7215e2f","impliedFormat":1},{"version":"a4153fbd5c9c2f03925575887c4ce96fc2b3d2366a2d80fad5efdb75056e5076","impliedFormat":1},{"version":"6f7c70ca6fa1a224e3407eb308ec7b894cfc58042159168675ccbe8c8d4b3c80","impliedFormat":1},{"version":"4b56181b844219895f36cfb19100c202e4c7322569dcda9d52f5c8e0490583c9","impliedFormat":1},{"version":"5609530206981af90de95236ce25ddb81f10c5a6a346bf347a86e2f5c40ae29b","impliedFormat":1},{"version":"632ce3ee4a6b320a61076aeca3da8432fb2771280719fde0936e077296c988a9","impliedFormat":1},{"version":"8b293d772aff6db4985bd6b33b364d971399993abb7dc3f19ceed0f331262f04","impliedFormat":1},{"version":"4eb7bad32782df05db4ba1c38c6097d029bed58f0cb9cda791b8c104ccfdaa1f","impliedFormat":1},{"version":"c6a8aa80d3dde8461b2d8d03711dbdf40426382923608aac52f1818a3cead189","impliedFormat":1},{"version":"bf5e79170aa7fc005b5bf87f2fe3c28ca8b22a1f7ff970aa2b1103d690593c92","impliedFormat":1},{"version":"ba3c92c785543eba69fbd333642f5f7da0e8bce146dec55f06cfe93b41e7e12f","impliedFormat":1},{"version":"c6d72ececae6067e65c78076a5d4a508f16c806577a3d206259a0d0bfeedc8d1","impliedFormat":1},{"version":"b6429631df099addfcd4a5f33a046cbbde1087e3fc31f75bfbbd7254ef98ea3c","impliedFormat":1},{"version":"4e9cf1b70c0faf6d02f1849c4044368dc734ad005c875fe7957b7df5afe867c9","impliedFormat":1},{"version":"7498b7d83674a020bd6be46aeed3f0717610cb2ae76d8323e560e964eb122d0c","impliedFormat":1},{"version":"b80405e0473b879d933703a335575858b047e38286771609721c6ab1ea242741","impliedFormat":1},{"version":"7193dfd01986cd2da9950af33229f3b7c5f7b1bee0be9743ad2f38ec3042305e","impliedFormat":1},{"version":"1ccb40a5b22a6fb32e28ffb3003dea3656a106dd3ed42f955881858563776d2c","impliedFormat":1},{"version":"8d97d5527f858ae794548d30d7fc78b8b9f6574892717cc7bc06307cc3f19c83","impliedFormat":1},{"version":"ccb4ecdc8f28a4f6644aa4b5ab7337f9d93ff99c120b82b1c109df12915292ac","impliedFormat":1},{"version":"8bbcf9cecabe7a70dcb4555164970cb48ba814945cb186493d38c496f864058f","impliedFormat":1},{"version":"7d57bdfb9d227f8a388524a749f5735910b3f42adfe01bfccca9999dc8cf594c","impliedFormat":1},{"version":"3508810388ea7c6585496ee8d8af3479880aba4f19c6bbd61297b17eb30428f4","impliedFormat":1},{"version":"56931daef761e6bdd586358664ccd37389baabeb5d20fe39025b9af90ea169a5","impliedFormat":1},{"version":"abb48247ab33e8b8f188ef2754dfa578129338c0f2e277bfc5250b14ef1ab7c5","impliedFormat":1},{"version":"beaba1487671ed029cf169a03e6d680540ea9fa8b810050bc94cb95d5e462db2","impliedFormat":1},{"version":"1418ef0ba0a978a148042bc460cf70930cd015f7e6d41e4eb9348c4909f0e16d","impliedFormat":1},{"version":"56be4f89812518a2e4f0551f6ef403ffdeb8158a7c271b681096a946a25227e9","impliedFormat":1},{"version":"bbb0937150b7ab2963a8bc260e86a8f7d2f10dc5ee7ddb1b4976095a678fdaa4","impliedFormat":1},{"version":"862301d178172dc3c6f294a9a04276b30b6a44d5f44302a6e9d7dc1b4145b20b","impliedFormat":1},{"version":"cbf20c7e913c08cb08c4c3f60dae4f190abbabaa3a84506e75e89363459952f0","impliedFormat":1},{"version":"0f3333443f1fea36c7815601af61cb3184842c06116e0426d81436fc23479cb8","impliedFormat":1},{"version":"421d3e78ed21efcbfa86a18e08d5b6b9df5db65340ef618a9948c1f240859cc1","impliedFormat":1},{"version":"b1225bc77c7d2bc3bad15174c4fd1268896a90b9ab3b306c99b1ade2f88cddcc","impliedFormat":1},{"version":"ca46e113e95e7c8d2c659d538b25423eac6348c96e94af3b39382330b3929f2a","impliedFormat":1},{"version":"03ca07dbb8387537b242b3add5deed42c5143b90b5a10a3c51f7135ca645bd63","impliedFormat":1},{"version":"ca936efd902039fda8a9fc3c7e7287801e7e3d5f58dd16bf11523dc848a247d7","impliedFormat":1},{"version":"2c7b3bfa8b39ed4d712a31e24a8f4526b82eeca82abb3828f0e191541f17004c","impliedFormat":1},{"version":"5ffaae8742b1abbe41361441aa9b55a4e42aee109f374f9c710a66835f14a198","impliedFormat":1},{"version":"ecab0f43679211efc9284507075e0b109c5ad024e49b190bb28da4adfe791e49","impliedFormat":1},{"version":"967109d5bc55face1aaa67278fc762ac69c02f57277ab12e5d16b65b9023b04f","impliedFormat":1},{"version":"36d25571c5c35f4ce81c9dcae2bdd6bbaf12e8348d57f75b3ef4e0a92175cd41","impliedFormat":1},{"version":"fde94639a29e3d16b84ea50d5956ee76263f838fa70fe793c04d9fce2e7c85b9","impliedFormat":1},{"version":"5f4c286fea005e44653b760ebfc81162f64aabc3d1712fd4a8b70a982b8a5458","impliedFormat":1},{"version":"e02dabe428d1ffd638eccf04a6b5fba7b2e8fccee984e4ef2437afc4e26f91c2","impliedFormat":1},{"version":"60dc0180bd223aa476f2e6329dca42fb0acaa71b744a39eb3f487ab0f3472e1c","impliedFormat":1},{"version":"b6fdbecf77dcbf1b010e890d1a8d8bfa472aa9396e6c559e0fceee05a3ef572f","impliedFormat":1},{"version":"e1bf9d73576e77e3ae62695273909089dbbb9c44fb52a1471df39262fe518344","impliedFormat":1},{"version":"d2d57df33a7a5ea6db5f393df864e3f8f8b8ee1dfdfe58180fb5d534d617470f","impliedFormat":1},{"version":"fdcd692f0ac95e72a0c6d1e454e13d42349086649828386fe7368ac08c989288","impliedFormat":1},{"version":"5583eef89a59daa4f62dd00179a3aeff4e024db82e1deff2c7ec3014162ea9a2","impliedFormat":1},{"version":"b0641d9de5eaa90bff6645d754517260c3536c925b71c15cb0f189b68c5386b4","impliedFormat":1},{"version":"9899a0434bd02881d19cb08b98ddd0432eb0dafbfe5566fa4226bdd15624b56f","impliedFormat":1},{"version":"4496c81ce10a0a9a2b9cb1dd0e0ddf63169404a3fb116eb65c52b4892a2c91b9","impliedFormat":1},{"version":"ecdb4312822f5595349ec7696136e92ecc7de4c42f1ea61da947807e3f11ebfc","impliedFormat":1},{"version":"42edbfb7198317dd7359ce3e52598815b5dc5ca38af5678be15a4086cccd7744","impliedFormat":1},{"version":"8105321e64143a22ed5411258894fb0ba3ec53816dad6be213571d974542feeb","impliedFormat":1},{"version":"d1b34c4f74d3da4bdf5b29bb930850f79fd5a871f498adafb19691e001c4ea42","impliedFormat":1},{"version":"9a1caf586e868bf47784176a62bf71d4c469ca24734365629d3198ebc80858d7","impliedFormat":1},{"version":"35a443f013255b33d6b5004d6d7e500548536697d3b6ba1937fd788ca4d5d37b","impliedFormat":1},{"version":"b591c69f31d30e46bc0a2b383b713f4b10e63e833ec42ee352531bbad2aadfaa","impliedFormat":1},{"version":"31e686a96831365667cbd0d56e771b19707bad21247d6759f931e43e8d2c797d","impliedFormat":1},{"version":"dfc3b8616bece248bf6cd991987f723f19c0b9484416835a67a8c5055c5960e0","impliedFormat":1},{"version":"03b64b13ecf5eb4e015a48a01bc1e70858565ec105a5639cfb2a9b63db59b8b1","impliedFormat":1},{"version":"c56cc01d91799d39a8c2d61422f4d5df44fab62c584d86c8a4469a5c0675f7c6","impliedFormat":1},{"version":"5205951312e055bc551ed816cbb07e869793e97498ef0f2277f83f1b13e50e03","impliedFormat":1},{"version":"50b1aeef3e7863719038560b323119f9a21f5bd075bb97efe03ee7dec23e9f1b","impliedFormat":1},{"version":"0cc13970d688626da6dce92ae5d32edd7f9eabb926bb336668e5095031833b7c","impliedFormat":1},{"version":"3be9c1368c34165ba541027585f438ed3e12ddc51cdc49af018e4646d175e6a1","impliedFormat":1},{"version":"7d617141eb3f89973b1e58202cdc4ba746ea086ef35cdedf78fb04a8bb9b8236","impliedFormat":1},{"version":"ea6d9d94247fd6d72d146467070fe7fc45e4af6e0f6e046b54438fd20d3bd6a2","impliedFormat":1},{"version":"d584e4046091cdef5df0cb4de600d46ba83ff3a683c64c4d30f5c5a91edc6c6c","impliedFormat":1},{"version":"ce68902c1612e8662a8edde462dff6ee32877ed035f89c2d5e79f8072f96aed0","impliedFormat":1},{"version":"d48ac7569126b1bc3cd899c3930ef9cf22a72d51cf45b60fc129380ae840c2f2","impliedFormat":1},{"version":"e4f0d7556fda4b2288e19465aa787a57174b93659542e3516fd355d965259712","impliedFormat":1},{"version":"756b471ce6ec8250f0682e4ad9e79c2fddbe40618ba42e84931dbb65d7ac9ab0","impliedFormat":1},{"version":"ce9635a3551490c9acdbcb9a0491991c3d9cd472e04d4847c94099252def0c94","impliedFormat":1},{"version":"b70ee10430cc9081d60eb2dc3bee49c1db48619d1269680e05843fdaba4b2f7a","impliedFormat":1},{"version":"9b78500996870179ab99cbbc02dffbb35e973d90ab22c1fb343ed8958598a36c","impliedFormat":1},{"version":"c6ee8f32bb16015c07b17b397e1054d6906bc916ab6f9cd53a1f9026b7080dbf","impliedFormat":1},{"version":"67e913fa79af629ee2805237c335ea5768ea09b0b541403e8a7eaef253e014d9","impliedFormat":1},{"version":"0b8a688a89097bd4487a78c33e45ca2776f5aedaa855a5ba9bc234612303c40e","impliedFormat":1},{"version":"188e5381ed8c466256937791eab2cc2b08ddcc5e4aaf6b4b43b8786ed1ab5edd","impliedFormat":1},{"version":"8559f8d381f1e801133c61d329df80f7fdab1cbad5c69ebe448b6d3c104a65bd","impliedFormat":1},{"version":"00a271352b854c5d07123587d0bb1e18b54bf2b45918ab0e777d95167fd0cb0b","impliedFormat":1},{"version":"10c4be0feeac95619c52d82e31a24f102b593b4a9eba92088c6d40606f95b85d","impliedFormat":1},{"version":"e1385f59b1421fceba87398c3eb16064544a0ce7a01b3a3f21fa06601dc415dc","impliedFormat":1},{"version":"bacf2c0f8cbfc5537b3c64fc79d3636a228ccbb00d769fb1426b542efe273585","impliedFormat":1},{"version":"3103c479ff634c3fbd7f97a1ccbfb645a82742838cb949fdbcf30dd941aa7c85","impliedFormat":1},{"version":"4b37b3fab0318aaa1d73a6fde1e3d886398345cff4604fe3c49e19e7edd8a50d","impliedFormat":1},{"version":"bf429e19e155685bda115cc7ea394868f02dec99ee51cfad8340521a37a5867a","impliedFormat":1},{"version":"72116c0e0042fd5aa020c2c121e6decfa5414cf35d979f7db939f15bb50d2943","impliedFormat":1},{"version":"20510f581b0ee148a80809122f9bcaa38e4691d3183a4ed585d6d02ffe95a606","impliedFormat":1},{"version":"71f4b56ed57bbdea38e1b12ad6455653a1fbf5b1f1f961d75d182bff544a9723","impliedFormat":1},{"version":"b3e1c5db2737b0b8357981082b7c72fe340edf147b68f949413fee503a5e2408","impliedFormat":1},{"version":"396e64a647f4442a770b08ed23df3c559a3fa7e35ffe2ae0bbb1f000791bda51","impliedFormat":1},{"version":"698551f7709eb21c3ddec78b4b7592531c3e72e22e0312a128c40bb68692a03f","impliedFormat":1},{"version":"662b28f09a4f60e802023b3a00bdd52d09571bc90bf2e5bfbdbc04564731a25e","impliedFormat":1},{"version":"e6b8fb8773eda2c898e414658884c25ff9807d2fce8f3bdb637ab09415c08c3c","impliedFormat":1},{"version":"528288d7682e2383242090f09afe55f1a558e2798ceb34dc92ae8d6381e3504a","impliedFormat":1},"183009b854e90a76739eefb32c970419b6d46a24f34d92cfc937f821775e2bd5","c6aaa4163b67407f01b38de667ea709e686135b0a0439c8b0ee1f3d835e37037","c4aef5d9abe4b18ec554fbce9164614cc32d8570e6e0244805b97462993573c3","5584f99740d3aad4d9a6d3e02b4110d07cea4184763e00a991c4bdbf973103d4","be2926ce6a16bdb749e95efc7b4be412b6b3fab7aa20608f5b684294e6968661","e080fae2c38eaa8bd43a8e0ff2900bbf568b0697823efe34dd707fc2ea5d6836","be84ec8264aae3226d362149d0f77355030e4a457916ee231f7d4f636e310bfb","4c41fa2faed10a0cf744225ade16b3e63d991c7262dd1083aa13990ab2616615","f2de8eac72ebcebf9d625479f6e8de3b6d42c0dc91465813d435e7617d9ad771","8a3a345da717c2161ae5496c4fe6f8c3dea87bf31b48115e81936cb79ed6e27f","a6c2a8a200514cfee0f55dc269e326ebe8039d36f68a1cb310f4ee4203bda178","e95cf569bd9243b582fe2e0e83deb30be41f93bfc6334f98feb1ad72df276bf5","2f9d994a4481b32d4ecaf62ffd5f86779c17d1dc1199dd2136f91a7f0b88a2db","38437b5050e7ddb46face791fa2df1aa257d052b8ba88dc4cedb8555d13ef692","9a660d0dd4eb1fa4150fa65ad9e6c1f5ca8c373256ad211bd38ef5165d0fac6c","85460570e0b68acc07e6d3916ca6b37f939845558348c546068938a614bce7d6","acf28ed1ec175b2fb106af7c62fdb6cb6cddb21ec7ddb76b9bad2a7996d651fd","784973a0b035bad1471bf649bc459ecdb426085ae944ec7f8844c4ea5af9a3a3","0d36dd8f2e79606850027fafefa0da0cc35b7d338815eaca3b08074c662a5b90","783334524772487f911fd429ee8504ca59f99cfa46c6bb8bd3538469b0a66950","92aed42b2c8cc53b2443b20eb50c9d222a06c0afcf219f4d6681d9ee8d7f4789","a1d7d152fceef66c3da23a2f9d6b7745146f9e60a1c8830d4c49130b6559cc30","3384a105737f285db8cc606b9bb238dfb47ee769ec9ab1294c5de75de746905b","b15a828a26ef46adb5910895f34dffeeb281ef66d682270b6c0655fbbf80f3b7","49b58ec9cb29f1933bf5c2b7394cb9d951a42d5b680d425240f111d82b0426ec","f57498e28241fb7c7c002cb2656d374f18036b6cea2278937ae6e67c03114ab1","6f1d252f71d7a2908256a58fa852bbdaec7a8ab85db85062a2bde84eb91fa54c","e9cf02099170ac9847ea1d99668adf44d8cb9f8ae2d5130b7ea8103029eec7df","74420602674466799c1c96cb9dbb5fdbd22c520752065b9b32b8c42dc2b13ad9","dc03076a830ee0231c59bed9a0f9822772d16d78b37b08b1ea2b62ca232c75dd","d7f5b32274971334fc43b98883ad6a22ec760722712a6658ee329385b3c22da0","cf6975ff4aac962aad4326f4d0705adae42e38eb7014bfcf60317633ed699a83","af275398b9165bee9a6a3d73ffffcaa8d09ce02e21a00c5b5bb649fe665e040c","49eadd10c0f781d7d3d3a36ea0359420160c14f108408aca8967c8fc699f83eb","86842b844622e5c7ae39cabb6fa50b56a048e32a48364e61f45f5207fa349bfb",{"version":"fb893a0dfc3c9fb0f9ca93d0648694dd95f33cbad2c0f2c629f842981dfd4e2e","impliedFormat":1},{"version":"3eb11dbf3489064a47a2e1cf9d261b1f100ef0b3b50ffca6c44dd99d6dd81ac1","impliedFormat":1},{"version":"151ff381ef9ff8da2da9b9663ebf657eac35c4c9a19183420c05728f31a6761d","impliedFormat":1},{"version":"5d08a179b846f5ee674624b349ebebe2121c455e3a265dc93da4e8d9e89722b4","impliedFormat":1},{"version":"96d14f21b7652903852eef49379d04dbda28c16ed36468f8c9fa08f7c14c9538","impliedFormat":1},{"version":"b58c81d4cc365d3986aee6c2a86592edc50f141b796899079196ffb103047390","impliedFormat":1},{"version":"fa8dbed00530fb4114906cd93f7fb55512c8eb9551d2f2e9796c69a4da4b594f","impliedFormat":1},{"version":"893cd2b5a7a59d55edc9584cffc0ac51e35ad0290c60d671b61be53d87a02702","impliedFormat":1}],"root":[411,[548,551],599,600,602,608,609,[618,622],[643,654],[664,669],[716,718],[893,927]],"options":{"allowJs":true,"esModuleInterop":true,"jsx":1,"module":99,"skipLibCheck":true,"strict":true,"target":4},"referencedMap":[[913,1],[914,2],[915,3],[919,4],[920,5],[917,6],[921,7],[922,8],[918,9],[923,10],[924,11],[925,12],[926,13],[916,14],[912,15],[927,16],[411,17],[433,18],[424,19],[427,20],[425,21],[431,22],[434,23],[509,24],[436,25],[440,26],[443,27],[486,28],[487,28],[488,29],[489,30],[493,31],[494,32],[492,33],[491,34],[496,35],[495,36],[497,28],[498,28],[499,37],[500,38],[501,39],[502,40],[503,41],[504,42],[505,38],[506,43],[507,31],[508,44],[490,45],[510,46],[511,47],[423,48],[432,49],[426,49],[422,50],[428,50],[435,50],[438,51],[441,49],[481,52],[483,53],[482,54],[444,49],[429,49],[430,45],[442,55],[445,49],[448,56],[420,48],[449,57],[480,49],[439,45],[450,58],[446,49],[451,49],[452,49],[453,49],[454,50],[421,59],[459,49],[458,49],[455,49],[456,49],[457,49],[461,49],[460,49],[462,49],[463,60],[464,50],[465,61],[466,50],[467,56],[468,49],[469,49],[474,49],[471,62],[470,49],[437,49],[472,49],[473,63],[475,49],[476,49],[478,64],[447,58],[479,65],[477,57],[484,49],[485,66],[531,45],[532,48],[512,45],[529,67],[536,68],[521,69],[520,70],[518,71],[519,72],[517,73],[526,74],[525,75],[514,76],[513,45],[528,77],[522,45],[535,78],[527,79],[516,45],[524,80],[523,81],[533,82],[591,83],[585,84],[588,85],[552,86],[553,87],[595,88],[543,89],[596,90],[544,91],[592,90],[589,92],[593,93],[590,94],[597,95],[598,96],[541,97],[530,98],[546,99],[545,45],[540,100],[539,101],[547,102],[542,103],[418,104],[538,105],[594,106],[537,45],[554,45],[534,107],[555,45],[556,107],[557,45],[558,45],[559,45],[560,107],[561,45],[562,107],[586,108],[563,45],[564,45],[565,45],[582,45],[413,109],[580,45],[566,45],[567,45],[568,45],[569,107],[570,107],[587,110],[571,45],[572,45],[579,45],[581,45],[578,45],[414,107],[415,111],[515,45],[573,45],[574,45],[584,112],[419,107],[575,45],[576,45],[577,45],[416,109],[611,113],[610,114],[617,115],[612,113],[614,113],[615,113],[613,113],[616,113],[417,114],[628,116],[623,45],[642,117],[627,118],[629,119],[637,119],[638,119],[630,119],[641,120],[631,119],[632,119],[633,119],[634,119],[635,119],[636,119],[639,119],[640,119],[624,121],[625,122],[626,45],[807,123],[808,45],[809,124],[810,125],[811,126],[806,127],[841,128],[842,129],[840,130],[844,131],[847,132],[843,133],[845,134],[846,134],[858,135],[848,136],[849,137],[850,138],[851,139],[852,140],[853,141],[854,142],[857,143],[855,144],[856,133],[859,145],[860,146],[864,147],[862,148],[861,149],[863,150],[799,151],[781,133],[782,152],[784,153],[798,152],[785,154],[787,133],[786,45],[788,133],[789,155],[796,133],[790,45],[792,45],[793,133],[794,156],[791,45],[795,157],[783,136],[797,158],[865,159],[838,160],[839,161],[837,162],[775,163],[772,164],[773,165],[774,166],[771,167],[767,168],[768,169],[761,167],[762,170],[763,171],[769,168],[770,172],[764,173],[765,174],[766,174],[802,154],[800,154],[803,175],[805,176],[804,177],[801,178],[752,156],[753,45],[776,179],[780,180],[777,45],[778,181],[779,45],[755,182],[756,182],[759,183],[760,184],[758,182],[757,183],[754,152],[812,133],[813,133],[814,133],[815,185],[836,186],[824,187],[823,45],[821,188],[816,189],[819,133],[817,133],[820,133],[822,190],[818,133],[832,45],[827,133],[828,133],[829,45],[830,133],[831,45],[825,45],[826,45],[835,191],[833,45],[834,133],[871,192],[872,193],[875,194],[876,195],[873,196],[874,197],[892,198],[884,199],[883,200],[882,158],[877,201],[881,202],[878,201],[879,201],[880,201],[867,158],[866,45],[870,203],[868,196],[869,204],[885,45],[886,45],[887,158],[891,205],[888,45],[889,158],[890,201],[729,45],[731,206],[732,207],[730,45],[733,45],[734,45],[737,208],[735,45],[736,45],[738,45],[739,45],[740,45],[741,209],[742,45],[743,210],[728,211],[719,45],[720,45],[722,45],[721,138],[723,138],[724,45],[725,138],[726,45],[727,45],[751,212],[749,213],[744,45],[745,45],[746,45],[747,45],[748,45],[750,45],[364,45],[659,214],[655,138],[657,214],[658,214],[663,215],[661,216],[662,214],[656,138],[660,45],[929,217],[931,218],[930,45],[671,219],[932,45],[681,219],[928,45],[933,45],[143,220],[144,220],[145,221],[99,222],[146,223],[147,224],[148,225],[94,45],[97,226],[95,45],[96,45],[149,227],[150,228],[151,229],[152,230],[153,231],[154,232],[155,232],[156,233],[157,234],[158,235],[159,236],[100,45],[98,45],[160,237],[161,238],[162,239],[194,240],[163,241],[164,242],[165,243],[166,244],[167,245],[168,246],[169,247],[170,248],[171,249],[172,250],[173,250],[174,251],[175,45],[176,252],[178,253],[177,254],[179,255],[180,256],[181,257],[182,258],[183,259],[184,260],[185,261],[186,262],[187,263],[188,264],[189,265],[190,266],[191,267],[101,45],[102,45],[103,45],[142,268],[192,269],[193,270],[934,271],[86,45],[199,272],[200,273],[198,138],[196,274],[197,275],[84,45],[87,276],[287,138],[85,45],[935,45],[670,45],[104,45],[412,45],[583,45],[606,277],[607,278],[603,138],[709,279],[683,280],[684,281],[685,281],[686,281],[687,281],[688,281],[689,281],[690,281],[691,281],[692,281],[693,281],[707,282],[694,281],[695,281],[696,281],[697,281],[698,281],[699,281],[700,281],[701,281],[703,281],[704,281],[702,281],[705,281],[706,281],[708,281],[682,283],[605,284],[604,45],[601,138],[93,285],[367,286],[371,287],[373,288],[220,289],[234,290],[338,291],[266,45],[341,292],[302,293],[311,294],[339,295],[221,296],[265,45],[267,297],[340,298],[241,299],[222,300],[246,299],[235,299],[205,299],[293,301],[294,302],[210,45],[290,303],[295,304],[382,305],[288,304],[383,306],[272,45],[291,307],[395,308],[394,309],[297,304],[393,45],[391,45],[392,310],[292,138],[279,311],[280,312],[289,313],[306,314],[307,315],[296,316],[274,317],[275,318],[386,319],[389,320],[253,321],[252,322],[251,323],[398,138],[250,324],[226,45],[401,45],[404,45],[403,138],[405,325],[201,45],[332,45],[233,326],[203,327],[355,45],[356,45],[358,45],[361,328],[357,45],[359,329],[360,329],[219,45],[232,45],[366,330],[374,331],[378,332],[215,333],[282,334],[281,45],[273,317],[301,335],[299,336],[298,45],[300,45],[305,337],[277,338],[214,339],[239,340],[329,341],[206,342],[213,343],[202,291],[343,344],[353,345],[342,45],[352,346],[240,45],[224,347],[320,348],[319,45],[326,349],[328,350],[321,351],[325,352],[327,349],[324,351],[323,349],[322,351],[262,353],[247,353],[314,354],[248,354],[208,355],[207,45],[318,356],[317,357],[316,358],[315,359],[209,360],[286,361],[303,362],[285,363],[310,364],[312,365],[309,363],[242,360],[195,45],[330,366],[268,367],[304,45],[351,368],[271,369],[346,370],[212,45],[347,371],[349,372],[350,373],[333,45],[345,342],[244,374],[331,375],[354,376],[216,45],[218,45],[223,377],[313,378],[211,379],[217,45],[270,380],[269,381],[225,382],[278,383],[276,384],[227,385],[229,386],[402,45],[228,387],[230,388],[369,45],[368,45],[370,45],[400,45],[231,389],[284,138],[92,45],[308,390],[254,45],[264,391],[243,45],[376,138],[385,392],[261,138],[380,304],[260,393],[363,394],[259,392],[204,45],[387,395],[257,138],[258,138],[249,45],[263,45],[256,396],[255,397],[245,398],[238,316],[348,45],[237,399],[236,45],[372,45],[283,138],[365,400],[83,45],[91,401],[88,138],[89,45],[90,45],[344,402],[337,403],[336,45],[335,404],[334,45],[375,405],[377,406],[379,407],[381,408],[384,409],[410,410],[388,410],[409,411],[390,412],[396,413],[397,414],[399,415],[406,416],[408,45],[407,417],[362,418],[713,419],[712,420],[715,421],[714,422],[711,423],[710,424],[678,425],[677,45],[81,45],[82,45],[13,45],[14,45],[16,45],[15,45],[2,45],[17,45],[18,45],[19,45],[20,45],[21,45],[22,45],[23,45],[24,45],[3,45],[25,45],[26,45],[4,45],[27,45],[31,45],[28,45],[29,45],[30,45],[32,45],[33,45],[34,45],[5,45],[35,45],[36,45],[37,45],[38,45],[6,45],[42,45],[39,45],[40,45],[41,45],[43,45],[7,45],[44,45],[49,45],[50,45],[45,45],[46,45],[47,45],[48,45],[8,45],[54,45],[51,45],[52,45],[53,45],[55,45],[9,45],[56,45],[57,45],[58,45],[60,45],[59,45],[61,45],[62,45],[10,45],[63,45],[64,45],[65,45],[11,45],[66,45],[67,45],[68,45],[69,45],[70,45],[1,45],[71,45],[72,45],[12,45],[76,45],[74,45],[79,45],[78,45],[73,45],[77,45],[75,45],[80,45],[120,426],[130,427],[119,426],[140,428],[111,429],[110,430],[139,417],[133,431],[138,432],[113,433],[127,434],[112,435],[136,436],[108,437],[107,417],[137,438],[109,439],[114,440],[115,45],[118,440],[105,45],[141,441],[131,442],[122,443],[123,444],[125,445],[121,446],[124,447],[134,417],[116,448],[117,449],[126,450],[106,451],[129,442],[128,440],[132,45],[135,452],[680,453],[676,45],[679,454],[673,455],[672,219],[675,456],[674,457],[648,45],[649,458],[650,458],[668,459],[669,460],[653,461],[718,462],[895,463],[654,464],[896,463],[897,462],[899,465],[900,463],[651,138],[618,466],[647,467],[602,468],[901,469],[903,470],[904,471],[905,472],[906,471],[902,473],[664,474],[894,472],[619,475],[666,476],[893,477],[667,478],[665,478],[717,479],[898,480],[645,481],[622,482],[644,483],[621,484],[652,485],[620,486],[608,478],[609,487],[909,488],[910,489],[643,490],[646,491],[907,472],[908,478],[911,492],[716,493],[549,45],[550,45],[551,45],[599,494],[600,45],[548,495]],"affectedFilesPendingEmit":[913,914,915,919,920,917,921,922,918,923,924,925,926,916,912,927,648,649,650,668,669,653,718,895,654,896,897,899,900,651,618,647,602,901,903,904,905,906,902,664,894,619,666,893,667,665,717,898,645,622,644,621,652,620,608,609,909,910,643,646,907,908,911,716,549,550,551,599,600,548],"version":"5.9.3"}

==================================================
FILE: next-frontend/eslint.config.mjs
==================================================
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;


==================================================
FILE: next-frontend/.gitignore
==================================================
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.
# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/
dist/ 
# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env
.env.local
.env.*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

# Python
__pycache__/
*.pyc

# Credentials
*.key
*.pem
*.json
!tsconfig.json
!package.json
!package-lock.json


==================================================
FILE: next-frontend/restore_files.py
==================================================
import os

# CONFIG: The root of the frontend application
BASE_DIR = "next-frontend/src"

# DEFINITIONS: Paths and Content
FILES = {
    # 1. The Utility Class Helper (Required for Tailwind classes)
    f"{BASE_DIR}/lib/utils.ts": """
import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
""",

    # 2. The Types Definition (Required for Security Status)
    f"{BASE_DIR}/lib/types.ts": """
export type SecurityStatus = "Top Secret" | "Restricted" | "Internal" | "Open";

export interface CampaignBucket {
  id: string;
  name: string;
  role: string;
  securityStatus: SecurityStatus;
  themeColor: string;
}
""",

    # 3. The Component (The UI Card itself)
    f"{BASE_DIR}/components/campaign/CampaignBucketCard.tsx": """
import type { CSSProperties } from "react";
import { ShieldCheck, ShieldAlert, Lock, Unlock } from "lucide-react";
import { cn } from "@app/lib/utils";
import type { SecurityStatus } from "@app/lib/types";

export interface CampaignBucketCardProps {
  name: string;
  role: string;
  securityStatus: SecurityStatus;
  themeColor: string;
  onClick?: () => void;
}

const securityLabelMap: Record<SecurityStatus, string> = {
  "Top Secret": "Top Secret Â· Zero-Trust",
  Restricted: "Restricted Â· Need-to-know",
  Internal: "Internal Â· Staff only",
  Open: "Open Â· Shared workspace",
};

function getSecurityIcon(status: SecurityStatus) {
  switch (status) {
    case "Top Secret": return ShieldCheck;
    case "Restricted": return ShieldAlert;
    case "Internal": return Lock;
    case "Open": default: return Unlock;
  }
}

export function CampaignBucketCard({
  name,
  role,
  securityStatus,
  themeColor,
  onClick,
}: CampaignBucketCardProps) {
  const Icon = getSecurityIcon(securityStatus);
  return (
    <button
      type="button"
      onClick={onClick}
      style={{ "--accent": themeColor } as CSSProperties}
      className={cn(
        "group relative flex flex-col items-stretch justify-between",
        "rounded-2xl border border-white/10 bg-zinc-900/60",
        "px-5 py-4 sm:px-6 sm:py-5",
        "backdrop-blur-xl shadow-[0_18px_60px_rgba(0,0,0,0.75)]",
        "transition-all duration-200 ease-out",
        "hover:border-white/20 hover:bg-zinc-900/80 hover:-translate-y-1 hover:shadow-[0_24px_80px_rgba(0,0,0,0.85)]",
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[color:var(--accent)] text-left"
      )}
    >
      <div
        aria-hidden="true"
        className="pointer-events-none absolute inset-px rounded-2xl opacity-0 blur-xl transition-opacity duration-300 group-hover:opacity-100"
        style={{
          background: "radial-gradient(circle at 0% 0%, color-mix(in srgb, var(--accent) 65%, transparent) 0, transparent 55%)",
        }}
      />
      <div className="relative flex items-start justify-between gap-4">
        <div className="inline-flex items-center gap-2 rounded-full border border-white/10 bg-zinc-950/80 px-3 py-1 text-xs font-mono tracking-tight text-zinc-200">
          <span className="h-1.5 w-1.5 rounded-full" style={{ backgroundColor: "var(--accent)", boxShadow: "0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent)" }} />
          <span className="uppercase text-[0.65rem] text-zinc-400">{securityStatus}</span>
        </div>
        <div className="flex items-center gap-2 text-xs text-zinc-400">
          <Icon className="h-4 w-4 text-[color:var(--accent)]" />
        </div>
      </div>
      <div className="relative mt-4 space-y-1.5">
        <h2 className="text-base sm:text-lg font-semibold tracking-tight text-zinc-50">{name}</h2>
        <p className="text-xs sm:text-sm text-zinc-400">Operating as <span className="font-mono text-zinc-200">{role}</span></p>
      </div>
    </button>
  );
}
"""
}

def restore_files():
    print("ðŸ”§ Restoring Missing Component Files...")
    for path, content in FILES.items():
        # Ensure directory exists
        os.makedirs(os.path.dirname(path), exist_ok=True)
        # Write file
        with open(path, "w", encoding="utf-8") as f:
            f.write(content.strip())
        print(f"âœ… Created: {path}")

    print("\nðŸš€ Files Restored. Running dependency check...")

if __name__ == "__main__":
    restore_files()


==================================================
FILE: next-frontend/src/middleware.ts
==================================================
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";

// Define public routes that don't require authentication
const isPublicRoute = createRouteMatcher([
  "/sign-in(.*)",
  "/sign-up(.*)",
]);

export default clerkMiddleware(async (auth, req) => {
  // Protect all routes except public ones
  if (!isPublicRoute(req)) {
    await auth.protect();
  }
});

export const config = {
  matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
};


==================================================
FILE: next-frontend/src/styles/globals.css
==================================================
@import "tailwindcss";

@theme {
  --color-zinc-950: #09090b;
  --color-zinc-900: #18181b;
  --color-zinc-800: #27272a;
  --color-zinc-100: #f4f4f5;
  --color-amber-400: #facc15;
}

:root {
  --background: #020617; /* Deep Navy (Slate 950) - No Black */
  --foreground: #f4f4f5;
  --card: #0f172a; /* Slate 900 */
  --popover: #0f172a; /* Slate 900 */
}

/* Dark Mode - Clean Background (Grid handled by CSS) */
body {
  background-color: var(--background);
  color: var(--foreground);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  position: relative;
  overflow-x: hidden;
  min-height: 100vh;
}

/* Light Mode - Ceramic (Physical Paper Documents) */
.light {
  --background: #f2f2f2; /* Off-white */
  --card-bg: #ffffff;
  --text-primary: #0a0a0a; /* Stark black */
  --foreground: var(--text-primary);
  background-color: var(--background);
  color: var(--foreground);
  /* No shadows, strictly black borders */
  border-color: #e5e5e5;
}

/* Utility to hide scrollbars but keep functionality */
.scrollbar-hide {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}
.scrollbar-hide::-webkit-scrollbar {
  display: none;  /* Chrome, Safari and Opera */
}

/* Thin scrollbar styling */
.scrollbar-thin {
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
}
.scrollbar-thin::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
.scrollbar-thin::-webkit-scrollbar-track {
  background: transparent;
}
.scrollbar-thin::-webkit-scrollbar-thumb {
  background-color: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
}
.scrollbar-thin::-webkit-scrollbar-thumb:hover {
  background-color: rgba(255, 255, 255, 0.2);
}

/* DocViewer Dark Theme Overrides */
.react-doc-viewer {
  background: transparent !important;
}

.react-doc-viewer .rdv-viewer {
  background: transparent !important;
}

.react-doc-viewer iframe {
  background: transparent !important;
}

/* Ensure DocViewer content is visible in dark theme */
.react-doc-viewer * {
  color: rgb(244, 244, 245) !important;
}

/* ============================================
   "EXPENSIVE" CSS DESIGN SYSTEM - ONYX & CERAMIC
   ============================================ */

/* Glass Panel - Hardware-accelerated backdrop blur */
.glass-panel {
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  background: rgba(10, 10, 12, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.08);
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  will-change: transform;
  transform: translateZ(0); /* Force GPU acceleration */
}

/* Text Glow - Amber glow effect */
.text-glow {
  text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
  will-change: text-shadow;
}

/* Border Glow - Animated gradient border effect */
.border-glow {
  position: relative;
  background: transparent;
  border: 1px solid transparent;
}

.border-glow::before {
  content: "";
  position: absolute;
  inset: -1px;
  border-radius: inherit;
  padding: 1px;
  background: linear-gradient(
    45deg,
    rgba(251, 191, 36, 0.3),
    rgba(251, 191, 36, 0.1),
    rgba(251, 191, 36, 0.3)
  );
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
  animation: border-glow-pulse 3s ease-in-out infinite;
  will-change: opacity;
}

@keyframes border-glow-pulse {
  0%, 100% {
    opacity: 0.5;
  }
  50% {
    opacity: 1;
  }
}

/* Spotlight Blob - Breathing animation for depth */
@keyframes spotlight-breathe {
  0%, 100% {
    transform: scale(1) translate(0, 0);
    opacity: 0.15;
  }
  50% {
    transform: scale(1.2) translate(10px, 10px);
    opacity: 0.25;
  }
}

@keyframes spotlight-pulse {
  0%, 100% {
    opacity: 0.15;
    transform: scale(1);
  }
  50% {
    opacity: 0.3;
    transform: scale(1.1);
  }
}

.spotlight-blob {
  position: fixed;
  width: 600px;
  height: 600px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(251, 191, 36, 0.2) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
  will-change: transform, opacity;
  transform: translate(-50%, -50%) translateZ(0); /* Center the blob, force GPU acceleration */
}

/* ============================================
   RILEY MARKDOWN STYLING - Enhanced Readability
   ============================================ */

.riley-md {
  font-size: 15.5px;
  line-height: 1.75;
  color: rgb(228, 228, 231);
}

.riley-md p {
  margin: 0 0 12px;
}

.riley-md h1 {
  font-size: 1.75rem;
  font-weight: 700;
  margin-top: 1.5rem;
  margin-bottom: 0.75rem;
  line-height: 1.3;
  color: rgb(244, 244, 245);
}

.riley-md h2 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-top: 1.25rem;
  margin-bottom: 0.625rem;
  line-height: 1.3;
  color: rgb(244, 244, 245);
}

.riley-md h3 {
  font-size: 18px;
  font-weight: 700;
  margin: 18px 0 10px;
  color: #fff;
}

.riley-md ul,
.riley-md ol {
  margin: 0 0 14px;
  padding-left: 22px;
}

.riley-md ul {
  list-style-type: disc;
}

.riley-md ol {
  list-style-type: decimal;
}

.riley-md li {
  margin: 0 0 8px;
}

.riley-md strong {
  color: #fff;
}

.riley-md code {
  background: rgba(255, 255, 255, 0.06);
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 0.875em;
  font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
}

.riley-md pre {
  background-color: rgba(24, 24, 27, 0.9); /* zinc-900 with opacity */
  color: rgb(244, 244, 245);
  padding: 1rem;
  border-radius: 0.5rem;
  overflow-x: auto;
  margin: 0.75rem 0;
  border: 1px solid rgba(63, 63, 70, 0.5); /* zinc-700 border */
}

.riley-md pre code {
  background-color: transparent;
  color: inherit;
  padding: 0;
  font-size: 0.875rem;
}

.riley-md blockquote {
  border-left: 3px solid rgba(251, 191, 36, 0.5);
  padding-left: 1rem;
  margin: 0.75rem 0;
  color: rgb(212, 212, 216); /* zinc-300 */
  font-style: italic;
}

.riley-md a {
  color: rgb(251, 191, 36);
  text-decoration: underline;
  text-decoration-color: rgba(251, 191, 36, 0.5);
}

.riley-md a:hover {
  color: rgb(253, 224, 71); /* amber-300 */
  text-decoration-color: rgb(253, 224, 71);
}


==================================================
FILE: next-frontend/src/app/page.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import { useAuth, useUser } from "@clerk/nextjs";
import { CampaignBucketCard } from "@app/components/campaign/CampaignBucketCard";
import { GlobalMenu } from "@app/components/layout/GlobalMenu";
import { OpsDock } from "@app/components/dashboard/OpsDock";
import { CreateCampaignModal } from "@app/components/dashboard/CreateCampaignModal";
import { CampaignDirectory } from "@app/components/dashboard/CampaignDirectory";
import Greeting from "@app/components/ui/Greeting";
import { apiFetch } from "@app/lib/api";

// Backend campaign response shape
interface BackendCampaign {
  id: string;
  name: string;
  description: string | null;
  role: "Lead" | "Member";
}

interface CampaignsResponse {
  campaigns: BackendCampaign[];
}

// Frontend campaign shape for CampaignBucketCard
interface CampaignBucket {
  name: string;
  role: string;
  lastActive: string;
  mentions: number;
  pendingRequests: number;
  userRole: "Lead" | "Member";
  themeColor: string;
  campaignId: string;
}

// Theme colors for campaigns (rotating assignment)
const THEME_COLORS = [
  "#0f766e", // Teal
  "#4f46e5", // Indigo
  "#e11d48", // Rose
  "#059669", // Emerald
  "#7c3aed", // Violet
  "#facc15", // Amber
];

// Map backend campaign to frontend shape
function mapBackendToFrontend(
  backendCampaign: BackendCampaign,
  index: number
): CampaignBucket {
  // Generate role display text based on user role
  const roleDisplay =
    backendCampaign.role === "Lead"
      ? "Lead Strategist"
      : backendCampaign.role === "Member"
      ? "Team Member"
      : "Member";

  // Assign theme color based on index (consistent per campaign)
  const themeColor = THEME_COLORS[index % THEME_COLORS.length];

  return {
    name: backendCampaign.name,
    role: roleDisplay,
    lastActive: "Recently active", // TODO: Add lastActive from backend if available
    mentions: 0, // TODO: Add mentions from backend if available
    pendingRequests: 0, // TODO: Add pendingRequests from backend if available
    userRole: backendCampaign.role,
    themeColor,
    campaignId: backendCampaign.id,
  };
}

export default function Dashboard() {
  const { user } = useUser();
  const { getToken, isLoaded } = useAuth();
  const [campaigns, setCampaigns] = useState<CampaignBucket[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [isDirectoryOpen, setIsDirectoryOpen] = useState(false);
  const [terminatingCampaignId, setTerminatingCampaignId] = useState<string | null>(null);

  // Fetch campaigns from API
  useEffect(() => {
    async function fetchCampaigns() {
      // Only fetch when Clerk is loaded
      if (!isLoaded) {
        return;
      }

      // If user is not authenticated, show empty state (not error)
      const userId = user?.id;
      if (!userId) {
        setIsLoading(false);
        setError(null);
        setCampaigns([]);
        return;
      }

      try {
        setIsLoading(true);
        setError(null);

        const token = await getToken();
        if (!token) {
          throw new Error("No authentication token available");
        }

        const data: CampaignsResponse = await apiFetch("/api/v1/campaigns", {
          token,
          method: "GET",
        });
        
        const mappedCampaigns = data.campaigns.map((campaign, index) =>
          mapBackendToFrontend(campaign, index)
        );
        setCampaigns(mappedCampaigns);
      } catch (err) {
        console.error("Error fetching campaigns:", err);
        // Preserve exact error message from apiFetch (includes status codes if available)
        const errorMessage = err instanceof Error 
          ? err.message 
          : "Unable to load campaigns. Please refresh.";
        setError(errorMessage);
        // Clear campaigns on error to ensure we don't show stale data
        setCampaigns([]);
      } finally {
        setIsLoading(false);
      }
    }

    fetchCampaigns();
  }, [isLoaded, user?.id, getToken]);

  const handleCampaignCreated = (newCampaign: CampaignBucket) => {
    // Optimistically add the new campaign to the list
    setCampaigns((prev) => [newCampaign, ...prev]);
    setIsCreateModalOpen(false);
    
    // Optionally re-fetch in background to ensure consistency
    // (The new campaign is already in state, so this is just for safety)
    setTimeout(async () => {
      try {
        const token = await getToken();
        if (!token) return;

        try {
          const data: CampaignsResponse = await apiFetch("/api/v1/campaigns", {
            token,
            method: "GET",
          });
          const mappedCampaigns = data.campaigns.map((campaign, index) =>
            mapBackendToFrontend(campaign, index)
          );
          setCampaigns(mappedCampaigns);
        } catch {
          // Silently fail - optimistic update already succeeded
        }
      } catch (err) {
        console.error("Background refresh failed:", err);
        // Don't show error to user - optimistic update already succeeded
      }
    }, 1000);
  };

  const handleEnterCampaign = (campaignId: string) => {
    // Navigate to campaign page
    window.location.href = `/campaign/${campaignId}`;
  };

  const handleRequestAccess = (campaignId: string) => {
    // TODO: Implement access request API call
    console.log("Requesting access to campaign:", campaignId);
  };

  const handleArchive = (campaignId: string) => {
    // Archive functionality removed - campaigns are managed by backend
    console.log("Archive not implemented - campaigns are managed by backend");
  };

  const handleRestore = (campaignId: string) => {
    // Restore functionality removed - campaigns are managed by backend
    console.log("Restore not implemented - campaigns are managed by backend");
  };

  const handleTerminate = async (campaignId: string) => {
    if (
      !confirm(
        `Are you sure you want to permanently terminate this campaign? This will delete ALL data and cannot be undone.`
      )
    ) {
      return;
    }

    setTerminatingCampaignId(campaignId);

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("No authentication token available");
      }

      await apiFetch(`/api/v1/campaign/${campaignId}`, {
        token,
        method: "DELETE",
      });

      // Optimistically remove from UI
      setCampaigns((prev) => prev.filter((c) => c.campaignId !== campaignId));
    } catch (err) {
      console.error("Termination error:", err);
      alert(
        `Failed to terminate campaign: ${
          err instanceof Error ? err.message : "Unknown error"
        }`
      );
    } finally {
      setTerminatingCampaignId(null);
    }
  };

  return (
    <div className="relative min-h-screen flex flex-col items-center pt-24 pb-12">
      {/* Ops Dock - Left Navigation */}
      <OpsDock
        onInitialize={() => setIsCreateModalOpen(true)}
        onDirectory={() => setIsDirectoryOpen(true)}
      />

      {/* Global Menu - Top Right */}
      <GlobalMenu />

      {/* Header - Top Center */}
      <div className="mb-8 text-center">
        <h1 className="text-4xl sm:text-5xl font-bold tracking-widest text-zinc-100 dark:text-zinc-100 light:text-zinc-900">
          RILEY | <span className="text-amber-400">PLATFORM</span>
        </h1>
        <p className="mt-6 text-xl sm:text-2xl font-light text-zinc-300">
          Welcome back, <Greeting />.
        </p>
      </div>

      {/* Loading State */}
      {isLoading && (
        <div className="w-full max-w-7xl px-6">
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[1, 2, 3].map((i) => (
              <div
                key={i}
                className="h-64 rounded-lg border border-zinc-800 bg-zinc-900/50 animate-pulse"
              />
            ))}
          </div>
          <p className="mt-6 text-center text-zinc-400">Loading missions...</p>
        </div>
      )}

      {/* Error State - Show exact error message from API */}
      {!isLoading && error && (
        <div className="w-full max-w-7xl px-6">
          <div className="rounded-lg border border-red-500/50 bg-red-500/10 p-6 text-center">
            <p className="text-red-400 font-medium">{error}</p>
            <button
              onClick={() => window.location.reload()}
              className="mt-4 rounded-lg bg-amber-400 px-4 py-2 text-sm font-semibold text-zinc-900 hover:bg-amber-500 transition-colors"
            >
              Refresh Page
            </button>
          </div>
        </div>
      )}

      {/* Empty State - Only show when not loading, no error, and truly empty */}
      {!isLoading && !error && campaigns.length === 0 && (
        <div className="w-full max-w-7xl px-6">
          <div className="rounded-lg border border-zinc-800 bg-zinc-900/50 p-12 text-center">
            <p className="text-xl text-zinc-300 mb-4">
              No campaigns yet.
            </p>
            <p className="text-zinc-400 mb-6">
              Create your first mission to get started.
            </p>
            <button
              onClick={() => setIsCreateModalOpen(true)}
              className="rounded-lg bg-amber-400 px-6 py-3 text-sm font-semibold text-zinc-900 hover:bg-amber-500 transition-colors"
            >
              Create Campaign
            </button>
          </div>
        </div>
      )}

      {/* Success State - Render campaign cards */}
      {!isLoading && !error && campaigns.length > 0 && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-7xl px-6">
          {campaigns.map((campaign) => (
            <CampaignBucketCard
              key={campaign.campaignId}
              name={campaign.name}
              role={campaign.role}
              lastActive={campaign.lastActive}
              mentions={campaign.mentions}
              pendingRequests={campaign.pendingRequests}
              userRole={campaign.userRole}
              themeColor={campaign.themeColor}
              campaignId={campaign.campaignId}
              isArchived={false}
              onArchive={handleArchive}
              onRestore={undefined}
              onTerminate={handleTerminate}
              isTerminating={terminatingCampaignId === campaign.campaignId}
            />
          ))}
        </div>
      )}

      {/* Modals */}
      <CreateCampaignModal
        isOpen={isCreateModalOpen}
        onClose={() => setIsCreateModalOpen(false)}
        onCampaignCreated={handleCampaignCreated}
      />
      <CampaignDirectory
        isOpen={isDirectoryOpen}
        onClose={() => setIsDirectoryOpen(false)}
        userCampaigns={campaigns}
        archivedCampaigns={[]}
        onEnterCampaign={handleEnterCampaign}
        onRequestAccess={handleRequestAccess}
        onRestore={handleRestore}
        onTerminate={handleTerminate}
        terminatingCampaignId={terminatingCampaignId}
      />
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/layout.tsx
==================================================
import type { Metadata } from "next";
import "@app/styles/globals.css";
import { cn } from "@app/lib/utils";
import { Providers } from "./providers";
import { GlobalRileyOrb } from "@app/components/layout/GlobalRileyOrb";
import { GridBackground } from "@app/components/layout/GridBackground";
import { ClerkProvider } from "@clerk/nextjs";
import { dark } from "@clerk/themes";

export const metadata: Metadata = {
  title: "RILEY | Collaborative Intelligence",
  description: "Secure Advocacy Operations Platform",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body
        className={cn(
          "min-h-screen font-sans antialiased selection:bg-zinc-800"
        )}
      >
        <GridBackground />
        <ClerkProvider
          appearance={{
            baseTheme: dark,
            variables: {
              colorPrimary: "#fbbf24", // amber-400
              colorBackground: "#0f172a", // Tron Blue (Slate 900)
            },
          }}
        >
          <Providers>
            {children}
            <GlobalRileyOrb />
          </Providers>
        </ClerkProvider>
      </body>
    </html>
  );
}



==================================================
FILE: next-frontend/src/app/providers.tsx
==================================================
"use client";

import { ThemeProvider } from "next-themes";

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <ThemeProvider attribute="class" defaultTheme="dark" enableSystem={false}>
      {children}
    </ThemeProvider>
  );
}



==================================================
FILE: next-frontend/src/app/(auth)/layout.tsx
==================================================
export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen bg-zinc-950 flex items-center justify-center">
      {children}
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/(auth)/sign-in/page.tsx
==================================================
"use client";

import { SignIn } from "@clerk/nextjs";

export default function Page() {
  return <SignIn />;
}


==================================================
FILE: next-frontend/src/app/(auth)/sign-up/page.tsx
==================================================
"use client";

import { SignUp } from "@clerk/nextjs";

export default function Page() {
  return <SignUp />;
}


==================================================
FILE: next-frontend/src/app/riley/page.tsx
==================================================
"use client";

import Link from "next/link";
import { ArrowLeft } from "lucide-react";
import { RileyStudio } from "@app/components/chat/RileyStudio";

export default function GlobalRileyPage() {
  return (
    <div className="h-screen flex flex-col bg-zinc-950">
      {/* Minimal Header with Back Button */}
      <header className="h-16 border-b border-zinc-800 flex items-center px-6 shrink-0">
        <Link
          href="/"
          className="flex items-center gap-2 text-sm text-zinc-400 hover:text-zinc-100 transition-colors"
        >
          <ArrowLeft className="h-4 w-4" />
          <span>Back to Dashboard</span>
        </Link>
      </header>

      {/* Riley Studio - Full Screen */}
      <div className="flex-1 min-h-0">
        <RileyStudio contextName="Rally Global Brain" tenantId="global" />
      </div>
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/layout.tsx
==================================================
import { ReactNode } from "react";

export default function CampaignLayout({
  children,
}: {
  children: ReactNode;
}) {
  return <>{children}</>;
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/page.tsx
==================================================
"use client";

import { useParams } from "next/navigation";
import { Users, FileText, Calendar } from "lucide-react";
import { cn } from "@app/lib/utils";

// Mock data
const recentActivity = [
  { id: "1", type: "upload", file: "Q3_Polling_Data.pdf", user: "Sarah Chen", time: "2 hours ago" },
  { id: "2", type: "upload", file: "Candidate_Bio_Draft.docx", user: "John Martinez", time: "5 hours ago" },
  { id: "3", type: "upload", file: "Strategic_Plan_Q1.xlsx", user: "Alex Rivera", time: "1 day ago" },
];

const teamStatus = [
  { name: "Sarah Chen", role: "Lead Strategist", status: "online" },
  { name: "John Martinez", role: "Media Expert", status: "online" },
  { name: "Alex Rivera", role: "Research Lead", status: "away" },
  { name: "Emma Wilson", role: "Policy Analyst", status: "offline" },
];

const upcomingDeadlines = [
  { id: "1", title: "Q3 Report Submission", date: "Jan 25, 2024", daysLeft: 3 },
  { id: "2", title: "Client Review Meeting", date: "Jan 28, 2024", daysLeft: 6 },
  { id: "3", title: "Campaign Launch Prep", date: "Feb 1, 2024", daysLeft: 10 },
];

// Helper function to format campaign name from ID
function formatCampaignName(campaignId: string): string {
  return campaignId
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
}

export default function CampaignOverviewPage() {
  const params = useParams();
  const campaignId = params.id as string;
  const campaignName = formatCampaignName(campaignId);

  return (
    <div className="min-h-full p-6 bg-transparent">
      {/* Header */}
      <div className="mb-8 bg-transparent">
        <h1 className="text-3xl font-bold tracking-tight text-zinc-100 mb-2">
          {campaignName} Dashboard
        </h1>
        <p className="text-zinc-500">Campaign Status: <span className="text-emerald-400">Active</span></p>
      </div>

      {/* Bento Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* Recent Activity Widget */}
        <div className="rounded-xl border border-zinc-800 bg-zinc-900/50 backdrop-blur-md p-6">
          <div className="flex items-center gap-2 mb-4">
            <FileText className="h-5 w-5 text-zinc-400" />
            <h2 className="text-lg font-semibold text-zinc-100">Recent Activity</h2>
          </div>
          <div className="space-y-3">
            {recentActivity.map((activity) => (
              <div
                key={activity.id}
                className="flex items-start gap-3 p-3 rounded-lg bg-zinc-800/30 hover:bg-zinc-800/50 transition-colors"
              >
                <div className="flex-shrink-0 mt-0.5">
                  <div className="h-2 w-2 rounded-full bg-emerald-500" />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm text-zinc-100 truncate">{activity.file}</p>
                  <p className="text-xs text-zinc-500 mt-0.5">
                    {activity.user} â€¢ {activity.time}
                  </p>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Team Status Widget */}
        <div className="rounded-xl border border-zinc-800 bg-zinc-900/50 backdrop-blur-md p-6">
          <div className="flex items-center gap-2 mb-4">
            <Users className="h-5 w-5 text-zinc-400" />
            <h2 className="text-lg font-semibold text-zinc-100">Team Status</h2>
          </div>
          <div className="space-y-3">
            {teamStatus.map((member, index) => (
              <div
                key={index}
                className="flex items-center gap-3 p-3 rounded-lg bg-zinc-800/30 hover:bg-zinc-800/50 transition-colors"
              >
                <div className="relative">
                  <div className="h-10 w-10 rounded-full bg-zinc-800 flex items-center justify-center text-xs font-medium text-zinc-100">
                    {member.name.split(" ").map((n) => n[0]).join("")}
                  </div>
                  <div
                    className={cn(
                      "absolute bottom-0 right-0 h-3 w-3 rounded-full border-2 border-zinc-900",
                      member.status === "online"
                        ? "bg-emerald-500"
                        : member.status === "away"
                        ? "bg-amber-500"
                        : "bg-zinc-600"
                    )}
                  />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-zinc-100 truncate">{member.name}</p>
                  <p className="text-xs text-zinc-500 truncate">{member.role}</p>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Upcoming Deadlines Widget */}
        <div className="rounded-xl border border-zinc-800 bg-zinc-900/50 backdrop-blur-md p-6">
          <div className="flex items-center gap-2 mb-4">
            <Calendar className="h-5 w-5 text-zinc-400" />
            <h2 className="text-lg font-semibold text-zinc-100">Upcoming Deadlines</h2>
          </div>
          <div className="space-y-3">
            {upcomingDeadlines.map((deadline) => (
              <div
                key={deadline.id}
                className="flex items-center justify-between p-3 rounded-lg bg-zinc-800/30 hover:bg-zinc-800/50 transition-colors"
              >
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-zinc-100 truncate">{deadline.title}</p>
                  <p className="text-xs text-zinc-500 mt-0.5">{deadline.date}</p>
                </div>
                <div className="flex-shrink-0 ml-3">
                  <span className="inline-flex items-center rounded-full bg-amber-500/10 border border-amber-500/20 px-2.5 py-1 text-xs font-medium text-amber-400">
                    {deadline.daysLeft}d
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/layout.tsx
==================================================
"use client";

import { ReactNode, useState } from "react";
import { CampaignSidebar } from "@app/components/layout/CampaignSidebar";
import { cn } from "@app/lib/utils";

interface CampaignLayoutProps {
  children: ReactNode;
}

export default function CampaignLayout({ children }: CampaignLayoutProps) {
  const [isCollapsed, setIsCollapsed] = useState(false);

  return (
    <div className="flex h-screen overflow-hidden bg-transparent text-white">
      <CampaignSidebar
        isCollapsed={isCollapsed}
        onToggle={() => setIsCollapsed(!isCollapsed)}
      />
      <main 
        className={cn(
          "flex-1 flex flex-col min-w-0 overflow-hidden relative bg-transparent transition-all duration-300",
          isCollapsed ? "ml-20" : "ml-64"
        )}
      >
        {children}
      </main>
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/chat/page.tsx
==================================================
"use client";

import { useState, useRef, useEffect } from "react";
import { useParams } from "next/navigation";
import { useAuth, useUser } from "@clerk/nextjs";
import { Send } from "lucide-react";
import { cn } from "@app/lib/utils";
import { apiFetch } from "@app/lib/api";
import { useCampaignName } from "@app/lib/useCampaignName";

// Helper function to get initials from name
function getInitials(name: string): string {
  return name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase()
    .slice(0, 2);
}

// Helper function to format time
function formatTime(date: Date): string {
  return date.toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    hour12: true,
  });
}

// Backend message shape
interface BackendMessage {
  id: string;
  content: string;
  timestamp: string; // ISO string
  author_id: string;
}

// Frontend message shape
interface TeamMessage {
  id: string;
  author: string;
  authorInitials: string;
  content: string;
  timestamp: Date;
  author_id: string;
}

// TeamMessageBubble component
function TeamMessageBubble({ message }: { message: TeamMessage }) {
  // Parse content and highlight mentions
  const renderContent = (text: string) => {
    // Split by spaces but keep the spaces
    const parts = text.split(/(\s+)/);
    
    return parts.map((part, idx) => {
      // Check if part is a mention (starts with @ and followed by word characters)
      if (part.startsWith("@") && /^@\w+/.test(part)) {
        return (
          <span
            key={idx}
            className="text-amber-400 font-medium"
          >
            {part}
          </span>
        );
      }
      return <span key={idx}>{part}</span>;
    });
  };

  return (
    <div className="flex items-start gap-3 px-4 py-3 hover:bg-zinc-900/30 transition-colors">
      {/* Avatar */}
      <div className="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full border-2 border-zinc-800 bg-zinc-700 text-sm font-medium text-zinc-100">
        {message.authorInitials}
      </div>
      
      {/* Message Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2 mb-1">
          <span className="text-sm font-medium text-zinc-100">
            {message.author}
          </span>
          <span className="text-xs text-zinc-500">
            {formatTime(message.timestamp)}
          </span>
        </div>
        <p className="text-sm text-zinc-300 whitespace-pre-wrap break-words">
          {renderContent(message.content)}
        </p>
      </div>
    </div>
  );
}

export default function TeamChatPage() {
  const params = useParams();
  const campaignId = params.id as string;
  const { user } = useUser();
  const { getToken, isLoaded } = useAuth();
  const [messages, setMessages] = useState<TeamMessage[]>([]);
  const [inputValue, setInputValue] = useState("");
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [isPosting, setIsPosting] = useState(false);
  const [lastTimestamp, setLastTimestamp] = useState<string | null>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);
  
  // Fetch campaign name using shared hook
  const { displayName } = useCampaignName(campaignId);

  // Map backend message to frontend shape
  const mapBackendToFrontend = (
    backendMsg: BackendMessage,
    userMap: Map<string, { name: string; initials: string }>
  ): TeamMessage => {
    const authorInfo = userMap.get(backendMsg.author_id) || {
      name: "Unknown User",
      initials: "??",
    };

    return {
      id: backendMsg.id,
      author: authorInfo.name,
      authorInitials: authorInfo.initials,
      content: backendMsg.content,
      timestamp: new Date(backendMsg.timestamp),
      author_id: backendMsg.author_id,
    };
  };

  // Fetch messages from API
  const fetchMessages = async (since: string | null = null) => {
    if (!isLoaded) return;

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("No authentication token available");
      }

      const path = `/api/v1/campaigns/${campaignId}/chat?limit=50${since ? `&since=${encodeURIComponent(since)}` : ""}`;
      const data = await apiFetch<{ messages: BackendMessage[] }>(path, {
        token,
        method: "GET",
      });
      const backendMessages: BackendMessage[] = data.messages || [];

      // Build user map (for now, use current user info for all messages)
      // In production, you might want to fetch user details from Clerk or backend
      const userMap = new Map<string, { name: string; initials: string }>();
      const currentUserName =
        user?.firstName ||
        user?.emailAddresses[0]?.emailAddress ||
        "You";
      const currentUserInitials = getInitials(currentUserName);

      // Add current user to map
      if (user?.id) {
        userMap.set(user.id, {
          name: currentUserName,
          initials: currentUserInitials,
        });
      }

      // Map backend messages to frontend shape
      const newMessages = backendMessages.map((msg) =>
        mapBackendToFrontend(msg, userMap)
      );

      // Update last timestamp (newest message timestamp)
      if (backendMessages.length > 0) {
        const newestMsg = backendMessages[backendMessages.length - 1];
        setLastTimestamp(newestMsg.timestamp);
      }

      // If since was provided, append new messages; otherwise replace all
      if (since) {
        setMessages((prev) => {
          // Avoid duplicates
          const existingIds = new Set(prev.map((m) => m.id));
          const uniqueNew = newMessages.filter((m) => !existingIds.has(m.id));
          return [...prev, ...uniqueNew];
        });
      } else {
        setMessages(newMessages);
      }

      setError(null);
    } catch (err) {
      console.error("Error fetching messages:", err);
      setError(
        err instanceof Error
          ? err.message
          : "Unable to load messages. Please refresh."
      );
    } finally {
      setIsLoading(false);
    }
  };

  // Initial fetch on mount
  useEffect(() => {
    if (isLoaded && campaignId && user?.id) {
      fetchMessages(null);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isLoaded, campaignId, user?.id]);

  // Set up polling (every 12 seconds)
  useEffect(() => {
    if (!isLoaded || !campaignId || isLoading || error || !user?.id) return;

    // Clear any existing interval
    if (pollingIntervalRef.current) {
      clearInterval(pollingIntervalRef.current);
    }

    // Poll for new messages
    pollingIntervalRef.current = setInterval(() => {
      if (lastTimestamp) {
        fetchMessages(lastTimestamp);
      } else {
        // If no lastTimestamp yet, fetch all messages
        fetchMessages(null);
      }
    }, 12000); // 12 seconds

    return () => {
      if (pollingIntervalRef.current) {
        clearInterval(pollingIntervalRef.current);
      }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isLoaded, campaignId, lastTimestamp, isLoading, error, user?.id]);

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  // Auto-resize textarea
  useEffect(() => {
    if (textareaRef.current) {
      textareaRef.current.style.height = "auto";
      textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
    }
  }, [inputValue]);


  const handleSend = async () => {
    if (!inputValue.trim() || !user || isPosting) return;

    const messageText = inputValue.trim();
    setIsPosting(true);
    setError(null);

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("No authentication token available");
      }

      await apiFetch(`/api/v1/campaigns/${campaignId}/chat`, {
        token,
        method: "POST",
        body: {
          content: messageText,
        },
      });

      // Clear input
      setInputValue("");

      // Immediately re-fetch messages since lastTimestamp to get the new message
      if (lastTimestamp) {
        await fetchMessages(lastTimestamp);
      } else {
        // If no lastTimestamp, fetch all messages
        await fetchMessages(null);
      }

      // Check for mentions and dispatch notification event
      const mentionPattern = /@(Anova|Me|anova|me)\b/i;
      if (mentionPattern.test(messageText)) {
        window.dispatchEvent(
          new CustomEvent("riley-notification", {
            detail: {
              type: "mention",
              message: messageText,
              author: user.firstName || user.emailAddresses[0]?.emailAddress || "You",
            },
          })
        );
      }
    } catch (err) {
      console.error("Error sending message:", err);
      setError(
        err instanceof Error
          ? err.message
          : "Failed to send message. Please try again."
      );
    } finally {
      setIsPosting(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  return (
    <div className="flex h-full relative">
      {/* Main Chat Area */}
      <div className="flex-1 flex flex-col overflow-hidden bg-transparent">
        {/* Header */}
        <header className="flex items-center justify-between p-6 border-b border-white/5 bg-slate-900/50 backdrop-blur-md">
          <h1 className="text-2xl font-bold text-zinc-100">
            Team Comms | <span className="text-amber-400">{displayName}</span>
          </h1>
        </header>

        {/* Loading State */}
        {isLoading && (
          <div className="flex-1 flex items-center justify-center">
            <p className="text-zinc-400">Loading messages...</p>
          </div>
        )}

        {/* Error State */}
        {!isLoading && error && (
          <div className="flex-1 flex items-center justify-center p-6">
            <div className="rounded-lg border border-red-500/50 bg-red-500/10 p-4 text-center max-w-md">
              <p className="text-red-400 font-medium mb-2">{error}</p>
              <button
                onClick={() => fetchMessages(null)}
                className="rounded-lg bg-amber-400 px-4 py-2 text-sm font-semibold text-zinc-900 hover:bg-amber-500 transition-colors"
              >
                Retry
              </button>
            </div>
          </div>
        )}

        {/* Message List - Scrollable */}
        {!isLoading && !error && (
          <div className="flex-1 overflow-y-auto bg-transparent">
            <div className="py-4">
              {messages.length === 0 ? (
                <div className="flex items-center justify-center h-full">
                  <p className="text-zinc-400">No messages yet. Start the conversation!</p>
                </div>
              ) : (
                messages.map((message) => (
                  <TeamMessageBubble key={message.id} message={message} />
                ))
              )}
              <div ref={messagesEndRef} />
            </div>
          </div>
        )}

        {/* Input Area - Fixed Bottom */}
        <div className="flex-shrink-0 border-t border-white/5 bg-slate-900/50 backdrop-blur-md px-4 py-4">
          <div className="flex items-end gap-3 max-w-4xl mx-auto">
            <div className="flex-1 relative">
              <textarea
                ref={textareaRef}
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Type a message... (Use @Name to mention someone)"
                disabled={isPosting || isLoading || !!error}
                className={cn(
                  "w-full resize-none rounded-lg border border-zinc-700 bg-zinc-900/50 px-4 py-3",
                  "text-sm text-zinc-100 placeholder:text-zinc-500",
                  "focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:border-amber-400/50",
                  "max-h-32 overflow-y-auto",
                  "disabled:opacity-50 disabled:cursor-not-allowed"
                )}
                rows={1}
              />
            </div>
            <button
              onClick={handleSend}
              disabled={!inputValue.trim() || isPosting || isLoading || !!error}
              className={cn(
                "flex-shrink-0 flex items-center justify-center",
                "h-11 w-11 rounded-lg",
                "bg-amber-500 hover:bg-amber-600",
                "disabled:bg-zinc-800 disabled:text-zinc-500 disabled:cursor-not-allowed",
                "text-white transition-colors",
                "focus:outline-none focus:ring-2 focus:ring-amber-400/50"
              )}
              aria-label="Send message"
            >
              <Send className="h-5 w-5" />
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/strategy/page.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import { useAuth } from "@clerk/nextjs";
import { Sparkles, X } from "lucide-react";
import { RileyContextChat, getRileyTitle } from "@app/components/campaign/RileyContextChat";
import { KanbanBoard } from "@app/components/campaign/KanbanBoard";
import { DocumentViewer } from "@app/components/ui/DocumentViewer";
import { AssignmentModal } from "@app/components/campaign/AssignmentModal";
import { Asset, KanbanCard, KanbanStatus } from "@app/lib/types";
import { apiFetch } from "@app/lib/api";

// Helper functions
function getFileTypeFromExtension(filename: string): Asset["type"] {
  const extension = filename.split(".").pop()?.toLowerCase() || "";
  if (extension === "pdf") return "pdf";
  if (extension === "docx" || extension === "doc") return "docx";
  if (extension === "xlsx" || extension === "xls" || extension === "csv") return "xlsx";
  if (extension === "pptx" || extension === "ppt") return "pptx";
  if (["png", "jpg", "jpeg", "webp", "gif", "svg"].includes(extension)) return "img";
  return "pdf"; // Default
}

function isAISupportedType(type: Asset["type"]): boolean {
  return type === "pdf" || type === "docx";
}

// Convert Asset to KanbanCard
function assetToKanbanCard(asset: Asset): KanbanCard {
  const statusMap: Record<Asset["status"], KanbanStatus> = {
    "in_progress": "Draft",
    "needs_review": "Needs Review",
    "in_review": "In Review",
    "approved": "Completed",
    "ready": "Draft",
    "processing": "Draft",
    "error": "Draft",
  };

  const assignees = asset.assignedTo.map((name) => {
    return name
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toUpperCase()
      .slice(0, 2);
  });

  return {
    id: asset.id,
    name: asset.name,
    type: asset.type,
    url: asset.url,
    status: statusMap[asset.status] || "Draft",
    assignees,
    tags: asset.tags,
  };
}

// Convert KanbanCard to DocumentViewer format
function kanbanCardToFile(card: KanbanCard): Asset {
  const statusMap: Record<KanbanStatus, Asset["status"]> = {
    "Draft": "in_progress",
    "Needs Review": "needs_review",
    "In Review": "in_review",
    "Completed": "approved",
  };

  return {
    id: card.id,
    name: card.name,
    type: card.type,
    url: card.url,
    tags: card.tags,
    uploadDate: new Date().toISOString().split("T")[0],
    uploader: "Team Member",
    size: "Unknown",
    urgency: "medium",
    assignedTo: [],
    comments: 0,
    status: statusMap[card.status] || "in_progress",
    aiEnabled: isAISupportedType(card.type),
  };
}

export default function StrategyPage() {
  const params = useParams();
  const { getToken } = useAuth();
  const campaignId = params.id as string;
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [selectedFile, setSelectedFile] = useState<Asset | null>(null);
  const [assignmentModalOpen, setAssignmentModalOpen] = useState(false);
  const [managingAssignees, setManagingAssignees] = useState<KanbanCard | null>(null);

  // Fetch files from backend and filter by Strategy tag
  useEffect(() => {
    const fetchFiles = async () => {
      if (!campaignId) return;

      try {
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }
        
        const data = await apiFetch<{ files: any[] }>(
          `/api/v1/list?tenant_id=${encodeURIComponent(campaignId)}`,
          {
            token,
            method: "GET",
          }
        );

        const fetchedAssets: Asset[] = data.files
          .filter((file: any) => {
            const tags = file.tags || [];
            return tags.includes("Strategy");
          })
          .map((file: any) => {
            const fileType = getFileTypeFromExtension(file.name);
            return {
              id: file.id || file.name,
              name: file.name,
              type: fileType,
              url: file.url,
              tags: file.tags || [],
              uploadDate: new Date(file.date).toISOString().split("T")[0],
              uploader: "System",
              size: file.size,
              urgency: "medium",
              assignedTo: [],
              comments: 0,
              status: "in_progress" as Asset["status"],
              aiEnabled: isAISupportedType(fileType),
            };
          });

        setAssets(fetchedAssets);
      } catch (error) {
        console.error("Error fetching files:", error);
        setAssets([]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchFiles();
  }, [campaignId]);

  // Handle viewing an asset from citation badge
  const handleViewAsset = (filename: string) => {
    // Search for the asset in the local assets state
    const asset = assets.find((a) => a.name === filename);
    
    if (asset) {
      setSelectedFile(asset);
    } else {
      // Asset not found in current view (might be Global/Archived)
      alert(`Asset "${filename}" not found in current view (might be Global/Archived).`);
    }
  };

  // Convert assets to KanbanCards
  const kanbanCards: KanbanCard[] = assets.map(assetToKanbanCard);

  // Handle status change (when dragging cards)
  const handleStatusChange = async (cardId: string, newStatus: KanbanStatus) => {
    // Map KanbanStatus back to Asset status
    const statusMap: Record<KanbanStatus, Asset["status"]> = {
      "Draft": "in_progress",
      "Needs Review": "needs_review",
      "In Review": "in_review",
      "Completed": "approved",
    };

    const newAssetStatus = statusMap[newStatus] || "in_progress";
    const previousAssets = [...assets];

    // Optimistic update: update local state immediately
    setAssets((prev) =>
      prev.map((asset) =>
        asset.id === cardId
          ? { ...asset, status: newAssetStatus }
          : asset
      )
    );

    // API call to persist status change
    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }
      
      await apiFetch(`/api/v1/files/${cardId}/assign`, {
        token,
        method: "PATCH",
        body: {
          assignee: "", // Keep existing assignee
          status: newAssetStatus,
        },
      });
    } catch (error) {
      // Revert on error
      setAssets(previousAssets);
      const errorMessage = error instanceof Error ? error.message : "Failed to update status";
      console.error("Failed to update status:", error);
      alert(`Failed to save status change: ${errorMessage}`);
    }
  };

  // Helper: Map initials to user IDs
  const initialsToUserId = (initials: string): string | null => {
    const mapping: Record<string, string> = {
      "SJ": "sarah",
      "JD": "john",
      "AK": "anova",
    };
    return mapping[initials] || null;
  };

  // Helper: Map user IDs to full names
  const userIdToName = (userId: string): string => {
    const userMap: Record<string, string> = {
      sarah: "Sarah Johnson",
      john: "John Doe",
      anova: "Anova Kim",
    };
    return userMap[userId] || userId;
  };

  // Handle assignment confirmation (from manage assignees flow)
  const handleAssignmentConfirm = async (userIds: string[]) => {
    if (!managingAssignees) return;

    const cardId = managingAssignees.id;
    
    try {
      // Update assignees - convert user IDs to full names
      const assigneeNames = userIds.map(userIdToName);
      
      // Update local state
      setAssets((prev) =>
        prev.map((asset) => {
          if (asset.id === cardId) {
            return {
              ...asset,
              assignedTo: assigneeNames,
            };
          }
          return asset;
        })
      );

      // TODO: Call backend to update assignees
      // For now, we'll just update local state
    } catch (error) {
      console.error("Failed to update assignees:", error);
      alert("Failed to update assignees. Please try again.");
    } finally {
      setManagingAssignees(null);
      setAssignmentModalOpen(false);
    }
  };

  // Handle manage assignees (from + button)
  const handleManageAssignees = (card: KanbanCard) => {
    setManagingAssignees(card);
    setAssignmentModalOpen(true);
  };

  // Handle card click to open viewer
  const handleCardClick = (card: KanbanCard) => {
    const file = kanbanCardToFile(card);
    setSelectedFile(file);
  };

  return (
    <div className="flex h-full relative">
      {/* MIDDLE: Kanban Board */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="flex items-center justify-between p-6 border-b border-zinc-800">
          <h1 className="text-2xl font-bold text-zinc-100">Strategy Workspace</h1>
          {!isChatOpen && (
            <button
              onClick={() => setIsChatOpen(true)}
              className="flex items-center gap-2 text-amber-500 hover:bg-zinc-900 px-4 py-2 rounded-md transition-colors"
            >
              <Sparkles className="w-4 h-4" />
              <span>Ask Riley</span>
            </button>
          )}
        </header>

        {/* Scrollable Board Area */}
        <div className="flex-1 overflow-x-auto overflow-y-hidden p-6">
          {isLoading ? (
            <div className="flex items-center justify-center h-full">
              <p className="text-zinc-500">Loading files...</p>
            </div>
          ) : (
            <KanbanBoard 
              cards={kanbanCards} 
              onStatusChange={handleStatusChange}
              onCardClick={handleCardClick}
              onManageAssignees={handleManageAssignees}
            />
          )}
        </div>
      </div>

      {/* RIGHT: Riley Chat */}
      {isChatOpen && (
        <div className="w-[400px] border-l border-zinc-800 bg-zinc-900/50 backdrop-blur-sm flex flex-col h-full shrink-0">
          <div className="h-16 flex items-center justify-between px-4 border-b border-zinc-800">
            <span className="font-semibold text-amber-500 flex items-center gap-2">
              <Sparkles className="w-4 h-4" /> {getRileyTitle("strategy")}
            </span>
            <button
              onClick={() => setIsChatOpen(false)}
              className="text-zinc-500 hover:text-white p-2 transition-colors"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          <div className="flex-1 overflow-hidden">
            <RileyContextChat 
              mode="strategy" 
              contextKey="strategy" 
              campaignId={campaignId}
              onViewAsset={handleViewAsset}
            />
          </div>
        </div>
      )}

      {/* Document Viewer Modal */}
      {selectedFile && (
        <DocumentViewer
          file={selectedFile}
          variant="modal"
          onClose={() => setSelectedFile(null)}
        />
      )}

      {/* Assignment Modal */}
      <AssignmentModal
        isOpen={assignmentModalOpen}
        fileName={managingAssignees?.name || ""}
        currentAssignees={
          managingAssignees
            ? managingAssignees.assignees
                .map(initialsToUserId)
                .filter((id): id is string => id !== null)
            : []
        }
        onClose={() => {
          setAssignmentModalOpen(false);
          setManagingAssignees(null);
        }}
        onConfirm={handleAssignmentConfirm}
      />
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/riley/page.tsx
==================================================
"use client";

import { useParams } from "next/navigation";
import { RileyStudio } from "@app/components/chat/RileyStudio";
import { useCampaignName } from "@app/lib/useCampaignName";

export default function CampaignRileyPage() {
  const params = useParams();
  const campaignId = params.id as string;
  const { displayName } = useCampaignName(campaignId);

  return (
    <div className="flex h-full relative">
      <div className="flex-1 flex flex-col overflow-hidden bg-transparent">
        <RileyStudio contextName={displayName} tenantId={campaignId} />
      </div>
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/pitch/page.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import { useAuth } from "@clerk/nextjs";
import { Sparkles, X } from "lucide-react";
import { RileyContextChat, getRileyTitle } from "@app/components/campaign/RileyContextChat";
import { KanbanBoard } from "@app/components/campaign/KanbanBoard";
import { DocumentViewer } from "@app/components/ui/DocumentViewer";
import { AssignmentModal } from "@app/components/campaign/AssignmentModal";
import { Asset, KanbanCard, KanbanStatus } from "@app/lib/types";
import { apiFetch } from "@app/lib/api";

// Helper functions
function getFileTypeFromExtension(filename: string): Asset["type"] {
  const extension = filename.split(".").pop()?.toLowerCase() || "";
  if (extension === "pdf") return "pdf";
  if (extension === "docx" || extension === "doc") return "docx";
  if (extension === "xlsx" || extension === "xls" || extension === "csv") return "xlsx";
  if (extension === "pptx" || extension === "ppt") return "pptx";
  if (["png", "jpg", "jpeg", "webp", "gif", "svg"].includes(extension)) return "img";
  return "pdf"; // Default
}

function isAISupportedType(type: Asset["type"]): boolean {
  return type === "pdf" || type === "docx";
}

// Convert Asset to KanbanCard
function assetToKanbanCard(asset: Asset): KanbanCard {
  const statusMap: Record<Asset["status"], KanbanStatus> = {
    "in_progress": "Draft",
    "needs_review": "Needs Review",
    "in_review": "In Review",
    "approved": "Completed",
    "ready": "Draft",
    "processing": "Draft",
    "error": "Draft",
  };

  const assignees = asset.assignedTo.map((name) => {
    return name
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toUpperCase()
      .slice(0, 2);
  });

  return {
    id: asset.id,
    name: asset.name,
    type: asset.type,
    url: asset.url,
    status: statusMap[asset.status] || "Draft",
    assignees,
    tags: asset.tags,
  };
}

// Convert KanbanCard to DocumentViewer format
function kanbanCardToFile(card: KanbanCard): Asset {
  const statusMap: Record<KanbanStatus, Asset["status"]> = {
    "Draft": "in_progress",
    "Needs Review": "needs_review",
    "In Review": "in_review",
    "Completed": "approved",
  };

  return {
    id: card.id,
    name: card.name,
    type: card.type,
    url: card.url,
    tags: card.tags,
    uploadDate: new Date().toISOString().split("T")[0],
    uploader: "Team Member",
    size: "Unknown",
    urgency: "medium",
    assignedTo: [],
    comments: 0,
    status: statusMap[card.status] || "in_progress",
    aiEnabled: isAISupportedType(card.type),
  };
}

export default function PitchIntakePage() {
  const params = useParams();
  const { getToken } = useAuth();
  const campaignId = params.id as string;
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [selectedFile, setSelectedFile] = useState<Asset | null>(null);
  const [assignmentModalOpen, setAssignmentModalOpen] = useState(false);
  const [managingAssignees, setManagingAssignees] = useState<KanbanCard | null>(null);

  // Fetch files from backend and filter by Pitch tag
  useEffect(() => {
    const fetchFiles = async () => {
      if (!campaignId) return;

      try {
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }
        
        const data = await apiFetch<{ files: any[] }>(
          `/api/v1/list?tenant_id=${encodeURIComponent(campaignId)}`,
          {
            token,
            method: "GET",
          }
        );

        const fetchedAssets: Asset[] = data.files
          .filter((file: any) => {
            const tags = file.tags || [];
            return tags.includes("Pitch");
          })
          .map((file: any) => {
            const fileType = getFileTypeFromExtension(file.name);
            return {
              id: file.id || file.name,
              name: file.name,
              type: fileType,
              url: file.url,
              tags: file.tags || [],
              uploadDate: new Date(file.date).toISOString().split("T")[0],
              uploader: "System",
              size: file.size,
              urgency: "medium",
              assignedTo: [],
              comments: 0,
              status: "in_progress" as Asset["status"],
              aiEnabled: isAISupportedType(fileType),
            };
          });

        setAssets(fetchedAssets);
      } catch (error) {
        console.error("Error fetching files:", error);
        setAssets([]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchFiles();
  }, [campaignId]);

  // Handle viewing an asset from citation badge
  const handleViewAsset = (filename: string) => {
    // Search for the asset in the local assets state
    const asset = assets.find((a) => a.name === filename);
    
    if (asset) {
      setSelectedFile(asset);
    } else {
      // Asset not found in current view (might be Global/Archived)
      alert(`Asset "${filename}" not found in current view (might be Global/Archived).`);
    }
  };

  // Convert assets to KanbanCards
  const kanbanCards: KanbanCard[] = assets.map(assetToKanbanCard);

  // Handle status change (when dragging cards)
  const handleStatusChange = async (cardId: string, newStatus: KanbanStatus) => {
    // Map KanbanStatus back to Asset status
    const statusMap: Record<KanbanStatus, Asset["status"]> = {
      "Draft": "in_progress",
      "Needs Review": "needs_review",
      "In Review": "in_review",
      "Completed": "approved",
    };

    const newAssetStatus = statusMap[newStatus] || "in_progress";
    const previousAssets = [...assets];

    // Optimistic update: update local state immediately
    setAssets((prev) =>
      prev.map((asset) =>
        asset.id === cardId
          ? { ...asset, status: newAssetStatus }
          : asset
      )
    );

    // API call to persist status change
    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }
      
      await apiFetch(`/api/v1/files/${cardId}/assign`, {
        token,
        method: "PATCH",
        body: {
          assignee: "", // Keep existing assignee
          status: newAssetStatus,
        },
      });
    } catch (error) {
      console.error("Failed to update status:", error);
      // Revert optimistic update
      setAssets(previousAssets);
      alert("Failed to save status change. Please try again.");
    }
  };

  // Helper: Map initials to user IDs
  const initialsToUserId = (initials: string): string | null => {
    const mapping: Record<string, string> = {
      "SJ": "sarah",
      "JD": "john",
      "AK": "anova",
    };
    return mapping[initials] || null;
  };

  // Helper: Map user IDs to full names
  const userIdToName = (userId: string): string => {
    const userMap: Record<string, string> = {
      sarah: "Sarah Johnson",
      john: "John Doe",
      anova: "Anova Kim",
    };
    return userMap[userId] || userId;
  };

  // Handle assignment confirmation (from manage assignees flow)
  const handleAssignmentConfirm = async (userIds: string[]) => {
    if (!managingAssignees) return;

    const cardId = managingAssignees.id;
    
    try {
      // Update assignees - convert user IDs to full names
      const assigneeNames = userIds.map(userIdToName);
      
      // Update local state
      setAssets((prev) =>
        prev.map((asset) => {
          if (asset.id === cardId) {
            return {
              ...asset,
              assignedTo: assigneeNames,
            };
          }
          return asset;
        })
      );

      // TODO: Call backend to update assignees
      // For now, we'll just update local state
    } catch (error) {
      console.error("Failed to update assignees:", error);
      alert("Failed to update assignees. Please try again.");
    } finally {
      setManagingAssignees(null);
      setAssignmentModalOpen(false);
    }
  };

  // Handle manage assignees (from + button)
  const handleManageAssignees = (card: KanbanCard) => {
    setManagingAssignees(card);
    setAssignmentModalOpen(true);
  };

  // Handle card click to open viewer
  const handleCardClick = (card: KanbanCard) => {
    const file = kanbanCardToFile(card);
    setSelectedFile(file);
  };

  return (
    <div className="flex h-full relative">
      {/* MIDDLE: Kanban Board */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="flex items-center justify-between p-6 border-b border-zinc-800">
          <h1 className="text-2xl font-bold text-zinc-100">Pitch & Intake</h1>
          {!isChatOpen && (
            <button
              onClick={() => setIsChatOpen(true)}
              className="flex items-center gap-2 text-amber-500 hover:bg-zinc-900 px-4 py-2 rounded-md transition-colors"
            >
              <Sparkles className="w-4 h-4" />
              <span>Ask Riley</span>
            </button>
          )}
        </header>

        {/* Scrollable Board Area */}
        <div className="flex-1 overflow-x-auto overflow-y-hidden p-6">
          {isLoading ? (
            <div className="flex items-center justify-center h-full">
              <p className="text-zinc-500">Loading files...</p>
            </div>
          ) : (
            <KanbanBoard 
              cards={kanbanCards} 
              onStatusChange={handleStatusChange}
              onCardClick={handleCardClick}
              onManageAssignees={handleManageAssignees}
            />
          )}
        </div>
      </div>

      {/* RIGHT: Riley Chat */}
      {isChatOpen && (
        <div className="w-[400px] border-l border-zinc-800 bg-zinc-900/50 backdrop-blur-sm flex flex-col h-full shrink-0">
          <div className="h-16 flex items-center justify-between px-4 border-b border-zinc-800">
            <span className="font-semibold text-amber-500 flex items-center gap-2">
              <Sparkles className="w-4 h-4" /> {getRileyTitle("pitch")}
            </span>
            <button
              onClick={() => setIsChatOpen(false)}
              className="text-zinc-500 hover:text-white p-2 transition-colors"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          <div className="flex-1 overflow-hidden">
            <RileyContextChat 
              mode="pitch" 
              contextKey="pitch" 
              campaignId={campaignId}
              onViewAsset={handleViewAsset}
            />
          </div>
        </div>
      )}

      {/* Document Viewer Modal */}
      {selectedFile && (
        <DocumentViewer
          file={selectedFile}
          variant="modal"
          onClose={() => setSelectedFile(null)}
        />
      )}

      {/* Assignment Modal */}
      <AssignmentModal
        isOpen={assignmentModalOpen}
        fileName={managingAssignees?.name || ""}
        currentAssignees={
          managingAssignees
            ? managingAssignees.assignees
                .map(initialsToUserId)
                .filter((id): id is string => id !== null)
            : []
        }
        onClose={() => {
          setAssignmentModalOpen(false);
          setManagingAssignees(null);
        }}
        onConfirm={handleAssignmentConfirm}
      />
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/messaging/page.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import { useAuth } from "@clerk/nextjs";
import { Sparkles, X } from "lucide-react";
import { RileyContextChat, getRileyTitle } from "@app/components/campaign/RileyContextChat";
import { KanbanBoard } from "@app/components/campaign/KanbanBoard";
import { DocumentViewer } from "@app/components/ui/DocumentViewer";
import { AssignmentModal } from "@app/components/campaign/AssignmentModal";
import { Asset, KanbanCard, KanbanStatus } from "@app/lib/types";
import { apiFetch } from "@app/lib/api";

// Helper functions
function getFileTypeFromExtension(filename: string): Asset["type"] {
  const extension = filename.split(".").pop()?.toLowerCase() || "";
  if (extension === "pdf") return "pdf";
  if (extension === "docx" || extension === "doc") return "docx";
  if (extension === "xlsx" || extension === "xls" || extension === "csv") return "xlsx";
  if (extension === "pptx" || extension === "ppt") return "pptx";
  if (["png", "jpg", "jpeg", "webp", "gif", "svg"].includes(extension)) return "img";
  return "pdf"; // Default
}

function isAISupportedType(type: Asset["type"]): boolean {
  return type === "pdf" || type === "docx";
}

// Convert Asset to KanbanCard
function assetToKanbanCard(asset: Asset): KanbanCard {
  // Map Asset status to KanbanStatus
  const statusMap: Record<Asset["status"], KanbanStatus> = {
    "in_progress": "Draft",
    "needs_review": "Needs Review",
    "in_review": "In Review",
    "approved": "Completed",
    "ready": "Draft",
    "processing": "Draft",
    "error": "Draft",
  };

  // Extract initials from assignedTo names
  const assignees = asset.assignedTo.map((name) => {
    return name
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toUpperCase()
      .slice(0, 2);
  });

  return {
    id: asset.id,
    name: asset.name,
    type: asset.type,
    url: asset.url,
    status: statusMap[asset.status] || "Draft",
    assignees,
    tags: asset.tags,
  };
}

// Convert KanbanCard to DocumentViewer format
function kanbanCardToFile(card: KanbanCard): Asset {
  // Map KanbanStatus back to Asset status
  const statusMap: Record<KanbanStatus, Asset["status"]> = {
    "Draft": "in_progress",
    "Needs Review": "needs_review",
    "In Review": "in_review",
    "Completed": "approved",
  };

  return {
    id: card.id,
    name: card.name,
    type: card.type,
    url: card.url,
    tags: card.tags,
    uploadDate: new Date().toISOString().split("T")[0],
    uploader: "Team Member",
    size: "Unknown",
    urgency: "medium",
    assignedTo: [],
    comments: 0,
    status: statusMap[card.status] || "in_progress",
    aiEnabled: isAISupportedType(card.type),
  };
}

export default function MessagingPage() {
  const params = useParams();
  const { getToken } = useAuth();
  const campaignId = params.id as string;
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [selectedFile, setSelectedFile] = useState<Asset | null>(null);
  const [assignmentModalOpen, setAssignmentModalOpen] = useState(false);
  const [managingAssignees, setManagingAssignees] = useState<KanbanCard | null>(null);

  // Fetch files from backend and filter by Messaging tag
  useEffect(() => {
    const fetchFiles = async () => {
      if (!campaignId) return;

      try {
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }
        
        const data = await apiFetch<{ files: any[] }>(
          `/api/v1/list?tenant_id=${encodeURIComponent(campaignId)}`,
          {
            token,
            method: "GET",
          }
        );

        // Convert backend file list to Asset format and filter by Messaging tag
        const fetchedAssets: Asset[] = data.files
          .filter((file: any) => {
            const tags = file.tags || [];
            return tags.includes("Messaging");
          })
          .map((file: any) => {
            const fileType = getFileTypeFromExtension(file.name);
            return {
              id: file.id || file.name,
              name: file.name,
              type: fileType,
              url: file.url,
              tags: file.tags || [],
              uploadDate: new Date(file.date).toISOString().split("T")[0],
              uploader: "System",
              size: file.size,
              urgency: "medium",
              assignedTo: [],
              comments: 0,
              status: "in_progress" as Asset["status"],
              aiEnabled: isAISupportedType(fileType),
            };
          });

        setAssets(fetchedAssets);
      } catch (error) {
        console.error("Error fetching files:", error);
        setAssets([]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchFiles();
  }, [campaignId]);

  // Handle viewing an asset from citation badge
  const handleViewAsset = (filename: string) => {
    // Search for the asset in the local assets state
    const asset = assets.find((a) => a.name === filename);
    
    if (asset) {
      setSelectedFile(asset);
    } else {
      // Asset not found in current view (might be Global/Archived)
      alert(`Asset "${filename}" not found in current view (might be Global/Archived).`);
    }
  };

  // Convert assets to KanbanCards
  const kanbanCards: KanbanCard[] = assets.map(assetToKanbanCard);

  // Handle status change (when dragging cards)
  const handleStatusChange = async (cardId: string, newStatus: KanbanStatus) => {
    // Map KanbanStatus back to Asset status
    const statusMap: Record<KanbanStatus, Asset["status"]> = {
      "Draft": "in_progress",
      "Needs Review": "needs_review",
      "In Review": "in_review",
      "Completed": "approved",
    };

    const newAssetStatus = statusMap[newStatus] || "in_progress";
    const previousAssets = [...assets];

    // Optimistic update: update local state immediately
    setAssets((prev) =>
      prev.map((asset) =>
        asset.id === cardId
          ? { ...asset, status: newAssetStatus }
          : asset
      )
    );

    // API call to persist status change
    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }
      
      await apiFetch(`/api/v1/files/${cardId}/assign`, {
        token,
        method: "PATCH",
        body: {
          assignee: "", // Keep existing assignee
          status: newAssetStatus,
        },
      });
    } catch (error) {
      // Revert on error
      setAssets(previousAssets);
      const errorMessage = error instanceof Error ? error.message : "Failed to update status";
      console.error("Failed to update status:", error);
      alert(`Failed to save status change: ${errorMessage}`);
    }
  };

  // Helper: Map initials to user IDs
  const initialsToUserId = (initials: string): string | null => {
    const mapping: Record<string, string> = {
      "SJ": "sarah",
      "JD": "john",
      "AK": "anova",
    };
    return mapping[initials] || null;
  };

  // Helper: Map user IDs to full names
  const userIdToName = (userId: string): string => {
    const userMap: Record<string, string> = {
      sarah: "Sarah Johnson",
      john: "John Doe",
      anova: "Anova Kim",
    };
    return userMap[userId] || userId;
  };

  // Handle assignment confirmation (from manage assignees flow)
  const handleAssignmentConfirm = async (userIds: string[]) => {
    if (!managingAssignees) return;

    const cardId = managingAssignees.id;
    
    try {
      // Update assignees - convert user IDs to full names
      const assigneeNames = userIds.map(userIdToName);
      
      // Update local state
      setAssets((prev) =>
        prev.map((asset) => {
          if (asset.id === cardId) {
            return {
              ...asset,
              assignedTo: assigneeNames,
            };
          }
          return asset;
        })
      );

      // TODO: Call backend to update assignees
      // For now, we'll just update local state
    } catch (error) {
      console.error("Failed to update assignees:", error);
      alert("Failed to update assignees. Please try again.");
    } finally {
      setManagingAssignees(null);
      setAssignmentModalOpen(false);
    }
  };

  // Handle manage assignees (from + button)
  const handleManageAssignees = (card: KanbanCard) => {
    setManagingAssignees(card);
    setAssignmentModalOpen(true);
  };

  // Handle card click to open viewer
  const handleCardClick = (card: KanbanCard) => {
    const file = kanbanCardToFile(card);
    setSelectedFile(file);
  };

  return (
    <div className="flex h-full relative">
      {/* MIDDLE: Kanban Board */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="flex items-center justify-between p-6 border-b border-zinc-800">
          <h1 className="text-2xl font-bold text-zinc-100">Messaging Studio</h1>
          {/* THE "OPEN" BUTTON - Only visible if chat is closed */}
          {!isChatOpen && (
            <button
              onClick={() => setIsChatOpen(true)}
              className="flex items-center gap-2 text-amber-500 hover:bg-zinc-900 px-4 py-2 rounded-md transition-colors"
            >
              <Sparkles className="w-4 h-4" />
              <span>Ask Riley</span>
            </button>
          )}
        </header>

        {/* Scrollable Board Area */}
        <div className="flex-1 overflow-x-auto overflow-y-hidden p-6">
          {isLoading ? (
            <div className="flex items-center justify-center h-full">
              <p className="text-zinc-500">Loading files...</p>
            </div>
          ) : (
            <KanbanBoard 
              cards={kanbanCards} 
              onStatusChange={handleStatusChange}
              onCardClick={handleCardClick}
              onManageAssignees={handleManageAssignees}
            />
          )}
        </div>
      </div>

      {/* RIGHT: Riley Chat - Conditionally Rendered */}
      {isChatOpen && (
        <div className="w-[400px] border-l border-zinc-800 bg-zinc-900/50 backdrop-blur-sm flex flex-col h-full shrink-0">
          {/* Header with CLOSE Button */}
          <div className="h-16 flex items-center justify-between px-4 border-b border-zinc-800">
            <span className="font-semibold text-amber-500 flex items-center gap-2">
              <Sparkles className="w-4 h-4" /> {getRileyTitle("messaging")}
            </span>
            <button
              onClick={() => setIsChatOpen(false)}
              className="text-zinc-500 hover:text-white p-2 transition-colors"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          {/* The Chat Content */}
          <div className="flex-1 overflow-hidden">
            <RileyContextChat 
              mode="messaging" 
              contextKey="messaging" 
              campaignId={campaignId}
              onViewAsset={handleViewAsset}
            />
          </div>
        </div>
      )}

      {/* Document Viewer Modal */}
      {selectedFile && (
        <DocumentViewer
          file={selectedFile}
          variant="modal"
          onClose={() => setSelectedFile(null)}
        />
      )}

      {/* Assignment Modal */}
      <AssignmentModal
        isOpen={assignmentModalOpen}
        fileName={managingAssignees?.name || ""}
        currentAssignees={
          managingAssignees
            ? managingAssignees.assignees
                .map(initialsToUserId)
                .filter((id): id is string => id !== null)
            : []
        }
        onClose={() => {
          setAssignmentModalOpen(false);
          setManagingAssignees(null);
        }}
        onConfirm={handleAssignmentConfirm}
      />
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/research/page.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import { useAuth } from "@clerk/nextjs";
import { TrendingUp, BarChart3, FileText, Lightbulb, Sparkles, X, Search, FileType2, Table, Presentation, Image as ImageIcon } from "lucide-react";
import { RileyContextChat, getRileyTitle } from "@app/components/campaign/RileyContextChat";
import { DocumentViewer } from "@app/components/ui/DocumentViewer";
import { Asset } from "@app/lib/types";
import { cn } from "@app/lib/utils";
import { apiFetch } from "@app/lib/api";

// Mock research insights
const mockInsights = [
  {
    id: "1",
    title: "Voter Sentiment Shift",
    description: "Support for environmental policy increased 12% in Q3 polling data.",
    type: "trend",
    icon: TrendingUp,
  },
  {
    id: "2",
    title: "Demographic Analysis",
    description: "18-34 age group shows strongest engagement with messaging campaigns.",
    type: "analysis",
    icon: BarChart3,
  },
  {
    id: "3",
    title: "Key Messaging Themes",
    description: "Top performing themes: 'Community First', 'Sustainable Future', 'Local Impact'.",
    type: "insight",
    icon: Lightbulb,
  },
  {
    id: "4",
    title: "Competitive Landscape",
    description: "Analysis of opponent messaging strategies and positioning gaps.",
    type: "analysis",
    icon: FileText,
  },
  {
    id: "5",
    title: "Media Coverage Trends",
    description: "Positive coverage increased 23% following Q3 campaign launch.",
    type: "trend",
    icon: TrendingUp,
  },
  {
    id: "6",
    title: "Policy Impact Metrics",
    description: "Survey data shows 68% support for proposed policy changes.",
    type: "insight",
    icon: BarChart3,
  },
];

function getInsightColor(type: string) {
  switch (type) {
    case "trend":
      return "border-emerald-500/30 bg-emerald-500/10";
    case "analysis":
      return "border-blue-500/30 bg-blue-500/10";
    case "insight":
      return "border-amber-500/30 bg-amber-500/10";
    default:
      return "border-zinc-800 bg-zinc-900/50";
  }
}

// Helper to get file type from extension
function getFileTypeFromExtension(filename: string): Asset["type"] {
  const ext = filename.split(".").pop()?.toLowerCase();
  switch (ext) {
    case "pdf":
      return "pdf";
    case "docx":
    case "doc":
      return "docx";
    case "xlsx":
    case "xls":
      return "xlsx";
    case "pptx":
    case "ppt":
      return "pptx";
    case "jpg":
    case "jpeg":
    case "png":
    case "gif":
    case "webp":
      return "img";
    default:
      return "pdf";
  }
}

function getFileIcon(type: Asset["type"]) {
  switch (type) {
    case "pdf":
      return { icon: FileText, color: "text-red-500" };
    case "docx":
      return { icon: FileType2, color: "text-blue-500" };
    case "xlsx":
      return { icon: Table, color: "text-emerald-500" };
    case "pptx":
      return { icon: Presentation, color: "text-orange-500" };
    case "img":
      return { icon: ImageIcon, color: "text-purple-500" };
    default:
      return { icon: FileText, color: "text-zinc-500" };
  }
}

function isAISupportedType(type: Asset["type"]): boolean {
  return ["pdf", "docx", "xlsx", "pptx"].includes(type);
}

export default function ResearchPage() {
  const params = useParams();
  const { getToken } = useAuth();
  const campaignId = params.id as string;
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedFile, setSelectedFile] = useState<Asset | null>(null);
  const [searchQuery, setSearchQuery] = useState("");

  // Fetch files from backend and filter by Research tag
  useEffect(() => {
    const fetchFiles = async () => {
      if (!campaignId) return;

      try {
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }
        
        const data = await apiFetch<{ files: any[] }>(
          `/api/v1/list?tenant_id=${encodeURIComponent(campaignId)}`,
          {
            token,
            method: "GET",
          }
        );

        // Convert backend file list to Asset format and filter by Research tag
        const fetchedAssets: Asset[] = data.files
          .filter((file: any) => {
            const tags = file.tags || [];
            return tags.includes("Research");
          })
          .map((file: any) => {
            const fileType = getFileTypeFromExtension(file.name);
            return {
              id: file.id || file.name,
              name: file.name,
              type: fileType,
              url: file.url,
              tags: file.tags || [],
              uploadDate: new Date(file.date).toISOString().split("T")[0],
              uploader: "System",
              size: file.size,
              urgency: "medium",
              assignedTo: [],
              comments: 0,
              status: "ready" as Asset["status"],
              aiEnabled: isAISupportedType(fileType),
            };
          });

        setAssets(fetchedAssets);
      } catch (error) {
        console.error("Error fetching files:", error);
        setAssets([]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchFiles();
  }, [campaignId]);

  // Handle viewing an asset from citation badge
  const handleViewAsset = (filename: string) => {
    // Search for the asset in the local assets state
    const asset = assets.find((a) => a.name === filename);
    
    if (asset) {
      setSelectedFile(asset);
    } else {
      // Asset not found in current view (might be Global/Archived)
      alert(`Asset "${filename}" not found in current view (might be Global/Archived).`);
    }
  };

  // Filter assets by search query
  const filteredAssets = assets.filter((asset) =>
    asset.name.toLowerCase().includes(searchQuery.toLowerCase())
  );

  return (
    <div className="flex h-full relative">
      {/* MIDDLE: Research Content */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="flex items-center justify-between p-6 border-b border-zinc-800">
          <h1 className="text-2xl font-bold text-zinc-100">Research Lab</h1>
          <div className="flex items-center gap-3">
            {/* Search Bar */}
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-zinc-500" />
              <input
                type="text"
                placeholder="Search research files..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="pl-10 pr-4 py-2 bg-zinc-900/50 border border-zinc-800 rounded-lg text-zinc-100 placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-amber-500/50 w-64"
              />
            </div>
            {/* THE "OPEN" BUTTON - Only visible if chat is closed */}
            {!isChatOpen && (
              <button
                onClick={() => setIsChatOpen(true)}
                className="flex items-center gap-2 text-amber-500 hover:bg-zinc-900 px-4 py-2 rounded-md transition-colors"
              >
                <Sparkles className="w-4 h-4" />
                <span>Ask Riley</span>
              </button>
            )}
            {/* THE "HIDE" BUTTON - Only visible if chat is open */}
            {isChatOpen && (
              <button
                onClick={() => setIsChatOpen(false)}
                className="flex items-center gap-2 bg-amber-500/10 text-amber-500 border border-amber-500/50 hover:bg-amber-500/20 px-4 py-2 rounded-md transition-colors"
              >
                <Sparkles className="w-4 h-4" />
                <span>Hide Riley</span>
              </button>
            )}
          </div>
        </header>

        {/* Scrollable Content Area */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* Key Insights Section */}
          <div className="mb-8">
            <h2 className="text-lg font-semibold text-zinc-100 mb-4">Key Insights</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {mockInsights.map((insight) => {
                const Icon = insight.icon;
                return (
                  <div
                    key={insight.id}
                    className={cn(
                      "rounded-xl border backdrop-blur-md p-6 hover:border-opacity-50 transition-colors",
                      getInsightColor(insight.type)
                    )}
                  >
                    <div className="flex items-start gap-3 mb-3">
                      <div className="flex-shrink-0 p-2 rounded-lg bg-zinc-900/50">
                        <Icon className="h-5 w-5 text-zinc-300" />
                      </div>
                      <div className="flex-1">
                        <h3 className="text-base font-semibold text-zinc-100 mb-1">
                          {insight.title}
                        </h3>
                        <p className="text-sm text-zinc-400 leading-relaxed">
                          {insight.description}
                        </p>
                      </div>
                    </div>
                    <div className="mt-4 pt-4 border-t border-zinc-800/50">
                      <span className="inline-flex items-center rounded-full bg-zinc-800/50 px-2.5 py-1 text-xs font-medium text-zinc-400 capitalize">
                        {insight.type}
                      </span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Source Material Section */}
          <div>
            <h2 className="text-lg font-semibold text-zinc-100 mb-4">Source Material</h2>
            {isLoading ? (
              <div className="flex items-center justify-center py-12">
                <p className="text-zinc-500">Loading files...</p>
              </div>
            ) : filteredAssets.length === 0 ? (
              <div className="flex items-center justify-center py-12">
                <p className="text-zinc-500">
                  {searchQuery ? "No files match your search." : "No files tagged with Research yet."}
                </p>
              </div>
            ) : (
              <div className="space-y-2">
                {filteredAssets.map((asset) => {
                  const { icon: FileIcon, color: iconColor } = getFileIcon(asset.type);
                  return (
                    <button
                      key={asset.id}
                      onClick={() => setSelectedFile(asset)}
                      className="w-full flex items-center gap-4 p-4 rounded-lg border border-zinc-800 bg-zinc-900/30 hover:bg-zinc-900/50 hover:border-zinc-700 transition-colors text-left"
                    >
                      <FileIcon className={cn("h-5 w-5 flex-shrink-0", iconColor)} />
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-zinc-100 truncate">{asset.name}</p>
                        <p className="text-xs text-zinc-500 mt-1">
                          {asset.size} â€¢ {asset.uploader} â€¢ {new Date(asset.uploadDate).toLocaleDateString()}
                        </p>
                      </div>
                    </button>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* RIGHT: Riley Chat - Conditionally Rendered */}
      {isChatOpen && (
        <div className="w-[400px] border-l border-zinc-800 bg-zinc-900/50 backdrop-blur-sm flex flex-col h-full shrink-0">
          {/* Header with CLOSE Button */}
          <div className="h-16 flex items-center justify-between px-4 border-b border-zinc-800">
            <span className="font-semibold text-amber-500 flex items-center gap-2">
              <Sparkles className="w-4 h-4" /> {getRileyTitle("research")}
            </span>
            <button
              onClick={() => setIsChatOpen(false)}
              className="text-zinc-500 hover:text-white p-2 transition-colors"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          {/* The Chat Content */}
          <div className="flex-1 overflow-hidden">
            <RileyContextChat 
              mode="research" 
              contextKey="research" 
              campaignId={campaignId}
              onViewAsset={handleViewAsset}
            />
          </div>
        </div>
      )}

      {/* Document Viewer Modal */}
      {selectedFile && (
        <DocumentViewer
          file={selectedFile}
          variant="modal"
          onClose={() => setSelectedFile(null)}
        />
      )}
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/media/page.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import { useParams } from "next/navigation";
import { useAuth } from "@clerk/nextjs";
import { Download, Video, Music, Image as ImageIcon, Sparkles, X, Upload, FileText, FileType2, Table, Presentation } from "lucide-react";
import { RileyContextChat, getRileyTitle } from "@app/components/campaign/RileyContextChat";
import { DocumentViewer } from "@app/components/ui/DocumentViewer";
import { Asset } from "@app/lib/types";
import { cn } from "@app/lib/utils";
import { apiFetch } from "@app/lib/api";

// Helper to get file type from extension
function getFileTypeFromExtension(filename: string): Asset["type"] {
  const ext = filename.split(".").pop()?.toLowerCase();
  switch (ext) {
    case "pdf":
      return "pdf";
    case "docx":
    case "doc":
      return "docx";
    case "xlsx":
    case "xls":
      return "xlsx";
    case "pptx":
    case "ppt":
      return "pptx";
    case "jpg":
    case "jpeg":
    case "png":
    case "gif":
    case "webp":
      return "img";
    default:
      return "img"; // Default to img for media page
  }
}

function getFileIcon(type: Asset["type"]) {
  switch (type) {
    case "pdf":
      return { icon: FileText, color: "text-red-500" };
    case "docx":
      return { icon: FileType2, color: "text-blue-500" };
    case "xlsx":
      return { icon: Table, color: "text-emerald-500" };
    case "pptx":
      return { icon: Presentation, color: "text-orange-500" };
    case "img":
      return { icon: ImageIcon, color: "text-purple-500" };
    default:
      return { icon: ImageIcon, color: "text-purple-500" };
  }
}

function isAISupportedType(type: Asset["type"]): boolean {
  return ["pdf", "docx", "xlsx", "pptx"].includes(type);
}

export default function MediaPage() {
  const params = useParams();
  const { getToken } = useAuth();
  const campaignId = params.id as string;
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isChatOpen, setIsChatOpen] = useState(false);
  const [selectedFile, setSelectedFile] = useState<Asset | null>(null);
  const fileInputRef = useState<HTMLInputElement | null>(null)[0];

  // Fetch files from backend and filter by Media tag
  useEffect(() => {
    const fetchFiles = async () => {
      if (!campaignId) return;

      try {
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }
        
        const data = await apiFetch<{ files: any[] }>(
          `/api/v1/list?tenant_id=${encodeURIComponent(campaignId)}`,
          {
            token,
            method: "GET",
          }
        );

        // Convert backend file list to Asset format and filter by Media tag
        const fetchedAssets: Asset[] = data.files
          .filter((file: any) => {
            const tags = file.tags || [];
            return tags.includes("Media");
          })
          .map((file: any) => {
            const fileType = getFileTypeFromExtension(file.name);
            return {
              id: file.id || file.name,
              name: file.name,
              type: fileType,
              url: file.url,
              tags: file.tags || [],
              uploadDate: new Date(file.date).toISOString().split("T")[0],
              uploader: "System",
              size: file.size,
              urgency: "medium",
              assignedTo: [],
              comments: 0,
              status: "ready" as Asset["status"],
              aiEnabled: isAISupportedType(fileType),
            };
          });

        setAssets(fetchedAssets);
      } catch (error) {
        console.error("Error fetching files:", error);
        setAssets([]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchFiles();
  }, [campaignId]);

  // Handle viewing an asset from citation badge
  const handleViewAsset = (filename: string) => {
    // Search for the asset in the local assets state
    const asset = assets.find((a) => a.name === filename);
    
    if (asset) {
      setSelectedFile(asset);
    } else {
      // Asset not found in current view (might be Global/Archived)
      alert(`Asset "${filename}" not found in current view (might be Global/Archived).`);
    }
  };

  const handleDownload = (asset: Asset) => {
    // Trigger download
    const link = document.createElement("a");
    link.href = asset.url;
    link.download = asset.name;
    link.target = "_blank";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="flex h-full relative">
      {/* MIDDLE: Media Gallery */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="flex items-center justify-between p-6 border-b border-zinc-800">
          <h1 className="text-2xl font-bold text-zinc-100">Media Assets</h1>
          <div className="flex items-center gap-3">
            {/* Upload Button */}
            <button
              onClick={() => {
                const input = document.createElement("input");
                input.type = "file";
                input.accept = "image/*,video/*,audio/*";
                input.onchange = async (e) => {
                  const file = (e.target as HTMLInputElement).files?.[0];
                  if (!file) return;
                  // Upload logic would go here
                  console.log("Uploading:", file.name);
                };
                input.click();
              }}
              className="flex items-center gap-2 bg-zinc-800 text-zinc-300 hover:bg-zinc-700 px-4 py-2 rounded-md transition-colors"
            >
              <Upload className="w-4 h-4" />
              <span>Upload</span>
            </button>
            {/* THE "OPEN" BUTTON - Only visible if chat is closed */}
            {!isChatOpen && (
              <button
                onClick={() => setIsChatOpen(true)}
                className="flex items-center gap-2 text-amber-500 hover:bg-zinc-900 px-4 py-2 rounded-md transition-colors"
              >
                <Sparkles className="w-4 h-4" />
                <span>Ask Riley</span>
              </button>
            )}
            {/* THE "HIDE" BUTTON - Only visible if chat is open */}
            {isChatOpen && (
              <button
                onClick={() => setIsChatOpen(false)}
                className="flex items-center gap-2 bg-amber-500/10 text-amber-500 border border-amber-500/50 hover:bg-amber-500/20 px-4 py-2 rounded-md transition-colors"
              >
                <Sparkles className="w-4 h-4" />
                <span>Hide Riley</span>
              </button>
            )}
          </div>
        </header>

        {/* Media Grid */}
        <div className="flex-1 overflow-y-auto p-6">
          {isLoading ? (
            <div className="flex items-center justify-center h-full">
              <p className="text-zinc-500">Loading files...</p>
            </div>
          ) : assets.length === 0 ? (
            <div className="flex items-center justify-center h-full">
              <p className="text-zinc-500">No files tagged with Media yet.</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {assets.map((asset) => {
                const { icon: FileIcon, color: iconColor } = getFileIcon(asset.type);
                const isVideo = asset.type === "img" && asset.name.match(/\.(mp4|webm|mov)$/i);
                const isAudio = asset.name.match(/\.(mp3|wav|ogg)$/i);
                const isImage = asset.type === "img" && !isVideo && !isAudio;

                return (
                  <div
                    key={asset.id}
                    className="rounded-xl border border-zinc-800 bg-zinc-900 overflow-hidden hover:border-zinc-700 transition-colors group cursor-pointer"
                    onClick={() => setSelectedFile(asset)}
                  >
                    {/* Media Preview */}
                    <div className="relative aspect-video bg-zinc-950 flex items-center justify-center">
                      {isVideo ? (
                        <div className="w-full h-full flex items-center justify-center">
                          <Video className="h-16 w-16 text-zinc-600" />
                        </div>
                      ) : isAudio ? (
                        <div className="w-full p-6">
                          <div className="flex items-center justify-center mb-4">
                            <div className="h-20 w-20 rounded-full bg-zinc-800 flex items-center justify-center">
                              <Music className="h-10 w-10 text-zinc-400" />
                            </div>
                          </div>
                        </div>
                      ) : isImage ? (
                        <img
                          src={asset.url}
                          alt={asset.name}
                          className="w-full h-full object-cover"
                          onError={(e) => {
                            // Fallback to icon if image fails to load
                            e.currentTarget.style.display = "none";
                            const parent = e.currentTarget.parentElement;
                            if (parent) {
                              parent.innerHTML = `
                                <div class="flex items-center justify-center h-full">
                                  <svg class="h-16 w-16 text-zinc-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                  </svg>
                                </div>
                              `;
                            }
                          }}
                        />
                      ) : (
                        <div className="flex items-center justify-center">
                          <FileIcon className={cn("h-16 w-16", iconColor)} />
                        </div>
                      )}
                    </div>

                    {/* Footer */}
                    <div className="p-4 border-t border-zinc-800 bg-zinc-900/50">
                      <div className="flex items-center justify-between gap-3">
                        <div className="flex-1 min-w-0">
                          <p className="text-sm font-medium text-zinc-100 truncate">{asset.name}</p>
                          <div className="flex items-center gap-2 mt-1">
                            {isVideo && <Video className="h-3.5 w-3.5 text-zinc-500" />}
                            {isAudio && <Music className="h-3.5 w-3.5 text-zinc-500" />}
                            {isImage && <ImageIcon className="h-3.5 w-3.5 text-zinc-500" />}
                            <span className="text-xs text-zinc-500">{asset.size}</span>
                          </div>
                        </div>
                        <button
                          type="button"
                          onClick={(e) => {
                            e.stopPropagation();
                            handleDownload(asset);
                          }}
                          className="flex-shrink-0 p-2 rounded-lg text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors opacity-0 group-hover:opacity-100"
                          aria-label="Download"
                        >
                          <Download className="h-4 w-4" />
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>

      {/* RIGHT: Riley Chat - Conditionally Rendered */}
      {isChatOpen && (
        <div className="w-[400px] border-l border-zinc-800 bg-zinc-900/50 backdrop-blur-sm flex flex-col h-full shrink-0">
          {/* Header with CLOSE Button */}
          <div className="h-16 flex items-center justify-between px-4 border-b border-zinc-800">
            <span className="font-semibold text-amber-500 flex items-center gap-2">
              <Sparkles className="w-4 h-4" /> {getRileyTitle("research")}
            </span>
            <button
              onClick={() => setIsChatOpen(false)}
              className="text-zinc-500 hover:text-white p-2 transition-colors"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          {/* The Chat Content */}
          <div className="flex-1 overflow-hidden">
            <RileyContextChat 
              mode="research" 
              contextKey="media" 
              campaignId={campaignId}
              onViewAsset={handleViewAsset}
            />
          </div>
        </div>
      )}

      {/* Document Viewer Modal */}
      {selectedFile && (
        <DocumentViewer
          file={selectedFile}
          variant="modal"
          onClose={() => setSelectedFile(null)}
        />
      )}
    </div>
  );
}


==================================================
FILE: next-frontend/src/app/campaign/[id]/assets/page.tsx
==================================================
"use client";

import { useState, useRef, useEffect } from "react";
import { useParams } from "next/navigation";
import { useAuth } from "@clerk/nextjs";
import { Upload, Loader2 } from "lucide-react";
import { Asset, AssetTag } from "@app/lib/types";
import { AssetRow } from "@app/components/campaign/AssetRow";
import { DocumentViewer } from "@app/components/ui/DocumentViewer";
import { RenameAssetModal } from "@app/components/campaign/RenameAssetModal";
import { DeleteFileModal } from "@app/components/campaign/DeleteFileModal";
import { PromoteModal } from "@app/components/campaign/PromoteModal";
import { apiFetch } from "@app/lib/api";

// Helper function to determine if file type supports AI processing
function isAISupportedType(type: Asset["type"]): boolean {
  return type === "pdf" || type === "docx";
}

// Mock initial data with new fields - using valid public URLs for testing
const initialAssets: Asset[] = [
  {
    id: "1",
    name: "Q3_Polling_Data.pdf",
    type: "pdf",
    url: "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf",
    tags: ["Research"],
    uploadDate: "2024-01-15",
    uploader: "Sarah Chen",
    size: "2.4 MB",
    urgency: "medium",
    assignedTo: [],
    comments: 0,
    status: "ready",
    aiEnabled: true, // PDF supports AI
  },
  {
    id: "2",
    name: "Candidate_Bio_Draft.docx",
    type: "docx",
    url: "https://file-examples.com/storage/fe68c7b4c5c0b5a5b5b5b5b/2017/10/file_example_DOCX_10.docx",
    tags: ["Messaging", "Strategy"],
    uploadDate: "2024-01-14",
    uploader: "John Martinez",
    size: "850 KB",
    urgency: "low",
    assignedTo: ["Sarah Chen"],
    comments: 2,
    status: "needs_review",
    aiEnabled: true, // Docx supports AI
  },
  {
    id: "3",
    name: "Strategic_Plan_Q1.xlsx",
    type: "xlsx",
    url: "https://file-examples.com/storage/fe68c7b4c5c0b5a5b5b5b5b/2017/10/file_example_XLSX_10.xlsx",
    tags: ["Strategy"],
    uploadDate: "2024-01-13",
    uploader: "Alex Rivera",
    size: "1.2 MB",
    urgency: "medium",
    assignedTo: [],
    comments: 0,
    status: "ready",
    aiEnabled: false, // Excel files not AI-enabled by default
  },
  {
    id: "4",
    name: "Press_Release_Template.pptx",
    type: "pptx",
    url: "https://file-examples.com/storage/fe68c7b4c5c0b5a5b5b5b5b/2017/10/file_example_PPTX_10.pptx",
    tags: [],
    uploadDate: "2024-01-12",
    uploader: "Sarah Chen",
    size: "3.1 MB",
    urgency: "low",
    assignedTo: [],
    comments: 0,
    status: "ready",
    aiEnabled: false, // PowerPoint not AI-enabled by default
  },
  {
    id: "5",
    name: "Campaign_Photo.jpg",
    type: "img",
    url: "https://images.unsplash.com/photo-1557804506-669a67965ba0?auto=format&fit=crop&w=800&q=80",
    tags: ["Media"],
    uploadDate: "2024-01-16",
    uploader: "John Martinez",
    size: "45.2 MB",
    urgency: "high",
    assignedTo: ["Alex Rivera"],
    comments: 5,
    status: "in_review",
    aiEnabled: false, // Media files disabled for AI
  },
  {
    id: "6",
    name: "Client_Pitch_Deck_2024.pptx",
    type: "pptx",
    url: "https://file-examples.com/storage/fe68c7b4c5c0b5a5b5b5b5b/2017/10/file_example_PPTX_10.pptx",
    tags: ["Pitch"],
    uploadDate: "2024-01-17",
    uploader: "Sarah Chen",
    size: "8.7 MB",
    urgency: "high",
    assignedTo: ["John Martinez", "Alex Rivera"],
    comments: 12,
    status: "approved",
    aiEnabled: false, // PowerPoint not AI-enabled by default
  },
];

function getFileTypeFromExtension(filename: string): Asset["type"] {
  const extension = filename.split(".").pop()?.toLowerCase() || "";
  if (extension === "pdf") return "pdf";
  if (extension === "docx" || extension === "doc") return "docx";
  if (extension === "xlsx" || extension === "xls" || extension === "csv") return "xlsx";
  if (extension === "pptx" || extension === "ppt") return "pptx";
  if (["png", "jpg", "jpeg", "webp", "gif", "svg"].includes(extension)) return "img";
  return "pdf"; // Default
}

function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}

export default function CampaignAssetsPage() {
  const params = useParams();
  const { getToken } = useAuth();
  const campaignId = params.id as string;
  const [assets, setAssets] = useState<Asset[]>([]);
  const [isUploading, setIsUploading] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null);
  const [renamingAsset, setRenamingAsset] = useState<Asset | null>(null);
  const [deletingAsset, setDeletingAsset] = useState<Asset | null>(null);
  const [promotingAsset, setPromotingAsset] = useState<Asset | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  // Fetch files from backend on mount
  useEffect(() => {
    const fetchFiles = async () => {
      if (!campaignId) return; // Don't fetch if no campaign ID
      
      try {
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }
        
        const data = await apiFetch<{ files: any[] }>(
          `/api/v1/list?tenant_id=${encodeURIComponent(campaignId)}`,
          {
            token,
            method: "GET",
          }
        );
        
        // Convert backend file list to Asset format
        const fetchedAssets: Asset[] = data.files.map((file: any) => {
          const baseType = getFileTypeFromExtension(file.name);
          const previewType = file.preview_type as string | undefined;

          // If server generated a PDF preview, treat as PDF for viewing
          const effectiveType = previewType === "pdf" ? "pdf" : baseType;

          return {
            id: file.id, // Qdrant UUID (required)
            name: file.name,
            type: effectiveType,
            url: file.url, // original file URL (used for download)
            previewUrl: file.preview_url ?? undefined,
            previewType,
            previewStatus: file.preview_status ?? undefined,
            tags: file.tags || [], // Use tags from backend
            uploadDate: new Date(file.date).toISOString().split("T")[0],
            uploader: "System",
            size: file.size,
            urgency: "medium",
            assignedTo: [],
            comments: 0,
            status: "ready",
            aiEnabled: isAISupportedType(effectiveType),
          };
        });
        
        setAssets(fetchedAssets);
      } catch (error) {
        console.error("Error fetching files:", error);
        // Return empty array if fetch fails (Qdrant is source of truth)
        setAssets([]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchFiles();
  }, [campaignId]);

  const handleUpload = () => {
    fileInputRef.current?.click();
  };

  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    setIsUploading(true);
    const fileType = getFileTypeFromExtension(file.name);
    const fileSize = formatFileSize(file.size);

    // Create FormData for multipart/form-data upload
    const formData = new FormData();
    formData.append("file", file);
    formData.append("tenant_id", campaignId); // Use actual campaign ID from URL
    formData.append("tags", ""); // Empty tags - user will add tags via UI

    const uploadFile = async (overwrite: boolean = false): Promise<{ id: string; url: string; filename: string; type?: string }> => {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }
      
      const path = `/api/v1/upload${overwrite ? "?overwrite=true" : ""}`;
      const result = await apiFetch<{ id: string; url: string; filename: string; type?: string }>(path, {
        token,
        method: "POST",
        body: formData,
      });
      return result;
    };

    try {
      // Try upload
      let result: { id: string; url: string; filename: string; type?: string };
      
      try {
        result = await uploadFile(false);
      } catch (error) {
        // Handle 409 Conflict (file exists)
        const errorMessage = error instanceof Error ? error.message : "Upload failed";
        if (errorMessage.includes("409")) {
          const shouldOverwrite = window.confirm(
            `File "${file.name}" already exists. Overwrite?`
          );
          
          if (shouldOverwrite) {
            // Retry with overwrite=true
            result = await uploadFile(true);
          } else {
            setIsUploading(false);
            if (fileInputRef.current) {
              fileInputRef.current.value = "";
            }
            return;
          }
        } else {
          // Re-throw any other error
          throw error;
        }
      }
      
      // Fetch the file from the list endpoint to get full metadata including tags
      // This ensures we have the correct tags that were saved to Qdrant
      const token = await getToken();
      if (token) {
        try {
          const listData = await apiFetch<{ files: any[] }>(
            `/api/v1/list?tenant_id=${encodeURIComponent(campaignId)}`,
            {
              token,
              method: "GET",
            }
          );
          const uploadedFile = listData.files.find((f: any) => f.id === result.id);
          
          if (uploadedFile) {
            const baseType = getFileTypeFromExtension(uploadedFile.name);
            const previewType = uploadedFile.preview_type as string | undefined;
            const effectiveType = previewType === "pdf" ? "pdf" : baseType;

            // Use the file data from Qdrant (source of truth)
            const newAsset: Asset = {
              id: uploadedFile.id,
              name: uploadedFile.name,
              type: effectiveType,
              url: uploadedFile.url, // original URL
              previewUrl: uploadedFile.preview_url ?? undefined,
              previewType,
              previewStatus: uploadedFile.preview_status ?? undefined,
              tags: uploadedFile.tags || [], // Use tags from Qdrant
              uploadDate: new Date(uploadedFile.date).toISOString().split("T")[0],
              uploader: "You",
              size: uploadedFile.size,
              urgency: "medium",
              assignedTo: [],
              comments: 0,
              status: "ready",
              aiEnabled: isAISupportedType(effectiveType),
            };
            
            // Add the new asset to the state
            setAssets([newAsset, ...assets]);
          }
        } catch (err) {
          console.error("Error fetching uploaded file metadata:", err);
        }
      }
      
      // Fallback if we can't fetch from list (shouldn't happen, but handle gracefully)
      const newAsset: Asset = {
        id: result.id,
        name: result.filename,
        type: fileType,
        url: result.url,
        tags: [], // Empty tags - user will add via UI
        uploadDate: new Date().toISOString().split("T")[0],
        uploader: "You",
        size: fileSize,
        urgency: "medium",
        assignedTo: [],
        comments: 0,
        status: "ready",
        aiEnabled: isAISupportedType(fileType),
      };

      // Add the new asset to the state so it appears in the table instantly
      setAssets([newAsset, ...assets]);
      setIsUploading(false);
    } catch (error) {
      console.error("Upload error:", error);
      // Show error to user (you might want to add a toast notification here)
      alert(`Upload failed: ${error instanceof Error ? error.message : "Unknown error"}`);
      setIsUploading(false);
    } finally {
      // Reset file input
      if (fileInputRef.current) {
        fileInputRef.current.value = "";
      }
    }
  };

  const handleTagChange = (assetId: string, tags: AssetTag[]) => {
    setAssets((prev) =>
      prev.map((asset) => (asset.id === assetId ? { ...asset, tags } : asset))
    );
  };

  const handleDelete = async (assetId: string, isGlobal: boolean) => {
    const asset = assets.find((a) => a.id === assetId);
    if (!asset) return;

    try {
      if (isGlobal) {
        // Global delete: Remove from disk, Qdrant, and all tabs
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }
        
        await apiFetch(`/api/v1/files/${assetId}`, {
          token,
          method: "DELETE",
        });

        // Remove from local state
        setAssets((prev) => prev.filter((a) => a.id !== assetId));
        
        // Close viewer if this asset was open
        if (selectedAsset?.id === assetId) {
          setSelectedAsset(null);
        }
      } else {
        // Local delete: Clear all tags (remove from all workstreams)
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }
        
        await apiFetch(`/api/v1/files/${assetId}/untag`, {
          token,
          method: "PATCH",
          body: { tag: "*" }, // "*" means clear all tags
        });

        // Update local state to clear all tags
        setAssets((prev) =>
          prev.map((a) =>
            a.id === assetId
              ? { ...a, tags: [] }
              : a
          )
        );
      }
    } catch (error) {
      console.error("Delete error:", error);
      throw error; // Re-throw so modal can handle it
    }
  };

  const handleDownload = (assetId: string) => {
    const asset = assets.find((a) => a.id === assetId);
    if (asset) {
      // Mock download - in production, this would trigger actual download
      console.log("Downloading:", asset.name);
      // You could use: window.open(asset.url, '_blank');
    }
  };

  const handleAIEnabledChange = (assetId: string, enabled: boolean) => {
    setAssets((prev) =>
      prev.map((asset) =>
        asset.id === assetId ? { ...asset, aiEnabled: enabled } : asset
      )
    );
  };

  const handleAssetClick = (asset: Asset) => {
    setSelectedAsset(asset);
  };

  const handleCloseViewer = () => {
    setSelectedAsset(null);
  };

  const handleRename = async (newName: string) => {
    if (!renamingAsset) return;

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }
      
      const result = await apiFetch<{ new_name: string; new_url: string }>(
        "/api/v1/files/rename",
        {
          token,
          method: "POST",
          body: {
            old_name: renamingAsset.name,
            new_name: newName,
          },
        }
      );

      // Update the asset in state
      setAssets((prev) =>
        prev.map((asset) =>
          asset.id === renamingAsset.id
            ? {
                ...asset,
                name: result.new_name,
                url: result.new_url,
              }
            : asset
        )
      );

      setRenamingAsset(null);
    } catch (error) {
      console.error("Rename error:", error);
      throw error; // Re-throw so the modal can handle it
    }
  };

  const handlePromote = async (isGolden: boolean) => {
    if (!promotingAsset) return;

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }
      
      await apiFetch(`/api/v1/files/${promotingAsset.id}/archive`, {
        token,
        method: "POST",
        body: { is_golden: isGolden },
      });

      // Success - modal will close automatically
      setPromotingAsset(null);
    } catch (error) {
      console.error("Promote error:", error);
      throw error; // Re-throw so the modal can handle it
    }
  };

  return (
    <div className="flex h-full relative">
      {/* Main Content */}
      <main className="flex-1 flex flex-col overflow-hidden bg-transparent">
        {/* Header */}
        <header className="flex items-center justify-between p-6 border-b border-white/5 bg-slate-900/50 backdrop-blur-md">
          <h1 className="text-2xl font-bold text-zinc-100">
            Campaign Assets
          </h1>
            <div className="flex items-center gap-3">
              <input
                ref={fileInputRef}
                type="file"
                className="hidden"
                accept=".pdf,.docx,.doc,.xlsx,.xls,.pptx,.ppt,.png,.jpg,.jpeg,.webp"
                onChange={handleFileSelect}
              />
              <button
                type="button"
                onClick={handleUpload}
                disabled={isUploading}
                className="inline-flex items-center gap-2 rounded-md border border-amber-500/20 bg-amber-500/10 px-4 py-2 text-sm font-medium text-amber-400 transition-all hover:bg-amber-500/20 hover:border-amber-500/30 focus:outline-none focus:ring-2 focus:ring-amber-500/50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isUploading ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin" />
                    Uploading...
                  </>
                ) : (
                  <>
                    <Upload className="h-4 w-4" />
                    Upload File
                  </>
                )}
              </button>
            </div>
        </header>

        {/* Scrollable Content Area */}
        <div className="flex-1 overflow-y-auto p-6">
          {/* The Vault (HUD-style Table) */}
          <div className="rounded-xl border border-slate-800 bg-slate-900/80 backdrop-blur-md overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-zinc-800/50">
                    <th className="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-zinc-400">
                      Icon
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-zinc-400">
                      Name
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-zinc-400">
                      Spotlight Tags
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-zinc-400">
                      Meta
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-zinc-400">
                      Riley's Memory
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-semibold uppercase tracking-wider text-zinc-400">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {isLoading ? (
                    <tr>
                      <td colSpan={6} className="px-6 py-12 text-center text-sm text-zinc-500">
                        Loading files...
                      </td>
                    </tr>
                  ) : assets.length === 0 ? (
                    <tr>
                      <td colSpan={6} className="px-6 py-12 text-center text-sm text-zinc-500">
                        No assets uploaded yet. Click "Upload File" to get started.
                      </td>
                    </tr>
                  ) : (
                    assets.map((asset) => (
                      <AssetRow
                        key={asset.id}
                        asset={asset}
                        onTagChange={handleTagChange}
                        onDelete={(id) => {
                          const asset = assets.find((a) => a.id === id);
                          if (asset) {
                            setDeletingAsset(asset);
                          }
                        }}
                        onDownload={handleDownload}
                        onAIEnabledChange={handleAIEnabledChange}
                        onClick={handleAssetClick}
                        onRename={setRenamingAsset}
                        onPromote={setPromotingAsset}
                      />
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>

      {/* Document Viewer */}
      {selectedAsset && (
        <DocumentViewer
          file={selectedAsset}
          onClose={handleCloseViewer}
        />
      )}

      {/* Rename Modal */}
      {renamingAsset && (
        <RenameAssetModal
          isOpen={!!renamingAsset}
          onClose={() => setRenamingAsset(null)}
          onRename={handleRename}
          currentName={renamingAsset.name}
        />
      )}

      {/* Delete Modal */}
      {deletingAsset && (
        <DeleteFileModal
          isOpen={!!deletingAsset}
          onClose={() => {
            setDeletingAsset(null);
          }}
          file={deletingAsset}
          currentContext="assets"
          onDelete={handleDelete}
        />
      )}

      {/* Promote Modal */}
      {promotingAsset && (
        <PromoteModal
          isOpen={!!promotingAsset}
          onClose={() => setPromotingAsset(null)}
          onPromote={handlePromote}
          fileName={promotingAsset.name}
        />
      )}
    </div>
  );
}


==================================================
FILE: next-frontend/src/lib/types.ts
==================================================
export type SecurityStatus = "Top Secret" | "Restricted" | "Open" | "Internal";

export interface CampaignBucket {
  id: string;
  name: string;
  role: string;
  securityStatus: SecurityStatus;
  /**
   * Arbitrary CSS color value used to tint the bucket card
   * (e.g., "#22c55e", "rgb(59,130,246)", "hsl(210 100% 56%)").
   */
  themeColor: string;
}

export type AssetTag = "Messaging" | "Research" | "Strategy" | "Media" | "Pitch" | "Other";

export interface Asset {
  id: string;
  name: string;
  type: "pdf" | "docx" | "xlsx" | "img" | "pptx";
  url: string;
  // Optional server-generated preview metadata (e.g., Office/HTML -> PDF)
  previewUrl?: string;
  previewType?: string;
  previewStatus?: string;
  tags: AssetTag[]; // Array for multi-tagging
  uploadDate: string;
  uploader: string;
  size: string; // File size (e.g., "2.4 MB", "150 KB")
  urgency: "low" | "medium" | "high" | "critical";
  assignedTo: string[]; // List of user IDs or Names
  comments: number; // Count of comments
  status: "processing" | "ready" | "error" | "in_progress" | "needs_review" | "in_review" | "approved";
  aiEnabled: boolean; // Whether this file is included in AI context (default true for PDF/Docx, false for Images/Video)
}

export type KanbanStatus = "Draft" | "Needs Review" | "In Review" | "Completed";

export interface KanbanCard {
  id: string;
  name: string;
  type: Asset["type"];
  url: string;
  status: KanbanStatus;
  assignees: string[]; // Array of initials like "SJ", "JD"
  tags: AssetTag[];
}




==================================================
FILE: next-frontend/src/lib/useCampaignName.ts
==================================================
import { useState, useEffect } from "react";
import { useAuth } from "@clerk/nextjs";
import { apiFetch } from "@app/lib/api";

// Backend campaign shape
interface BackendCampaign {
  id: string;
  name: string;
  description: string | null;
  role: "Lead" | "Member";
}

interface CampaignsResponse {
  campaigns: BackendCampaign[];
}

interface UseCampaignNameResult {
  name: string;
  displayName: string;
  isLoading: boolean;
}

/**
 * Hook to fetch and return the campaign name for a given campaign ID.
 * Falls back to shortened ID (first 8 chars) if campaign not found or fetch fails.
 * 
 * @param campaignId - The campaign ID from route params
 * @returns Object with `name` (actual name or empty), `displayName` (name or fallback), and `isLoading` state
 */
export function useCampaignName(campaignId: string | undefined): UseCampaignNameResult {
  const { getToken, isLoaded } = useAuth();
  const [name, setName] = useState<string>("");
  const [isLoading, setIsLoading] = useState<boolean>(true);

  useEffect(() => {
    async function fetchCampaignName() {
      if (!isLoaded || !campaignId) {
        setIsLoading(false);
        return;
      }

      try {
        const token = await getToken();
        if (!token) {
          // Fallback to empty name if no token
          setName("");
          setIsLoading(false);
          return;
        }

        const data: CampaignsResponse = await apiFetch("/api/v1/campaigns", {
          token,
          method: "GET",
        });

        // Find campaign with matching ID
        const campaign = data.campaigns.find((c) => c.id === campaignId);
        if (campaign) {
          setName(campaign.name);
        } else {
          // Campaign not found - leave name empty (will use fallback in displayName)
          setName("");
        }
      } catch (err) {
        console.error("Error fetching campaign name:", err);
        // On error, leave name empty (will use fallback in displayName)
        setName("");
      } finally {
        setIsLoading(false);
      }
    }

    fetchCampaignName();
  }, [isLoaded, campaignId, getToken]);

  // displayName falls back to first 8 chars of ID if name is not available
  const displayName = name || (campaignId ? campaignId.slice(0, 8) : "");

  return { name, displayName, isLoading };
}


==================================================
FILE: next-frontend/src/lib/personas.ts
==================================================
/** Persona Codex: Strategic archetypes for target audience recognition. */

export const RALLY_PERSONAS = [
  "Unbothered Ursula & Ulysses",
  "Empathetic Eric",
  "Active Ava",
  "Skeptical Sam",
  "Passive Patty",
  "Supporter Spencer",
  "Advocate Angie",
  "Legislator Brian (State Level)",
  "Secretary of Education Michelle (State Level)",
  "Mayor Michael (Local Level)",
  "Superintendent James (District Level)",
  "District Administrator Jennifer (District Level)",
  "Educator Christina (Educator)",
  "Foundation CEO Sarah (Philanthropoid)",
  "Program Director Emily (Philanthropoid)",
  "Philanthropist Chuck (Philantropist)",
  "National Housing Advocate Monica",
  "National Education Advocate Chris",
  "Federal Policymaker David",
  "Governor Charlie",
  "Education Personnel",
  "Decision Makers and Policy Makers",
  "Media",
  "Parents",
  "Gen Z",
  "Thoughtleaders and Advocates",
  "Policymaker Jeff (Federal Level)",
  "Legislator Margaret (State Level)",
  "District Administrator Daniel (District Level)",
  "Philanthropist Chuck Harvey",
  "Equity Forward Salesperson Benjamin Pattton",
  "Concerned Californians",
  "Mental Health Specialist",
  "The Field",
  "The Media",
  "Unbothered",
  "Empathetic",
  "Advocates",
  "Unaware + Unbothered",
];

/**
 * Detects if a message contains any persona names.
 * Returns the first matching persona found, or null if none.
 */
export function detectPersona(content: string): string | null {
  // Sort personas by length (longest first) to match more specific names first
  const sortedPersonas = [...RALLY_PERSONAS].sort((a, b) => b.length - a.length);
  
  for (const persona of sortedPersonas) {
    // Case-insensitive search for the persona name
    const regex = new RegExp(persona.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
    if (regex.test(content)) {
      return persona;
    }
  }
  
  return null;
}


==================================================
FILE: next-frontend/src/lib/utils.ts
==================================================
export type ClassValue =
  | string
  | number
  | boolean
  | null
  | undefined
  | ClassValue[]
  | { [key: string]: boolean | null | undefined };

export function cn(...inputs: ClassValue[]): string {
  const classes: string[] = [];

  for (const input of inputs) {
    if (!input && input !== 0) continue;

    if (typeof input === "string" || typeof input === "number") {
      classes.push(String(input));
    } else if (Array.isArray(input)) {
      const inner = cn(...input);
      if (inner) classes.push(inner);
    } else if (typeof input === "object") {
      for (const [key, value] of Object.entries(input)) {
        if (value) classes.push(key);
      }
    }
  }

  return classes.join(" ");
}




==================================================
FILE: next-frontend/src/lib/api.ts
==================================================
/**
 * Centralized API client for all backend requests.
 * 
 * Ensures:
 * - No localhost URLs in production
 * - All /api/v1/* requests include Authorization header
 * - Proper error handling and messaging
 */

/**
 * Get the API base URL from environment or fallback.
 * 
 * @returns API base URL string
 * @throws Error if NEXT_PUBLIC_API_URL is missing in production
 */
export function getApiBaseUrl(): string {
  const envUrl = process.env.NEXT_PUBLIC_API_URL;
  
  // In production (non-localhost), require env var
  if (typeof window !== "undefined" && window.location.hostname !== "localhost") {
    if (!envUrl) {
      throw new Error("NEXT_PUBLIC_API_URL missing in production");
    }
    return envUrl;
  }
  
  // Development fallback to localhost
  return envUrl || "http://localhost:8000";
}

// Log base URL once on app load (dev only)
if (typeof window !== "undefined" && process.env.NODE_ENV !== "production") {
  console.log("[API] Base URL:", getApiBaseUrl());
}

interface ApiFetchOptions {
  token?: string | null;
  method?: string;
  body?: any | FormData;
  headers?: Record<string, string>;
}

/**
 * Unified fetch wrapper for API requests.
 * 
 * @param path - API path (e.g., "/api/v1/campaigns")
 * @param options - Fetch options including token, method, body, headers
 * @returns Promise resolving to parsed JSON response
 * @throws Error with descriptive message on failure
 */
export async function apiFetch<T = any>(
  path: string,
  options: ApiFetchOptions = {}
): Promise<T> {
  const { token, method = "GET", body, headers = {} } = options;
  
  // Require token for /api/v1/* endpoints
  if (path.startsWith("/api/v1/") && !token) {
    throw new Error("Missing auth token");
  }
  
  const baseUrl = getApiBaseUrl();
  const url = `${baseUrl}${path}`;
  
  // Build headers
  const requestHeaders: Record<string, string> = {
    ...headers,
  };
  
  // Add Authorization header if token provided
  if (token) {
    requestHeaders.Authorization = `Bearer ${token}`;
  }
  
  // Handle FormData vs JSON body
  const isFormData = body instanceof FormData;
  if (!isFormData) {
    requestHeaders["Content-Type"] = "application/json";
  }
  
  // Build request options
  const requestOptions: RequestInit = {
    method,
    headers: requestHeaders,
  };
  
  // Add body for non-GET requests
  if (body && method !== "GET") {
    requestOptions.body = isFormData ? body : JSON.stringify(body);
  }
  
  try {
    const response = await fetch(url, requestOptions);
    
    if (!response.ok) {
      // Try to parse error detail from response
      let errorDetail = `HTTP ${response.status}`;
      try {
        const errorData = await response.json();
        if (errorData.detail) {
          errorDetail = `HTTP ${response.status}: ${errorData.detail}`;
        } else if (errorData.message) {
          errorDetail = `HTTP ${response.status}: ${errorData.message}`;
        }
      } catch {
        // If JSON parse fails, use status text
        const statusText = response.statusText || "Unknown error";
        errorDetail = `HTTP ${response.status}: ${statusText}`;
      }
      throw new Error(errorDetail);
    }
    
    // Parse JSON response
    const data = await response.json();
    return data as T;
  } catch (error) {
    // Re-throw if already an Error with message
    if (error instanceof Error) {
      throw error;
    }
    // Network/CORS errors
    throw new Error("Network/CORS failure");
  }
}


==================================================
FILE: next-frontend/src/components/RileyAssistant.tsx
==================================================
"use client";

import { useState } from "react";
import { Bot, Sparkles, X, AlertCircle, Calendar, FileText, ChevronUp } from "lucide-react";
import { cn } from "@app/lib/utils";

type Notification = {
  id: string;
  type: "slack" | "calendar" | "upload";
  icon: React.ReactNode;
  message: string;
  hasSummary?: boolean;
  summary?: string;
};

const mockNotifications: Notification[] = [
  {
    id: "1",
    type: "slack",
    icon: <AlertCircle className="h-4 w-4" />,
    message: "Urgent: VP of Comms posted in #general-announcements.",
    hasSummary: true,
    summary: "The VP of Communications shared an update about the upcoming press conference regarding the housing policy initiative.",
  },
  {
    id: "2",
    type: "calendar",
    icon: <Calendar className="h-4 w-4" />,
    message: "Reminder: Client Strategy Review starts in 15 mins.",
    hasSummary: false,
  },
  {
    id: "3",
    type: "upload",
    icon: <FileText className="h-4 w-4" />,
    message: "New Upload: 'Q3_Budget_Draft.xlsx' added to Housing Justice bucket.",
    hasSummary: false,
  },
];

export function RileyAssistant() {
  const [notifications] = useState<Notification[]>(mockNotifications);
  const [showSummary, setShowSummary] = useState<string | null>(null);
  const [isExpanded, setIsExpanded] = useState<boolean>(true);

  const handleReadSummary = (notification: Notification) => {
    if (notification.hasSummary && notification.summary) {
      setShowSummary(notification.summary);
    }
  };

  const closeSummary = () => {
    setShowSummary(null);
  };

  const alertCount = notifications.length;

  return (
    <div className="relative">
      {isExpanded ? (
        /* Expanded View: Full Card - Floating Overlay */
        <div className="absolute top-0 right-0 z-50 w-[400px] rounded-2xl border border-zinc-800 bg-zinc-900/95 backdrop-blur-md shadow-2xl animate-[fadeIn_0.2s_ease-out,zoomIn_0.2s_ease-out]">
          {/* Header with Bot Icon */}
          <div className="flex items-center gap-3 border-b border-zinc-800 bg-zinc-900/50 px-5 py-4">
            <div className="relative">
              <div className="absolute inset-0 animate-pulse rounded-full bg-blue-400/20 blur-md" />
              <div className="relative flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 shadow-sm">
                <Bot className="h-5 w-5 text-white" aria-hidden="true" />
              </div>
            </div>
            <div className="flex-1">
              <h3 className="text-sm font-semibold text-zinc-100">Riley Assistant</h3>
              <p className="text-xs text-zinc-400">Proactive Intelligence Feed</p>
            </div>
            <div className="flex items-center gap-2">
              <Sparkles className="h-4 w-4 text-blue-400" aria-hidden="true" />
              <button
                type="button"
                onClick={() => setIsExpanded(false)}
                className="rounded-lg p-1.5 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors"
                aria-label="Minimize"
              >
                <ChevronUp className="h-4 w-4" aria-hidden="true" />
              </button>
            </div>
          </div>

          {/* Notifications Feed - Read Only */}
          <div className="max-h-[500px] overflow-y-auto p-4 [&::-webkit-scrollbar]:hidden [-ms-overflow-style:'none'] [scrollbar-width:'none']">
            {notifications.length === 0 ? (
              /* Zero State */
              <div className="flex flex-col items-center justify-center py-12 text-center">
                <div className="text-4xl mb-3">ðŸŽ‰</div>
                <p className="text-sm text-zinc-400">
                  You're all caught up! No new alerts.
                </p>
              </div>
            ) : (
              <div className="space-y-3">
                {notifications.map((notification) => (
                  <div
                    key={notification.id}
                    className={cn(
                      "rounded-lg border border-zinc-800 bg-zinc-800/30 p-3 transition-all hover:border-zinc-700 hover:bg-zinc-800/50",
                      notification.type === "slack" && "border-amber-500/30 bg-amber-500/5"
                    )}
                  >
                    <div className="flex items-start gap-3">
                      <div
                        className={cn(
                          "mt-0.5 flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full",
                          notification.type === "slack" && "bg-amber-500/20 text-amber-400",
                          notification.type === "calendar" && "bg-blue-500/20 text-blue-400",
                          notification.type === "upload" && "bg-emerald-500/20 text-emerald-400"
                        )}
                      >
                        {notification.icon}
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm text-zinc-300">{notification.message}</p>
                        {notification.hasSummary && (
                          <button
                            type="button"
                            onClick={() => handleReadSummary(notification)}
                            className="mt-2 text-xs font-medium text-blue-400 hover:text-blue-300 hover:underline"
                          >
                            Read Summary â†’
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      ) : (
        /* Minimized View: Pill/Badge */
        <button
          type="button"
          onClick={() => setIsExpanded(true)}
          className="inline-flex items-center gap-2 rounded-full border border-zinc-800 bg-zinc-900/60 backdrop-blur-sm px-4 py-2.5 shadow-sm transition-all hover:border-zinc-700 hover:shadow-md"
        >
          <div className="relative">
            <div className="absolute inset-0 animate-pulse rounded-full bg-blue-400/20 blur-sm" />
            <div className="relative flex h-6 w-6 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-indigo-600">
              <Bot className="h-3.5 w-3.5 text-white" aria-hidden="true" />
            </div>
          </div>
          <span className="text-sm font-medium text-zinc-300">
            Riley is active ({alertCount} alert{alertCount !== 1 ? "s" : ""})
          </span>
          <Sparkles className="h-3.5 w-3.5 text-blue-400" aria-hidden="true" />
        </button>
      )}

      {/* Summary Modal/Toast */}
      {showSummary && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4" onClick={closeSummary}>
          <div
            className="relative w-full max-w-md rounded-2xl border border-zinc-800 bg-zinc-900/95 backdrop-blur-xl shadow-xl"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between border-b border-zinc-800 bg-zinc-900/50 px-5 py-4">
              <div className="flex items-center gap-2">
                <Bot className="h-5 w-5 text-blue-400" aria-hidden="true" />
                <h3 className="text-sm font-semibold text-zinc-100">Riley Summary</h3>
              </div>
              <button
                type="button"
                onClick={closeSummary}
                className="rounded-lg p-1 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100"
              >
                <X className="h-4 w-4" aria-hidden="true" />
              </button>
            </div>
            <div className="px-5 py-4">
              <p className="text-sm leading-relaxed text-zinc-300">{showSummary}</p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


==================================================
FILE: next-frontend/src/components/SearchInterface.tsx
==================================================
"use client";

import { useMemo, useState } from "react";
import { useAuth } from "@clerk/nextjs";
import {
  File,
  FileText,
  FileType2,
  Image as ImageIcon,
  Loader2,
  Presentation,
  Search,
  Table,
} from "lucide-react";
import { cn } from "@app/lib/utils";
import { apiFetch } from "@app/lib/api";

type SearchResult = {
  id: string;
  score: number;
  payload?: {
    filename?: string;
    text_preview?: string;
    content?: string;
    type?: string;
    year?: number;
    [key: string]: unknown;
  };
};

type SearchResponse = {
  results: SearchResult[];
};

function basename(path?: string) {
  if (!path) return "Unknown file";
  const parts = path.split(/[\\/]/).filter(Boolean);
  return parts[parts.length - 1] ?? path;
}

function splitExtension(filename: string): { base: string; ext: string } {
  const lastDot = filename.lastIndexOf(".");
  if (lastDot <= 0 || lastDot === filename.length - 1) {
    return { base: filename, ext: "" };
  }
  return {
    base: filename.slice(0, lastDot),
    ext: filename.slice(lastDot + 1).toLowerCase(),
  };
}

function truncate(text: string, max = 200) {
  const t = text.trim();
  if (t.length <= max) return t;
  return `${t.slice(0, max).trimEnd()}â€¦`;
}

function fileTypePresentation(ext: string) {
  switch (ext) {
    case "pdf":
      return {
        kindLabel: "PDF",
        icon: FileText,
        iconClass: "text-rose-700",
        chipClass: "bg-rose-50 text-rose-700 border-rose-200",
      };
    case "docx":
    case "doc":
      return {
        kindLabel: "Document",
        icon: FileType2,
        iconClass: "text-blue-700",
        chipClass: "bg-blue-50 text-blue-700 border-blue-200",
      };
    case "xlsx":
    case "csv":
      return {
        kindLabel: "Dataset",
        icon: Table,
        iconClass: "text-emerald-700",
        chipClass: "bg-emerald-50 text-emerald-700 border-emerald-200",
      };
    case "pptx":
    case "ppt":
      return {
        kindLabel: "Presentation",
        icon: Presentation,
        iconClass: "text-orange-700",
        chipClass: "bg-orange-50 text-orange-700 border-orange-200",
      };
    case "png":
    case "jpg":
    case "jpeg":
    case "webp":
      return {
        kindLabel: "Visual Asset",
        icon: ImageIcon,
        iconClass: "text-purple-700",
        chipClass: "bg-purple-50 text-purple-700 border-purple-200",
      };
    default:
      return {
        kindLabel: ext ? ext.toUpperCase() : "File",
        icon: File,
        iconClass: "text-slate-600",
        chipClass: "bg-slate-50 text-slate-700 border-slate-200",
      };
  }
}

function relevanceBadgeClass(pct: number) {
  if (pct > 70) return "bg-emerald-50 text-emerald-800 border-emerald-200";
  if (pct < 50) return "bg-yellow-50 text-yellow-800 border-yellow-200";
  return "bg-slate-100 text-slate-800 border-slate-200";
}

export function SearchInterface() {
  const { getToken } = useAuth();
  const [queryText, setQueryText] = useState("");
  const [results, setResults] = useState<SearchResult[]>([]);
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const canSearch = useMemo(() => queryText.trim().length > 0, [queryText]);

  async function onSearch() {
    if (!canSearch || isLoading) return;

    setIsLoading(true);
    setError(null);

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }

      const data = await apiFetch<SearchResponse>("/api/v1/search", {
        token,
        method: "POST",
        body: {
          query_text: queryText,
          tenant_id: "bypass-mode",
        },
      });
      setResults(Array.isArray(data?.results) ? data.results : []);
    } catch (e) {
      setResults([]);
      setError(e instanceof Error ? e.message : "Unknown error");
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <section className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm sm:p-6">
      <div className="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div className="space-y-1">
          <div className="inline-flex items-center gap-2 text-sm font-semibold text-slate-900">
            <Search className="h-4 w-4 text-slate-700" aria-hidden="true" />
            Live Search
          </div>
          <p className="text-sm text-slate-500">
            Query the Intelligence Core (tenant:{" "}
            <span className="font-mono text-slate-700">bypass-mode</span>)
          </p>
        </div>
      </div>

      <div className="mt-4 flex flex-col gap-3 sm:flex-row">
        <div className="relative flex-1">
          <Search
            className="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-slate-400"
            aria-hidden="true"
          />
          <input
            value={queryText}
            onChange={(e) => setQueryText(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === "Enter") onSearch();
            }}
            placeholder="Ask: What happened in the 2024 community outreach report?"
            className={cn(
              "w-full rounded-xl border border-slate-200 bg-white px-10 py-3 text-sm text-slate-900",
              "placeholder:text-slate-400 shadow-sm",
              "focus:outline-none focus:ring-2 focus:ring-slate-300 focus:border-slate-300"
            )}
          />
        </div>

        <button
          type="button"
          onClick={onSearch}
          disabled={!canSearch || isLoading}
          className={cn(
            "inline-flex items-center justify-center gap-2 rounded-xl px-4 py-3 text-sm font-semibold",
            "border border-slate-200 bg-slate-900 text-white shadow-sm",
            "hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-60",
            "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-50"
          )}
        >
          {isLoading ? (
            <>
              <Loader2 className="h-4 w-4 animate-spin" aria-hidden="true" />
              Analyzingâ€¦
            </>
          ) : (
            <>
              <Search className="h-4 w-4" aria-hidden="true" />
              Analyze
            </>
          )}
        </button>
      </div>

      {error ? (
        <div className="mt-4 rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
          {error}
        </div>
      ) : null}

      <div className="mt-5 space-y-3">
        {results.length > 0 ? (
          <div className="grid gap-3">
            {results.map((r) => {
              const rawFilename = basename(r.payload?.filename);
              const { base: displayTitle, ext } = splitExtension(rawFilename);
              const fileMeta = fileTypePresentation(ext);

              const rawPreview =
                r.payload?.text_preview ??
                r.payload?.content ??
                "No preview available.";
              const isPreviewMissing = rawPreview === "No preview available.";
              const preview = isPreviewMissing ? "" : truncate(rawPreview, 200);

              const year = r.payload?.year;
              const pct = Number.isFinite(r.score)
                ? Math.round(r.score * 100)
                : 0;
              const Icon = fileMeta.icon;

              return (
                <div
                  key={r.id}
                  className={cn(
                    "rounded-xl border border-slate-200 bg-white p-4 shadow-sm",
                    isPreviewMissing && "bg-slate-50"
                  )}
                >
                  <div className="flex items-start justify-between gap-4">
                    <div className="min-w-0">
                      <div className="flex items-start gap-3">
                        <div className="mt-0.5 flex h-9 w-9 items-center justify-center rounded-lg border border-slate-200 bg-white">
                          <Icon
                            className={cn("h-4 w-4", fileMeta.iconClass)}
                            aria-hidden="true"
                          />
                        </div>

                        <div className="min-w-0 flex-1">
                          <div className="flex flex-wrap items-center gap-2">
                            <div className="truncate text-sm font-semibold text-slate-900">
                              {displayTitle || rawFilename}
                            </div>
                            <div
                              className={cn(
                                "inline-flex items-center rounded-full border px-2 py-0.5 text-[0.7rem] font-semibold",
                                fileMeta.chipClass
                              )}
                            >
                              {fileMeta.kindLabel}
                            </div>
                          </div>

                          {isPreviewMissing ? (
                            <div className="mt-1 text-xs text-slate-500">
                              Visual/metadata-only result
                            </div>
                          ) : (
                            <div className="mt-1 text-sm text-slate-600">
                              {preview}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>

                    <div className="flex flex-none flex-col items-end gap-2">
                      <div
                        className={cn(
                          "rounded-full border px-3 py-1 text-xs font-semibold",
                          relevanceBadgeClass(pct)
                        )}
                      >
                        Relevance: {pct}%
                      </div>
                      {typeof year === "number" ? (
                        <div className="text-xs text-slate-500">
                          Year:{" "}
                          <span className="font-mono text-slate-700">
                            {year}
                          </span>
                        </div>
                      ) : null}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        ) : (
          <div className="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-sm text-slate-500">
            {isLoading
              ? "Searchingâ€¦"
              : "Run a query to see matching documents, snippets, and scores."}
          </div>
        )}
      </div>
    </section>
  );
}




==================================================
FILE: next-frontend/src/components/KnowledgeBasket.tsx
==================================================
"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@clerk/nextjs";
import { FileText, FileType2, Table, Presentation, Image as ImageIcon, File, Loader2 } from "lucide-react";
import { cn } from "@app/lib/utils";
import { apiFetch } from "@app/lib/api";

type FileItem = {
  id: string;
  filename: string;
  type: string;
  year?: number | null;
};

function basename(path?: string) {
  if (!path) return "Unknown file";
  const parts = path.split(/[\\/]/).filter(Boolean);
  return parts[parts.length - 1] ?? path;
}

function splitExtension(filename: string): { base: string; ext: string } {
  const lastDot = filename.lastIndexOf(".");
  if (lastDot <= 0 || lastDot === filename.length - 1) {
    return { base: filename, ext: "" };
  }
  return {
    base: filename.slice(0, lastDot),
    ext: filename.slice(lastDot + 1).toLowerCase(),
  };
}

function getFileIcon(ext: string) {
  switch (ext) {
    case "pdf":
      return FileText;
    case "docx":
    case "doc":
      return FileType2;
    case "xlsx":
    case "csv":
      return Table;
    case "pptx":
    case "ppt":
      return Presentation;
    case "png":
    case "jpg":
    case "jpeg":
    case "webp":
      return ImageIcon;
    default:
      return File;
  }
}

function getFileTypeColor(ext: string) {
  switch (ext) {
    case "pdf":
      return "text-rose-700 bg-rose-100";
    case "docx":
    case "doc":
      return "text-blue-700 bg-blue-100";
    case "xlsx":
    case "csv":
      return "text-emerald-700 bg-emerald-100";
    case "pptx":
    case "ppt":
      return "text-orange-700 bg-orange-100";
    case "png":
    case "jpg":
    case "jpeg":
    case "webp":
      return "text-purple-700 bg-purple-100";
    default:
      return "text-slate-700 bg-slate-100";
  }
}

interface KnowledgeBasketProps {
  tenantId: string;
}

export function KnowledgeBasket({ tenantId }: KnowledgeBasketProps) {
  const { getToken } = useAuth();
  const [files, setFiles] = useState<FileItem[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchFiles() {
      setIsLoading(true);
      setError(null);

      try {
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication required");
        }

        const data = await apiFetch<{ files: FileItem[] }>(`/api/v1/files/${tenantId}`, {
          token,
          method: "GET",
        });
        setFiles(data.files || []);
      } catch (e) {
        setError(e instanceof Error ? e.message : "Failed to load files");
        setFiles([]);
      } finally {
        setIsLoading(false);
      }
    }

    fetchFiles();
  }, [tenantId, getToken]);

  return (
    <div className="h-full overflow-y-auto p-6">
      {/* Header */}
      <div className="mb-6">
        <h2 className="text-lg font-semibold text-slate-900">Knowledge Basket</h2>
        <p className="mt-1 text-sm text-slate-500">Campaign documents and resources</p>
      </div>

      {/* Loading State */}
      {isLoading && (
        <div className="flex items-center justify-center py-8">
          <Loader2 className="h-5 w-5 animate-spin text-slate-400" aria-hidden="true" />
        </div>
      )}

      {/* Error State */}
      {error && !isLoading && (
        <div className="rounded-lg border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
          {error}
        </div>
      )}

      {/* File List */}
      {!isLoading && !error && (
        <div className="space-y-2">
          {files.length === 0 ? (
            <div className="rounded-lg border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-center text-sm text-slate-500">
              No files found for this tenant.
            </div>
          ) : (
            files.map((file) => {
              const { base, ext } = splitExtension(basename(file.filename));
              const Icon = getFileIcon(ext);
              const iconColor = getFileTypeColor(ext);

              return (
                <div
                  key={file.id}
                  className="group flex items-center gap-3 rounded-lg border border-slate-200 bg-slate-50/50 p-3 transition-all hover:border-amber-200 hover:bg-amber-50/30"
                >
                  <div className={cn("flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg transition-colors", iconColor)}>
                    <Icon className="h-5 w-5" aria-hidden="true" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-slate-900 truncate">{base}</p>
                    <div className="flex items-center gap-2">
                      <p className="text-xs text-slate-500 uppercase">{ext || "file"}</p>
                      {file.year && (
                        <>
                          <span className="text-xs text-slate-400">â€¢</span>
                          <p className="text-xs text-slate-500">{file.year}</p>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      )}
    </div>
  );
}



==================================================
FILE: next-frontend/src/components/ChatInterface.tsx
==================================================
"use client";

import { useRef, useState, useEffect } from "react";
import { useAuth } from "@clerk/nextjs";
import { Loader2, Send, Zap, Brain } from "lucide-react";
import { TypewriterMarkdown } from "@app/components/TypewriterMarkdown";
import { cn } from "@app/lib/utils";
import { detectPersona } from "@app/lib/personas";
import { apiFetch } from "@app/lib/api";

type Message = {
  id: string;
  role: "user" | "assistant";
  content: string;
  sourcesCount?: number;
  modelUsed?: string;
};

type ChatMode = "fast" | "deep";

type ChatResponse = {
  response: string;
  model_used: string;
  sources_count: number;
};

interface ChatInterfaceProps {
  tenantId?: string;
}

export function ChatInterface({ tenantId = "rally" }: ChatInterfaceProps) {
  const { getToken } = useAuth();
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [mode, setMode] = useState<ChatMode>("fast");
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const chatContainerRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const canSend = input.trim().length > 0 && !isLoading;

  async function handleSend() {
    if (!canSend) return;

    const userMessage: Message = {
      id: `user-${Date.now()}`,
      role: "user",
      content: input.trim(),
    };

    setMessages((prev) => [...prev, userMessage]);
    setInput("");
    setIsLoading(true);

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }

      const data = await apiFetch<ChatResponse>("/api/v1/chat", {
        token,
        method: "POST",
        body: {
          query: userMessage.content,
          tenant_id: tenantId,
          mode: mode,
        },
      });

      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: "assistant",
        content: data.response,
        sourcesCount: data.sources_count,
        modelUsed: data.model_used,
      };

      setMessages((prev) => [...prev, assistantMessage]);
    } catch (e) {
      const errorMessage: Message = {
        id: `error-${Date.now()}`,
        role: "assistant",
        content: `Error: ${e instanceof Error ? e.message : "Unknown error occurred"}`,
      };
      setMessages((prev) => [...prev, errorMessage]);
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <section className="flex flex-col rounded-2xl border border-slate-200 bg-white shadow-sm">
      {/* Brain Toggle Header */}
      <div className="flex items-center justify-between border-b border-slate-200 bg-slate-50/50 px-5 py-3 sm:px-6">
        <div className="flex flex-col gap-1">
          <div className="flex items-center gap-2 text-sm font-semibold text-slate-900">
            <Brain className="h-4 w-4 text-slate-700" aria-hidden="true" />
            Strategic Chat
          </div>
          <p className="text-xs text-slate-500">
            Format: Clean, conversational, minimal headers.
          </p>
        </div>
        <div className="flex items-center gap-2">
          <button
            type="button"
            onClick={() => setMode("fast")}
            className={cn(
              "inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium transition-all",
              "border",
              mode === "fast"
                ? "border-slate-300 bg-white text-slate-900 shadow-sm"
                : "border-transparent bg-transparent text-slate-500 hover:text-slate-700"
            )}
          >
            <Zap className="h-3.5 w-3.5" aria-hidden="true" />
            Speed (Gemini 2.5 Flash)
          </button>
          <button
            type="button"
            onClick={() => setMode("deep")}
            className={cn(
              "inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium transition-all",
              "border",
              mode === "deep"
                ? "border-amber-400 bg-amber-400 text-slate-900 shadow-sm"
                : "border-transparent bg-transparent text-slate-500 hover:text-slate-700"
            )}
          >
            <Brain className="h-3.5 w-3.5" aria-hidden="true" />
            Deep Strategy (Gemini 2.5 Pro)
          </button>
        </div>
      </div>

      {/* Chat Window */}
      <div
        ref={chatContainerRef}
        className="flex h-[500px] flex-col overflow-y-auto px-4 py-4 sm:px-6"
      >
        {messages.length === 0 ? (
          <div className="flex h-full items-center justify-center">
            <div className="text-center">
              <p className="text-sm font-medium text-slate-900">
                Start a conversation with Riley
              </p>
              <p className="mt-1 text-xs text-slate-500">
                Ask questions about your client's documents and get strategic
                insights.
              </p>
            </div>
          </div>
        ) : (
          <div className="flex flex-col gap-4">
            {messages.map((msg, index) => {
              const isNewestMessage = index === messages.length - 1;
              const shouldAnimate = msg.role === "assistant" && isNewestMessage;

              // Detect persona in assistant messages
              const detectedPersona = msg.role === "assistant" ? detectPersona(msg.content) : null;

              return (
                <div
                  key={msg.id}
                  className={cn(
                    "flex w-full flex-col",
                    msg.role === "user" ? "items-end" : "items-start"
                  )}
                >
                  {/* Persona Detection Badge */}
                  {detectedPersona && (
                    <div className="mb-1.5 flex items-center gap-1.5 rounded-lg bg-amber-50 border border-amber-200 px-2.5 py-1 text-xs text-amber-800">
                      <span>ðŸŽ¯</span>
                      <span className="font-medium">Target Persona Identified:</span>
                      <span className="font-semibold">{detectedPersona}</span>
                    </div>
                  )}
                  <div
                    className={cn(
                      "max-w-[85%] rounded-2xl px-4 py-3 text-sm",
                      msg.role === "user"
                        ? "bg-slate-900 text-white"
                        : "border border-slate-100 bg-white text-slate-900"
                    )}
                  >
                    {msg.role === "user" ? (
                      <div className="whitespace-pre-wrap break-words">
                        {msg.content}
                      </div>
                    ) : (
                      <TypewriterMarkdown
                        content={msg.content}
                        shouldAnimate={shouldAnimate}
                      />
                    )}
                    {msg.role === "assistant" && msg.sourcesCount !== undefined && (
                      <div className="mt-2 flex items-center gap-1.5 border-t border-slate-100 pt-2 text-xs text-slate-500">
                        <span>ðŸ“š</span>
                        <span>Analyzed {msg.sourcesCount} document{msg.sourcesCount !== 1 ? "s" : ""}</span>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
            {isLoading && (
              <div className="flex justify-start">
                <div className="rounded-2xl border border-slate-200 bg-white px-4 py-3">
                  <div className="flex items-center gap-2 text-sm text-slate-500">
                    <Loader2 className="h-4 w-4 animate-spin" aria-hidden="true" />
                    <span>Riley is thinking...</span>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>
        )}
      </div>

      {/* Input Area */}
      <div className="border-t border-slate-200 bg-slate-50/50 p-4 sm:p-5">
        <div className="flex gap-3">
          <input
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                handleSend();
              }
            }}
            placeholder="Ask Riley about your documents..."
            className={cn(
              "flex-1 rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-900",
              "placeholder:text-slate-400 shadow-sm",
              "focus:outline-none focus:ring-2 focus:ring-slate-300 focus:border-slate-300"
            )}
          />
          <button
            type="button"
            onClick={handleSend}
            disabled={!canSend}
            className={cn(
              "inline-flex items-center justify-center gap-2 rounded-xl px-5 py-3 text-sm font-semibold",
              "border border-amber-400 bg-amber-400 text-slate-900 shadow-sm",
              "hover:bg-amber-500 disabled:cursor-not-allowed disabled:opacity-60",
              "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-50"
            )}
          >
            {isLoading ? (
              <Loader2 className="h-4 w-4 animate-spin" aria-hidden="true" />
            ) : (
              <>
                <Send className="h-4 w-4" aria-hidden="true" />
                Send
              </>
            )}
          </button>
        </div>
      </div>
    </section>
  );
}



==================================================
FILE: next-frontend/src/components/TypewriterMarkdown.tsx
==================================================
"use client";

import { useEffect, useState } from "react";
import ReactMarkdown from "react-markdown";

interface TypewriterMarkdownProps {
  content: string;
  onComplete?: () => void;
  shouldAnimate?: boolean;
}

export function TypewriterMarkdown({
  content,
  onComplete,
  shouldAnimate = true,
}: TypewriterMarkdownProps) {
  const [displayedText, setDisplayedText] = useState(shouldAnimate ? "" : content);
  const [isComplete, setIsComplete] = useState(!shouldAnimate);

  useEffect(() => {
    if (!shouldAnimate) {
      setDisplayedText(content);
      setIsComplete(true);
      return;
    }

    // Reset when content changes
    setDisplayedText("");
    setIsComplete(false);

    let currentIndex = 0;
    const charsPerChunk = 2; // Type 2-3 characters at a time for optimization
    const delayPerChunk = 12; // ~12ms per chunk = ~6ms per character

    const typeInterval = setInterval(() => {
      if (currentIndex >= content.length) {
        clearInterval(typeInterval);
        setIsComplete(true);
        onComplete?.();
        return;
      }

      const nextIndex = Math.min(currentIndex + charsPerChunk, content.length);
      setDisplayedText(content.slice(0, nextIndex));
      currentIndex = nextIndex;
    }, delayPerChunk);

    return () => {
      clearInterval(typeInterval);
    };
  }, [content, shouldAnimate, onComplete]);

  return (
    <div className="prose prose-sm max-w-none leading-loose prose-headings:mb-4 prose-headings:mt-6 prose-p:mb-6 prose-strong:text-slate-900 prose-ul:my-1 prose-li:mb-3 prose-li:leading-loose">
      <ReactMarkdown>{displayedText}</ReactMarkdown>
      {!isComplete && (
        <span className="inline-block w-0.5 h-4 bg-slate-400 ml-0.5 animate-pulse align-middle">
          |
        </span>
      )}
    </div>
  );
}



==================================================
FILE: next-frontend/src/components/chat/RileyStudio.tsx
==================================================
"use client";

import { useState, useRef, useEffect } from "react";
import { useAuth, useUser } from "@clerk/nextjs";
import { Send, Loader2, Sparkles, Zap, Brain, FileText, Pencil, Check, X, Search, MessageSquare, BarChart3 } from "lucide-react";
import ReactMarkdown from "react-markdown";
import remarkBreaks from "remark-breaks";
import { cn } from "@app/lib/utils";
import { TypewriterMarkdown } from "@app/components/ui/TypewriterMarkdown";
import { apiFetch } from "@app/lib/api";

type Message = {
  id: string;
  role: "user" | "assistant" | "system";
  content: string;
  sourcesCount?: number;
  status?: "thinking"; // For placeholder messages
};

type Conversation = {
  id: string;
  title: string;
  lastMessage: string;
  timestamp: Date;
};

interface RileyStudioProps {
  contextName: string;
  tenantId: string;
  mode?: "fast" | "deep";
}

export function RileyStudio({ contextName, tenantId, mode: initialMode = "fast" }: RileyStudioProps) {
  const { getToken, userId, isLoaded: authLoaded } = useAuth();
  const { user, isLoaded: userLoaded } = useUser();
  
  // Derive user display name: username ?? firstName ?? primaryEmail ?? "there"
  const userDisplayName = user?.username ?? user?.firstName ?? user?.primaryEmailAddress?.emailAddress ?? "there";
  
  // Check for missing requirements
  const missingAuth = !authLoaded || !userLoaded || !user;
  const missingTenantId = !tenantId;
  const [conversations, setConversations] = useState<Conversation[]>([]);
  const [activeConversationId, setActiveConversationId] = useState<string | null>(null);
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [mode, setMode] = useState<"fast" | "deep">(initialMode);
  const [renamingSessionId, setRenamingSessionId] = useState<string | null>(null);
  const [renameInput, setRenameInput] = useState("");
  const [isRenaming, setIsRenaming] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);
  const renameInputRef = useRef<HTMLInputElement>(null);
  
  // Check if this is Global Riley (Imperial Amber theme)
  const isGlobal = tenantId === "global";

  // Generate collision-proof, scope-aware session ID
  const createNewSessionId = (): string => {
    // Ensure tenantId is always included (either "global" or campaignId)
    const safeTenantId = tenantId || "global";
    // Use userId from Clerk, fallback to "anonymous" if not available
    const safeUserId = userId || "anonymous";
    // Generate timestamp
    const timestamp = Date.now();
    // Format: session_{tenantId}_{userId}_{timestamp}
    return `session_${safeTenantId}_${safeUserId}_${timestamp}`;
  };

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  // Auto-resize textarea
  useEffect(() => {
    if (inputRef.current) {
      inputRef.current.style.height = "auto";
      inputRef.current.style.height = `${Math.min(inputRef.current.scrollHeight, 200)}px`;
    }
  }, [input]);

  // Load chat history when conversation is selected
  useEffect(() => {
    if (!activeConversationId) {
      // Clear messages when no conversation is selected
      setMessages([]);
      return;
    }

    // Only load history if messages are empty or only contain system message
    // This prevents overwriting optimistic updates
    setMessages((prev) => {
      const hasUserOrAssistantMessages = prev.some(
        (msg) => msg.role === "user" || msg.role === "assistant"
      );
      // If we have user/assistant messages, don't load history (preserve optimistic updates)
      if (hasUserOrAssistantMessages) {
        return prev;
      }
      // Otherwise, clear and load history
      return [];
    });
    
    setIsLoading(true);

    async function loadHistory() {
      try {
        const token = await getToken();
        if (!token) {
          setIsLoading(false);
          return;
        }
        
        const history = await apiFetch<Array<{ role: string; content: string }>>(
          `/api/v1/chat/history/${activeConversationId}`,
          {
            token,
            method: "GET",
          }
        );
        
        // Guard: Only update if history exists and messages are still empty/only system
        setMessages((prev) => {
          const hasUserOrAssistantMessages = prev.some(
            (msg) => msg.role === "user" || msg.role === "assistant"
          );
          // Don't overwrite if user/assistant messages exist
          if (hasUserOrAssistantMessages) {
            return prev;
          }
          
          if (history && Array.isArray(history) && history.length > 0) {
            const historyMessages: Message[] = history.map(
              (msg: { role: string; content: string }, idx: number) => ({
                id: `history-${Date.now()}-${idx}`,
                role: msg.role === "user" ? "user" : "assistant",
                content: msg.content,
              })
            );
            return [
              {
                id: "system-1",
                role: "system",
                content: `Hi, I'm Riley. I have access to ${contextName}. How can I help you today?`,
              },
              ...historyMessages,
            ];
          } else {
            // Empty history - keep system message only if messages are still empty
            return prev.length === 0 || (prev.length === 1 && prev[0].role === "system")
              ? [
                  {
                    id: "system-1",
                    role: "system",
                    content: `Hi, I'm Riley. I have access to ${contextName}. How can I help you today?`,
                  },
                ]
              : prev;
          }
        });
      } catch (error) {
        console.error("Failed to load chat history:", error);
        // Guard: Only set system message if messages are still empty
        setMessages((prev) => {
          const hasUserOrAssistantMessages = prev.some(
            (msg) => msg.role === "user" || msg.role === "assistant"
          );
          if (hasUserOrAssistantMessages) {
            return prev;
          }
          return [
            {
              id: "system-1",
              role: "system",
              content: `Hi, I'm Riley. I have access to ${contextName}. How can I help you today?`,
            },
          ];
        });
      } finally {
        setIsLoading(false);
      }
    }

    loadHistory();
  }, [activeConversationId, contextName, getToken]);

  // Check if send is enabled and why it might be disabled
  const canSend = input.trim().length > 0 && !isLoading && !missingAuth && !missingTenantId;
  const sendDisabledReason = missingAuth 
    ? "Not authenticated" 
    : missingTenantId 
    ? "Tenant ID missing" 
    : input.trim().length === 0 
    ? "Enter a message" 
    : isLoading 
    ? "Sending..." 
    : null;

  const handleNewConversation = () => {
    // Generate collision-proof, scope-aware session ID
    const newId = createNewSessionId();
    setActiveConversationId(newId);
    setMessages([
      {
        id: "system-1",
        role: "system",
        content: `Hi, I'm Riley. I have access to ${contextName}. How can I help you today?`,
      },
    ]);
    setInput("");
  };

  const handleRenameStart = (e: React.MouseEvent, conv: Conversation) => {
    e.stopPropagation();
    setRenamingSessionId(conv.id);
    setRenameInput(conv.title);
    // Focus input after state update
    setTimeout(() => {
      renameInputRef.current?.focus();
      renameInputRef.current?.select();
    }, 0);
  };

  const handleRenameCancel = (e?: React.MouseEvent) => {
    if (e) e.stopPropagation();
    setRenamingSessionId(null);
    setRenameInput("");
  };

  const handleRenameSave = async (e: React.MouseEvent | React.KeyboardEvent, sessionId: string) => {
    e.stopPropagation();
    
    const newTitle = renameInput.trim();
    if (!newTitle || newTitle === conversations.find(c => c.id === sessionId)?.title) {
      handleRenameCancel();
      return;
    }

    setIsRenaming(true);
    try {
      const token = await getToken();
      if (!token) return;
      
      await apiFetch(`/api/v1/sessions/${sessionId}`, {
        token,
        method: "PATCH",
        body: { title: newTitle },
      });
      
      // Update the conversation in the list
      setConversations((prev) =>
        prev.map((conv) =>
          conv.id === sessionId ? { ...conv, title: newTitle } : conv
        )
      );
      handleRenameCancel();
    } catch (error) {
      console.error("Error renaming session:", error);
    } finally {
      setIsRenaming(false);
    }
  };

  const handleRenameKeyDown = (e: React.KeyboardEvent<HTMLInputElement>, sessionId: string) => {
    if (e.key === "Enter") {
      e.preventDefault();
      handleRenameSave(e, sessionId);
    } else if (e.key === "Escape") {
      e.preventDefault();
      handleRenameCancel();
    }
  };

  // Render content with interactive citation badges
  function renderContent(text: string): React.ReactNode {
    if (!text) return null;

    // Regex to match [[Source: Filename.pdf]] patterns
    const citationRegex = /(\[\[Source: .*?\]\])/g;
    const parts: Array<{ type: "text" | "citation"; content: string }> = [];
    let lastIndex = 0;
    let match;

    // Find all citation matches
    while ((match = citationRegex.exec(text)) !== null) {
      // Add text before the citation
      if (match.index > lastIndex) {
        parts.push({
          type: "text",
          content: text.substring(lastIndex, match.index),
        });
      }

      // Extract filename from citation (remove [[Source: ]] wrapper)
      const citationText = match[1];
      const filenameMatch = citationText.match(/\[\[Source: (.+?)\]\]/);
      const filename = filenameMatch ? filenameMatch[1] : citationText;

      parts.push({
        type: "citation",
        content: filename,
      });

      lastIndex = match.index + match[0].length;
    }

    // Add remaining text after last citation
    if (lastIndex < text.length) {
      parts.push({
        type: "text",
        content: text.substring(lastIndex),
      });
    }

    // If no citations found, return plain text
    if (parts.length === 0) {
      return <span>{text}</span>;
    }

    // Render parts with citation badges and markdown for text
    return (
      <>
        {parts.map((part, idx) => {
          if (part.type === "citation") {
            return (
              <button
                key={`citation-${idx}`}
                type="button"
                onClick={() => {
                  // For global chat, we might not have onViewAsset, so just show alert
                  alert(`Citation: ${part.content}\n\nNote: File viewing not available in global chat.`);
                }}
                className="inline-flex items-center gap-1.5 bg-zinc-800/50 border border-zinc-700/50 rounded-md px-2 py-0.5 text-[10px] transition-all mx-1 align-baseline cursor-pointer text-amber-500/90 hover:bg-amber-500/10 hover:border-amber-500/30 hover:text-amber-400"
              >
                <FileText className="h-2.5 w-2.5" />
                <span>{part.content}</span>
              </button>
            );
          }
          // Render text parts (markdown will be handled by parent container)
          return <span key={`text-${idx}`}>{part.content}</span>;
        })}
      </>
    );
  }

  const handleSend = async () => {
    if (!canSend) return;

    // Step 1: Ensure we have a session ID BEFORE any async operations
    // This prevents history loading from interfering with optimistic updates
    let sessionId = activeConversationId;
    if (!sessionId) {
      const newId = createNewSessionId();
      setActiveConversationId(newId);
      sessionId = newId;
    }

    // Step 2: Capture user input immediately
    const userInput = input.trim();
    const userMessage: Message = {
      id: `user-${Date.now()}`,
      role: "user",
      content: userInput,
    };

    // Step 3: Create thinking placeholder for assistant response (store ID for later replacement)
    const thinkingId = `thinking-${Date.now()}`;
    const thinkingMessage: Message = {
      id: thinkingId,
      role: "assistant",
      content: "",
      status: "thinking",
    };

    // Step 4: OPTIMISTIC UPDATE - Immediately append user message + thinking placeholder
    // This makes the message appear instantly in the UI BEFORE any await
    setMessages((prev) => {
      // If this is the first message (only system message exists), keep system + add user + thinking
      if (prev.length === 1 && prev[0].role === "system") {
        return [prev[0], userMessage, thinkingMessage];
      }
      // Otherwise, append to existing messages
      return [...prev, userMessage, thinkingMessage];
    });
    
    // Step 5: Clear input field immediately for better UX
    setInput("");

    // Step 6: Set loading state to show "Thinking" indicator
    setIsLoading(true);

    try {
      // Step 7: Get auth token
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication token not available");
      }

      // Step 8: Perform the API call
      const data = await apiFetch<{
        response: string;
        sources_count?: number;
      }>("/api/v1/chat", {
        token,
        method: "POST",
        body: {
          query: userInput,
          tenant_id: tenantId,
          mode: mode,
          session_id: sessionId,
          user_display_name: userDisplayName,
        },
      });

      // Step 9: Replace thinking placeholder with actual assistant response
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: "assistant",
        content: data.response,
        sourcesCount: data.sources_count,
      };

      // Replace thinking message with actual response
      setMessages((prev) => {
        return prev.map((msg) =>
          msg.id === thinkingId ? assistantMessage : msg
        );
      });

      // Step 10: Update conversation list if this is a new conversation
      if (sessionId && !conversations.find((c) => c.id === sessionId)) {
        setConversations((prev) => [
          {
            id: sessionId,
            title: userMessage.content.slice(0, 30) + (userMessage.content.length > 30 ? "..." : ""),
            lastMessage: userMessage.content,
            timestamp: new Date(),
          },
          ...prev,
        ]);
      }
    } catch (error) {
      // Log error to console for debugging
      console.error("Riley chat error:", error);
      
      // On error, replace thinking placeholder with error message
      const errorText = error instanceof Error 
        ? error.message 
        : "Unknown error occurred";
      
      // apiFetch throws errors with format "HTTP <status>: <detail>" or "Network/CORS failure"
      // Display the exact error message to help with debugging
      const errorMessage: Message = {
        id: `error-${Date.now()}`,
        role: "assistant",
        content: `Error: ${errorText}`,
      };
      // Replace thinking message with error message
      setMessages((prev) => {
        return prev.map((msg) =>
          msg.id === thinkingId ? errorMessage : msg
        );
      });
    } finally {
      // Step 11: Clear loading state (hides "Thinking" indicator)
      setIsLoading(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  const formatTime = (date: Date) => {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(hours / 24);

    if (days > 0) return `${days}d ago`;
    if (hours > 0) return `${hours}h ago`;
    return "Just now";
  };

  const promptStarters = [
    { text: "What are the key insights from recent research?", icon: Search, color: "text-cyan-400" },
    { text: "Help me refine the messaging strategy", icon: MessageSquare, color: "text-purple-400" },
    { text: "Analyze the current campaign performance", icon: BarChart3, color: "text-emerald-400" },
    { text: "Generate ideas for the next phase", icon: Zap, color: "text-orange-400" },
  ];

  const isEmpty = messages.length === 0 || (messages.length === 1 && messages[0].role === "system");

  return (
    <div 
      className={cn(
        "flex h-full text-white overflow-hidden",
        !isGlobal && "bg-slate-950/50 backdrop-blur-sm"
      )}
      style={isGlobal ? {
        background: "radial-gradient(ellipse at center, rgba(120, 53, 15, 0.2) 0%, rgb(2, 6, 23) 50%, rgb(2, 6, 23) 100%)"
      } : undefined}
    >
      {/* Left Sidebar - Chat History */}
      <aside className="w-64 bg-zinc-900/50 border-r border-zinc-800 flex flex-col shrink-0">
        {/* New Conversation Button */}
        <div className="p-4 border-b border-zinc-800">
          <button
            type="button"
            onClick={handleNewConversation}
            className={cn(
              "w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg transition-colors font-medium",
              isGlobal
                ? "bg-amber-500/10 border border-amber-500/20 text-amber-400 hover:bg-amber-500/20"
                : "bg-amber-500/10 border border-amber-500/20 text-amber-400 hover:bg-amber-500/20"
            )}
          >
            <Sparkles className="h-4 w-4" />
            <span>New Conversation</span>
          </button>
        </div>

        {/* Conversation List */}
        <div className="flex-1 overflow-y-auto p-2 space-y-1">
          {conversations.map((conv) => {
            const isActive = activeConversationId === conv.id;
            const isRenaming = renamingSessionId === conv.id;

            return (
              <div
                key={conv.id}
                className={cn(
                  "w-full rounded-lg transition-colors relative group",
                  isActive
                    ? "bg-zinc-800/50 border border-amber-500/30"
                    : "hover:bg-zinc-800/30 border border-transparent"
                )}
              >
                <div
                  role="button"
                  tabIndex={0}
                  onClick={() => {
                    setActiveConversationId(conv.id);
                  }}
                  onKeyDown={(e) => {
                    if (e.key === "Enter" || e.key === " ") {
                      e.preventDefault();
                      setActiveConversationId(conv.id);
                    }
                  }}
                  className="w-full text-left p-3 cursor-pointer"
                >
                  {isRenaming ? (
                    <div className="flex items-center gap-2">
                      <input
                        ref={renameInputRef}
                        type="text"
                        value={renameInput}
                        onChange={(e) => setRenameInput(e.target.value)}
                        onKeyDown={(e) => handleRenameKeyDown(e, conv.id)}
                        onClick={(e) => e.stopPropagation()}
                        className="flex-1 bg-zinc-900/50 border border-zinc-700 rounded px-2 py-1 text-sm text-zinc-100 focus:outline-none focus:ring-1 focus:ring-amber-500/50"
                        disabled={isRenaming}
                      />
                      <button
                        type="button"
                        onClick={(e) => handleRenameSave(e, conv.id)}
                        disabled={isRenaming}
                        className="p-1 rounded transition-colors text-amber-400 hover:bg-amber-500/10"
                      >
                        <Check className="h-4 w-4" />
                      </button>
                      <button
                        type="button"
                        onClick={(e) => handleRenameCancel(e)}
                        disabled={isRenaming}
                        className="p-1 rounded text-zinc-500 hover:bg-zinc-800/50 transition-colors"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>
                  ) : (
                    <>
                      <div className="flex items-start justify-between gap-2">
                        <div className="flex-1 min-w-0">
                          <div className="font-medium text-sm text-zinc-100 truncate">{conv.title}</div>
                          <div className="text-xs text-zinc-500 mt-1 truncate">{conv.lastMessage}</div>
                          <div className="text-xs text-zinc-600 mt-1">{formatTime(conv.timestamp)}</div>
                        </div>
                        {isActive && (
                          <button
                            type="button"
                            onClick={(e) => handleRenameStart(e, conv)}
                        className="opacity-0 group-hover:opacity-100 p-1.5 rounded transition-all text-amber-400 hover:bg-amber-500/10"
                            title="Rename conversation"
                          >
                            <Pencil className="h-3.5 w-3.5" />
                          </button>
                        )}
                      </div>
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </aside>

      {/* Main Area */}
      <main className="flex-1 flex flex-col min-w-0">
        {/* Header with Mode Toggle */}
        <header className="h-16 border-b border-zinc-800 flex items-center justify-between px-6 shrink-0">
          <div className="flex items-center gap-2">
            <Sparkles className={cn(
              "h-5 w-5",
              isGlobal ? "text-amber-400 drop-shadow-[0_0_15px_rgba(251,191,36,0.4)]" : "text-amber-400"
            )} />
            <h1 className="text-lg font-bold text-white">Riley</h1>
            <span className="text-zinc-600">|</span>
            <span className={cn(
              "text-sm font-medium",
              isGlobal ? "text-amber-400 drop-shadow-[0_0_10px_rgba(251,191,36,0.3)]" : "text-amber-500/90"
            )}>
              {isGlobal ? "Rally Global Brain" : contextName}
            </span>
          </div>
          <div className="flex items-center gap-2">
            <button
              type="button"
              onClick={() => setMode("fast")}
              className={cn(
                "flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm transition-colors",
                mode === "fast"
                  ? "bg-amber-500/10 border border-amber-500/20 text-amber-400"
                  : "bg-zinc-800/50 border border-zinc-700/50 text-zinc-500 hover:bg-zinc-800"
              )}
            >
              <Zap className="h-4 w-4" />
              <span>Fast</span>
            </button>
            <button
              type="button"
              onClick={() => setMode("deep")}
              className={cn(
                "flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm transition-colors",
                mode === "deep"
                  ? "bg-amber-500/10 border border-amber-500/20 text-amber-400"
                  : "bg-zinc-800/50 border border-zinc-700/50 text-zinc-500 hover:bg-zinc-800"
              )}
            >
              <Brain className="h-4 w-4" />
              <span>Deep</span>
            </button>
          </div>
        </header>

        {/* Message Area */}
        <div className="flex-1 overflow-y-auto">
          {isEmpty ? (
            /* Empty State */
            <div className="h-full flex flex-col items-center justify-center px-6 py-12">
              <div className="max-w-2xl w-full text-center">
                <div className="mb-8 flex justify-center">
                  <div className={cn(
                    "h-20 w-20 rounded-full border flex items-center justify-center",
                    "bg-amber-500/10 border-amber-500/20"
                  )}>
                    <Sparkles className={cn(
                      "h-10 w-10 text-amber-400",
                      isGlobal && "drop-shadow-[0_0_15px_rgba(251,191,36,0.4)]"
                    )} />
                  </div>
                </div>
                <h2 className="text-3xl font-bold text-white mb-2">
                  Hi, I'm Riley.
                </h2>
                <p className="text-zinc-400 mb-8">
                  I have access to <strong className={cn(
                    isGlobal ? "text-amber-400" : "text-amber-400"
                  )}>{isGlobal ? "Rally Global Brain" : contextName}</strong>. Ask me anything about strategy, messaging, or historical data.
                </p>

                {/* Prompt Starters */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {promptStarters.map((prompt, idx) => {
                    const Icon = prompt.icon;
                    return (
                      <button
                        key={idx}
                        type="button"
                        onClick={() => {
                          setInput(prompt.text);
                          inputRef.current?.focus();
                        }}
                        className={cn(
                          "p-6 md:p-8 text-left rounded-lg border transition-all duration-200 ease-out text-sm",
                          "bg-slate-900/50 border-white/5",
                          "hover:border-amber-500/30 hover:bg-amber-500/5 hover:scale-[1.02] hover:shadow-[0_0_20px_rgba(251,191,36,0.1)]"
                        )}
                      >
                        <div className="flex items-start gap-3">
                          <Icon className={cn("h-5 w-5 flex-shrink-0 mt-0.5", prompt.color)} />
                          <span className="text-zinc-300 font-medium">{prompt.text}</span>
                        </div>
                      </button>
                    );
                  })}
                </div>
              </div>
            </div>
          ) : (
            /* Message Stream */
            <div className="max-w-3xl mx-auto w-full px-6 py-8 space-y-6">
              {messages.map((message, index) => {
                const isLastMessage = index === messages.length - 1;
                const isLastAssistant = message.role === "assistant" && isLastMessage;

                return (
                  <div
                    key={message.id}
                    className={cn(
                      "flex gap-4",
                      message.role === "user" ? "justify-end" : "justify-start"
                    )}
                  >
                    {message.role !== "user" && (
                      <div className="flex-shrink-0 h-8 w-8 rounded-full border flex items-center justify-center bg-amber-500/10 border-amber-500/20">
                        <Sparkles className="h-4 w-4 text-amber-400" />
                      </div>
                    )}
                    <div
                      className={cn(
                        "rounded-lg px-4 py-3 max-w-[85%]",
                        message.role === "user"
                          ? "bg-amber-500/10 border border-amber-500/20 text-amber-100"
                          : message.role === "system"
                          ? "bg-zinc-800/50 border border-zinc-700/50 text-zinc-300 italic"
                          : isGlobal
                          ? "bg-zinc-900/50 border border-amber-500/10 text-zinc-100"
                          : "bg-zinc-900/50 border border-zinc-800/50 text-zinc-100"
                      )}
                    >
                      {message.status === "thinking" ? (
                        // Thinking placeholder
                        <div className="flex items-center gap-2 text-sm text-zinc-400">
                          <Loader2 className="h-4 w-4 animate-spin" />
                          <span>Riley is thinking...</span>
                        </div>
                      ) : isLastAssistant ? (
                        // Typewriter effect for last assistant message
                        <TypewriterMarkdown content={message.content} />
                      ) : message.role === "assistant" ? (
                        // Static markdown for previous assistant messages
                        <div className="riley-md">
                          <ReactMarkdown remarkPlugins={[remarkBreaks]}>
                            {message.content.replace(/<br\s*\/?>/gi, '\n\n')}
                          </ReactMarkdown>
                        </div>
                      ) : (
                        // User and system messages (plain text)
                        <div className="text-sm whitespace-pre-wrap">{message.content}</div>
                      )}
                      {message.role === "assistant" && message.sourcesCount !== undefined && (
                        <div className="mt-2 flex items-center gap-1.5 border-t border-zinc-800 pt-2 text-xs text-zinc-500">
                          <span>ðŸ“š</span>
                          <span>Analyzed {message.sourcesCount} document{message.sourcesCount !== 1 ? "s" : ""}</span>
                        </div>
                      )}
                    </div>
                    {message.role === "user" && (
                      <div className="flex-shrink-0 h-8 w-8 rounded-full bg-zinc-800 flex items-center justify-center text-xs font-medium text-zinc-300">
                        A
                      </div>
                    )}
                  </div>
                );
              })}

              {/* Thinking Indicator - Shows when isLoading is true */}
              {isLoading && (
                <div className="flex gap-4 justify-start">
                  <div className="flex-shrink-0 h-8 w-8 rounded-full border flex items-center justify-center bg-amber-500/10 border-amber-500/20">
                    <Sparkles className="h-4 w-4 text-amber-400" />
                  </div>
                  <div className="rounded-lg px-4 py-3 bg-zinc-900/50 border border-zinc-800/50">
                    <div className="flex items-center gap-2">
                    <Loader2 className="h-4 w-4 animate-spin text-zinc-400" />
                      <span className="text-sm text-zinc-400">Riley is thinking...</span>
                    </div>
                  </div>
                </div>
              )}

              <div ref={messagesEndRef} />
            </div>
          )}
        </div>

        {/* Input Area - Fixed Bottom */}
        <div className="flex-shrink-0 border-t border-zinc-800 p-4 bg-slate-950/50 backdrop-blur-sm">
          <div className="max-w-3xl mx-auto w-full">
            {sendDisabledReason && !isLoading && (
              <div className="mb-2 text-xs text-zinc-500 text-center">
                {sendDisabledReason}
              </div>
            )}
            <div className="flex items-end gap-3">
              <textarea
                ref={inputRef}
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Message Riley..."
                disabled={isLoading || missingAuth || missingTenantId}
                rows={1}
                className="flex-1 resize-none rounded-lg border border-zinc-800 bg-zinc-900/50 px-4 py-3 text-sm text-zinc-100 placeholder:text-zinc-600 focus:outline-none focus:ring-2 focus:ring-amber-500/50 disabled:opacity-50 disabled:cursor-not-allowed max-h-[200px]"
              />
              <button
                type="button"
                onClick={handleSend}
                disabled={!canSend}
                className={cn(
                  "flex-shrink-0 p-3 rounded-lg transition-colors",
                  canSend
                    ? "bg-amber-500/10 border border-amber-500/20 text-amber-400 hover:bg-amber-500/20"
                    : "bg-zinc-800/50 border border-zinc-700/50 text-zinc-600 cursor-not-allowed"
                )}
                aria-label="Send message"
                title={sendDisabledReason || "Send message"}
              >
                {isLoading ? (
                  <Loader2 className="h-5 w-5 animate-spin" />
                ) : (
                  <Send className="h-5 w-5" />
                )}
              </button>
            </div>
            <p className="text-xs text-zinc-600 mt-2 text-center">
              {mode === "fast" ? "âš¡ Fast mode: Quick responses" : "ðŸ§  Deep mode: Comprehensive analysis"}
            </p>
          </div>
        </div>
      </main>
    </div>
  );
}


==================================================
FILE: next-frontend/src/components/dashboard/CreateCampaignModal.tsx
==================================================
"use client";

import { useState } from "react";
import { useAuth } from "@clerk/nextjs";
import { X, Shield, CheckCircle } from "lucide-react";
import { cn } from "@app/lib/utils";
import { motion, AnimatePresence } from "framer-motion";
import { apiFetch } from "@app/lib/api";

interface CampaignBucket {
  name: string;
  role: string;
  lastActive: string;
  mentions: number;
  pendingRequests: number;
  userRole: "Lead" | "Member";
  themeColor: string;
  campaignId: string;
}

interface CreateCampaignModalProps {
  isOpen: boolean;
  onClose: () => void;
  onCampaignCreated: (campaign: CampaignBucket) => void;
}

// Theme colors for campaigns (rotating assignment)
const THEME_COLORS = [
  "#0f766e", // Teal
  "#4f46e5", // Indigo
  "#e11d48", // Rose
  "#059669", // Emerald
  "#7c3aed", // Violet
  "#facc15", // Amber
];

interface Member {
  id: string;
  email: string;
  role: string;
}

export function CreateCampaignModal({ isOpen, onClose, onCampaignCreated }: CreateCampaignModalProps) {
  const { getToken, userId } = useAuth();
  const [name, setName] = useState("");
  const [description, setDescription] = useState("");
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitError, setSubmitError] = useState<string | null>(null);
  
  // Member invitation state
  const [createdCampaignId, setCreatedCampaignId] = useState<string | null>(null);
  const [memberEmail, setMemberEmail] = useState("");
  const [memberRole, setMemberRole] = useState<"Member" | "Lead">("Member");
  const [members, setMembers] = useState<Member[]>([]);
  const [addMemberError, setAddMemberError] = useState<string | null>(null);
  const [addMemberSuccess, setAddMemberSuccess] = useState<string | null>(null);
  const [isAddingMember, setIsAddingMember] = useState(false);

  // Reset form when modal closes
  const handleClose = () => {
    if (!isSubmitting && !isAddingMember) {
      setName("");
      setDescription("");
      setSubmitError(null);
      setCreatedCampaignId(null);
      setMemberEmail("");
      setMemberRole("Member");
      setMembers([]);
      setAddMemberError(null);
      setAddMemberSuccess(null);
      onClose();
    }
  };

  const handleSubmit = async () => {
    if (!name.trim()) {
      setSubmitError("Campaign name is required");
      return;
    }

    setIsSubmitting(true);
    setSubmitError(null);

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("No authentication token available");
      }

      const createdCampaign = await apiFetch<{ id: string; name: string; description: string | null }>("/api/v1/campaigns", {
        token,
        method: "POST",
        body: {
          name: name.trim(),
          description: description.trim() || null,
        },
      });

      // Map backend response to frontend CampaignBucket shape
      // Use a deterministic index for theme color (consistent per campaign ID)
      const colorIndex = Math.abs(
        createdCampaign.id.split("").reduce((acc: number, char: string) => acc + char.charCodeAt(0), 0)
      ) % THEME_COLORS.length;
      const themeColor = THEME_COLORS[colorIndex];

      // Create frontend campaign object
      const frontendCampaign: CampaignBucket = {
        name: createdCampaign.name,
        role: "Lead Strategist", // Creator is always Lead
        lastActive: "Just now",
        mentions: 0,
        pendingRequests: 0,
        userRole: "Lead",
        themeColor,
        campaignId: createdCampaign.id,
      };

      // Call onCampaignCreated immediately (optimistic update)
      onCampaignCreated(frontendCampaign);

      // Store campaign ID and show invite section
      setCreatedCampaignId(createdCampaign.id);
      
      // Fetch initial members list (includes creator)
      try {
        const membersData = await apiFetch<{ members: Member[] }>(
          `/api/v1/campaigns/${createdCampaign.id}/members`,
          {
            token,
            method: "GET",
          }
        );
        setMembers(membersData.members || []);
      } catch (err) {
        // If fetching members fails, continue anyway - user can still add members
        console.error("Error fetching initial members:", err);
      }
      
      // Don't close modal yet - show invite section
      setIsSubmitting(false);
    } catch (err) {
      console.error("Error creating campaign:", err);
      // Preserve exact error message from apiFetch (includes status codes if available)
      const errorMessage = err instanceof Error 
        ? err.message 
        : "Failed to create campaign. Please try again.";
      setSubmitError(errorMessage);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleAddMember = async () => {
    if (!createdCampaignId || !memberEmail.trim()) {
      setAddMemberError("Email is required");
      return;
    }

    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(memberEmail.trim())) {
      setAddMemberError("Please enter a valid email address");
      return;
    }

    setIsAddingMember(true);
    setAddMemberError(null);
    setAddMemberSuccess(null);

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("No authentication token available");
      }

      const data = await apiFetch<{ members: Member[] }>(
        `/api/v1/campaigns/${createdCampaignId}/members`,
        {
          token,
          method: "POST",
          body: {
            email: memberEmail.trim(),
            role: memberRole,
          },
        }
      );
      
      // Update members list from response
      setMembers(data.members || []);
      setAddMemberSuccess(`${memberEmail.trim()} added successfully`);
      setMemberEmail("");
      setMemberRole("Member");
      
      // Clear success message after 3 seconds
      setTimeout(() => setAddMemberSuccess(null), 3000);
    } catch (err) {
      console.error("Error adding member:", err);
      
      // Handle specific error cases with user-friendly messages
      let errorMessage = "Failed to add member";
      if (err instanceof Error) {
        const message = err.message;
        // Check for 404 - User not found (from backend or HTTP status)
        if (message.includes("404") || 
            message.toLowerCase().includes("not found") || 
            message.toLowerCase().includes("user not found")) {
          errorMessage = "User not found â€” ask them to sign up first";
        }
        // Check for 403 - Only Lead can add members (from backend or HTTP status)
        else if (message.includes("403") || 
                 message.toLowerCase().includes("only lead") || 
                 message.toLowerCase().includes("only campaign leads") ||
                 message.toLowerCase().includes("permission") ||
                 message.toLowerCase().includes("access denied")) {
          errorMessage = "Only Lead members can add members";
        }
        // Use the exact error message from API (includes status codes from apiFetch)
        else {
          errorMessage = message;
        }
      }
      
      setAddMemberError(errorMessage);
    } finally {
      setIsAddingMember(false);
    }
  };

  const handleDone = () => {
    if (!createdCampaignId) return;

    // Campaign was already added to the list via onCampaignCreated in handleSubmit
    // Just close the modal and reset state
    setName("");
    setDescription("");
    setSubmitError(null);
    setCreatedCampaignId(null);
    setMemberEmail("");
    setMemberRole("Member");
    setMembers([]);
    setAddMemberError(null);
    setAddMemberSuccess(null);
    onClose();
  };

  if (!isOpen) return null;

  return (
    <AnimatePresence>
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
        {/* Backdrop */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="absolute inset-0 bg-black/60 backdrop-blur-sm"
          onClick={handleClose}
        />

        {/* Modal */}
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.95 }}
          transition={{ duration: 0.2 }}
          className="relative w-full max-w-2xl rounded-2xl border border-zinc-800 bg-zinc-900/95 backdrop-blur-xl shadow-2xl"
        >
          {/* Header */}
          <div className="flex items-center justify-between border-b border-zinc-800 px-6 py-4">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-400/10 border border-amber-400/20">
                <Shield className="h-5 w-5 text-amber-400" />
              </div>
              <div>
                <h2 className="text-lg font-semibold text-zinc-100">Create Campaign</h2>
                <p className="text-xs text-zinc-400">Start a new mission</p>
              </div>
            </div>
            <button
              type="button"
              onClick={handleClose}
              disabled={isSubmitting}
              className="rounded-lg p-1.5 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors disabled:opacity-50"
            >
              <X className="h-5 w-5" />
            </button>
          </div>

          {/* Content */}
          <div className="p-6">
            <div className="space-y-6">
              {submitError && (
                <div className="rounded-lg border border-red-500/50 bg-red-500/10 p-3">
                  <p className="text-sm text-red-400">{submitError}</p>
                </div>
              )}

              <div>
                <label className="block text-sm font-medium text-zinc-300 mb-2">
                  Campaign Name
                </label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="e.g., Clean Water Initiative 2025"
                  className="w-full rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-3 text-zinc-100 placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:border-amber-400/50"
                  disabled={isSubmitting}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-zinc-300 mb-2">
                  Description (Optional)
                </label>
                <textarea
                  value={description}
                  onChange={(e) => setDescription(e.target.value)}
                  placeholder="Brief description of the campaign..."
                  rows={3}
                  className="w-full rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-3 text-zinc-100 placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:border-amber-400/50 resize-none"
                  disabled={isSubmitting}
                />
              </div>

              {!createdCampaignId ? (
                <>
                  <div className="rounded-lg border border-amber-400/20 bg-amber-400/10 p-4">
                    <p className="text-sm text-amber-300">
                      You will be added as the Lead of this campaign. Team members can be added after creation.
                    </p>
                  </div>
                </>
              ) : (
                <>
                  {/* Success message for campaign creation */}
                  <div className="rounded-lg border border-emerald-500/50 bg-emerald-500/10 p-4">
                    <div className="flex items-center gap-2">
                      <CheckCircle className="h-5 w-5 text-emerald-400" />
                      <p className="text-sm text-emerald-300">
                        Campaign created successfully! Invite team members below.
                      </p>
                    </div>
                  </div>

                  {/* Invite Team Members Section */}
                  <div>
                    <label className="block text-sm font-medium text-zinc-300 mb-3">
                      Invite Team Members
                    </label>
                    
                    {addMemberError && (
                      <div className="mb-3 rounded-lg border border-red-500/50 bg-red-500/10 p-3">
                        <p className="text-sm text-red-400">{addMemberError}</p>
                      </div>
                    )}
                    
                    {addMemberSuccess && (
                      <div className="mb-3 rounded-lg border border-emerald-500/50 bg-emerald-500/10 p-3">
                        <div className="flex items-center gap-2">
                          <CheckCircle className="h-4 w-4 text-emerald-400" />
                          <p className="text-sm text-emerald-300">{addMemberSuccess}</p>
                        </div>
                      </div>
                    )}

                    <div className="flex gap-2 mb-4">
                      <input
                        type="email"
                        value={memberEmail}
                        onChange={(e) => setMemberEmail(e.target.value)}
                        placeholder="Enter email address"
                        className="flex-1 rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-2 text-zinc-100 placeholder:text-zinc-500 focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:border-amber-400/50"
                        disabled={isAddingMember}
                        onKeyDown={(e) => {
                          if (e.key === "Enter" && !isAddingMember) {
                            handleAddMember();
                          }
                        }}
                      />
                      <select
                        value={memberRole}
                        onChange={(e) => setMemberRole(e.target.value as "Member" | "Lead")}
                        className="rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-2 text-zinc-100 focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:border-amber-400/50"
                        disabled={isAddingMember}
                      >
                        <option value="Member">Member</option>
                        <option value="Lead">Lead</option>
                      </select>
                      <button
                        type="button"
                        onClick={handleAddMember}
                        disabled={isAddingMember || !memberEmail.trim()}
                        className={cn(
                          "rounded-lg bg-amber-400 px-4 py-2 text-sm font-semibold text-zinc-900 transition-colors whitespace-nowrap",
                          isAddingMember || !memberEmail.trim()
                            ? "opacity-50 cursor-not-allowed"
                            : "hover:bg-amber-500"
                        )}
                      >
                        {isAddingMember ? "Adding..." : "Add Member"}
                      </button>
                    </div>
                  </div>

                  {/* Team Members List */}
                  {members.length > 0 && (
                    <div>
                      <label className="block text-sm font-medium text-zinc-300 mb-3">
                        Team Members ({members.length})
                      </label>
                      <div className="space-y-2">
                        {members.map((member) => (
                          <div
                            key={member.id}
                            className="flex items-center justify-between rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-3"
                          >
                            <div className="flex items-center gap-3">
                              <div className="flex h-10 w-10 items-center justify-center rounded-full bg-zinc-700 text-sm font-medium text-zinc-100">
                                {member.email.charAt(0).toUpperCase()}
                              </div>
                              <div>
                                <p className="text-sm font-medium text-zinc-100">{member.email}</p>
                                <p className="text-xs text-zinc-400">{member.role}</p>
                              </div>
                            </div>
                            {member.role === "Lead" && (
                              <div className="flex items-center gap-1 rounded-full bg-amber-400/20 border border-amber-400/30 px-2 py-1">
                                <span className="text-xs font-medium text-amber-400">Lead</span>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>

          {/* Footer */}
          <div className="flex items-center justify-between border-t border-zinc-800 px-6 py-4">
            {!createdCampaignId ? (
              <>
                <button
                  type="button"
                  onClick={handleClose}
                  disabled={isSubmitting}
                  className="rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-2 text-sm font-medium text-zinc-300 hover:bg-zinc-800 transition-colors disabled:opacity-50"
                >
                  Cancel
                </button>
                <button
                  type="button"
                  onClick={handleSubmit}
                  disabled={isSubmitting || !name.trim()}
                  className={cn(
                    "rounded-lg bg-amber-400 px-4 py-2 text-sm font-semibold text-zinc-900 transition-colors",
                    isSubmitting || !name.trim()
                      ? "opacity-50 cursor-not-allowed"
                      : "hover:bg-amber-500"
                  )}
                >
                  {isSubmitting ? "Creating..." : "Create Campaign"}
                </button>
              </>
            ) : (
              <>
                <button
                  type="button"
                  onClick={handleClose}
                  disabled={isAddingMember}
                  className="rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-2 text-sm font-medium text-zinc-300 hover:bg-zinc-800 transition-colors disabled:opacity-50"
                >
                  Skip
                </button>
                <button
                  type="button"
                  onClick={handleDone}
                  disabled={isAddingMember}
                  className={cn(
                    "rounded-lg bg-amber-400 px-4 py-2 text-sm font-semibold text-zinc-900 transition-colors",
                    isAddingMember
                      ? "opacity-50 cursor-not-allowed"
                      : "hover:bg-amber-500"
                  )}
                >
                  Done
                </button>
              </>
            )}
          </div>
        </motion.div>
      </div>
    </AnimatePresence>
  );
}


==================================================
FILE: next-frontend/src/components/dashboard/CampaignDirectory.tsx
==================================================
"use client";

import { useState, useMemo, useEffect } from "react";
import { useAuth, useUser } from "@clerk/nextjs";
import { X, Users, Crown, Globe, ArrowRight, Search, Loader2 } from "lucide-react";
import { cn } from "@app/lib/utils";
import { motion, AnimatePresence } from "framer-motion";
import Link from "next/link";
import { GlobalDocsList } from "./GlobalDocsList";
import { CampaignBucketCard } from "@app/components/campaign/CampaignBucketCard";
import { Asset } from "@app/lib/types";
import { apiFetch } from "@app/lib/api";

// Backend campaign response shape
interface BackendCampaign {
  id: string;
  name: string;
  description: string | null;
  role: "Lead" | "Member";
}

interface CampaignsResponse {
  campaigns: BackendCampaign[];
}

interface UserCampaign {
  name: string;
  role: string;
  lastActive: string;
  mentions: number;
  pendingRequests?: number;
  userRole?: "Lead" | "Member";
  themeColor: string;
  campaignId: string;
}

// Theme colors for campaigns (rotating assignment)
const THEME_COLORS = [
  "#0f766e", // Teal
  "#4f46e5", // Indigo
  "#e11d48", // Rose
  "#059669", // Emerald
  "#7c3aed", // Violet
  "#facc15", // Amber
];

// Map backend campaign to frontend shape
function mapBackendToFrontend(
  backendCampaign: BackendCampaign,
  index: number
): UserCampaign {
  const roleDisplay =
    backendCampaign.role === "Lead"
      ? "Lead Strategist"
      : backendCampaign.role === "Member"
      ? "Team Member"
      : "Member";

  const themeColor = THEME_COLORS[index % THEME_COLORS.length];

  return {
    name: backendCampaign.name,
    role: roleDisplay,
    lastActive: "Recently active",
    mentions: 0,
    pendingRequests: 0,
    userRole: backendCampaign.role,
    themeColor,
    campaignId: backendCampaign.id,
  };
}

interface CampaignDirectoryProps {
  isOpen: boolean;
  onClose: () => void;
  userCampaigns?: UserCampaign[];
  archivedCampaigns?: UserCampaign[];
  onEnterCampaign?: (campaignId: string) => void;
  onRequestAccess?: (campaignId: string) => void;
  onRestore?: (campaignId: string) => void;
  onTerminate?: (campaignId: string) => Promise<void>;
  terminatingCampaignId?: string | null;
  onViewDocument?: (file: Asset) => void;
}

export function CampaignDirectory({
  isOpen,
  onClose,
  userCampaigns = [],
  archivedCampaigns = [],
  onEnterCampaign,
  onRequestAccess,
  onRestore,
  onTerminate,
  terminatingCampaignId = null,
  onViewDocument,
}: CampaignDirectoryProps) {
  const { user } = useUser();
  const { getToken, isLoaded } = useAuth();
  const [searchQuery, setSearchQuery] = useState("");
  const [activeTab, setActiveTab] = useState<"campaigns" | "archive" | "documents">("campaigns");
  
  // State for fetched campaigns
  const [campaigns, setCampaigns] = useState<UserCampaign[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Fetch campaigns from API
  useEffect(() => {
    async function fetchCampaigns() {
      if (!isOpen || !isLoaded) {
        return;
      }

      const userId = user?.id;
      if (!userId) {
        setIsLoading(false);
        setError(null);
        setCampaigns([]);
        return;
      }

      try {
        setIsLoading(true);
        setError(null);

        const token = await getToken();
        if (!token) {
          throw new Error("No authentication token available");
        }

        const data: CampaignsResponse = await apiFetch("/api/v1/campaigns", {
          token,
          method: "GET",
        });
        
        const mappedCampaigns = data.campaigns.map((campaign, index) =>
          mapBackendToFrontend(campaign, index)
        );
        setCampaigns(mappedCampaigns);
      } catch (err) {
        console.error("Error fetching campaigns:", err);
        const errorMessage = err instanceof Error 
          ? err.message 
          : "Unable to load campaigns. Please refresh.";
        setError(errorMessage);
        setCampaigns([]);
      } finally {
        setIsLoading(false);
      }
    }

    fetchCampaigns();
  }, [isOpen, isLoaded, user?.id, getToken]);

  // Filter campaigns by search query
  const filteredCampaigns = useMemo(() => {
    if (!searchQuery.trim()) return campaigns;
    
    const query = searchQuery.toLowerCase();
    return campaigns.filter(
      (campaign) =>
        campaign.name.toLowerCase().includes(query) ||
        campaign.role.toLowerCase().includes(query)
    );
  }, [campaigns, searchQuery]);

  const handleEnterCampaign = (campaignId: string) => {
    if (onEnterCampaign) {
      onEnterCampaign(campaignId);
    }
  };

  if (!isOpen) return null;

  return (
    <AnimatePresence>
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
        {/* Backdrop */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="absolute inset-0 bg-black/60 backdrop-blur-sm"
          onClick={onClose}
        />

        {/* Directory Panel */}
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.95 }}
          transition={{ duration: 0.2 }}
          className="relative w-full max-w-6xl max-h-[90vh] rounded-2xl border border-zinc-800 bg-zinc-900/95 backdrop-blur-xl shadow-2xl flex flex-col"
        >
          {/* Header */}
          <div className="flex items-center justify-between border-b border-zinc-800 px-6 py-4">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-400/10 border border-blue-400/20">
                <Globe className="h-5 w-5 text-blue-400" />
              </div>
              <div>
                <h2 className="text-lg font-semibold text-zinc-100">Firm Directory</h2>
                <p className="text-xs text-zinc-400">
                  {activeTab === "campaigns"
                    ? isLoading 
                      ? "Loading campaigns..."
                      : error
                      ? "Error loading campaigns"
                      : `${filteredCampaigns.length} campaign${filteredCampaigns.length !== 1 ? "s" : ""} available`
                    : activeTab === "archive"
                    ? `${archivedCampaigns.length} archived campaign${archivedCampaigns.length !== 1 ? "s" : ""}`
                    : "Global firm archive"}
                </p>
              </div>
            </div>
            <button
              type="button"
              onClick={onClose}
              className="rounded-lg p-1.5 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors"
            >
              <X className="h-5 w-5" />
            </button>
          </div>

          {/* Tab Switcher */}
          <div className="flex items-center gap-2 border-b border-zinc-800 px-6">
            <button
              type="button"
              onClick={() => setActiveTab("campaigns")}
              className={cn(
                "px-4 py-3 text-sm font-medium transition-colors border-b-2",
                activeTab === "campaigns"
                  ? "text-amber-400 border-amber-400"
                  : "text-zinc-400 border-transparent hover:text-zinc-300"
              )}
            >
              Active Campaigns
            </button>
            <button
              type="button"
              onClick={() => setActiveTab("archive")}
              className={cn(
                "px-4 py-3 text-sm font-medium transition-colors border-b-2",
                activeTab === "archive"
                  ? "text-amber-400 border-amber-400"
                  : "text-zinc-400 border-transparent hover:text-zinc-300"
              )}
            >
              Firm Archive
            </button>
            <button
              type="button"
              onClick={() => setActiveTab("documents")}
              className={cn(
                "px-4 py-3 text-sm font-medium transition-colors border-b-2",
                activeTab === "documents"
                  ? "text-amber-400 border-amber-400"
                  : "text-zinc-400 border-transparent hover:text-zinc-300"
              )}
            >
              Firm Documents
            </button>
          </div>

          {/* Content - Conditional Rendering */}
          {activeTab === "campaigns" ? (
            <>
              {/* Search Bar */}
              <div className="px-6 py-4 border-b border-zinc-800">
                <div className="flex items-center gap-2 rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-3">
                  <Search className="h-4 w-4 text-zinc-500" />
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="Search campaigns..."
                    className="flex-1 bg-transparent text-zinc-100 placeholder:text-zinc-500 focus:outline-none"
                  />
                </div>
              </div>

              {/* Content - Scrollable Grid */}
              <div className="flex-1 overflow-y-auto p-6">
                {/* Loading State */}
                {isLoading && (
                  <div className="flex flex-col items-center justify-center py-12">
                    <Loader2 className="h-8 w-8 text-amber-400 animate-spin mb-4" />
                    <p className="text-sm text-zinc-400">Loading campaigns...</p>
                  </div>
                )}

                {/* Error State */}
                {!isLoading && error && (
                  <div className="flex flex-col items-center justify-center py-12 text-center">
                    <div className="rounded-lg border border-red-500/50 bg-red-500/10 p-6 max-w-md">
                      <p className="text-red-400 font-medium mb-4">{error}</p>
                      <button
                        onClick={() => window.location.reload()}
                        className="rounded-lg bg-amber-400 px-4 py-2 text-sm font-semibold text-zinc-900 hover:bg-amber-500 transition-colors"
                      >
                        Refresh Page
                      </button>
                    </div>
                  </div>
                )}

                {/* Empty State */}
                {!isLoading && !error && filteredCampaigns.length === 0 && (
                  <div className="flex flex-col items-center justify-center py-12 text-center">
                    <p className="text-sm text-zinc-400">
                      {searchQuery 
                        ? "No campaigns match your search." 
                        : "No campaigns available."}
                    </p>
                  </div>
                )}

                {/* Success State - Campaign Cards */}
                {!isLoading && !error && filteredCampaigns.length > 0 && (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredCampaigns.map((campaign) => (
                      <CampaignBucketCard
                        key={campaign.campaignId}
                        name={campaign.name}
                        role={campaign.role}
                        lastActive={campaign.lastActive}
                        mentions={campaign.mentions}
                        pendingRequests={campaign.pendingRequests}
                        userRole={campaign.userRole}
                        themeColor={campaign.themeColor}
                        campaignId={campaign.campaignId}
                        isArchived={false}
                        onArchive={undefined}
                        onRestore={undefined}
                        onTerminate={onTerminate}
                        isTerminating={terminatingCampaignId === campaign.campaignId}
                      />
                    ))}
                  </div>
                )}
              </div>
            </>
          ) : activeTab === "archive" ? (
            <>
              {/* Search Bar for Archive */}
              <div className="px-6 py-4 border-b border-zinc-800">
                <div className="flex items-center gap-2 rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-3">
                  <Search className="h-4 w-4 text-zinc-500" />
                  <input
                    type="text"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    placeholder="Search archived campaigns..."
                    className="flex-1 bg-transparent text-zinc-100 placeholder:text-zinc-500 focus:outline-none"
                  />
                </div>
              </div>

              {/* Archived Campaigns Grid */}
              <div className="flex-1 overflow-y-auto p-6">
                {archivedCampaigns.length === 0 ? (
                  <div className="flex flex-col items-center justify-center py-12 text-center">
                    <p className="text-sm text-zinc-400">
                      {searchQuery ? "No archived campaigns match your search." : "No archived campaigns."}
                    </p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {archivedCampaigns
                      .filter((campaign) =>
                        campaign.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        campaign.role.toLowerCase().includes(searchQuery.toLowerCase())
                      )
                      .map((campaign) => (
                        <CampaignBucketCard
                          key={campaign.campaignId}
                          name={campaign.name}
                          role={campaign.role}
                          lastActive={campaign.lastActive}
                          mentions={campaign.mentions}
                          pendingRequests={campaign.pendingRequests}
                          userRole={campaign.userRole}
                          themeColor={campaign.themeColor}
                          campaignId={campaign.campaignId}
                          isArchived={true}
                          onArchive={undefined}
                          onRestore={onRestore}
                          onTerminate={onTerminate}
                          isTerminating={terminatingCampaignId === campaign.campaignId}
                        />
                      ))}
                  </div>
                )}
              </div>
            </>
          ) : (
            <GlobalDocsList onViewDocument={onViewDocument} />
          )}
        </motion.div>
      </div>
    </AnimatePresence>
  );
}


==================================================
FILE: next-frontend/src/components/dashboard/OpsDock.tsx
==================================================
"use client";

import { Plus, Globe, Sparkles } from "lucide-react";
import Link from "next/link";
import { cn } from "@app/lib/utils";

interface OpsDockProps {
  onInitialize: () => void;
  onDirectory: () => void;
}

export function OpsDock({ onInitialize, onDirectory }: OpsDockProps) {
  return (
    <div className="fixed left-6 top-1/2 -translate-y-1/2 z-40">
      <div className="flex flex-col gap-3 rounded-2xl border border-zinc-800 bg-zinc-950/60 backdrop-blur-xl p-3 shadow-2xl">
        {/* Initialize Button */}
        <button
          type="button"
          onClick={onInitialize}
          className={cn(
            "group relative flex h-12 w-12 items-center justify-center",
            "rounded-xl border border-zinc-800 bg-zinc-900/40",
            "text-zinc-300 transition-all duration-200",
            "hover:border-amber-400/50 hover:bg-amber-400/10 hover:text-amber-400",
            "focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:ring-offset-2 focus:ring-offset-zinc-950"
          )}
          aria-label="New Mission"
        >
          <Plus className="h-5 w-5" />
          {/* Tooltip */}
          <div className="absolute left-full ml-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
            <div className="rounded-lg border border-zinc-800 bg-zinc-900/95 backdrop-blur-sm px-3 py-1.5 text-xs font-medium text-zinc-100 whitespace-nowrap shadow-lg">
              New Mission
            </div>
          </div>
        </button>

        {/* Directory Button */}
        <button
          type="button"
          onClick={onDirectory}
          className={cn(
            "group relative flex h-12 w-12 items-center justify-center",
            "rounded-xl border border-zinc-800 bg-zinc-900/40",
            "text-zinc-300 transition-all duration-200",
            "hover:border-blue-400/50 hover:bg-blue-400/10 hover:text-blue-400",
            "focus:outline-none focus:ring-2 focus:ring-blue-400/50 focus:ring-offset-2 focus:ring-offset-zinc-950"
          )}
          aria-label="Firm Knowledge Base"
        >
          <Globe className="h-5 w-5" />
          {/* Tooltip */}
          <div className="absolute left-full ml-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
            <div className="rounded-lg border border-zinc-800 bg-zinc-900/95 backdrop-blur-sm px-3 py-1.5 text-xs font-medium text-zinc-100 whitespace-nowrap shadow-lg">
              Firm Knowledge Base
            </div>
          </div>
        </button>

        {/* Riley AI Button */}
        <Link
          href="/riley"
          className={cn(
            "group relative flex h-12 w-12 items-center justify-center",
            "rounded-xl border border-zinc-800 bg-zinc-900/40",
            "text-zinc-300 transition-all duration-200",
            "hover:border-amber-400/50 hover:bg-amber-400/10 hover:text-amber-400",
            "focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:ring-offset-2 focus:ring-offset-zinc-950"
          )}
          aria-label="Talk to Global HQ"
        >
          <Sparkles className="h-5 w-5" />
          {/* Tooltip */}
          <div className="absolute left-full ml-3 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
            <div className="rounded-lg border border-zinc-800 bg-zinc-900/95 backdrop-blur-sm px-3 py-1.5 text-xs font-medium text-zinc-100 whitespace-nowrap shadow-lg">
              Talk to Global HQ
            </div>
          </div>
        </Link>
      </div>
    </div>
  );
}



==================================================
FILE: next-frontend/src/components/dashboard/GlobalDocsList.tsx
==================================================
"use client";

import { useState, useEffect, useMemo } from "react";
import { useAuth } from "@clerk/nextjs";
import { FileText, FileType2, Table, Presentation, Image as ImageIcon, Search, Eye, Trophy } from "lucide-react";
import { cn } from "@app/lib/utils";
import { DocumentViewer } from "@app/components/ui/DocumentViewer";
import { Asset, AssetTag } from "@app/lib/types";
import { apiFetch } from "@app/lib/api";

interface GlobalFile {
  id: string;
  name: string;
  url: string;
  type: string;
  date: string;
  size: string;
  tags: string[];
  is_golden?: boolean;
  client_id?: string; // Original campaign ID
}

function getFileIcon(type: string) {
  const ext = type.toLowerCase();
  switch (ext) {
    case "pdf":
      return { icon: FileText, color: "text-red-500" };
    case "docx":
    case "doc":
      return { icon: FileType2, color: "text-blue-500" };
    case "xlsx":
    case "xls":
    case "csv":
      return { icon: Table, color: "text-emerald-500" };
    case "pptx":
    case "ppt":
      return { icon: Presentation, color: "text-orange-500" };
    case "img":
    case "png":
    case "jpg":
    case "jpeg":
    case "webp":
      return { icon: ImageIcon, color: "text-purple-500" };
    default:
      return { icon: FileText, color: "text-zinc-500" };
  }
}

// Helper to format campaign name from ID
function formatCampaignName(campaignId: string | undefined): string {
  if (!campaignId) return "Unknown Campaign";
  return campaignId
    .split("-")
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(" ");
}

interface GlobalDocsListProps {
  onViewDocument?: (file: Asset) => void;
}

export function GlobalDocsList({ onViewDocument }: GlobalDocsListProps) {
  const { getToken } = useAuth();
  const [files, setFiles] = useState<GlobalFile[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedFile, setSelectedFile] = useState<Asset | null>(null);

  // Fetch global files
  useEffect(() => {
    const fetchGlobalFiles = async () => {
      try {
        const token = await getToken();
        if (!token) {
          throw new Error("Authentication token not available");
        }

        const data = await apiFetch<{ files: GlobalFile[] }>(
          `/api/v1/list?tenant_id=global`,
          {
            token,
            method: "GET",
          }
        );
        setFiles(data.files || []);
      } catch (error) {
        console.error("Error fetching global files:", error);
        setFiles([]);
      } finally {
        setIsLoading(false);
      }
    };

    fetchGlobalFiles();
  }, [getToken]);

  // Filter files by search query
  const filteredFiles = useMemo(() => {
    if (!searchQuery.trim()) return files;
    const query = searchQuery.toLowerCase();
    return files.filter((file) =>
      file.name.toLowerCase().includes(query)
    );
  }, [files, searchQuery]);

  // Convert string[] tags to AssetTag[]
  const convertTags = (tags: string[]): AssetTag[] => {
    const validTags: AssetTag[] = ["Messaging", "Research", "Strategy", "Media", "Pitch", "Other"];
    return tags
      .filter((tag): tag is AssetTag => validTags.includes(tag as AssetTag))
      .map((tag) => tag as AssetTag);
  };

  // Convert GlobalFile to Asset for DocumentViewer
  const convertToAsset = (file: GlobalFile): Asset => {
    return {
      id: file.id,
      name: file.name,
      type: file.type as Asset["type"],
      url: file.url,
      tags: convertTags(file.tags),
      uploadDate: file.date.split("T")[0],
      uploader: "Firm Archive",
      size: file.size,
      urgency: "medium",
      assignedTo: [],
      comments: 0,
      status: "approved",
      aiEnabled: file.type === "pdf" || file.type === "docx",
    };
  };

  const handleView = (file: GlobalFile) => {
    const asset = convertToAsset(file);
    if (onViewDocument) {
      onViewDocument(asset);
    } else {
      setSelectedFile(asset);
    }
  };

  if (isLoading) {
    return (
      <div className="flex items-center justify-center py-12">
        <p className="text-sm text-zinc-500">Loading firm archive...</p>
      </div>
    );
  }

  return (
    <>
      {/* Search Bar */}
      <div className="px-6 py-4 border-b border-zinc-800">
        <div className="flex items-center gap-2 rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-3">
          <Search className="h-4 w-4 text-zinc-500" />
          <input
            type="text"
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search documents..."
            className="flex-1 bg-transparent text-zinc-100 placeholder:text-zinc-500 focus:outline-none"
          />
        </div>
      </div>

      {/* Files Table */}
      <div className="flex-1 overflow-y-auto">
        {filteredFiles.length === 0 ? (
          <div className="flex flex-col items-center justify-center py-12 text-center">
            <p className="text-sm text-zinc-400">
              {searchQuery ? "No documents match your search." : "No documents in the firm archive yet."}
            </p>
          </div>
        ) : (
          <div className="p-6">
            <table className="w-full">
              <thead>
                <tr className="border-b border-zinc-800">
                  <th className="px-4 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">
                    File
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">
                    Status
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">
                    Origin
                  </th>
                  <th className="px-4 py-3 text-right text-xs font-medium text-zinc-400 uppercase tracking-wider">
                    Action
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-zinc-800">
                {filteredFiles.map((file) => {
                  const { icon: FileIcon, color: iconColor } = getFileIcon(file.type);
                  return (
                    <tr
                      key={file.id}
                      className="hover:bg-zinc-900/50 transition-colors"
                    >
                      {/* Icon & Name */}
                      <td className="px-4 py-4">
                        <div className="flex items-center gap-3">
                          <FileIcon className={cn("h-5 w-5 flex-shrink-0", iconColor)} />
                          <span className="text-sm font-medium text-zinc-100 truncate max-w-md">
                            {file.name}
                          </span>
                        </div>
                      </td>

                      {/* Badges */}
                      <td className="px-4 py-4">
                        <div className="flex items-center gap-2">
                          {file.is_golden && (
                            <span className="inline-flex items-center gap-1 rounded-full bg-amber-500/10 border border-amber-500/30 px-2 py-1 text-xs font-semibold text-amber-400">
                              <Trophy className="h-3 w-3" />
                              Golden Standard
                            </span>
                          )}
                        </div>
                      </td>

                      {/* Origin Campaign */}
                      <td className="px-4 py-4">
                        <span className="text-sm text-zinc-400">
                          {formatCampaignName(file.client_id)}
                        </span>
                      </td>

                      {/* Action */}
                      <td className="px-4 py-4 text-right">
                        <button
                          type="button"
                          onClick={() => handleView(file)}
                          className="inline-flex items-center gap-2 rounded-lg border border-zinc-700 bg-zinc-800/50 px-3 py-1.5 text-sm font-medium text-zinc-300 hover:border-amber-400/50 hover:bg-amber-400/10 hover:text-amber-400 transition-colors"
                        >
                          <Eye className="h-4 w-4" />
                          View
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Document Viewer */}
      {selectedFile && !onViewDocument && (
        <DocumentViewer
          file={selectedFile}
          onClose={() => setSelectedFile(null)}
          variant="modal"
        />
      )}
    </>
  );
}


==================================================
FILE: next-frontend/src/components/layout/GridBackground.tsx
==================================================
"use client";

import React, { useState, useEffect, useMemo } from "react";
import { usePathname } from "next/navigation";
import { useSpring, useMotionValue } from "framer-motion";
import { motion } from "framer-motion";

/**
 * GridBackground - Tron Legacy Grid with Reactive Particle Swarm
 * 
 * Features:
 * - Sharp, high-contrast Tron-style SVG grid with glow
 * - Swarm of 60-80 reactive particles that respond to mouse
 * - Parallax physics for 3D depth effect
 * - Hardware-accelerated animations
 * - Particles only visible on home page
 */
interface Particle {
  id: number;
  initialX: number;
  initialY: number;
  size: number;
  color: "cyan" | "amber";
  pulseDuration: number;
  strength: number; // Parallax strength (0.1 to 0.5)
}

export function GridBackground() {
  const pathname = usePathname();
  const isHomePage = pathname === "/";
  const [isMounted, setIsMounted] = useState(false);

  // Prevent hydration mismatch - only render dynamic content after mount
  useEffect(() => {
    setIsMounted(true);
  }, []);

  // Mouse position tracking
  const mouseX = useMotionValue(50);
  const mouseY = useMotionValue(50);

  // Spring physics for smooth mouse following
  const springX = useSpring(mouseX, { damping: 30, stiffness: 100 });
  const springY = useSpring(mouseY, { damping: 30, stiffness: 100 });

  // Track mouse position
  useEffect(() => {
    if (!isHomePage) return;

    const handleMouseMove = (e: MouseEvent) => {
      // Normalize to percentage (0-100)
      const normalizedX = (e.clientX / window.innerWidth) * 100;
      const normalizedY = (e.clientY / window.innerHeight) * 100;
      
      mouseX.set(normalizedX);
      mouseY.set(normalizedY);
    };

    window.addEventListener("mousemove", handleMouseMove, { passive: true });
    return () => {
      window.removeEventListener("mousemove", handleMouseMove);
    };
  }, [isHomePage, mouseX, mouseY]);

  // Generate particle swarm (60-80 particles)
  const particles = useMemo<Particle[]>(() => {
    if (!isHomePage) return [];
    
    const count = 70; // Number of particles
    const particlesArray: Particle[] = [];
    
    for (let i = 0; i < count; i++) {
      particlesArray.push({
        id: i,
        initialX: Math.random() * 100, // 0-100%
        initialY: Math.random() * 100, // 0-100%
        size: 2 + Math.random() * 2, // 2-4px
        color: Math.random() < 0.8 ? "cyan" : "amber", // 80% cyan, 20% amber
        pulseDuration: 2 + Math.random() * 3, // 2-5 seconds
        strength: 0.1 + Math.random() * 0.4, // 0.1 to 0.5 parallax strength
      });
    }
    
    return particlesArray;
  }, [isHomePage]);

  // Return simple background during SSR to prevent hydration mismatch
  if (!isMounted) {
    return (
      <div
        className="fixed inset-0 w-full h-full pointer-events-none bg-[#020617]"
        style={{ zIndex: -1 }}
      />
    );
  }

  return (
    <div
      className="fixed inset-0 w-full h-full pointer-events-none"
      style={{ zIndex: -1 }}
    >
      {/* Tron Legacy Grid - Sharp, High-Contrast */}
      <svg
        className="absolute inset-0 w-full h-full"
        xmlns="http://www.w3.org/2000/svg"
      >
        <defs>
          {/* Glow filter for grid lines */}
          <filter id="grid-glow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="0.5" result="coloredBlur" />
            <feMerge>
              <feMergeNode in="coloredBlur" />
              <feMergeNode in="SourceGraphic" />
            </feMerge>
          </filter>
          
          {/* Grid pattern */}
          <pattern
            id="tron-grid-pattern"
            x="0"
            y="0"
            width="60"
            height="60"
            patternUnits="userSpaceOnUse"
          >
            <path
              d="M 60 0 L 0 0 0 60"
              fill="none"
              stroke="rgba(56, 189, 248, 0.1)"
              strokeWidth="0.5"
              filter="url(#grid-glow)"
            />
          </pattern>
          
          {/* Secondary blurred layer for depth */}
          <pattern
            id="tron-grid-blur"
            x="0"
            y="0"
            width="60"
            height="60"
            patternUnits="userSpaceOnUse"
          >
            <path
              d="M 60 0 L 0 0 0 60"
              fill="none"
              stroke="rgba(56, 189, 248, 0.1)"
              strokeWidth="1"
            />
          </pattern>
        </defs>
        
        {/* Main grid layer */}
        <rect width="100%" height="100%" fill="url(#tron-grid-pattern)" />
        
        {/* Blurred depth layer */}
        <rect width="100%" height="100%" fill="url(#tron-grid-blur)" opacity="0.5" />
      </svg>

      {/* Reactive Particle Swarm (Home Page Only) */}
      {isHomePage && particles.map((particle) => (
        <ParticleOrb
          key={particle.id}
          particle={particle}
          springX={springX}
          springY={springY}
        />
      ))}
    </div>
  );
}

/**
 * Individual particle orb component with reactive physics
 */
interface ParticleOrbProps {
  particle: Particle;
  springX: any;
  springY: any;
}

function ParticleOrb({ particle, springX, springY }: ParticleOrbProps) {
  const [springXValue, setSpringXValue] = useState(50);
  const [springYValue, setSpringYValue] = useState(50);

  // Subscribe to spring values
  useEffect(() => {
    const unsubscribeX = springX.on("change", (latest: number) => {
      setSpringXValue(latest);
    });
    const unsubscribeY = springY.on("change", (latest: number) => {
      setSpringYValue(latest);
    });

    return () => {
      unsubscribeX();
      unsubscribeY();
    };
  }, [springX, springY]);

  // Calculate parallax offset
  const mouseOffsetX = (springXValue - 50) * particle.strength;
  const mouseOffsetY = (springYValue - 50) * particle.strength;

  const finalX = particle.initialX + mouseOffsetX;
  const finalY = particle.initialY + mouseOffsetY;

  const colorClass = particle.color === "cyan" 
    ? "bg-cyan-400" 
    : "bg-amber-400";
  
  const glowColor = particle.color === "cyan"
    ? "0 0 8px rgba(34, 211, 238, 0.6), 0 0 4px rgba(34, 211, 238, 0.4)"
    : "0 0 8px rgba(251, 191, 36, 0.6), 0 0 4px rgba(251, 191, 36, 0.4)";

  return (
    <motion.div
      className={`absolute rounded-full ${colorClass}`}
      style={{
        left: `${finalX}%`,
        top: `${finalY}%`,
        width: `${particle.size}px`,
        height: `${particle.size}px`,
        boxShadow: glowColor,
        transform: "translate(-50%, -50%)",
      }}
      animate={{
        opacity: [0.2, 0.8, 0.2],
      }}
      transition={{
        duration: particle.pulseDuration,
        repeat: Infinity,
        ease: "easeInOut",
      }}
    />
  );
}


==================================================
FILE: next-frontend/src/components/layout/GlobalMenu.tsx
==================================================
"use client";

import { useState, useRef, useEffect } from "react";
import { useRouter } from "next/navigation";
import { useClerk } from "@clerk/nextjs";
import { useTheme } from "next-themes";
import { Menu, Bell, User, Sparkles, LogOut, X, Sun, Moon, LucideIcon } from "lucide-react";
import { cn } from "@app/lib/utils";
import { motion, AnimatePresence } from "framer-motion";

interface MenuItem {
  icon: LucideIcon;
  label: string;
  onClick: () => void;
  isDestructive?: boolean;
  isDisabled?: boolean;
  suffix?: string;
}

export function GlobalMenu() {
  const [isOpen, setIsOpen] = useState(false);
  const [mounted, setMounted] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);
  const { signOut } = useClerk();
  const router = useRouter();
  const { theme, setTheme } = useTheme();

  // Prevent hydration mismatch
  useEffect(() => {
    setMounted(true);
  }, []);

  // Close menu when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }

    if (isOpen) {
      document.addEventListener("mousedown", handleClickOutside);
      return () => document.removeEventListener("mousedown", handleClickOutside);
    }
  }, [isOpen]);

  const menuItems: MenuItem[] = [
    {
      icon: Bell,
      label: "Notification Center",
      onClick: () => {
        console.log("Notification Center clicked");
        setIsOpen(false);
      },
    },
    {
      icon: User,
      label: "Account Settings",
      onClick: () => {
        console.log("Account Settings clicked");
        setIsOpen(false);
      },
    },
    {
      icon: mounted && theme === "light" ? Sun : Moon,
      label: "Themes",
      onClick: () => {
        setTheme(theme === "dark" ? "light" : "dark");
        setIsOpen(false);
      },
    },
    {
      icon: LogOut,
      label: "Log Out",
      onClick: async () => {
        setIsOpen(false);
        await signOut();
        router.push("/sign-in");
      },
      isDestructive: true,
    },
  ];

  return (
    <div className="absolute right-6 top-6 z-50" ref={menuRef}>
      {/* Menu Button */}
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className={cn(
          "flex h-10 w-10 items-center justify-center rounded-lg",
          "bg-zinc-900/60 backdrop-blur-sm border border-zinc-800",
          "text-zinc-300 transition-all",
          "hover:bg-zinc-800/80 hover:text-zinc-100 hover:border-zinc-700",
          "focus:outline-none focus:ring-2 focus:ring-amber-400/50 focus:ring-offset-2 focus:ring-offset-zinc-950"
        )}
        aria-label="Global Menu"
      >
        {isOpen ? (
          <X className="h-5 w-5" />
        ) : (
          <Menu className="h-5 w-5" />
        )}
      </button>

      {/* Dropdown Menu */}
      <AnimatePresence>
        {isOpen && (
          <>
            {/* Backdrop */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.2 }}
              className="fixed inset-0 -z-10"
              onClick={() => setIsOpen(false)}
            />
            {/* Menu Panel */}
            <motion.div
              initial={{ opacity: 0, scale: 0.95, y: -10 }}
              animate={{ opacity: 1, scale: 1, y: 0 }}
              exit={{ opacity: 0, scale: 0.95, y: -10 }}
              transition={{ duration: 0.2 }}
              className="absolute right-0 mt-2 w-56 rounded-lg border border-zinc-800 bg-zinc-900/90 backdrop-blur-xl shadow-2xl overflow-hidden"
            >
              <div className="py-1">
                {menuItems.map((item) => {
                  const Icon = item.icon;
                  return (
                    <button
                      key={item.label}
                      type="button"
                      onClick={item.isDisabled ? undefined : item.onClick}
                      disabled={item.isDisabled}
                      className={cn(
                        "flex w-full items-center gap-3 px-4 py-2.5 text-sm transition-colors",
                        item.isDisabled
                          ? "opacity-60 cursor-not-allowed text-zinc-400"
                          : item.isDestructive
                          ? "text-red-400 hover:bg-zinc-800/50 hover:text-red-300"
                          : "text-zinc-300 hover:bg-zinc-800/50 hover:text-zinc-100"
                      )}
                    >
                      <Icon className="h-4 w-4 flex-shrink-0" />
                      <span className="flex-1 text-left">{item.label}</span>
                      {item.suffix && (
                        <span className="text-xs text-zinc-500">{item.suffix}</span>
                      )}
                    </button>
                  );
                })}
              </div>
            </motion.div>
          </>
        )}
      </AnimatePresence>
    </div>
  );
}


==================================================
FILE: next-frontend/src/components/layout/CampaignSidebar.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import Link from "next/link";
import { usePathname, useParams } from "next/navigation";
import {
  LayoutDashboard,
  MessageSquare,
  Search,
  FileText,
  Home,
  Clapperboard,
  Inbox,
  Target,
  ChevronLeft,
  ChevronRight,
  Sparkles,
  MessageCircle,
} from "lucide-react";
import { UserButton } from "@clerk/nextjs";
import { cn } from "@app/lib/utils";

type NavItem = {
  name: string;
  href: string;
  icon: React.ReactNode;
};

interface CampaignSidebarProps {
  isCollapsed: boolean;
  onToggle: () => void;
}

export function CampaignSidebar({ isCollapsed, onToggle }: CampaignSidebarProps) {
  const params = useParams();
  const campaignId = params.id as string;
  const pathname = usePathname();
  const [isMounted, setIsMounted] = useState(false);

  // Defer UserButton rendering until after mount to prevent hydration mismatch
  useEffect(() => {
    setIsMounted(true);
  }, []);

  const navItems: NavItem[] = [
    {
      name: "Overview",
      href: `/campaign/${campaignId}`,
      icon: <LayoutDashboard className="h-5 w-5" />,
    },
    {
      name: "Pitch & Intake",
      href: `/campaign/${campaignId}/pitch`,
      icon: <Inbox className="h-5 w-5" />,
    },
    {
      name: "Research",
      href: `/campaign/${campaignId}/research`,
      icon: <Search className="h-5 w-5" />,
    },
    {
      name: "Strategy",
      href: `/campaign/${campaignId}/strategy`,
      icon: <Target className="h-5 w-5" />,
    },
    {
      name: "Messaging",
      href: `/campaign/${campaignId}/messaging`,
      icon: <MessageSquare className="h-5 w-5" />,
    },
    {
      name: "Media",
      href: `/campaign/${campaignId}/media`,
      icon: <Clapperboard className="h-5 w-5" />,
    },
    {
      name: "Assets",
      href: `/campaign/${campaignId}/assets`,
      icon: <FileText className="h-5 w-5" />,
    },
    {
      name: "Riley AI",
      href: `/campaign/${campaignId}/riley`,
      icon: <Sparkles className="h-5 w-5" />,
    },
    {
      name: "Team Chat",
      href: `/campaign/${campaignId}/chat`,
      icon: <MessageCircle className="h-5 w-5" />,
    },
  ];

  return (
    <aside
      className={cn(
        "h-screen fixed left-0 top-0 z-40 border-r border-slate-800 bg-slate-900/60 backdrop-blur-xl transition-all duration-300 flex flex-col",
        isCollapsed ? "w-20" : "w-64"
      )}
    >
      {/* Logo */}
      <div className={cn("flex h-16 items-center border-b border-white/5 px-6", isCollapsed && "justify-center")}>
        <Link
          href="/"
          className={cn(
            "flex items-center gap-2 text-lg font-semibold text-slate-100 transition-colors hover:text-amber-400",
            isCollapsed && "justify-center"
          )}
        >
          <Home className="h-5 w-5 flex-shrink-0" />
          {!isCollapsed && <span>RILEY | PLATFORM</span>}
        </Link>
      </div>

      {/* Navigation */}
      <nav className="flex-1 mt-6 space-y-2 px-2 overflow-y-auto">
        {navItems.map((item) => {
          const isActive =
            pathname === item.href || pathname.startsWith(item.href + "/");
          return (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                "flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-400 transition-all duration-200 mx-2 rounded-lg",
                isCollapsed ? "justify-center px-3" : "",
                isActive
                  ? "text-amber-400 bg-amber-400/10 border border-amber-400/20 shadow-[0_0_15px_rgba(251,191,36,0.1)]"
                  : "hover:text-amber-400 hover:bg-amber-400/10 hover:shadow-[0_0_15px_rgba(251,191,36,0.1)]"
              )}
              title={isCollapsed ? item.name : undefined}
            >
              <span className="flex-shrink-0">{item.icon}</span>
              {!isCollapsed && <span>{item.name}</span>}
            </Link>
          );
        })}
      </nav>

      {/* User Profile - Pushed to bottom */}
      <div className={cn("mt-auto border-t border-white/5 p-4", isCollapsed && "flex justify-center")}>
        <div className={cn("flex items-center", isCollapsed ? "justify-center" : "gap-3")}>
          {!isMounted ? (
            // Skeleton placeholder to prevent hydration mismatch
            <>
              <div className="h-8 w-8 rounded-full bg-slate-700/50 animate-pulse flex-shrink-0" />
              {!isCollapsed && (
                <div className="h-4 w-24 rounded bg-slate-700/50 animate-pulse" />
              )}
            </>
          ) : (
            <UserButton
              showName={!isCollapsed}
              appearance={{
                elements: {
                  avatarBox: "h-8 w-8",
                  userButtonPopoverCard: "bg-slate-900/95 border border-white/5 backdrop-blur-xl",
                  userButtonPopoverActions: "bg-slate-900/95",
                  userButtonPopoverActionButton: "text-slate-100 hover:bg-amber-400/10 hover:text-amber-400",
                  userButtonPopoverFooter: "hidden",
                },
              }}
            />
          )}
        </div>
      </div>

      {/* Toggle Button - At Bottom */}
      <button
        type="button"
        onClick={onToggle}
        className="w-full p-4 border-t border-white/5 hover:bg-amber-400/10 hover:text-amber-400 cursor-pointer flex justify-center items-center transition-all duration-200 text-slate-400"
        aria-label={isCollapsed ? "Expand sidebar" : "Collapse sidebar"}
      >
        {isCollapsed ? (
          <ChevronRight className="h-5 w-5" />
        ) : (
          <ChevronLeft className="h-5 w-5" />
        )}
      </button>
    </aside>
  );
}


==================================================
FILE: next-frontend/src/components/layout/Shell.tsx
==================================================
"use client";

import { ReactNode, useState } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import { LayoutDashboard, MessageSquare, Search, FileText, Home, Sparkles, X } from "lucide-react";
import { cn } from "@app/lib/utils";
import { NotificationBell } from "@app/components/ui/NotificationBell";
import { RileyOrb } from "@app/components/ui/RileyOrb";
import { ChatInterface } from "@app/components/ChatInterface";
import { motion, AnimatePresence } from "framer-motion";

type NavItem = {
  name: string;
  href: string;
  icon: React.ReactNode;
};

const navItems: NavItem[] = [
  { name: "Overview", href: "/", icon: <LayoutDashboard className="h-5 w-5" /> },
  { name: "Messaging", href: "/messaging", icon: <MessageSquare className="h-5 w-5" /> },
  { name: "Research", href: "/research", icon: <Search className="h-5 w-5" /> },
  { name: "Assets", href: "/assets", icon: <FileText className="h-5 w-5" /> },
];

export function Shell({ children }: { children: ReactNode }) {
  const pathname = usePathname();
  const [isChatOpen, setIsChatOpen] = useState(false);

  // Extract breadcrumbs from pathname
  const getBreadcrumbs = () => {
    const segments = pathname.split("/").filter(Boolean);
    if (segments.length === 0) return "Dashboard";
    
    // Handle campaign pages
    if (segments[0] === "campaign" && segments[1]) {
      const campaignName = segments[1]
        .split("-")
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
      
      // Add sub-page if present (messaging, assets, etc.)
      if (segments[2]) {
        const subPage = segments[2]
          .split("-")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
        return `Campaign > ${campaignName} > ${subPage}`;
      }
      
      return `Campaign > ${campaignName}`;
    }
    
    // Handle other pages
    return segments
      .map((seg) => seg.charAt(0).toUpperCase() + seg.slice(1))
      .join(" > ");
  };

  return (
    <div className="flex h-screen overflow-hidden bg-slate-50">
      {/* Left Sidebar - Fixed */}
      <aside className="fixed left-0 top-0 z-40 h-screen w-64 border-r border-slate-800 bg-slate-900 text-white">
        {/* Logo */}
        <div className="flex h-16 items-center border-b border-slate-800 px-6">
          <Link
            href="/"
            className="flex items-center gap-2 text-lg font-semibold text-white transition-colors hover:text-amber-400"
          >
            <Home className="h-5 w-5" />
            <span>RILEY | PLATFORM</span>
          </Link>
        </div>

        {/* Navigation */}
        <nav className="mt-6 space-y-1 px-3">
          {navItems.map((item) => {
            const isActive = pathname === item.href || pathname.startsWith(item.href + "/");
            return (
              <Link
                key={item.href}
                href={item.href}
                className={cn(
                  "flex items-center gap-3 rounded-lg px-4 py-3 text-sm font-medium transition-colors",
                  isActive
                    ? "bg-slate-800 text-amber-400"
                    : "text-slate-300 hover:bg-slate-800 hover:text-white"
                )}
              >
                {item.icon}
                {item.name}
              </Link>
            );
          })}
        </nav>

        {/* User Profile (Bottom) */}
        <div className="absolute bottom-0 left-0 right-0 border-t border-slate-800 p-4">
          <div className="flex items-center gap-3">
            <div className="flex h-8 w-8 items-center justify-center rounded-full bg-slate-700 text-xs font-medium text-white">
              A
            </div>
            <div className="flex-1 min-w-0">
              <p className="truncate text-sm font-medium text-white">Alex</p>
              <p className="truncate text-xs text-slate-400">alex@rally.org</p>
            </div>
          </div>
        </div>
      </aside>

      {/* Main Content Area */}
      <div className="flex flex-1 flex-col pl-64">
        {/* Top Bar */}
        <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b border-slate-200 bg-white/80 backdrop-blur-sm px-6">
          {/* Breadcrumbs */}
          <div className="flex items-center gap-2 text-sm text-slate-600">
            <span>{getBreadcrumbs()}</span>
          </div>

          {/* Right Side Actions */}
          <div className="flex items-center gap-4">
            {/* Ask Riley Button */}
            <button
              type="button"
              onClick={() => setIsChatOpen(!isChatOpen)}
              className={cn(
                "inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition-colors",
                isChatOpen
                  ? "bg-amber-400 text-slate-900 hover:bg-amber-500"
                  : "bg-slate-100 text-slate-700 hover:bg-slate-200"
              )}
            >
              <Sparkles className="h-4 w-4" />
              Ask Riley
            </button>
            <NotificationBell />
          </div>
        </header>

        {/* Scrollable Main Content */}
        <main className="flex-1 overflow-y-auto bg-slate-50">
          {children}
        </main>
      </div>

      {/* Riley Orb - Fixed Bottom Right */}
      <RileyOrb />

      {/* Slide-out Chat Panel */}
      <AnimatePresence>
        {isChatOpen && (
          <>
            {/* Backdrop */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.2 }}
              className="fixed inset-0 z-40 bg-black/20"
              onClick={() => setIsChatOpen(false)}
            />
            {/* Chat Panel */}
            <motion.div
              initial={{ x: "100%" }}
              animate={{ x: 0 }}
              exit={{ x: "100%" }}
              transition={{ type: "spring", damping: 25, stiffness: 200 }}
              className="fixed right-0 top-0 z-50 h-full w-full max-w-md border-l border-slate-200 bg-white shadow-2xl"
            >
              {/* Chat Header */}
              <div className="flex h-16 items-center justify-between border-b border-slate-200 bg-slate-50 px-6">
                <div className="flex items-center gap-2">
                  <Sparkles className="h-5 w-5 text-amber-500" />
                  <h2 className="text-lg font-semibold text-slate-900">Riley Assistant</h2>
                </div>
                <button
                  type="button"
                  onClick={() => setIsChatOpen(false)}
                  className="rounded-lg p-1.5 text-slate-400 transition-colors hover:bg-slate-200 hover:text-slate-600"
                  aria-label="Close chat"
                >
                  <X className="h-5 w-5" />
                </button>
              </div>

              {/* Chat Interface */}
              <div className="h-[calc(100%-4rem)]">
                <ChatInterface tenantId="rally" />
              </div>
            </motion.div>
          </>
        )}
      </AnimatePresence>
    </div>
  );
}



==================================================
FILE: next-frontend/src/components/layout/GlobalRileyOrb.tsx
==================================================
"use client";

import { useState, useRef, useEffect } from "react";
import { Bot, Sparkles, X, AlertCircle, Calendar, FileText, Minus, MessageCircle } from "lucide-react";
import { cn } from "@app/lib/utils";
import { motion, AnimatePresence, useMotionValue } from "framer-motion";

type Notification = {
  id: string;
  type: "slack" | "calendar" | "system" | "mention";
  icon: React.ReactNode;
  message: string;
  isCritical?: boolean;
};

// Felix Scenario - High-Value Alerts
const mockNotifications: Notification[] = [
  {
    id: "1",
    type: "slack",
    icon: <AlertCircle className="h-4 w-4" />,
    message: "Felix (CEO) posted in #general: 'Q4 Strategy shift - all hands on deck.'",
    isCritical: true,
  },
  {
    id: "2",
    type: "calendar",
    icon: <Calendar className="h-4 w-4" />,
    message: "Client Review: Clean Water Campaign starts in 15 mins.",
    isCritical: false,
  },
  {
    id: "3",
    type: "system",
    icon: <FileText className="h-4 w-4" />,
    message: "3 New Documents uploaded to Housing Justice.",
    isCritical: false,
  },
];

interface SavedPosition {
  x: number;
  y: number;
}

const STORAGE_KEY = "riley_orb_pos";
const DEFAULT_POSITION = { x: 0, y: 0 }; // Relative to bottom-right corner

export function GlobalRileyOrb() {
  const [isCollapsed, setIsCollapsed] = useState(true);
  const [notifications, setNotifications] = useState<Notification[]>(mockNotifications);
  const popoverRef = useRef<HTMLDivElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  
  // Position state - stored as offset from bottom-right corner
  const [position, setPosition] = useState<SavedPosition>(DEFAULT_POSITION);
  
  // Motion values for dragging
  const x = useMotionValue(0);
  const y = useMotionValue(0);

  // Load saved position from localStorage on mount
  useEffect(() => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const parsed = JSON.parse(saved) as SavedPosition;
        setPosition(parsed);
        x.set(parsed.x);
        y.set(parsed.y);
      }
    } catch (err) {
      console.error("Failed to load saved orb position:", err);
    }
  }, [x, y]);

  // Update constraints on window resize
  useEffect(() => {
    const handleResize = () => {
      // Constraints will be recalculated on next render
    };
    window.addEventListener("resize", handleResize);
    return () => window.removeEventListener("resize", handleResize);
  }, []);

  // Calculate viewport constraints
  const getConstraints = () => {
    if (typeof window === "undefined" || !containerRef.current) {
      return { left: -Infinity, right: Infinity, top: -Infinity, bottom: Infinity };
    }
    
    const orbSize = 56; // h-14 w-14 = 56px
    const padding = 24; // 6 * 4 = 24px (bottom-6 right-6)
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Constraints relative to bottom-right corner
    // Left constraint: can't go further left than viewport edge
    const left = -(viewportWidth - orbSize - padding);
    // Right constraint: can't go further right than default position
    const right = 0;
    // Top constraint: can't go above viewport (accounting for orb size)
    const top = -(viewportHeight - orbSize - padding);
    // Bottom constraint: can't go below default position
    const bottom = 0;
    
    return { left, right, top, bottom };
  };

  // Save position to localStorage on drag end
  const handleDragEnd = () => {
    const newPosition = { x: x.get(), y: y.get() };
    setPosition(newPosition);
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(newPosition));
    } catch (err) {
      console.error("Failed to save orb position:", err);
    }
  };

  // Close popover when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (popoverRef.current && !popoverRef.current.contains(event.target as Node)) {
        setIsCollapsed(true);
      }
    }

    if (!isCollapsed) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [isCollapsed]);

  // Listen for riley-notification custom events
  useEffect(() => {
    function handleRileyNotification(event: CustomEvent) {
      const { type, message, author } = event.detail;
      
      if (type === "mention") {
        const newNotification: Notification = {
          id: Date.now().toString(),
          type: "mention",
          icon: <MessageCircle className="h-4 w-4" />,
          message: `${author} mentioned you: "${message}"`,
          isCritical: true, // Mentions are critical alerts
        };
        
        setNotifications((prev) => [newNotification, ...prev]);
      }
    }

    window.addEventListener("riley-notification", handleRileyNotification as EventListener);

    return () => {
      window.removeEventListener("riley-notification", handleRileyNotification as EventListener);
    };
  }, []);

  const alertCount = notifications.length;
  const hasNewAlerts = notifications.some((n) => n.isCritical);
  const constraints = getConstraints();

  return (
    <motion.div
      ref={containerRef}
      className="fixed bottom-6 right-6 z-50"
      style={{
        x,
        y,
      }}
      drag
      dragMomentum={false}
      dragConstraints={constraints}
      dragElastic={0}
      onDragEnd={handleDragEnd}
      whileDrag={{ cursor: "grabbing" }}
    >
      <div ref={popoverRef}>
      {/* Expanded Panel - Notification Feed */}
      <AnimatePresence>
        {!isCollapsed && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95, y: 10 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95, y: 10 }}
            transition={{ duration: 0.2 }}
            className="absolute bottom-20 right-0 w-96 rounded-2xl border border-zinc-800 bg-zinc-900/95 backdrop-blur-xl shadow-2xl"
          >
            {/* Header */}
            <div className="flex items-center justify-between border-b border-zinc-800 bg-zinc-900/50 px-5 py-4">
              <div className="flex items-center gap-3">
                <div className="relative">
                  <div className="absolute inset-0 animate-pulse rounded-full bg-blue-400/20 blur-md" />
                  <div className="relative flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-indigo-600">
                    <Bot className="h-5 w-5 text-white" />
                  </div>
                </div>
                <div>
                  <h3 className="text-sm font-semibold text-zinc-100">Intelligence Feed</h3>
                  <p className="text-xs text-zinc-400">Scanning for high-priority updates...</p>
                </div>
              </div>
              <button
                type="button"
                onClick={() => setIsCollapsed(true)}
                className="rounded-lg p-1.5 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors"
                aria-label="Minimize"
              >
                <Minus className="h-4 w-4" />
              </button>
            </div>

            {/* Notifications Feed - Read Only */}
            <div className="max-h-[500px] overflow-y-auto p-4 [&::-webkit-scrollbar]:hidden [-ms-overflow-style:'none'] [scrollbar-width:'none']">
              {notifications.length === 0 ? (
                /* Zero State */
                <div className="flex flex-col items-center justify-center py-12 text-center">
                  <div className="text-4xl mb-3">ðŸŽ‰</div>
                  <p className="text-sm text-zinc-400">
                    You're all caught up! No new alerts.
                  </p>
                </div>
              ) : (
                <div className="space-y-3">
                  {notifications.map((notification) => (
                    <div
                      key={notification.id}
                      className={cn(
                        "rounded-lg border p-3 transition-all hover:border-zinc-700",
                        notification.isCritical
                          ? "border-red-500/50 bg-red-500/10 hover:bg-red-500/15"
                          : "border-zinc-800 bg-zinc-800/30 hover:bg-zinc-800/50"
                      )}
                    >
                      <div className="flex items-start gap-3">
                        <div
                          className={cn(
                            "mt-0.5 flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full",
                            notification.type === "slack" && notification.isCritical
                              ? "bg-red-500/20 text-red-400"
                              : notification.type === "slack"
                              ? "bg-amber-500/20 text-amber-400"
                              : notification.type === "calendar"
                              ? "bg-blue-500/20 text-blue-400"
                              : notification.type === "mention"
                              ? "bg-amber-500/20 text-amber-400"
                              : "bg-emerald-500/20 text-emerald-400"
                          )}
                        >
                          {notification.icon}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-sm text-zinc-300">{notification.message}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Status Footer */}
            <div className="border-t border-zinc-800 bg-zinc-900/50 px-5 py-3">
              <div className="flex items-center gap-2 text-xs text-zinc-500">
                <div className="h-2 w-2 rounded-full bg-emerald-400" />
                <span>Riley is active</span>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Collapsed Orb Button */}
      <motion.button
        type="button"
        onClick={() => setIsCollapsed(!isCollapsed)}
        className="relative flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg transition-all hover:shadow-xl hover:scale-105 cursor-grab active:cursor-grabbing"
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
        aria-label="Intelligence Feed"
      >
        {/* Pulsing Glow Effect - Only if there are new alerts */}
        {hasNewAlerts && (
          <motion.div
            className="absolute inset-0 rounded-full bg-blue-400/30"
            animate={{
              scale: [1, 1.2, 1],
              opacity: [0.5, 0.3, 0.5],
            }}
            transition={{
              duration: 2,
              repeat: Infinity,
              ease: "easeInOut",
            }}
          />
        )}
        <Bot className="relative h-6 w-6 text-white" />
        {/* Alert Badge */}
        {alertCount > 0 && (
          <span className="absolute -top-1 -right-1 flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">
            {alertCount > 9 ? "9+" : alertCount}
          </span>
        )}
      </motion.button>
      </div>
    </motion.div>
  );
}



==================================================
FILE: next-frontend/src/components/layout/ShootingStars.tsx
==================================================
"use client";

import { useEffect, useState } from "react";
import { useTheme } from "next-themes";

export function ShootingStars() {
  const { theme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  // Only show shooting stars in dark mode
  if (!mounted || theme === "light") {
    return null;
  }

  return (
    <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden">
      <div className="shooting-star" style={{ top: "20%", left: "-100px", animationDelay: "0s", animationDuration: "3s" }} />
      <div className="shooting-star" style={{ top: "40%", left: "-100px", animationDelay: "1s", animationDuration: "4s" }} />
      <div className="shooting-star" style={{ top: "60%", left: "-100px", animationDelay: "2s", animationDuration: "3.5s" }} />
      <div className="shooting-star" style={{ top: "80%", left: "-100px", animationDelay: "0.5s", animationDuration: "4.5s" }} />
      <div className="shooting-star" style={{ top: "30%", left: "-100px", animationDelay: "1.5s", animationDuration: "3.8s" }} />
      <div className="shooting-star" style={{ top: "70%", left: "-100px", animationDelay: "2.5s", animationDuration: "4.2s" }} />
    </div>
  );
}


==================================================
FILE: next-frontend/src/components/campaign/RileyContextChat.tsx
==================================================
"use client";

import { useState, useRef, useEffect } from "react";
import { useUser, useAuth } from "@clerk/nextjs";
import { Send, Loader2, Trash2, FileText } from "lucide-react";
import ReactMarkdown from "react-markdown";
import { cn } from "@app/lib/utils";
import { TypewriterMarkdown } from "@app/components/ui/TypewriterMarkdown";
import { apiFetch } from "@app/lib/api";

type Message = {
  id: string;
  role: "user" | "assistant" | "system";
  content: string;
  status?: "thinking"; // For placeholder messages
};

interface RileyContextChatProps {
  mode: "messaging" | "research" | "strategy" | "pitch";
  contextKey: string;
  campaignId: string;
  onViewAsset?: (filename: string) => void;
}

export function RileyContextChat({ mode, contextKey, campaignId, onViewAsset }: RileyContextChatProps) {
  // All hooks must be called unconditionally before any early returns
  const { user, isLoaded } = useUser();
  const { getToken, isLoaded: authLoaded } = useAuth();
  
  // Derive user display name: username ?? firstName ?? primaryEmail ?? "there"
  const userDisplayName = user?.username ?? user?.firstName ?? user?.primaryEmailAddress?.emailAddress ?? "there";
  
  // Check for missing requirements (but still render UI with error banner)
  const missingAuth = !authLoaded || !isLoaded || !user;
  const missingCampaignId = !campaignId;
  
  const getSystemMessage = () => {
    switch (mode) {
      case "messaging":
        return "I've analyzed your active columns. I can help you refine messaging, suggest edits, or review drafts. What would you like to work on?";
      case "research":
        return "I've reviewed your research data. I can help you analyze trends, identify insights, or answer questions about your findings. What would you like to explore?";
      case "strategy":
        return "I've reviewed your strategy documents. I can help you develop tactics, analyze positioning, or refine your approach. What would you like to focus on?";
      case "pitch":
        return "I've analyzed your pitch materials. I can help you refine presentations, strengthen arguments, or prepare for client meetings. What would you like to improve?";
      default:
        return "How can I help you today?";
    }
  };

  const getTitle = () => {
    switch (mode) {
      case "messaging":
        return "Riley Messaging";
      case "research":
        return "Riley Research";
      case "strategy":
        return "Riley Strategy";
      case "pitch":
        return "Riley Pitch";
      default:
        return "Riley Strategy";
    }
  };

  const [messages, setMessages] = useState<Message[]>([
    {
      id: "system-1",
      role: "system",
      content: getSystemMessage(),
    },
  ]);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [isClearing, setIsClearing] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLInputElement>(null);

  // Derive sessionId with user ID to prevent collisions (after hooks, but handle conditionally)
  const sessionId = isLoaded && user && campaignId 
    ? `session_${campaignId}_${contextKey}_${user.id}` 
    : null;

  // Load chat history on mount and when sessionId changes
  useEffect(() => {
    // Only load if we have a valid sessionId
    if (!sessionId || !user || !campaignId) {
      return;
    }

    // Only load history if messages are empty or only contain system message
    // This prevents overwriting optimistic updates
    setMessages((prev) => {
      const hasUserOrAssistantMessages = prev.some(
        (msg) => msg.role === "user" || msg.role === "assistant"
      );
      // If we have user/assistant messages, don't load history (preserve optimistic updates)
      if (hasUserOrAssistantMessages) {
        return prev;
      }
      // Otherwise, keep current messages (might be system message)
      return prev;
    });

    async function loadHistory() {
      try {
        const token = await getToken();
        if (!token) return;
        
        const history = await apiFetch<Array<{ role: string; content: string }>>(
          `/api/v1/chat/history/${sessionId}`,
          {
            token,
            method: "GET",
          }
        );
        
        // Guard: Only update if history exists and messages are still empty/only system
        setMessages((prev) => {
          const hasUserOrAssistantMessages = prev.some(
            (msg) => msg.role === "user" || msg.role === "assistant"
          );
          // Don't overwrite if user/assistant messages exist
          if (hasUserOrAssistantMessages) {
            return prev;
          }
          
          if (history && Array.isArray(history) && history.length > 0) {
            // Convert history to Message format
            const historyMessages: Message[] = history.map(
              (msg: { role: string; content: string }, idx: number) => ({
                id: `history-${Date.now()}-${idx}`,
                role: msg.role === "user" ? "user" : "assistant",
                content: msg.content,
              })
            );
            // Prepend system message
            return [
              {
                id: "system-1",
                role: "system",
                content: getSystemMessage(),
              },
              ...historyMessages,
            ];
          } else {
            // Empty history - keep system message only if messages are still empty
            return prev.length === 0 || (prev.length === 1 && prev[0].role === "system")
              ? [
                  {
                    id: "system-1",
                    role: "system",
                    content: getSystemMessage(),
                  },
                ]
              : prev;
          }
        });
      } catch (error) {
        // If history fetch fails (404 or other), continue with default system message
        // Guard: Only set system message if messages are still empty
        setMessages((prev) => {
          const hasUserOrAssistantMessages = prev.some(
            (msg) => msg.role === "user" || msg.role === "assistant"
          );
          if (hasUserOrAssistantMessages) {
            return prev;
          }
          
          if (error instanceof Error && error.message.includes("404")) {
            // No history exists yet, keep default system message
            return [
              {
                id: "system-1",
                role: "system",
                content: getSystemMessage(),
              },
            ];
          } else {
            console.error("Failed to load chat history:", error);
            return [
              {
                id: "system-1",
                role: "system",
                content: getSystemMessage(),
              },
            ];
          }
        });
      }
    }

    loadHistory();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [sessionId, user?.id, campaignId]); // Reload when sessionId, user, or campaignId changes

  // Auto-scroll to bottom when new messages arrive
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  // Check if send is enabled and why it might be disabled
  const canSend = input.trim().length > 0 && !isLoading && !missingAuth && !missingCampaignId;
  const sendDisabledReason = missingAuth 
    ? "Not authenticated" 
    : missingCampaignId 
    ? "Campaign ID missing" 
    : input.trim().length === 0 
    ? "Enter a message" 
    : isLoading 
    ? "Sending..." 
    : null;

  async function handleSend() {
    if (!canSend || !sessionId) return;

    // Step 1: Capture user input immediately
    const userInput = input.trim();
    const userMessage: Message = {
      id: `user-${Date.now()}`,
      role: "user",
      content: userInput,
    };

    // Step 2: Create thinking placeholder for assistant response (store ID for later replacement)
    const thinkingId = `thinking-${Date.now()}`;
    const thinkingMessage: Message = {
      id: thinkingId,
      role: "assistant",
      content: "",
      status: "thinking",
    };

    // Step 3: OPTIMISTIC UPDATE - Immediately append user message + thinking placeholder
    // This makes the message appear instantly in the UI BEFORE any await
    setMessages((prev) => [...prev, userMessage, thinkingMessage]);
    
    // Step 4: Clear input field immediately for better UX
    setInput("");
    
    // Step 5: Set loading state
    setIsLoading(true);

    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }

      const data = await apiFetch<{ response: string }>("/api/v1/chat", {
        token,
        method: "POST",
        body: {
          query: userInput,
          tenant_id: campaignId,
          mode: "fast",
          session_id: sessionId,
          user_display_name: userDisplayName,
        },
      });

      // Step 6: Replace thinking placeholder with actual assistant response
      const assistantMessage: Message = {
        id: `assistant-${Date.now()}`,
        role: "assistant",
        content: data.response,
      };
      
      // Replace thinking message with actual response
      setMessages((prev) => {
        return prev.map((msg) =>
          msg.id === thinkingId ? assistantMessage : msg
        );
      });
    } catch (error) {
      // Log error to console for debugging
      console.error("Riley chat error:", error);
      
      // Replace thinking placeholder with error message
      const errorText = error instanceof Error 
        ? error.message 
        : "Unknown error occurred";
      
      const errorMessage: Message = {
        id: `error-${Date.now()}`,
        role: "assistant",
        content: `Error: ${errorText}`,
      };
      
      // Replace thinking message with error message
      setMessages((prev) => {
        return prev.map((msg) =>
          msg.id === thinkingId ? errorMessage : msg
        );
      });
    } finally {
      setIsLoading(false);
    }
  }

  async function handleClearContext() {
    setIsClearing(true);
    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }
      
      await apiFetch(`/api/v1/chat/history/${sessionId}`, {
        token,
        method: "DELETE",
      });
      
      // Reset messages to just the system message
      setMessages([
        {
          id: "system-1",
          role: "system",
          content: getSystemMessage(),
        },
      ]);
    } catch (error) {
      console.error("Failed to clear chat history:", error);
      // Optionally show a toast/notification to the user
    } finally {
      setIsClearing(false);
    }
  }

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  // Render content with interactive citation badges
  function renderContent(text: string): React.ReactNode {
    if (!text) return null;

    // Regex to match [[Source: Filename.pdf]] patterns
    const citationRegex = /(\[\[Source: .*?\]\])/g;
    const parts: Array<{ type: "text" | "citation"; content: string }> = [];
    let lastIndex = 0;
    let match;

    // Find all citation matches
    while ((match = citationRegex.exec(text)) !== null) {
      // Add text before the citation
      if (match.index > lastIndex) {
        parts.push({
          type: "text",
          content: text.substring(lastIndex, match.index),
        });
      }

      // Extract filename from citation (remove [[Source: ]] wrapper)
      const citationText = match[1];
      const filenameMatch = citationText.match(/\[\[Source: (.+?)\]\]/);
      const filename = filenameMatch ? filenameMatch[1] : citationText;

      parts.push({
        type: "citation",
        content: filename,
      });

      lastIndex = match.index + match[0].length;
    }

    // Add remaining text after last citation
    if (lastIndex < text.length) {
      parts.push({
        type: "text",
        content: text.substring(lastIndex),
      });
    }

    // If no citations found, return plain text
    if (parts.length === 0) {
      return <span>{text}</span>;
    }

    // Render parts with citation badges
    return (
      <>
        {parts.map((part, idx) => {
          if (part.type === "citation") {
            return (
              <button
                key={`citation-${idx}`}
                type="button"
                onClick={() => {
                  if (onViewAsset) {
                    onViewAsset(part.content);
                  }
                }}
                className={cn(
                  "inline-flex items-center gap-1.5",
                  "bg-zinc-800/50 border border-zinc-700/50 rounded-md",
                  "px-2 py-0.5 text-[10px] text-amber-500/90",
                  "hover:bg-amber-500/10 hover:border-amber-500/30 hover:text-amber-400",
                  "transition-all mx-1 align-baseline cursor-pointer"
                )}
              >
                <FileText className="h-2.5 w-2.5" />
                <span>{part.content}</span>
              </button>
            );
          }
          return <span key={`text-${idx}`}>{part.content}</span>;
        })}
      </>
    );
  }

  return (
    <div className="h-full flex flex-col">
      {/* Error Banner */}
      {(missingAuth || missingCampaignId) && (
        <div className="flex-shrink-0 bg-red-500/10 border-b border-red-500/30 px-4 py-2">
          <p className="text-sm text-red-400">
            {missingAuth ? "Not authenticated. Please sign in." : "Campaign ID missing. Cannot send messages."}
          </p>
        </div>
      )}
      
      {/* Header with Clear Context Button */}
      <div className="flex-shrink-0 flex items-center justify-end px-4 py-2 border-b border-zinc-800">
        <button
          type="button"
          onClick={handleClearContext}
          disabled={isClearing}
          className={cn(
            "flex items-center gap-1.5 px-2 py-1 text-xs text-zinc-400 hover:text-zinc-200 transition-colors rounded",
            "hover:bg-zinc-800/50 disabled:opacity-50 disabled:cursor-not-allowed"
          )}
          aria-label="Clear context"
        >
          {isClearing ? (
            <Loader2 className="h-3 w-3 animate-spin" />
          ) : (
            <Trash2 className="h-3 w-3" />
          )}
          <span>Clear Context</span>
        </button>
      </div>

      {/* Chat Area - Scrollable */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin">
        {messages.map((message, index) => {
          const isLastMessage = index === messages.length - 1;
          const isLastAssistant = message.role === "assistant" && isLastMessage;
          
          return (
            <div
              key={message.id}
              className={cn(
                "flex flex-col gap-1",
                message.role === "user" ? "items-end" : "items-start"
              )}
            >
              <div
                className={cn(
                  "rounded-lg px-3 py-2 max-w-[85%] text-sm",
                  message.role === "user"
                    ? "bg-amber-500/10 border border-amber-500/20 text-amber-100"
                    : message.role === "system"
                    ? "bg-zinc-800/50 border border-zinc-700/50 text-zinc-300 italic"
                    : "bg-zinc-900/50 border border-zinc-800/50 text-zinc-100"
                )}
              >
                {message.status === "thinking" ? (
                  // Thinking placeholder
                  <div className="flex items-center gap-2 text-zinc-400">
                    <Loader2 className="h-4 w-4 animate-spin" />
                    <span>Riley is thinking...</span>
                  </div>
                ) : isLastAssistant ? (
                  // Typewriter effect for last assistant message
                  <TypewriterMarkdown content={message.content} />
                ) : message.role === "assistant" ? (
                  // Static markdown for previous assistant messages
                  <div className="riley-md">
                    <ReactMarkdown>{message.content}</ReactMarkdown>
                  </div>
                ) : (
                  // User and system messages (plain text)
                  message.content
                )}
              </div>
            </div>
          );
        })}

        {/* Loading Indicator */}
        {isLoading && (
          <div className="flex items-start gap-2">
            <div className="rounded-lg px-3 py-2 bg-zinc-900/50 border border-zinc-800/50">
              <Loader2 className="h-4 w-4 animate-spin text-zinc-400" />
            </div>
          </div>
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* Input Area - Fixed Bottom */}
      <div className="flex-shrink-0 border-t border-zinc-800 p-4">
        {sendDisabledReason && !isLoading && (
          <div className="mb-2 text-xs text-zinc-500 text-center">
            {sendDisabledReason}
          </div>
        )}
        <div className="flex items-center gap-2">
          <input
            ref={inputRef}
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Ask Riley..."
            disabled={isLoading || missingAuth || missingCampaignId}
            className="flex-1 rounded-lg border border-zinc-800 bg-zinc-900/50 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-600 focus:outline-none focus:ring-2 focus:ring-amber-500/50 disabled:opacity-50 disabled:cursor-not-allowed"
          />
          <button
            type="button"
            onClick={handleSend}
            disabled={!canSend}
            className={cn(
              "flex-shrink-0 p-2 rounded-lg transition-colors",
              canSend
                ? "bg-amber-500/10 border border-amber-500/20 text-amber-400 hover:bg-amber-500/20"
                : "bg-zinc-800/50 border border-zinc-700/50 text-zinc-600 cursor-not-allowed"
            )}
            aria-label="Send message"
            title={sendDisabledReason || "Send message"}
          >
            {isLoading ? (
              <Loader2 className="h-4 w-4 animate-spin" />
            ) : (
              <Send className="h-4 w-4" />
            )}
          </button>
        </div>
      </div>
    </div>
  );
}

// Export helper function for pages to use
export function getRileyTitle(mode: "messaging" | "research" | "strategy" | "pitch"): string {
  switch (mode) {
    case "messaging":
      return "Riley Messaging";
    case "research":
      return "Riley Research";
    case "strategy":
      return "Riley Strategy";
    case "pitch":
      return "Riley Pitch";
    default:
      return "Riley Strategy";
  }
}


==================================================
FILE: next-frontend/src/components/campaign/RenameAssetModal.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import { X, Pencil } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { cn } from "@app/lib/utils";

interface RenameAssetModalProps {
  isOpen: boolean;
  onClose: () => void;
  onRename: (newName: string) => Promise<void>;
  currentName: string;
}

export function RenameAssetModal({
  isOpen,
  onClose,
  onRename,
  currentName,
}: RenameAssetModalProps) {
  const [newName, setNewName] = useState("");
  const [isRenaming, setIsRenaming] = useState(false);

  // Extract filename without extension for the input
  const getBaseName = (filename: string): string => {
    const lastDot = filename.lastIndexOf(".");
    if (lastDot === -1) return filename;
    return filename.substring(0, lastDot);
  };

  // Get file extension
  const getExtension = (filename: string): string => {
    const lastDot = filename.lastIndexOf(".");
    if (lastDot === -1) return "";
    return filename.substring(lastDot);
  };

  // Initialize input with base name (without extension)
  useEffect(() => {
    if (isOpen) {
      setNewName(getBaseName(currentName));
    }
  }, [isOpen, currentName]);

  const handleSave = async () => {
    if (!newName.trim()) return;

    const extension = getExtension(currentName);
    const fullNewName = newName.trim() + extension;

    setIsRenaming(true);
    try {
      await onRename(fullNewName);
      onClose();
    } catch (error) {
      console.error("Rename error:", error);
      alert(`Rename failed: ${error instanceof Error ? error.message : "Unknown error"}`);
    } finally {
      setIsRenaming(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSave();
    }
    if (e.key === "Escape") {
      onClose();
    }
  };

  if (!isOpen) return null;

  return (
    <AnimatePresence>
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
        {/* Backdrop */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="absolute inset-0 bg-black/60 backdrop-blur-sm"
          onClick={onClose}
        />

        {/* Modal */}
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.95 }}
          transition={{ duration: 0.2 }}
          className="relative w-full max-w-md rounded-xl border border-zinc-800 bg-zinc-900/95 backdrop-blur-xl shadow-2xl"
          onClick={(e) => e.stopPropagation()}
        >
          {/* Header */}
          <div className="flex items-center justify-between border-b border-zinc-800 px-6 py-4">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-400/10 border border-amber-400/20">
                <Pencil className="h-5 w-5 text-amber-400" />
              </div>
              <div>
                <h2 className="text-lg font-semibold text-zinc-100">Rename File</h2>
                <p className="text-xs text-zinc-400">Enter a new name for the file</p>
              </div>
            </div>
            <button
              type="button"
              onClick={onClose}
              className="rounded-lg p-1.5 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors"
            >
              <X className="h-5 w-5" />
            </button>
          </div>

          {/* Content */}
          <div className="p-6 space-y-4">
            <div>
              <label className="block text-sm font-medium text-zinc-300 mb-2">
                File Name
              </label>
              <input
                type="text"
                value={newName}
                onChange={(e) => setNewName(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder="Enter file name"
                autoFocus
                className={cn(
                  "w-full rounded-lg border border-zinc-800 bg-zinc-950/50 px-4 py-3",
                  "text-zinc-100 placeholder:text-zinc-600",
                  "focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500/50",
                  "transition-colors"
                )}
              />
              <p className="mt-2 text-xs text-zinc-500">
                Extension <span className="text-zinc-400">{getExtension(currentName)}</span> will be preserved
              </p>
            </div>
          </div>

          {/* Footer */}
          <div className="flex items-center justify-end gap-3 border-t border-zinc-800 px-6 py-4">
            <button
              type="button"
              onClick={onClose}
              disabled={isRenaming}
              className="rounded-lg border border-zinc-700 bg-transparent px-4 py-2 text-sm font-medium text-zinc-300 transition-colors hover:bg-zinc-800 hover:text-zinc-100 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Cancel
            </button>
            <button
              type="button"
              onClick={handleSave}
              disabled={!newName.trim() || isRenaming}
              className={cn(
                "rounded-lg border border-amber-500/20 bg-amber-500/10 px-4 py-2 text-sm font-medium text-amber-400",
                "transition-colors hover:bg-amber-500/20 hover:border-amber-500/30",
                "disabled:opacity-50 disabled:cursor-not-allowed"
              )}
            >
              {isRenaming ? "Renaming..." : "Save"}
            </button>
          </div>
        </motion.div>
      </div>
    </AnimatePresence>
  );
}



==================================================
FILE: next-frontend/src/components/campaign/CampaignBucketCard.tsx
==================================================
"use client";

import type { CSSProperties } from "react";
import { useState, useRef, useEffect } from "react";
import Link from "next/link";
import { Bell, Shield, Trash2, Archive, RotateCcw } from "lucide-react";
import { motion } from "framer-motion";
import { cn } from "@app/lib/utils";
import { useTheme } from "next-themes";

export interface CampaignBucketCardProps {
  name: string;
  role: string;
  lastActive: string;
  mentions: number;
  pendingRequests?: number;
  userRole?: "Lead" | "Member";
  /**
   * Arbitrary CSS color value used to tint the card.
   * Example: "#22c55e", "rgb(59,130,246)", "hsl(222 84% 56%)"
   */
  themeColor: string;
  campaignId?: string;
  onClick?: () => void;
  onDelete?: (campaignId: string) => void;
  isArchived?: boolean;
  onArchive?: (campaignId: string) => void;
  onRestore?: (campaignId: string) => void;
  onTerminate?: (campaignId: string) => void;
  isTerminating?: boolean;
}

// Sparkline Graph Component
function SparklineGraph({ value, maxValue = 10 }: { value: number; maxValue?: number }) {
  const [isMounted, setIsMounted] = useState(false);

  // Prevent hydration mismatch - only render dynamic content after mount
  useEffect(() => {
    setIsMounted(true);
  }, []);

  // Return empty div with same dimensions during SSR
  if (!isMounted) {
    return (
      <div
        className="overflow-visible"
        style={{ width: "40px", height: "12px" }}
      />
    );
  }

  // Generate random data points for the sparkline
  const points = Array.from({ length: 12 }, (_, i) => {
    const base = (value / maxValue) * 100;
    const variation = Math.random() * 20 - 10;
    return Math.max(10, Math.min(90, base + variation));
  });

  const pathData = points
    .map((y, i) => {
      const x = (i / (points.length - 1)) * 100;
      return `${i === 0 ? "M" : "L"} ${x} ${100 - y}`;
    })
    .join(" ");

  return (
    <svg
      width="40"
      height="12"
      viewBox="0 0 100 100"
      className="overflow-visible"
      style={{ filter: "drop-shadow(0 0 2px rgba(59, 130, 246, 0.6))" }}
    >
      <path
        d={pathData}
        fill="none"
        stroke="rgba(59, 130, 246, 0.8)"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
      />
    </svg>
  );
}

export function CampaignBucketCard({
  name,
  role,
  lastActive,
  mentions,
  pendingRequests = 0,
  userRole,
  themeColor,
  campaignId,
  onClick,
  onDelete,
  isArchived = false,
  onArchive,
  onRestore,
  onTerminate,
  isTerminating = false,
}: CampaignBucketCardProps) {
  const [isConfirmingDelete, setIsConfirmingDelete] = useState(false);
  const [isConfirmingTerminate, setIsConfirmingTerminate] = useState(false);
  const [mounted, setMounted] = useState(false);
  const cardRef = useRef<HTMLDivElement>(null);
  const { theme } = useTheme();
  const isLightMode = mounted && theme === "light";

  // Prevent hydration mismatch
  useEffect(() => {
    setMounted(true);
  }, []);

  const href = campaignId ? `/campaign/${campaignId}` : "/campaign/clean-water";

  const handleDeleteClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    
    if (!onDelete || !campaignId) return;
    
    if (!isConfirmingDelete) {
      setIsConfirmingDelete(true);
      setTimeout(() => setIsConfirmingDelete(false), 3000);
    } else {
      onDelete(campaignId);
      setIsConfirmingDelete(false);
    }
  };

  const handleArchiveClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (onArchive && campaignId) {
      onArchive(campaignId);
    }
  };

  const handleRestoreClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (onRestore && campaignId) {
      onRestore(campaignId);
    }
  };

  const handleTerminateClick = (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    
    if (!onTerminate || !campaignId) return;
    
    if (!isConfirmingTerminate) {
      setIsConfirmingTerminate(true);
      setTimeout(() => setIsConfirmingTerminate(false), 3000);
    } else {
      onTerminate(campaignId);
      setIsConfirmingTerminate(false);
    }
  };

  const handleEnterClick = (e: React.MouseEvent) => {
    if (onClick) {
      onClick();
    }
  };

  const cardContent = (
    <motion.div
      ref={cardRef}
      style={
        {
          "--accent": themeColor,
        } as CSSProperties
      }
      className={cn(
        "group relative flex flex-col items-stretch justify-between overflow-visible",
        isLightMode
          ? "bg-white border-2 border-black shadow-[4px_4px_0_0_#000]"
          : "bg-transparent border border-slate-800 transition-colors duration-200",
        "rounded-xl",
        // High-Intensity Neon Halo (Dark Mode Only)
        !isLightMode && "group-hover:border-amber-400/50 group-hover:shadow-[0_0_30px_rgba(251,191,36,0.4)] group-hover:filter group-hover:drop-shadow-[0_0_12px_rgba(251,191,36,0.6)]",
        isArchived
          ? "opacity-60 grayscale-[0.3] hover:opacity-80 hover:grayscale-0"
          : "",
        "text-left"
      )}
      whileHover={{ scale: 1.02, y: -4 }}
      whileTap={{ scale: 0.98, transition: { duration: 0.05 } }}
      transition={{ duration: 0.15, ease: "easeOut" }}
    >
      {/* Internal Content Wrapper - Prevents Gradient Bleed */}
      <div className={cn(
        "relative h-full w-full rounded-xl overflow-hidden",
        !isLightMode && "bg-gradient-to-br from-slate-900 to-slate-950",
        "px-5 py-4 sm:px-6 sm:py-5"
      )}>
        {/* Top row: lastActive + badges + action buttons */}
      <div className="flex items-start justify-between gap-4 relative z-10">
        <span className={cn(
          "text-xs font-medium",
          isLightMode ? "text-black/60 font-mono" : "text-zinc-500"
        )}>
          {lastActive}
        </span>
        
        <div className="flex items-center gap-2">
          {/* Sparkline Graph (replaces Mentions Badge) */}
          {mentions > 0 && (
            <div className="relative inline-flex items-center gap-1.5 rounded-full bg-sky-500/10 border border-sky-500/30 px-2 py-1">
              <SparklineGraph value={mentions} maxValue={20} />
              <span className="text-xs font-semibold text-sky-400 font-mono">{mentions}</span>
            </div>
          )}
          
          {/* Pending Requests Badge (Only for Leads) */}
          {pendingRequests > 0 && userRole === "Lead" && (
            <div className={cn(
              "relative inline-flex items-center gap-1.5 rounded-full px-2 py-1",
              isLightMode
                ? "bg-amber-100 border border-black text-black"
                : "bg-amber-500/10 border border-amber-500/30 text-amber-400"
            )}>
              <Shield className="h-3 w-3" aria-hidden="true" />
              <span className="text-xs font-semibold font-mono">
                {pendingRequests} Request{pendingRequests !== 1 ? "s" : ""}
              </span>
            </div>
          )}

          {/* Archive Button */}
          {!isArchived && onArchive && campaignId && (
            <button
              type="button"
              onClick={handleArchiveClick}
              className={cn(
                "relative inline-flex items-center gap-1.5 rounded-full px-2 py-1 transition-all duration-200",
                "opacity-0 group-hover:opacity-100",
                isLightMode
                  ? "bg-black/5 border border-black/20 text-black hover:bg-black/10"
                  : "bg-zinc-800/50 border border-zinc-700/50 text-zinc-400 hover:bg-zinc-700/50 hover:text-zinc-300"
              )}
              title="Archive campaign"
            >
              <Archive className="h-3 w-3" aria-hidden="true" />
            </button>
          )}

          {/* Restore Button */}
          {isArchived && onRestore && campaignId && (
            <button
              type="button"
              onClick={handleRestoreClick}
              className={cn(
                "relative inline-flex items-center gap-1.5 rounded-full px-2 py-1 transition-all duration-200",
                "opacity-0 group-hover:opacity-100",
                isLightMode
                  ? "bg-black/5 border border-black/20 text-black hover:bg-black/10"
                  : "bg-zinc-800/50 border border-zinc-700/50 text-zinc-400 hover:bg-zinc-700/50 hover:text-zinc-300"
              )}
              title="Restore campaign"
            >
              <RotateCcw className="h-3 w-3" aria-hidden="true" />
            </button>
          )}

          {/* Terminate Button */}
          {isArchived && onTerminate && campaignId && (
            <button
              type="button"
              onClick={handleTerminateClick}
              disabled={isTerminating}
              className={cn(
                "relative inline-flex items-center gap-1.5 rounded-full px-2 py-1 transition-all duration-200",
                "opacity-0 group-hover:opacity-100",
                isConfirmingTerminate
                  ? "bg-red-500/10 border border-red-500/50 text-red-400 hover:bg-red-500/20"
                  : "bg-red-500/10 border border-red-500/30 text-red-400 hover:bg-red-500/20",
                isTerminating && "opacity-50 cursor-not-allowed"
              )}
              title={isConfirmingTerminate ? "Click again to confirm termination" : "Permanently delete campaign"}
            >
              <Trash2 className="h-3 w-3" aria-hidden="true" />
              {isConfirmingTerminate && (
                <span className="text-xs font-semibold">Confirm?</span>
              )}
            </button>
          )}

          {/* Delete Button (Legacy) */}
          {!isArchived && onDelete && campaignId && (
            <button
              type="button"
              onClick={handleDeleteClick}
              className={cn(
                "relative inline-flex items-center gap-1.5 rounded-full px-2 py-1 transition-all duration-200",
                "opacity-0 group-hover:opacity-100",
                isConfirmingDelete
                  ? "bg-red-500/10 border border-red-500/50 text-red-400 hover:bg-red-500/20"
                  : isLightMode
                  ? "bg-black/5 border border-black/20 text-black hover:bg-black/10"
                  : "bg-zinc-800/50 border border-zinc-700/50 text-zinc-400 hover:bg-zinc-700/50 hover:text-zinc-300"
              )}
              title={isConfirmingDelete ? "Click again to confirm deletion" : "Delete campaign"}
            >
              <Trash2 className="h-3 w-3" aria-hidden="true" />
              {isConfirmingDelete && (
                <span className="text-xs font-semibold">Confirm?</span>
              )}
            </button>
          )}
        </div>
      </div>

      {/* Title & role */}
      <div className="mt-4 space-y-1.5 relative z-10">
        <h3 className={cn(
          "text-lg font-bold line-clamp-1 transition-colors",
          isLightMode ? "text-black" : "text-zinc-100 group-hover:text-amber-400"
        )}>
          {name}
        </h3>
        <p className={cn(
          "text-xs sm:text-sm",
          isLightMode ? "text-black/70" : "text-zinc-400"
        )}>
          Operating as{" "}
          <span className={cn(
            "font-mono",
            isLightMode ? "text-black font-semibold" : "text-zinc-300"
          )}>
            {role}
          </span>
        </p>
      </div>

      {/* Bottom strip: card metadata */}
      <div className={cn(
        "mt-4 flex items-center justify-between gap-3 border-t pt-3 text-[0.7rem] sm:text-xs relative z-10",
        isLightMode ? "border-black/20 text-black/60" : "border-zinc-800 text-zinc-400"
      )}>
        <div className="flex items-center gap-2">
          <span className={cn(
            "rounded-full px-2 py-0.5 font-mono text-[0.6rem] uppercase tracking-[0.16em]",
            isLightMode
              ? "bg-black/5 border border-black/20 text-black"
              : "bg-zinc-800 text-zinc-300"
          )}>
            ADVOCACY BUCKET
          </span>
          <span className={cn(
            "hidden sm:inline font-mono text-[0.6rem]",
            isLightMode ? "text-black/50" : "text-zinc-500"
          )}>
            Click to view impact and collaborators
          </span>
        </div>
        <span className={cn(
          "inline-flex items-center gap-1 font-mono text-[0.6rem]",
          isLightMode ? "text-black/60" : "text-zinc-500"
        )}>
          <span
            className={cn(
              "h-1 w-5 rounded-full",
              isLightMode
                ? "bg-black"
                : "bg-gradient-to-r from-[color:var(--accent)]/80 via-[color:var(--accent)] to-[color:var(--accent)]/60"
            )}
            aria-hidden="true"
          />
          {isArchived ? "ARCHIVED" : "ACTIVE"}
        </span>
      </div>
      </div>
    </motion.div>
  );

  if (onClick) {
    return (
      <button type="button" onClick={handleEnterClick} className="block w-full text-left">
        {cardContent}
      </button>
    );
  }

  return (
    <Link 
      href={href} 
      className="block w-full"
      onClick={handleEnterClick}
    >
      {cardContent}
    </Link>
  );
}


==================================================
FILE: next-frontend/src/components/campaign/AssetRow.tsx
==================================================
"use client";

import { useState } from "react";
import { useAuth } from "@clerk/nextjs";
import * as Popover from "@radix-ui/react-popover";
import {
  FileText,
  FileType2,
  Table,
  Presentation,
  Image as ImageIcon,
  MoreHorizontal,
  Loader2,
  Check,
  Plus,
  Download,
  Trash2,
  Brain,
  Sparkles,
  Pencil,
  Globe,
} from "lucide-react";
import { cn } from "@app/lib/utils";
import { Asset, AssetTag } from "@app/lib/types";
import { apiFetch } from "@app/lib/api";

interface AssetRowProps {
  asset: Asset;
  onTagChange: (assetId: string, tags: AssetTag[]) => void;
  onDelete: (assetId: string) => void;
  onDownload: (assetId: string) => void;
  onAIEnabledChange: (assetId: string, enabled: boolean) => void;
  onClick?: (asset: Asset) => void;
  onRename?: (asset: Asset) => void;
  onPromote?: (asset: Asset) => void;
}

// Helper function to determine if file type supports AI processing
function isAISupportedType(type: Asset["type"]): boolean {
  return type === "pdf" || type === "docx";
}

const allTags: AssetTag[] = ["Messaging", "Research", "Strategy", "Media", "Pitch", "Other"];

const tagColors: Record<AssetTag, { bg: string; text: string; border: string }> = {
  Messaging: {
    bg: "bg-purple-500/10",
    text: "text-purple-400",
    border: "border-purple-500/20",
  },
  Research: {
    bg: "bg-cyan-500/10",
    text: "text-cyan-400",
    border: "border-cyan-500/20",
  },
  Strategy: {
    bg: "bg-amber-500/10",
    text: "text-amber-400",
    border: "border-amber-500/20",
  },
  Media: {
    bg: "bg-pink-500/10",
    text: "text-pink-400",
    border: "border-pink-500/20",
  },
  Pitch: {
    bg: "bg-orange-500/10",
    text: "text-orange-400",
    border: "border-orange-500/20",
  },
  Other: {
    bg: "bg-slate-500/10",
    text: "text-slate-400",
    border: "border-slate-500/20",
  },
};

function getFileIcon(type: Asset["type"]) {
  switch (type) {
    case "pdf":
      return { icon: FileText, color: "text-red-500" };
    case "docx":
      return { icon: FileType2, color: "text-blue-500" };
    case "xlsx":
      return { icon: Table, color: "text-emerald-500" };
    case "pptx":
      return { icon: Presentation, color: "text-orange-500" };
    case "img":
      return { icon: ImageIcon, color: "text-purple-500" };
    default:
      return { icon: FileText, color: "text-zinc-500" };
  }
}

function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

// Helper function to check if a string looks like a UUID
function isUUID(str: string): boolean {
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i;
  return uuidRegex.test(str);
}

// Helper function to format filename for display
function formatFilename(name: string): string {
  // If it's a UUID, try to extract a meaningful part or show a generic name
  if (isUUID(name)) {
    // Extract file extension if present
    const extension = name.split(".").pop();
    if (extension && extension !== name) {
      return `File.${extension}`;
    }
    return "Uploaded File";
  }
  return name;
}

export function AssetRow({ asset, onTagChange, onDelete, onDownload, onAIEnabledChange, onClick, onRename, onPromote }: AssetRowProps) {
  const { getToken } = useAuth();
  const { icon: FileIcon, color: iconColor } = getFileIcon(asset.type);
  const [isUpdatingTags, setIsUpdatingTags] = useState(false);

  const handleTagToggle = async (tag: AssetTag) => {
    // Check if tag exists in current tags
    const currentTags = asset.tags || [];
    const tagExists = currentTags.includes(tag);
    
    // If tag exists: remove it, if not: add it
    const newTags = tagExists
      ? currentTags.filter((t) => t !== tag) // Remove tag
      : [...currentTags, tag]; // Add tag
    
    // Optimistic update: update local state immediately
    onTagChange(asset.id, newTags);
    
    // Persist to backend
    setIsUpdatingTags(true);
    try {
      const token = await getToken();
      if (!token) {
        throw new Error("Authentication required");
      }
      
      await apiFetch(`/api/v1/files/${asset.id}/tags`, {
        token,
        method: "PUT",
        body: { tags: newTags },
      });
    } catch (error) {
      // Revert on error
      onTagChange(asset.id, asset.tags);
      const errorMessage = error instanceof Error ? error.message : "Failed to update tags";
      console.error("Failed to update tags:", error);
      alert(`Failed to save tags: ${errorMessage}`);
    } finally {
      setIsUpdatingTags(false);
    }
  };

  return (
    <tr className="group border-b border-zinc-800/50 last:border-0 transition-colors hover:bg-zinc-800/50">
      {/* Icon */}
      <td className="px-6 py-4">
        <div className="flex items-center justify-center">
          {asset.status === "processing" ? (
            <Loader2 className="h-5 w-5 animate-spin text-zinc-400" />
          ) : (
            <FileIcon className={cn("h-5 w-5", iconColor)} />
          )}
        </div>
      </td>

      {/* Name */}
      <td className="px-6 py-4">
        <button
          type="button"
          onClick={() => onClick?.(asset)}
          className="font-medium text-zinc-100 hover:text-amber-400 transition-colors cursor-pointer text-left max-w-[300px] truncate block"
          title={asset.name} // Show full name on hover
        >
          {formatFilename(asset.name)}
        </button>
      </td>

      {/* Tags */}
      <td className="px-6 py-4">
        <div className="flex items-center gap-2">
          {/* Active Tags */}
          <div className="flex flex-wrap items-center gap-1.5">
            {asset.tags.map((tag) => (
              <span
                key={tag}
                className={cn(
                  "inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-xs font-medium",
                  tagColors[tag].bg,
                  tagColors[tag].text,
                  tagColors[tag].border
                )}
              >
                {tag}
              </span>
            ))}
          </div>

          {/* Tag Popover with Portal */}
          <Popover.Root>
            <Popover.Trigger asChild>
              <button
                type="button"
                className={cn(
                  "inline-flex items-center gap-1 rounded-md px-2 py-1 text-xs transition-opacity hover:text-zinc-100",
                  asset.tags.length === 0
                    ? "border border-zinc-700/50 bg-zinc-800/30 text-zinc-400 hover:border-zinc-600 hover:bg-zinc-800/50"
                    : "text-zinc-500 opacity-0 group-hover:opacity-100"
                )}
              >
                <Plus className="h-3 w-3" />
                Tag
              </button>
            </Popover.Trigger>
            <Popover.Portal>
              <Popover.Content
                sideOffset={5}
                align="start"
                className="z-50 w-48 rounded-lg border border-zinc-700 bg-zinc-900/95 backdrop-blur-md p-2 shadow-xl"
              >
                <div className="space-y-1">
                  {allTags.map((tag) => {
                    const isChecked = asset.tags.includes(tag);
                    return (
                      <label
                        key={tag}
                        className="flex cursor-pointer items-center gap-2 rounded-md px-3 py-2 text-sm text-zinc-100 transition-colors hover:bg-zinc-800"
                      >
                        <div className="relative flex h-4 w-4 items-center justify-center">
                          <input
                            type="checkbox"
                            checked={isChecked}
                            onChange={() => handleTagToggle(tag)}
                            className="sr-only"
                          />
                          <div
                            className={cn(
                              "flex h-4 w-4 items-center justify-center rounded border-2 transition-colors",
                              isChecked
                                ? cn(
                                    tagColors[tag].border,
                                    tagColors[tag].bg,
                                    "border-transparent"
                                  )
                                : "border-zinc-600 bg-transparent"
                            )}
                          >
                            {isChecked && (
                              <Check className={cn("h-3 w-3", tagColors[tag].text)} />
                            )}
                          </div>
                        </div>
                        <span className="flex-1">{tag}</span>
                      </label>
                    );
                  })}
                </div>
                <Popover.Arrow className="fill-zinc-700" />
              </Popover.Content>
            </Popover.Portal>
          </Popover.Root>
        </div>
      </td>

      {/* Meta */}
      <td className="px-6 py-4">
        <div className="space-y-0.5">
          <div className="text-sm text-zinc-500" suppressHydrationWarning>{formatDate(asset.uploadDate)}</div>
          <div className="text-xs text-zinc-500">{asset.size} â€¢ {asset.uploader}</div>
        </div>
      </td>

      {/* Riley's Memory (AI Toggle) */}
      <td className="px-6 py-4">
        <div className="flex items-center justify-center">
          {isAISupportedType(asset.type) ? (
            <button
              type="button"
              onClick={() => onAIEnabledChange(asset.id, !asset.aiEnabled)}
              className={cn(
                "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500/50 focus:ring-offset-2 focus:ring-offset-zinc-900",
                asset.aiEnabled
                  ? "bg-emerald-500/20 border border-emerald-500/30"
                  : "bg-zinc-800 border border-zinc-700"
              )}
              aria-label={asset.aiEnabled ? "Disable AI context" : "Enable AI context"}
            >
              <span
                className={cn(
                  "inline-block h-4 w-4 transform rounded-full bg-white transition-transform",
                  asset.aiEnabled ? "translate-x-6" : "translate-x-1"
                )}
              />
              <div className="absolute inset-0 flex items-center justify-center">
                {asset.aiEnabled ? (
                  <Brain className="h-3 w-3 text-emerald-400" />
                ) : (
                  <Brain className="h-3 w-3 text-zinc-500" />
                )}
              </div>
            </button>
          ) : (
            <div className="relative group">
              <button
                type="button"
                disabled
                className={cn(
                  "relative inline-flex h-6 w-11 items-center rounded-full bg-zinc-800/30 border border-zinc-700/50 opacity-50 cursor-not-allowed"
                )}
                aria-label="Media processing disabled for speed"
              >
                <span className="inline-block h-4 w-4 transform rounded-full bg-zinc-600 translate-x-1" />
                <div className="absolute inset-0 flex items-center justify-center">
                  <Brain className="h-3 w-3 text-zinc-600" />
                </div>
              </button>
              {/* Tooltip */}
              <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10">
                <div className="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-xs text-zinc-400 whitespace-nowrap shadow-xl">
                  Media processing disabled for speed
                  <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-zinc-800" />
                </div>
              </div>
            </div>
          )}
        </div>
      </td>

      {/* Actions */}
      <td className="px-6 py-4">
        <Popover.Root>
          <Popover.Trigger asChild>
            <button
              type="button"
              className="rounded-md p-1.5 text-zinc-400 transition-colors hover:bg-zinc-800 hover:text-zinc-100"
              aria-label="More actions"
            >
              <MoreHorizontal className="h-4 w-4" />
            </button>
          </Popover.Trigger>
          <Popover.Portal>
            <Popover.Content
              sideOffset={5}
              align="end"
              className="z-50 min-w-[150px] rounded-lg border border-zinc-800 bg-zinc-900 p-1 shadow-xl"
            >
              <div className="space-y-0.5">
                {onRename && (
                  <button
                    type="button"
                    onClick={() => {
                      onRename(asset);
                    }}
                    className="flex w-full items-center gap-2 rounded-md px-3 py-2 text-sm text-zinc-100 transition-colors hover:bg-zinc-800"
                  >
                    <Pencil className="h-4 w-4" />
                    Rename
                  </button>
                )}
                {onPromote && (
                  <button
                    type="button"
                    onClick={() => {
                      onPromote(asset);
                    }}
                    className="flex w-full items-center gap-2 rounded-md px-3 py-2 text-sm text-zinc-100 transition-colors hover:bg-zinc-800"
                  >
                    <Globe className="h-4 w-4" />
                    Promote to Archive
                  </button>
                )}
                <button
                  type="button"
                  onClick={() => {
                    onDownload(asset.id);
                  }}
                  className="flex w-full items-center gap-2 rounded-md px-3 py-2 text-sm text-zinc-100 transition-colors hover:bg-zinc-800"
                >
                  <Download className="h-4 w-4" />
                  Download
                </button>
                <button
                  type="button"
                  onClick={() => {
                    onDelete(asset.id);
                  }}
                  className="flex w-full items-center gap-2 rounded-md px-3 py-2 text-sm text-red-400 transition-colors hover:bg-zinc-800"
                >
                  <Trash2 className="h-4 w-4" />
                  Delete
                </button>
              </div>
              <Popover.Arrow className="fill-zinc-800" />
            </Popover.Content>
          </Popover.Portal>
        </Popover.Root>
      </td>
    </tr>
  );
}



==================================================
FILE: next-frontend/src/components/campaign/KanbanBoard.tsx
==================================================
"use client";

import { useState } from "react";
import {
  DndContext,
  DragOverlay,
  closestCorners,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragStartEvent,
  DragEndEvent,
  useDroppable,
} from "@dnd-kit/core";
import {
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
  useSortable,
} from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";
import { FileText, FileType2, Table, Presentation, Image as ImageIcon, Plus } from "lucide-react";
import { cn } from "@app/lib/utils";
import { KanbanCard, KanbanStatus, Asset } from "@app/lib/types";
import { DocumentViewer } from "@app/components/ui/DocumentViewer";

interface KanbanBoardProps {
  cards: KanbanCard[];
  onStatusChange: (cardId: string, newStatus: KanbanStatus) => void;
  onCardClick?: (card: KanbanCard) => void;
  onManageAssignees?: (card: KanbanCard) => void;
}

type ColumnType = "Draft" | "Needs Review" | "In Review" | "Completed";

interface Column {
  id: ColumnType;
  label: string;
  emoji: string;
  borderColor: string;
  bgGlow?: string;
}

const columns: Column[] = [
  {
    id: "Draft",
    label: "Draft",
    emoji: "ðŸ“",
    borderColor: "border-l-4 border-zinc-700",
  },
  {
    id: "Needs Review",
    label: "Needs Review",
    emoji: "ðŸ”",
    borderColor: "border-l-4 border-yellow-500",
    bgGlow: "bg-yellow-500/5",
  },
  {
    id: "In Review",
    label: "In Review",
    emoji: "ðŸ‘€",
    borderColor: "border-l-4 border-amber-400",
    bgGlow: "bg-amber-500/5",
  },
  {
    id: "Completed",
    label: "Completed",
    emoji: "âœ…",
    borderColor: "border-l-4 border-emerald-500",
  },
];

function getFileIcon(type: KanbanCard["type"]) {
  switch (type) {
    case "pdf":
      return { icon: FileText, color: "text-red-500" };
    case "docx":
      return { icon: FileType2, color: "text-blue-500" };
    case "xlsx":
      return { icon: Table, color: "text-emerald-500" };
    case "pptx":
      return { icon: Presentation, color: "text-orange-500" };
    case "img":
      return { icon: ImageIcon, color: "text-purple-500" };
    default:
      return { icon: FileText, color: "text-zinc-500" };
  }
}

interface KanbanCardComponentProps {
  card: KanbanCard;
  onClick: () => void;
  onManageAssignees?: (card: KanbanCard) => void;
}

function KanbanCardComponent({ card, onClick, onManageAssignees }: KanbanCardComponentProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: card.id });

  const { icon: FileIcon, color: iconColor } = getFileIcon(card.type);

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    scale: isDragging ? 1.05 : 1,
  };

  // Separate click handler that doesn't interfere with drag
  const handleClick = (e: React.MouseEvent) => {
    // Only fire onClick if we're not dragging
    if (!isDragging) {
      onClick();
    }
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      onClick={handleClick}
      className={cn(
        "cursor-grab active:cursor-grabbing rounded-lg border border-slate-700 bg-slate-900 p-4 shadow-lg transition-all hover:shadow-xl",
        isDragging && "scale-105 ring-2 ring-amber-400/50 shadow-2xl"
      )}
    >
      {/* Card Header */}
      <div className="mb-3 flex items-start gap-2">
        <FileIcon className={cn("h-4 w-4 flex-shrink-0 mt-0.5", iconColor)} aria-hidden="true" />
        <h4 className="flex-1 text-sm font-medium text-zinc-100 break-words">{card.name}</h4>
      </div>

      {/* Team Avatars */}
      <div className="flex items-center gap-2">
        <div className="flex -space-x-2">
          {card.assignees.map((initials, idx) => (
            <div
              key={idx}
              className="flex h-7 w-7 items-center justify-center rounded-full border-2 border-zinc-800 bg-zinc-700 text-xs font-medium text-zinc-100"
              title={initials}
            >
              {initials}
            </div>
          ))}
        </div>
        {onManageAssignees && (
          <button
            onClick={(e) => {
              e.stopPropagation();
              onManageAssignees(card);
            }}
            className="flex h-7 w-7 items-center justify-center rounded-full border border-zinc-700 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 hover:text-zinc-100 transition-colors flex-shrink-0"
            aria-label="Manage assignees"
            title="Manage team"
          >
            <Plus className="h-3.5 w-3.5" />
          </button>
        )}
      </div>
    </div>
  );
}

interface ColumnComponentProps {
  column: Column;
  cards: KanbanCard[];
  onCardClick: (card: KanbanCard) => void;
  onManageAssignees?: (card: KanbanCard) => void;
}

function ColumnComponent({ column, cards, onCardClick, onManageAssignees }: ColumnComponentProps) {
  const { setNodeRef } = useDroppable({
    id: column.id,
  });

  const cardIds = cards.map((card) => card.id);

  const hasCards = cards.length > 0;

  return (
    <div
      ref={setNodeRef}
      className={cn(
        "flex flex-col min-w-[320px] max-h-full rounded-xl border-l-4 p-4 flex-shrink-0 bg-[#0b1120] border border-slate-800 shadow-xl",
        hasCards
          ? "border-l-amber-400 bg-amber-400/5"
          : "border-l-slate-800"
      )}
    >
      {/* Column Header */}
      <div className="mb-4 flex items-center gap-2 flex-shrink-0 bg-transparent">
        <span className="text-lg">{column.emoji}</span>
        <h3 className="text-sm font-semibold text-zinc-100">{column.label}</h3>
        <span className="ml-auto rounded-full bg-zinc-800/60 px-2 py-0.5 text-xs font-medium text-zinc-400">
          {cards.length}
        </span>
      </div>

      {/* Cards */}
      <SortableContext items={cardIds} strategy={verticalListSortingStrategy}>
        <div className="flex-1 space-y-3 overflow-y-auto overflow-x-hidden scrollbar-thin min-h-0" style={{ WebkitOverflowScrolling: "touch" }}>
          {cards.map((card) => (
            <KanbanCardComponent 
              key={card.id} 
              card={card} 
              onClick={() => onCardClick(card)}
              onManageAssignees={onManageAssignees}
            />
          ))}
        </div>
      </SortableContext>
    </div>
  );
}

// Convert KanbanCard to DocumentViewer format
function convertToDocumentViewerFile(card: KanbanCard) {
  // Map KanbanStatus to Asset status
  const statusMap: Record<KanbanCard["status"], Asset["status"]> = {
    "Draft": "in_progress",
    "Needs Review": "needs_review",
    "In Review": "in_review",
    "Completed": "approved",
  };
  
  return {
    id: card.id,
    name: card.name,
    type: card.type,
    url: card.url,
    status: statusMap[card.status] || "in_progress",
    uploader: "Team Member",
    size: "Unknown",
    uploadDate: new Date().toISOString().split("T")[0],
  };
}

export function KanbanBoard({ cards, onStatusChange, onCardClick, onManageAssignees }: KanbanBoardProps) {
  const [activeCard, setActiveCard] = useState<KanbanCard | null>(null);
  const [selectedCard, setSelectedCard] = useState<KanbanCard | null>(null);
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 5, // Require 5px movement before drag starts (allows clicks to work)
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  // Group cards by status
  const cardsByStatus = columns.reduce(
    (acc, column) => {
      acc[column.id] = cards.filter((card) => card.status === column.id);
      return acc;
    },
    {} as Record<ColumnType, KanbanCard[]>
  );

  const handleDragStart = (event: DragStartEvent) => {
    const { active } = event;
    const card = cards.find((c) => c.id === active.id);
    setActiveCard(card || null);
  };

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;
    setActiveCard(null);

    if (!over) return;

    const activeId = active.id as string;
    const overId = over.id as string;

    // Find target column
    const targetColumn = columns.find((col) => col.id === overId) || 
      columns.find((col) => cardsByStatus[col.id].some((card) => card.id === overId));

    if (!targetColumn) return;

    // Find source card
    const sourceCard = cards.find((c) => c.id === activeId);
    if (!sourceCard || sourceCard.status === targetColumn.id) return;

    // Direct status update - always update immediately on drag
    onStatusChange(activeId, targetColumn.id);
  };

  const handleCardClick = (card: KanbanCard) => {
    if (onCardClick) {
      // If parent provides onCardClick, use it (parent handles viewer)
      onCardClick(card);
    } else {
      // Otherwise, use internal viewer
      setSelectedCard(card);
    }
  };

  const handleCloseViewer = () => {
    setSelectedCard(null);
  };

  return (
    <>
      <DndContext
        sensors={sensors}
        collisionDetection={closestCorners}
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        <div className="flex h-full overflow-x-auto overflow-y-hidden gap-6 p-6 min-w-0 scrollbar-thin" style={{ WebkitOverflowScrolling: "touch" }}>
          {columns.map((column) => (
            <ColumnComponent
              key={column.id}
              column={column}
              cards={cardsByStatus[column.id] || []}
              onCardClick={handleCardClick}
              onManageAssignees={onManageAssignees}
            />
          ))}
        </div>

        <DragOverlay>
          {activeCard ? (
            <div className="rounded-lg border border-zinc-700/50 bg-zinc-800/80 backdrop-blur-sm p-4 shadow-2xl">
              <div className="mb-3 flex items-start gap-2">
                {(() => {
                  const { icon: FileIcon, color } = getFileIcon(activeCard.type);
                  return <FileIcon className={cn("h-4 w-4 flex-shrink-0 mt-0.5", color)} />;
                })()}
                <h4 className="flex-1 text-sm font-medium text-zinc-100">{activeCard.name}</h4>
              </div>
            </div>
          ) : null}
        </DragOverlay>
      </DndContext>

      {/* Document Viewer Modal - Only show if parent doesn't handle clicks */}
      {!onCardClick && selectedCard && (
        <DocumentViewer
          file={convertToDocumentViewerFile(selectedCard)}
          onClose={handleCloseViewer}
          variant="modal"
        />
      )}
    </>
  );
}


==================================================
FILE: next-frontend/src/components/campaign/AssignmentModal.tsx
==================================================
"use client";

import { useState, useEffect } from "react";
import { X, User, Check } from "lucide-react";
import { cn } from "@app/lib/utils";

interface AssignmentModalProps {
  isOpen: boolean;
  fileName: string;
  onClose: () => void;
  onConfirm: (userIds: string[]) => void;
  currentAssignees?: string[]; // Array of user IDs like ["sarah", "john"]
}

// Mock users - in production, this would come from the backend
const mockUsers = [
  { id: "anova", name: "Anova", initials: "AK", isMe: true },
  { id: "sarah", name: "Sarah", initials: "SJ", isMe: false },
  { id: "john", name: "John", initials: "JD", isMe: false },
];

export function AssignmentModal({
  isOpen,
  fileName,
  onClose,
  onConfirm,
  currentAssignees = [],
}: AssignmentModalProps) {
  // Track selected users (initialize from currentAssignees)
  const [selectedUsers, setSelectedUsers] = useState<Set<string>>(new Set(currentAssignees));

  // Update selection when currentAssignees changes (when modal opens)
  useEffect(() => {
    if (isOpen) {
      setSelectedUsers(new Set(currentAssignees));
    }
  }, [isOpen, currentAssignees]);

  if (!isOpen) return null;

  // Toggle user selection
  const handleUserToggle = (userId: string) => {
    setSelectedUsers((prev) => {
      const next = new Set(prev);
      if (next.has(userId)) {
        next.delete(userId);
      } else {
        next.add(userId);
      }
      return next;
    });
  };

  // Handle confirm - pass array of selected user IDs
  const handleConfirm = () => {
    onConfirm(Array.from(selectedUsers));
    onClose();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
      <div className="w-full max-w-md rounded-xl border border-zinc-800 bg-zinc-900 shadow-2xl">
        {/* Header */}
        <div className="flex items-center justify-between border-b border-zinc-800 p-6">
          <h2 className="text-lg font-semibold text-zinc-100">Manage Team</h2>
          <button
            onClick={onClose}
            className="text-zinc-500 hover:text-zinc-100 transition-colors"
            aria-label="Close"
          >
            <X className="h-5 w-5" />
          </button>
        </div>

        {/* Body */}
        <div className="p-6">
          <p className="text-sm text-zinc-400 mb-6">
            Select team members for <span className="font-medium text-zinc-100">{fileName}</span>
          </p>

          {/* User List */}
          <div className="space-y-2">
            {mockUsers.map((user) => {
              const isSelected = selectedUsers.has(user.id);
              return (
                <button
                  key={user.id}
                  onClick={() => handleUserToggle(user.id)}
                  className={cn(
                    "w-full flex items-center gap-3 p-4 rounded-lg border transition-colors",
                    isSelected
                      ? user.isMe
                        ? "border-amber-500/70 bg-amber-500/15 hover:border-amber-500/90 hover:bg-amber-500/20"
                        : "border-amber-500/50 bg-amber-500/10 hover:border-amber-500/70 hover:bg-amber-500/15"
                      : user.isMe
                      ? "border-amber-500/30 bg-amber-500/5 hover:border-amber-500/50 hover:bg-amber-500/10"
                      : "border-zinc-800 bg-zinc-900/50 hover:border-amber-500/50 hover:bg-amber-500/10",
                    "text-left"
                  )}
                >
                  {/* Checkbox */}
                  <div
                    className={cn(
                      "flex-shrink-0 h-5 w-5 rounded border-2 flex items-center justify-center transition-colors",
                      isSelected
                        ? "border-amber-500 bg-amber-500"
                        : "border-zinc-600 bg-transparent"
                    )}
                  >
                    {isSelected && <Check className="h-3 w-3 text-zinc-900" />}
                  </div>

                  {/* Avatar */}
                  <div
                    className={cn(
                      "flex-shrink-0 h-10 w-10 rounded-full border-2 flex items-center justify-center text-sm font-medium",
                      isSelected
                        ? user.isMe
                          ? "border-amber-500/70 bg-amber-500/30 text-amber-200"
                          : "border-amber-500/50 bg-amber-500/20 text-amber-300"
                        : user.isMe
                        ? "border-amber-500/30 bg-amber-500/10 text-amber-400"
                        : "border-zinc-700 bg-zinc-800 text-zinc-300"
                    )}
                  >
                    {user.initials}
                  </div>

                  {/* Name */}
                  <div className="flex-1">
                    <p className="text-sm font-medium text-zinc-100">
                      {user.isMe ? "Me" : user.name}
                      {user.isMe && <span className="ml-2 text-xs text-amber-400">({user.name})</span>}
                    </p>
                    <p className="text-xs text-zinc-500">
                      {user.isMe ? "Assign to yourself" : "Team Member"}
                    </p>
                  </div>
                </button>
              );
            })}
          </div>
        </div>

        {/* Footer */}
        <div className="flex items-center justify-end gap-3 border-t border-zinc-800 p-6">
          <button
            onClick={onClose}
            className="px-4 py-2 text-sm font-medium text-zinc-400 hover:text-zinc-100 transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={handleConfirm}
            className="px-4 py-2 text-sm font-medium bg-amber-500 hover:bg-amber-600 text-zinc-900 rounded-md transition-colors"
          >
            Update Team
          </button>
        </div>
      </div>
    </div>
  );
}



==================================================
FILE: next-frontend/src/components/campaign/PromoteModal.tsx
==================================================
"use client";

import { useState } from "react";
import { X, Globe, Sparkles } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { cn } from "@app/lib/utils";

interface PromoteModalProps {
  isOpen: boolean;
  onClose: () => void;
  onPromote: (isGolden: boolean) => Promise<void>;
  fileName: string;
}

export function PromoteModal({
  isOpen,
  onClose,
  onPromote,
  fileName,
}: PromoteModalProps) {
  const [isGolden, setIsGolden] = useState(false);
  const [isPromoting, setIsPromoting] = useState(false);

  const handlePromote = async () => {
    setIsPromoting(true);
    try {
      await onPromote(isGolden);
      onClose();
      setIsGolden(false); // Reset for next time
    } catch (error) {
      console.error("Promote error:", error);
      alert(`Failed to promote file: ${error instanceof Error ? error.message : "Unknown error"}`);
    } finally {
      setIsPromoting(false);
    }
  };

  if (!isOpen) return null;

  return (
    <AnimatePresence>
      <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
        {/* Backdrop */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="absolute inset-0 bg-black/60 backdrop-blur-sm"
          onClick={onClose}
        />

        {/* Modal */}
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          exit={{ opacity: 0, scale: 0.95 }}
          transition={{ duration: 0.2 }}
          className="relative w-full max-w-md rounded-xl border border-zinc-800 bg-zinc-900/95 backdrop-blur-xl shadow-2xl"
          onClick={(e) => e.stopPropagation()}
        >
          {/* Header */}
          <div className="flex items-center justify-between border-b border-zinc-800 px-6 py-4">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-400/10 border border-blue-400/20">
                <Globe className="h-5 w-5 text-blue-400" />
              </div>
              <div>
                <h2 className="text-lg font-semibold text-zinc-100">Add to Rally Archive</h2>
                <p className="text-xs text-zinc-400">Promote to Global Firm Archive</p>
              </div>
            </div>
            <button
              type="button"
              onClick={onClose}
              disabled={isPromoting}
              className="rounded-lg p-1.5 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <X className="h-5 w-5" />
            </button>
          </div>

          {/* Content */}
          <div className="p-6 space-y-4">
            <p className="text-sm text-zinc-300">
              This makes the document visible to the entire firm via Global Riley.
            </p>

            {/* Golden Standard Toggle */}
            <label
              className={cn(
                "flex items-start gap-3 p-4 rounded-lg border cursor-pointer transition-colors",
                isGolden
                  ? "border-amber-500/50 bg-amber-500/10"
                  : "border-zinc-700 bg-zinc-800/30 hover:bg-zinc-800/50"
              )}
            >
              <div className="relative flex h-5 w-5 items-center justify-center flex-shrink-0 mt-0.5">
                <input
                  type="checkbox"
                  checked={isGolden}
                  onChange={(e) => setIsGolden(e.target.checked)}
                  className="sr-only"
                />
                <div
                  className={cn(
                    "flex h-5 w-5 items-center justify-center rounded border-2 transition-colors",
                    isGolden
                      ? "border-amber-500 bg-amber-500/20"
                      : "border-zinc-600 bg-transparent"
                  )}
                >
                  {isGolden && (
                    <Sparkles className="h-3 w-3 text-amber-400" />
                  )}
                </div>
              </div>
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium text-zinc-100">
                    ðŸŒŸ Mark as Golden Standard
                  </span>
                </div>
                <p className="mt-1 text-xs text-zinc-400">
                  High Priority Learning - This document will be prioritized in Global Riley's training.
                </p>
              </div>
            </label>
          </div>

          {/* Footer */}
          <div className="flex items-center justify-end gap-3 border-t border-zinc-800 px-6 py-4">
            <button
              type="button"
              onClick={onClose}
              disabled={isPromoting}
              className="rounded-lg border border-zinc-700 bg-transparent px-4 py-2 text-sm font-medium text-zinc-300 transition-colors hover:bg-zinc-800 hover:text-zinc-100 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Cancel
            </button>
            <button
              type="button"
              onClick={handlePromote}
              disabled={isPromoting}
              className={cn(
                "rounded-lg border border-blue-500/20 bg-blue-500/10 px-4 py-2 text-sm font-medium text-blue-400",
                "transition-colors hover:bg-blue-500/20 hover:border-blue-500/30",
                "disabled:opacity-50 disabled:cursor-not-allowed"
              )}
            >
              {isPromoting ? "Promoting..." : "Promote"}
            </button>
          </div>
        </motion.div>
      </div>
    </AnimatePresence>
  );
}


==================================================
FILE: next-frontend/src/components/campaign/DeleteFileModal.tsx
==================================================
"use client";

import { useState } from "react";
import { X, Trash2, AlertTriangle, Loader2 } from "lucide-react";
import { Asset } from "@app/lib/types";
import { cn } from "@app/lib/utils";

interface DeleteFileModalProps {
  isOpen: boolean;
  onClose: () => void;
  file: Asset | null;
  currentContext: "assets" | "messaging" | "research" | "strategy" | "pitch";
  onDelete: (fileId: string, isGlobal: boolean) => Promise<void>;
}

type Step = "selection" | "confirmation";

export function DeleteFileModal({
  isOpen,
  onClose,
  file,
  currentContext,
  onDelete,
}: DeleteFileModalProps) {
  const [step, setStep] = useState<Step>("selection");
  const [isDeleting, setIsDeleting] = useState(false);

  if (!isOpen || !file) return null;

  const handleLocalDelete = async () => {
    if (!file) return;
    
    setIsDeleting(true);
    try {
      await onDelete(file.id, false);
      onClose();
      setStep("selection");
    } catch (error) {
      console.error("Failed to remove tag:", error);
      alert("Failed to remove file from this view. Please try again.");
    } finally {
      setIsDeleting(false);
    }
  };

  const handleGlobalDelete = async () => {
    if (!file) return;
    
    setIsDeleting(true);
    try {
      await onDelete(file.id, true);
      onClose();
      setStep("selection");
    } catch (error) {
      console.error("Failed to delete file:", error);
      alert("Failed to delete file. Please try again.");
    } finally {
      setIsDeleting(false);
    }
  };

  const handleBack = () => {
    setStep("selection");
  };

  // Map context to display name
  const contextName = {
    assets: "Assets Vault",
    messaging: "Messaging",
    research: "Research",
    strategy: "Strategy",
    pitch: "Pitch & Intake",
  }[currentContext];

  // In Assets context: show selection if file has tags, otherwise skip to confirmation
  const shouldSkipSelection = currentContext === "assets" && (!file.tags || file.tags.length === 0);
  const hasTags = file.tags && file.tags.length > 0;

  return (
    <div
      className={cn(
        "fixed inset-0 z-50 flex items-center justify-center",
        isOpen ? "opacity-100" : "opacity-0 pointer-events-none"
      )}
      onClick={(e) => {
        if (e.target === e.currentTarget) {
          onClose();
        }
      }}
    >
      {/* Backdrop */}
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" />

      {/* Modal */}
      <div className="relative z-50 w-full max-w-md rounded-xl border border-zinc-800 bg-zinc-950 shadow-2xl">
        {/* Header */}
        <div className="flex items-center justify-between border-b border-zinc-800 p-6">
          <h2 className="text-xl font-semibold text-zinc-100">
            {step === "confirmation" ? (
              <>
                <AlertTriangle className="mr-2 inline-block h-5 w-5 text-red-500" />
                Irreversible Action
              </>
            ) : (
              `Delete ${file.name}?`
            )}
          </h2>
          <button
            type="button"
            onClick={onClose}
            className="rounded-md p-1.5 text-zinc-400 transition-colors hover:bg-zinc-800 hover:text-zinc-100"
            disabled={isDeleting}
          >
            <X className="h-5 w-5" />
          </button>
        </div>

        {/* Content */}
        <div className="p-6">
          {step === "selection" && !shouldSkipSelection ? (
            <>
              {currentContext === "assets" && hasTags ? (
                <>
                  <p className="mb-2 text-sm text-zinc-300">
                    This file is currently active in:
                  </p>
                  <div className="mb-4 flex flex-wrap gap-2">
                    {file.tags.map((tag) => (
                      <span
                        key={tag}
                        className="rounded-full border border-zinc-700 bg-zinc-900/50 px-2 py-1 text-xs text-zinc-300"
                      >
                        {tag}
                      </span>
                    ))}
                  </div>
                  <p className="mb-6 text-sm text-zinc-400">
                    Choose how you want to manage this file:
                  </p>

                  {/* Option A: Remove from Workstreams */}
                  <button
                    type="button"
                    onClick={handleLocalDelete}
                    disabled={isDeleting}
                    className={cn(
                      "mb-3 w-full rounded-lg border border-zinc-700 bg-zinc-900/50 px-4 py-3 text-left transition-colors",
                      "hover:bg-zinc-900 hover:border-zinc-600",
                      "disabled:opacity-50 disabled:cursor-not-allowed"
                    )}
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="font-medium text-zinc-100">
                          Remove from these Workstreams only
                        </div>
                        <div className="mt-1 text-xs text-zinc-500">
                          Removes all tags from this file. File remains in the
                          Assets Vault but disappears from all workstream tabs.
                        </div>
                      </div>
                      {isDeleting && (
                        <Loader2 className="h-4 w-4 animate-spin text-zinc-400" />
                      )}
                    </div>
                  </button>
                </>
              ) : (
                <p className="mb-6 text-sm text-zinc-400">
                  Choose how you want to remove this file:
                </p>
              )}

              {/* Option B: Local Delete (Remove from Context) - Only for workstream pages */}
              {currentContext !== "assets" && (
                <button
                  type="button"
                  onClick={handleLocalDelete}
                  disabled={isDeleting}
                  className={cn(
                    "mb-3 w-full rounded-lg border border-zinc-700 bg-zinc-900/50 px-4 py-3 text-left transition-colors",
                    "hover:bg-zinc-900 hover:border-zinc-600",
                    "disabled:opacity-50 disabled:cursor-not-allowed"
                  )}
                >
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="font-medium text-zinc-100">
                        Remove from {contextName}
                      </div>
                      <div className="mt-1 text-xs text-zinc-500">
                        Removes this file from the {contextName} view only. File
                        remains in the Vault and other workstreams.
                      </div>
                    </div>
                    {isDeleting && (
                      <Loader2 className="h-4 w-4 animate-spin text-zinc-400" />
                    )}
                  </div>
                </button>
              )}

              {/* Option C: Global Delete */}
              <button
                type="button"
                onClick={() => setStep("confirmation")}
                disabled={isDeleting}
                className={cn(
                  "w-full rounded-lg border border-red-500/30 bg-red-500/10 px-4 py-3 text-left transition-colors",
                  "hover:bg-red-500/20 hover:border-red-500/50",
                  "disabled:opacity-50 disabled:cursor-not-allowed"
                )}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium text-red-400">
                      {currentContext === "assets" ? "Delete from System" : "Delete from Everywhere"}
                    </div>
                    <div className="mt-1 text-xs text-zinc-500">
                      Permanently deletes the file from disk, Qdrant, and all
                      workstreams. This cannot be undone.
                    </div>
                  </div>
                  <Trash2 className="h-4 w-4 text-red-400" />
                </div>
              </button>
            </>
          ) : (
            <>
              {/* Confirmation Step */}
              <div className="mb-6">
                <p className="mb-2 text-sm text-zinc-300">
                  This will permanently delete{" "}
                  <span className="font-semibold text-zinc-100">
                    {file.name}
                  </span>{" "}
                  from:
                </p>
                <ul className="ml-4 list-disc space-y-1 text-sm text-zinc-400">
                  <li>The Assets Vault</li>
                  <li>All active workstreams (Messaging, Research, Strategy, Pitch)</li>
                  <li>Qdrant vector database</li>
                  <li>Disk storage</li>
                </ul>
                <p className="mt-4 text-sm font-medium text-red-400">
                  âš ï¸ This action cannot be undone.
                </p>
              </div>

              {/* Actions */}
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={shouldSkipSelection ? onClose : handleBack}
                  disabled={isDeleting}
                  className={cn(
                    "flex-1 rounded-lg border border-zinc-700 bg-zinc-900/50 px-4 py-2.5 font-medium text-zinc-300 transition-colors",
                    "hover:bg-zinc-900 hover:text-zinc-100",
                    "disabled:opacity-50 disabled:cursor-not-allowed"
                  )}
                >
                  Cancel
                </button>
                <button
                  type="button"
                  onClick={handleGlobalDelete}
                  disabled={isDeleting}
                  className={cn(
                    "flex-1 rounded-lg border border-red-500/50 bg-red-500/20 px-4 py-2.5 font-medium text-red-400 transition-colors",
                    "hover:bg-red-500/30 hover:border-red-500",
                    "disabled:opacity-50 disabled:cursor-not-allowed",
                    "flex items-center justify-center gap-2"
                  )}
                >
                  {isDeleting ? (
                    <>
                      <Loader2 className="h-4 w-4 animate-spin" />
                      Deleting...
                    </>
                  ) : (
                    <>
                      <Trash2 className="h-4 w-4" />
                      Yes, Delete Everything
                    </>
                  )}
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  );
}



==================================================
FILE: next-frontend/src/components/ui/ScrambleText.tsx
==================================================
"use client";

import React, { useState, useEffect, useRef } from "react";
import { cn } from "@app/lib/utils";

interface ScrambleTextProps {
  text: string;
  className?: string;
  scrambleChars?: string[];
  duration?: number; // Duration of scramble animation in ms
  trigger?: "mount" | "hover" | "both";
}

const DEFAULT_SCRAMBLE_CHARS = ["X", "/", "#", "@", "&", "%", "$", "?"];

/**
 * ScrambleText - Easter Egg Text Component
 * 
 * Cycles through random characters before revealing the real text.
 * Perfect for headings and special UI elements.
 */
export function ScrambleText({
  text,
  className,
  scrambleChars = DEFAULT_SCRAMBLE_CHARS,
  duration = 1000,
  trigger = "mount",
}: ScrambleTextProps) {
  const [displayText, setDisplayText] = useState<string>(text);
  const [isScrambling, setIsScrambling] = useState(false);
  const intervalRef = useRef<NodeJS.Timeout | null>(null);
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const scramble = () => {
    if (isScrambling) return;
    
    setIsScrambling(true);
    const chars = text.split("");
    let iterations = 0;
    const maxIterations = Math.max(text.length, 10);

    intervalRef.current = setInterval(() => {
      setDisplayText(
        chars
          .map((char, index) => {
            // Skip spaces
            if (char === " ") return " ";
            
            // Reveal characters progressively
            if (index < iterations) {
              return char;
            }
            
            // Scramble remaining characters
            return scrambleChars[Math.floor(Math.random() * scrambleChars.length)];
          })
          .join("")
      );

      iterations += 1 / 3; // Smooth reveal

      if (iterations >= maxIterations) {
        if (intervalRef.current) {
          clearInterval(intervalRef.current);
          intervalRef.current = null;
        }
        setDisplayText(text);
        setIsScrambling(false);
      }
    }, duration / maxIterations);
  };

  // Cleanup on unmount
  useEffect(() => {
    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);

  // Trigger on mount
  useEffect(() => {
    if (trigger === "mount" || trigger === "both") {
      // Small delay for better UX
      timeoutRef.current = setTimeout(() => {
        scramble();
      }, 100);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [trigger]); // Only trigger on mount/trigger change, not text change

  const handleMouseEnter = () => {
    if (trigger === "hover" || trigger === "both") {
      scramble();
    }
  };

  return (
    <span
      className={cn("inline-block", className)}
      onMouseEnter={handleMouseEnter}
    >
      {displayText}
    </span>
  );
}


==================================================
FILE: next-frontend/src/components/ui/RileyOrb.tsx
==================================================
"use client";

import { useState, useRef, useEffect } from "react";
import { Bot, Sparkles, X, AlertCircle, Calendar, FileText, ChevronUp } from "lucide-react";
import { cn } from "@app/lib/utils";
import { motion, AnimatePresence } from "framer-motion";

type Notification = {
  id: string;
  type: "slack" | "calendar" | "system";
  icon: React.ReactNode;
  message: string;
  isCritical?: boolean;
};

// Felix Scenario - High-Value Alerts
const mockNotifications: Notification[] = [
  {
    id: "1",
    type: "slack",
    icon: <AlertCircle className="h-4 w-4" />,
    message: "Felix (CEO) posted in #general: 'Q4 Strategy shift - all hands on deck.'",
    isCritical: true,
  },
  {
    id: "2",
    type: "calendar",
    icon: <Calendar className="h-4 w-4" />,
    message: "Client Review: Clean Water Campaign starts in 15 mins.",
    isCritical: false,
  },
  {
    id: "3",
    type: "system",
    icon: <FileText className="h-4 w-4" />,
    message: "3 New Documents uploaded to Housing Justice.",
    isCritical: false,
  },
];

export function RileyOrb() {
  const [isOpen, setIsOpen] = useState(false);
  const [notifications] = useState<Notification[]>(mockNotifications);
  const popoverRef = useRef<HTMLDivElement>(null);

  // Close popover when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (popoverRef.current && !popoverRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }

    if (isOpen) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [isOpen]);

  const alertCount = notifications.length;

  return (
    <div className="fixed bottom-6 right-6 z-50" ref={popoverRef}>
      {/* Orb Button */}
      <motion.button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="relative flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 shadow-lg transition-all hover:shadow-xl hover:scale-105"
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
        aria-label="Intelligence Feed"
      >
        {/* Pulsing Glow Effect */}
        <motion.div
          className="absolute inset-0 rounded-full bg-blue-400/30"
          animate={{
            scale: [1, 1.2, 1],
            opacity: [0.5, 0.3, 0.5],
          }}
          transition={{
            duration: 2,
            repeat: Infinity,
            ease: "easeInOut",
          }}
        />
        <Bot className="relative h-6 w-6 text-white" />
      </motion.button>

      {/* Popover Panel - Notification Feed */}
      <AnimatePresence>
        {isOpen && (
          <motion.div
            initial={{ opacity: 0, scale: 0.95, y: 10 }}
            animate={{ opacity: 1, scale: 1, y: 0 }}
            exit={{ opacity: 0, scale: 0.95, y: 10 }}
            transition={{ duration: 0.2 }}
            className="absolute bottom-20 right-0 w-96 rounded-2xl border border-zinc-800 bg-zinc-900/95 backdrop-blur-xl shadow-2xl"
          >
            {/* Header */}
            <div className="flex items-center justify-between border-b border-zinc-800 bg-zinc-900/50 px-5 py-4">
              <div className="flex items-center gap-3">
                <div className="relative">
                  <div className="absolute inset-0 animate-pulse rounded-full bg-blue-400/20 blur-md" />
                  <div className="relative flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-indigo-600">
                    <Bot className="h-5 w-5 text-white" />
                  </div>
                </div>
                <div>
                  <h3 className="text-sm font-semibold text-zinc-100">Intelligence Feed</h3>
                  <p className="text-xs text-zinc-400">Scanning for high-priority updates...</p>
                </div>
              </div>
              <button
                type="button"
                onClick={() => setIsOpen(false)}
                className="rounded-lg p-1.5 text-zinc-400 hover:bg-zinc-800 hover:text-zinc-100 transition-colors"
                aria-label="Close"
              >
                <X className="h-4 w-4" />
              </button>
            </div>

            {/* Notifications Feed - Read Only */}
            <div className="max-h-[500px] overflow-y-auto p-4 [&::-webkit-scrollbar]:hidden [-ms-overflow-style:'none'] [scrollbar-width:'none']">
              {notifications.length === 0 ? (
                /* Zero State */
                <div className="flex flex-col items-center justify-center py-12 text-center">
                  <div className="text-4xl mb-3">ðŸŽ‰</div>
                  <p className="text-sm text-zinc-400">
                    You're all caught up! No new alerts.
                  </p>
                </div>
              ) : (
                <div className="space-y-3">
                  {notifications.map((notification) => (
                    <div
                      key={notification.id}
                      className={cn(
                        "rounded-lg border p-3 transition-all hover:border-zinc-700",
                        notification.isCritical
                          ? "border-red-500/50 bg-red-500/10 hover:bg-red-500/15"
                          : "border-zinc-800 bg-zinc-800/30 hover:bg-zinc-800/50"
                      )}
                    >
                      <div className="flex items-start gap-3">
                        <div
                          className={cn(
                            "mt-0.5 flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full",
                            notification.type === "slack" && notification.isCritical
                              ? "bg-red-500/20 text-red-400"
                              : notification.type === "slack"
                              ? "bg-amber-500/20 text-amber-400"
                              : notification.type === "calendar"
                              ? "bg-blue-500/20 text-blue-400"
                              : "bg-emerald-500/20 text-emerald-400"
                          )}
                        >
                          {notification.icon}
                        </div>
                        <div className="flex-1 min-w-0">
                          <p className="text-sm text-zinc-300">{notification.message}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Status Footer */}
            <div className="border-t border-zinc-800 bg-zinc-900/50 px-5 py-3">
              <div className="flex items-center gap-2 text-xs text-zinc-500">
                <div className="h-2 w-2 rounded-full bg-emerald-400" />
                <span>Riley is active</span>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}


==================================================
FILE: next-frontend/src/components/ui/Greeting.tsx
==================================================
"use client";

import { useEffect, useState } from "react";
import { useUser } from "@clerk/nextjs";

export default function Greeting() {
  const { user, isLoaded } = useUser();
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  // Render placeholder until both mounted and Clerk is loaded
  if (!mounted || !isLoaded) {
    return <>there</>;
  }

  // After mount and load, render user's firstName or fallback to "there"
  return <>{user?.firstName ?? "there"}</>;
}


==================================================
FILE: next-frontend/src/components/ui/NotificationBell.tsx
==================================================
"use client";

import { useState, useRef, useEffect } from "react";
import { Bell, X, Check, Settings } from "lucide-react";
import { cn } from "@app/lib/utils";

type Notification = {
  id: string;
  type: "tag" | "approval" | "system";
  title: string;
  message: string;
  timestamp: string;
  action?: {
    label: string;
    onClick: () => void;
  };
};

const mockNotifications: Notification[] = [
  {
    id: "1",
    type: "tag",
    title: "Tagged in Document",
    message: "Sarah tagged you in 'Q3 Pitch Deck'",
    timestamp: "5m ago",
    action: {
      label: "Review",
      onClick: () => console.log("Review Q3 Pitch Deck"),
    },
  },
  {
    id: "2",
    type: "approval",
    title: "Status Update",
    message: "John moved 'Press Release' to Approved.",
    timestamp: "12m ago",
    action: {
      label: "View",
      onClick: () => console.log("View Press Release"),
    },
  },
  {
    id: "3",
    type: "system",
    title: "System Alert",
    message: "New file uploaded to Housing Justice campaign.",
    timestamp: "1h ago",
  },
];

export function NotificationBell() {
  const [isOpen, setIsOpen] = useState(false);
  const [notifications, setNotifications] = useState<Notification[]>(mockNotifications);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Close dropdown when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }

    if (isOpen) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [isOpen]);

  const unreadCount = notifications.length;
  const hasUnread = unreadCount > 0;

  const handleDismiss = (id: string) => {
    setNotifications((prev) => prev.filter((n) => n.id !== id));
  };

  const handleAction = (notification: Notification) => {
    if (notification.action) {
      notification.action.onClick();
      handleDismiss(notification.id);
    }
  };

  return (
    <div className="relative" ref={dropdownRef}>
      {/* Bell Button */}
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className="relative rounded-lg p-2 text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900"
        aria-label="Notifications"
      >
        <Bell className="h-5 w-5" />
        {hasUnread && (
          <span className="absolute right-1 top-1 flex h-2 w-2">
            <span className="absolute inline-flex h-full w-full animate-ping rounded-full bg-amber-400 opacity-75" />
            <span className="relative inline-flex h-2 w-2 rounded-full bg-amber-500" />
          </span>
        )}
      </button>

      {/* Dropdown Panel */}
      {isOpen && (
        <div className="absolute right-0 top-12 z-50 w-96 rounded-xl border border-slate-200 bg-white/95 backdrop-blur-md shadow-2xl animate-in fade-in zoom-in-95 duration-200">
          {/* Header */}
          <div className="flex items-center justify-between border-b border-slate-200 px-5 py-4">
            <div className="flex items-center gap-2">
              <Bell className="h-4 w-4 text-slate-600" />
              <h3 className="text-sm font-semibold text-slate-900">
                Notifications {hasUnread && `(${unreadCount})`}
              </h3>
            </div>
            <button
              type="button"
              onClick={() => setIsOpen(false)}
              className="rounded-lg p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-600"
              aria-label="Close"
            >
              <X className="h-4 w-4" />
            </button>
          </div>

          {/* Notifications List */}
          <div className="max-h-[400px] overflow-y-auto [&::-webkit-scrollbar]:hidden [-ms-overflow-style:'none'] [scrollbar-width:'none']">
            {notifications.length === 0 ? (
              <div className="px-5 py-8 text-center text-sm text-slate-500">
                No notifications
              </div>
            ) : (
              <div className="divide-y divide-slate-100">
                {notifications.map((notification) => (
                  <div
                    key={notification.id}
                    className={cn(
                      "px-5 py-4 transition-colors hover:bg-slate-50",
                      notification.type === "tag" && "bg-amber-50/30",
                      notification.type === "approval" && "bg-emerald-50/30"
                    )}
                  >
                    <div className="flex items-start gap-3">
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between gap-2">
                          <p className="text-xs font-medium text-slate-500">
                            {notification.title}
                          </p>
                          <span className="text-xs text-slate-400">
                            {notification.timestamp}
                          </span>
                        </div>
                        <p className="mt-1 text-sm text-slate-700">
                          {notification.message}
                        </p>
                        {notification.action && (
                          <button
                            type="button"
                            onClick={() => handleAction(notification)}
                            className="mt-2 text-xs font-medium text-amber-600 hover:text-amber-700 hover:underline"
                          >
                            {notification.action.label} â†’
                          </button>
                        )}
                      </div>
                      <button
                        type="button"
                        onClick={() => handleDismiss(notification.id)}
                        className="flex-shrink-0 rounded-lg p-1 text-slate-400 hover:bg-slate-100 hover:text-slate-600"
                        aria-label="Dismiss"
                      >
                        <X className="h-3.5 w-3.5" />
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Footer */}
          {notifications.length > 0 && (
            <div className="border-t border-slate-200 px-5 py-3">
              <button
                type="button"
                className="flex w-full items-center justify-center gap-2 rounded-lg px-3 py-2 text-xs font-medium text-slate-600 transition-colors hover:bg-slate-100"
              >
                <Settings className="h-3.5 w-3.5" />
                Notification Settings
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  );
}



==================================================
FILE: next-frontend/src/components/ui/DocumentViewer.tsx
==================================================
"use client";

import { useState, useRef, useEffect, useCallback, useMemo, memo } from "react";
import { X, Send, FileText, FileType2, Table, Presentation, Image as ImageIcon, Download, CheckCircle, Clock, AlertCircle, PlayCircle, GripVertical, ExternalLink, ZoomIn, ZoomOut } from "lucide-react";
import { cn } from "@app/lib/utils";
import { motion, AnimatePresence } from "framer-motion";
import { Asset, KanbanCard } from "@app/lib/types";
import DocViewer, { DocViewerRenderers } from "@cyntler/react-doc-viewer";
import "@cyntler/react-doc-viewer/dist/index.css";

interface Comment {
  id: string;
  author: string;
  content: string;
  timestamp: string;
  mentions?: string[];
}

// Flexible file interface that works with both Asset and KanbanCard
interface FileData {
  id: string;
  name: string;
  type: Asset["type"];
  url: string;
  // Optional preview metadata from backend (e.g., Office/HTML -> PDF)
  previewUrl?: string;
  previewType?: string;
  previewStatus?: string;
  status?: Asset["status"];
  uploader?: string;
  size?: string;
  uploadDate?: string;
}

interface DocumentViewerProps {
  file: FileData;
  onClose: () => void;
  variant?: "drawer" | "modal";
}

// Mock comments - in production, these would come from the API
const mockComments: Comment[] = [
  {
    id: "1",
    author: "Sarah Chen",
    content: "@John check slide 4. The messaging needs to be more concise.",
    timestamp: "2 hours ago",
    mentions: ["John"],
  },
  {
    id: "2",
    author: "John Martinez",
    content: "Looks good! The positioning is clear and distinct.",
    timestamp: "1 hour ago",
  },
  {
    id: "3",
    author: "Alex Rivera",
    content: "Can we add a call-to-action section at the end?",
    timestamp: "30 minutes ago",
  },
];

function getFileIcon(type: FileData["type"]) {
  switch (type) {
    case "pdf":
      return { icon: FileText, color: "text-red-500" };
    case "docx":
      return { icon: FileType2, color: "text-blue-500" };
    case "xlsx":
      return { icon: Table, color: "text-emerald-500" };
    case "pptx":
      return { icon: Presentation, color: "text-orange-500" };
    case "img":
      return { icon: ImageIcon, color: "text-purple-500" };
    default:
      return { icon: FileText, color: "text-zinc-500" };
  }
}

function getStatusBadge(status?: Asset["status"]) {
  switch (status) {
    case "approved":
      return { icon: CheckCircle, color: "text-emerald-400", bg: "bg-emerald-500/10", border: "border-emerald-500/20", label: "Client Ready" };
    case "in_review":
      return { icon: Clock, color: "text-yellow-400", bg: "bg-yellow-500/10", border: "border-yellow-500/20", label: "In Review" };
    case "needs_review":
      return { icon: AlertCircle, color: "text-red-400", bg: "bg-red-500/10", border: "border-red-500/20", label: "Needs Review" };
    case "in_progress":
      return { icon: PlayCircle, color: "text-blue-400", bg: "bg-blue-500/10", border: "border-blue-500/20", label: "In Progress" };
    default:
      return { icon: Clock, color: "text-zinc-400", bg: "bg-zinc-500/10", border: "border-zinc-500/20", label: "Ready" };
  }
}

function getInitials(name: string): string {
  return name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase()
    .slice(0, 2);
}

// Map our file types to DocViewer's expected file types
function mapFileType(type: FileData["type"]): string {
  switch (type) {
    case "pdf":
      return "pdf";
    case "docx":
      return "docx";
    case "xlsx":
      return "xlsx";
    case "pptx":
      return "pptx";
    case "img":
      return "jpg"; // DocViewer handles images as jpg/png
    default:
      return "pdf";
  }
}

// Memoized DocViewer component to prevent re-renders when parent state changes
const StableDocViewer = memo(({ documents, config }: { documents: any[]; config: any }) => {
  return (
    <DocViewer
      documents={documents}
      pluginRenderers={DocViewerRenderers}
      style={{ height: "100%", background: "transparent", minHeight: "100%" }}
      config={config}
    />
  );
}, (prevProps, nextProps) => {
  // Only re-render if documents actually change
  return (
    prevProps.documents[0]?.uri === nextProps.documents[0]?.uri &&
    prevProps.documents[0]?.fileType === nextProps.documents[0]?.fileType
  );
});

StableDocViewer.displayName = "StableDocViewer";

export function DocumentViewer({ file, onClose, variant = "drawer" }: DocumentViewerProps) {
  const [comments, setComments] = useState<Comment[]>(mockComments);
  const [commentInput, setCommentInput] = useState("");
  const [width, setWidth] = useState(800); // Default width for drawer
  const [isResizing, setIsResizing] = useState(false);
  const [renderError, setRenderError] = useState<string | null>(null);
  const [zoom, setZoom] = useState(1); // Zoom level (0.5 to 3)
  const commentsEndRef = useRef<HTMLDivElement>(null);
  const resizeRef = useRef<HTMLDivElement>(null);
  const { icon: FileIcon, color: iconColor } = getFileIcon(file.type);
  const statusBadge = getStatusBadge(file.status || "ready");

  const minWidth = 400;
  const maxWidth = 1200;
  const isModal = variant === "modal";
  const hasPdfPreview = file.type === "pdf" || file.previewType === "pdf";

  // Auto-scroll comments to bottom
  useEffect(() => {
    commentsEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [comments]);

  // Resize handler
  const handleMouseDown = useCallback((e: React.MouseEvent) => {
    e.preventDefault();
    setIsResizing(true);
  }, []);

  useEffect(() => {
    if (!isResizing) return;

    const handleMouseMove = (e: MouseEvent) => {
      const newWidth = window.innerWidth - e.clientX;
      const clampedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
      setWidth(clampedWidth);
    };

    const handleMouseUp = () => {
      setIsResizing(false);
    };

    document.addEventListener("mousemove", handleMouseMove);
    document.addEventListener("mouseup", handleMouseUp);

    return () => {
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
    };
  }, [isResizing, minWidth, maxWidth]);

  const handleSendComment = () => {
    if (!commentInput.trim()) return;

    const newComment: Comment = {
      id: Date.now().toString(),
      author: "You",
      content: commentInput.trim(),
      timestamp: "just now",
    };

    setComments([...comments, newComment]);
    setCommentInput("");
  };

  const handleKeyPress = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSendComment();
    }
  };

  // Decide which URL and type to use for the main viewer (prefer preview PDF)
  const effectiveUrl = useMemo(() => {
    if (file.previewType === "pdf" && file.previewUrl) {
      return file.previewUrl;
    }
    return file.url;
  }, [file.previewType, file.previewUrl, file.url]);

  const effectiveType = useMemo<Asset["type"]>(() => {
    if (file.previewType === "pdf") {
      return "pdf";
    }
    return file.type;
  }, [file.previewType, file.type]);

  // Memoize documents array to prevent unnecessary recalculations
  const documents = useMemo(() => [
    {
      uri: effectiveUrl,
      fileType: mapFileType(effectiveType),
      fileName: file.name,
    },
  ], [effectiveUrl, effectiveType, file.name]);

  // Memoize DocViewer config to prevent re-renders
  const docViewerConfig = useMemo(() => ({
    header: {
      disableHeader: true,
      disableFileName: true,
      retainURLParams: false,
    },
    // Enable PDF vertical scrolling by default
    pdfVerticalScrollByDefault: true,
  }), []);

  const handleOpenExternally = () => {
    // Trigger download by creating a temporary anchor element
    const link = document.createElement("a");
    link.href = file.url;
    link.download = file.name;
    link.target = "_blank";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleDownload = () => {
    // Create a temporary anchor element to trigger download
    const link = document.createElement("a");
    link.href = file.url;
    link.download = file.name;
    link.target = "_blank";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleZoomIn = () => {
    setZoom((z) => Math.min(z + 0.2, 3));
  };

  const handleZoomOut = () => {
    setZoom((z) => Math.max(z - 0.2, 0.5));
  };

  return (
    <AnimatePresence>
      <>
        {/* Backdrop */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.2 }}
          className={cn(
            "fixed inset-0 z-40 bg-black/60 backdrop-blur-sm",
            isModal ? "bg-black/80" : "bg-black/60"
          )}
          onClick={onClose}
        />

        {/* Container - Drawer or Modal */}
        <motion.div
          initial={isModal ? { opacity: 0, scale: 0.95 } : { x: "100%" }}
          animate={isModal ? { opacity: 1, scale: 1 } : { x: 0 }}
          exit={isModal ? { opacity: 0, scale: 0.95 } : { x: "100%" }}
          transition={isModal ? { duration: 0.2 } : { type: "spring", damping: 25, stiffness: 200 }}
          style={isModal ? {} : { width: `${width}px` }}
          className={cn(
            "z-50 bg-zinc-950/95 backdrop-blur-xl border border-zinc-800 shadow-2xl flex flex-col",
            isModal
              ? "fixed inset-0 m-auto w-[90vw] h-[90vh] rounded-xl overflow-hidden"
              : "fixed inset-y-0 right-0 border-l"
          )}
          onClick={(e) => e.stopPropagation()}
        >
          {/* Resize Handle - Only for drawer */}
          {!isModal && (
            <div
              ref={resizeRef}
              onMouseDown={handleMouseDown}
              className={cn(
                "absolute left-0 top-0 bottom-0 w-1 cursor-col-resize hover:bg-amber-500/50 transition-colors z-10",
                isResizing && "bg-amber-500"
              )}
            >
              <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                <GripVertical className="h-4 w-4 text-zinc-600" />
              </div>
            </div>
          )}

          {/* Header */}
          <div className="flex items-center justify-between border-b border-zinc-800 px-6 py-4 flex-shrink-0">
            <div className="flex items-center gap-3 min-w-0 flex-1">
              <FileIcon className={cn("h-5 w-5 flex-shrink-0", iconColor)} />
              <div className="min-w-0 flex-1">
                <h2 className="text-lg font-semibold text-zinc-100 truncate">{file.name}</h2>
                <div className="flex items-center gap-2 mt-1">
                  <span className={cn(
                    "inline-flex items-center gap-1.5 rounded-full border px-2 py-0.5 text-xs font-medium",
                    statusBadge.bg,
                    statusBadge.color,
                    statusBadge.border
                  )}>
                    {(() => {
                      const StatusIcon = statusBadge.icon;
                      return <StatusIcon className="h-3 w-3" />;
                    })()}
                    {statusBadge.label}
                  </span>
                </div>
              </div>
            </div>
            <div className="flex items-center gap-2 ml-4">
              <button
                type="button"
                onClick={handleOpenExternally}
                className="inline-flex items-center gap-2 rounded-lg border border-zinc-700 bg-transparent px-3 py-2 text-sm font-medium text-zinc-300 transition-colors hover:bg-zinc-800 hover:text-zinc-100 flex-shrink-0"
                aria-label="Open in App"
              >
                <ExternalLink className="h-4 w-4" />
                <span>Open in App</span>
              </button>
              <button
                type="button"
                onClick={onClose}
                className="rounded-lg p-2 text-zinc-400 transition-colors hover:bg-zinc-800 hover:text-zinc-100 flex-shrink-0"
                aria-label="Close"
              >
                <X className="h-5 w-5" />
              </button>
            </div>
          </div>

          {/* Main Content - 2 Column Grid */}
          {/* Isolated columns to prevent layout shifts */}
          <div className="flex-1 flex overflow-hidden">
            {/* Column 1: Preview (2/3) - Isolated from comment state */}
            <div className="flex-[2] flex flex-col overflow-hidden border-r border-zinc-800 bg-zinc-950 isolate">
              {/* Custom Toolbar with Zoom and Download Controls */}
              <div className="flex items-center justify-between border-b border-zinc-800 px-4 py-2 bg-zinc-900/50 flex-shrink-0">
                <div className="flex items-center gap-2">
                  <span className="text-xs text-zinc-400 font-medium">Zoom: {Math.round(zoom * 100)}%</span>
                </div>
                <div className="flex items-center gap-2">
                  {/* Zoom Out */}
                  <button
                    type="button"
                    onClick={handleZoomOut}
                    disabled={zoom <= 0.5}
                    className="inline-flex items-center justify-center rounded-lg p-1.5 text-zinc-400 transition-colors hover:bg-zinc-800 hover:text-zinc-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    aria-label="Zoom Out"
                  >
                    <ZoomOut className="h-4 w-4" />
                  </button>
                  {/* Zoom In */}
                  <button
                    type="button"
                    onClick={handleZoomIn}
                    disabled={zoom >= 3}
                    className="inline-flex items-center justify-center rounded-lg p-1.5 text-zinc-400 transition-colors hover:bg-zinc-800 hover:text-zinc-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    aria-label="Zoom In"
                  >
                    <ZoomIn className="h-4 w-4" />
                  </button>
                  {/* Download */}
                  <button
                    type="button"
                    onClick={handleDownload}
                    className="inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 text-xs font-medium text-zinc-300 transition-colors hover:bg-zinc-800 hover:text-zinc-100 border border-zinc-700"
                    aria-label="Download"
                  >
                    <Download className="h-3.5 w-3.5" />
                    <span>Download</span>
                  </button>
                </div>
              </div>
              {/* Main viewer area: image, PDF (original or preview), or fallback */}
              <div className="flex-1 overflow-auto bg-zinc-950">
                {file.type === "img" ? (
                  <div className="flex items-center justify-center h-full p-6">
                    <img
                      src={file.url}
                      alt={file.name}
                      className="max-h-full max-w-full rounded-lg border border-zinc-800 object-contain"
                    />
                  </div>
                ) : hasPdfPreview ? (
                  <div
                    style={{
                      transform: `scale(${zoom})`,
                      transformOrigin: "top center",
                      width: `${100 / zoom}%`,
                      height: `${100 / zoom}%`,
                    }}
                  >
                    <StableDocViewer documents={documents} config={docViewerConfig} />
                  </div>
                ) : (
                <div className="flex flex-col items-center justify-center h-full p-8 text-center bg-zinc-950">
                  <div className="max-w-md space-y-4">
                    <div className={cn("rounded-full bg-zinc-800/50 p-4 inline-block", iconColor)}>
                      <FileIcon className="h-12 w-12" />
                    </div>
                    <div className="space-y-2">
                      <h3 className="text-lg font-semibold text-zinc-100">{file.name}</h3>
                      <p className="text-sm text-zinc-500">
                        {file.size || "Unknown size"} â€¢ Uploaded by {file.uploader || "Unknown"}
                      </p>
                    </div>
                      <div className="rounded-lg border border-zinc-700 bg-zinc-900/60 p-4">
                        <p className="text-sm text-zinc-300">
                          {file.previewStatus === "failed"
                            ? "Preview could not be generated. Download to view."
                            : "Preview processing... You can download to view the original file."}
                      </p>
                    </div>
                    <div className="flex gap-3 justify-center">
                      <button
                        type="button"
                        onClick={() => window.open(file.url, "_blank")}
                        className="inline-flex items-center gap-2 rounded-lg border border-zinc-700 bg-zinc-800/50 px-4 py-2 text-sm font-medium text-zinc-100 transition-colors hover:bg-zinc-700 hover:border-zinc-600"
                      >
                        <Download className="h-4 w-4" />
                        Download
                      </button>
                      </div>
                    </div>
                  </div>
                )}
                </div>
            </div>

            {/* Column 2: Collaboration (1/3) - Isolated from viewer state */}
            <div className="flex-1 flex flex-col overflow-hidden bg-zinc-900/30 isolate">
              {/* Comments Header */}
              <div className="border-b border-zinc-800 px-4 py-3 flex-shrink-0">
                <h3 className="text-sm font-semibold text-zinc-100">Team Comments</h3>
                <p className="text-xs text-zinc-500 mt-0.5">{comments.length} comments</p>
              </div>

              {/* Comments List */}
              <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin">
                {comments.map((comment) => (
                  <div
                    key={comment.id}
                    className="rounded-lg border border-zinc-800 bg-zinc-900/50 p-3"
                  >
                    <div className="flex items-start gap-3">
                      {/* Avatar */}
                      <div className="flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-full border-2 border-zinc-800 bg-zinc-700 text-xs font-medium text-zinc-100">
                        {getInitials(comment.author)}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-sm font-medium text-zinc-100">
                            {comment.author}
                          </span>
                          <span className="text-xs text-zinc-500">{comment.timestamp}</span>
                        </div>
                        <p className="text-sm text-zinc-300 whitespace-pre-wrap break-words">
                          {comment.content.split(" ").map((word, idx) => {
                            // Highlight mentions
                            if (word.startsWith("@")) {
                              return (
                                <span
                                  key={idx}
                                  className="text-amber-400 font-medium"
                                >
                                  {word}{" "}
                                </span>
                              );
                            }
                            return <span key={idx}>{word} </span>;
                          })}
                        </p>
                      </div>
                    </div>
                  </div>
                ))}
                <div ref={commentsEndRef} />
              </div>

              {/* Comment Input */}
              <div className="border-t border-zinc-800 p-4 flex-shrink-0">
                <div className="flex items-end gap-2">
                  <textarea
                    value={commentInput}
                    onChange={(e) => setCommentInput(e.target.value)}
                    onKeyDown={handleKeyPress}
                    placeholder="Write a comment... (@ to mention)"
                    rows={2}
                    className="flex-1 rounded-lg border border-zinc-800 bg-zinc-900/50 px-3 py-2 text-sm text-zinc-100 placeholder:text-zinc-600 focus:outline-none focus:ring-2 focus:ring-amber-500/50 resize-none"
                  />
                  <button
                    type="button"
                    onClick={handleSendComment}
                    disabled={!commentInput.trim()}
                    className="rounded-lg bg-amber-500/10 border border-amber-500/20 p-2 text-amber-400 transition-colors hover:bg-amber-500/20 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0"
                    aria-label="Send comment"
                  >
                    <Send className="h-4 w-4" />
                  </button>
                </div>
                <p className="text-xs text-zinc-500 mt-2">
                  Press Enter to send, Shift+Enter for new line
                </p>
              </div>
            </div>
          </div>
        </motion.div>
      </>
    </AnimatePresence>
  );
}


==================================================
FILE: next-frontend/src/components/ui/TypewriterMarkdown.tsx
==================================================
"use client";

import { useEffect, useState } from "react";
import ReactMarkdown from "react-markdown";
import remarkBreaks from "remark-breaks";

interface TypewriterMarkdownProps {
  content: string;
  onComplete?: () => void;
}

export function TypewriterMarkdown({
  content,
  onComplete,
}: TypewriterMarkdownProps) {
  const [displayedContent, setDisplayedContent] = useState("");

  useEffect(() => {
    // Reset when content changes
    setDisplayedContent("");
    
    if (!content) {
      onComplete?.();
      return;
    }
    
    // Pre-process HTML: Replace <br> tags with newlines for proper markdown rendering
    const processedContent = content.replace(/<br\s*\/?>/gi, '\n\n');
    
    // Split processed content into words (preserve spaces)
    const words = processedContent.split(/(\s+)/);
    let tokenIndex = 0;
    const wordsPerBatch = 3; // Show 3 words at a time
    const delayPerBatch = 30; // 30ms per batch

    const typeInterval = setInterval(() => {
      // Calculate tokens to show (each word = 2 tokens: word + space)
      const tokensToShow = Math.min(tokenIndex + (wordsPerBatch * 2), words.length);
      
      if (tokensToShow >= words.length) {
        // Show all remaining content
        setDisplayedContent(processedContent);
        clearInterval(typeInterval);
        onComplete?.();
        return;
      }

      // Get batch of words
      const batch = words.slice(0, tokensToShow).join("");
      setDisplayedContent(batch);
      
      // Move forward by 3 words worth of tokens
      tokenIndex = tokensToShow;
    }, delayPerBatch);

    return () => {
      clearInterval(typeInterval);
    };
  }, [content, onComplete]);

  return (
    <div className="riley-md">
      <ReactMarkdown remarkPlugins={[remarkBreaks]}>{displayedContent}</ReactMarkdown>
      {displayedContent.length < content.length && (
        <span className="inline-block w-0.5 h-4 bg-amber-400 ml-0.5 animate-pulse align-middle">
          |
        </span>
      )}
    </div>
  );
}


==================================================
FILE: src/app/layout.tsx
==================================================
import type { ReactNode } from "react";
import "@app/styles/globals.css";

export const metadata = {
  title: "Project RILEY",
  description: "Collaborative Intelligence Platform for campaign teams.",
};

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en" className="h-full">
      <body className="min-h-screen bg-zinc-950 text-zinc-100 antialiased">
        <div className="relative flex min-h-screen flex-col bg-gradient-to-b from-zinc-950 via-zinc-950 to-black">
          {children}
        </div>
      </body>
    </html>
  );
}




==================================================
FILE: src/app/(dashboard)/dashboard/page.tsx
==================================================
import type { Metadata } from "next";
import { CampaignBucketCard } from "@app/components/campaign/CampaignBucketCard";
import type { CampaignBucket } from "@app/lib/types";

export const metadata: Metadata = {
  title: "Campaign Selection Â· Project RILEY",
};

const demoBuckets: CampaignBucket[] = [
  {
    id: "youth-mission",
    name: "Youth Mission Â· 2026 Turnout",
    role: "Campaign Director",
    securityStatus: "Top Secret",
    themeColor: "hsl(222 84% 56%)", // Riley Blue
  },
  {
    id: "fire-recovery",
    name: "Fire Recovery Â· Mutual Aid Coalition",
    role: "Relief Coordinator",
    securityStatus: "Restricted",
    themeColor: "hsl(14 96% 56%)", // Signal Red
  },
  {
    id: "housing-justice",
    name: "Housing Justice Â· Citywide",
    role: "Policy Lead",
    securityStatus: "Internal",
    themeColor: "hsl(160 84% 45%)", // Civic Green
  },
];

export default function DashboardPage() {
  return (
    <main className="mx-auto flex w-full max-w-6xl flex-1 flex-col px-4 pb-10 pt-8 sm:px-6 lg:px-8">
      <header className="mb-8 space-y-2">
        <div className="inline-flex items-center gap-2 rounded-full border border-zinc-800 bg-zinc-950/60 px-3 py-1 text-xs font-mono tracking-tight text-zinc-400 backdrop-blur">
          <span className="h-1.5 w-1.5 rounded-full bg-emerald-400 shadow-[0_0_0_4px_rgba(52,211,153,0.35)]" />
          AIRLOCK Â· CAMPAIGN SELECTION
        </div>
        <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div>
            <h1 className="text-xl sm:text-2xl font-semibold tracking-tight text-zinc-50">
              Choose your active campaign
            </h1>
            <p className="mt-1 max-w-2xl text-sm text-zinc-400">
              Each campaign operates in its own secure bucket. Your role and
              clearances are applied the moment you step inside.
            </p>
          </div>
          <div className="flex items-center gap-3 text-xs text-zinc-500">
            <span className="inline-flex items-center gap-1 rounded-full border border-zinc-800 bg-zinc-950/70 px-3 py-1 font-mono">
              <span className="h-1.5 w-1.5 rounded-full bg-sky-400" />
              AI LINKED
            </span>
            <span className="hidden sm:inline font-mono">
              Visual sovereignty mode:{" "}
              <span className="text-zinc-300">ENGAGED</span>
            </span>
          </div>
        </div>
      </header>

      <section
        aria-label="Available campaign buckets"
        className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"
      >
        {demoBuckets.map((bucket) => (
          <CampaignBucketCard
            key={bucket.id}
            name={bucket.name}
            role={bucket.role}
            securityStatus={bucket.securityStatus}
            themeColor={bucket.themeColor}
            onClick={() => {
              // TODO: Navigate to /[campaignId] once routing is wired
            }}
          />
        ))}
      </section>
    </main>
  );
}




==================================================
FILE: src/lib/types.ts
==================================================
export type SecurityStatus = "Top Secret" | "Restricted" | "Open" | "Internal";

export interface CampaignBucket {
  id: string;
  name: string;
  role: string;
  securityStatus: SecurityStatus;
  /**
   * Arbitrary CSS color value used to tint the bucket card
   * (e.g. "#22c55e", "rgb(59,130,246)", "hsl(210 100% 56%)").
   */
  themeColor: string;
}




==================================================
FILE: src/lib/utils.ts
==================================================
export type ClassValue = string | number | boolean | null | undefined | ClassValue[] | { [key: string]: boolean | null | undefined };

export function cn(...inputs: ClassValue[]): string {
  const classes: string[] = [];

  for (const input of inputs) {
    if (!input && input !== 0) continue;

    if (typeof input === "string" || typeof input === "number") {
      classes.push(String(input));
    } else if (Array.isArray(input)) {
      const inner = cn(...input);
      if (inner) classes.push(inner);
    } else if (typeof input === "object") {
      for (const [key, value] of Object.entries(input)) {
        if (value) classes.push(key);
      }
    }
  }

  return classes.join(" ");
}




==================================================
FILE: fix_frontend_structure.py
==================================================
import os
import shutil
import json

# --- CONFIGURATION ---
BASE_DIR = "next-frontend"
SRC_DIR = os.path.join(BASE_DIR, "src")
PAGES_DIR = os.path.join(SRC_DIR, "pages")
APP_DIR = os.path.join(SRC_DIR, "app")

# Files to Create/Overwrite
TS_CONFIG_PATH = os.path.join(BASE_DIR, "tsconfig.json")
LAYOUT_PATH = os.path.join(APP_DIR, "layout.tsx")
PAGE_PATH = os.path.join(APP_DIR, "page.tsx")
GLOBALS_CSS_PATH = os.path.join(SRC_DIR, "styles", "globals.css")

def write_file(path, content):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content.strip())
    print(f"âœ… Wrote: {path}")

def fix_structure():
    print(f"ðŸ”§ Starting Repair on {BASE_DIR}...")

    # 1. DELETE LEGACY PAGES ROUTER
    if os.path.exists(PAGES_DIR):
        print(f"ðŸ—‘ï¸  Removing legacy Pages Router: {PAGES_DIR}")
        shutil.rmtree(PAGES_DIR)
    else:
        print(f"âœ“ Pages directory already clean.")

    # 2. FIX TSCONFIG (Ensure @app alias works)
    # We load the existing one if possible to keep other settings, but enforce paths
    tsconfig = {
      "compilerOptions": {
        "lib": ["dom", "dom.iterable", "esnext"],
        "allowJs": True,
        "skipLibCheck": True,
        "strict": True,
        "noEmit": True,
        "esModuleInterop": True,
        "module": "esnext",
        "moduleResolution": "bundler",
        "resolveJsonModule": True,
        "isolatedModules": True,
        "jsx": "preserve",
        "incremental": True,
        "plugins": [{"name": "next"}],
        "paths": {
          "@app/*": ["./src/*"]
        },
        "baseUrl": "."
      },
      "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
      "exclude": ["node_modules"]
    }
    
    with open(TS_CONFIG_PATH, "w") as f:
        json.dump(tsconfig, f, indent=2)
    print(f"âœ… Fixed tsconfig.json with @app alias.")

    # 3. ENSURE GLOBAL CSS (Tailwind v4)
    # Your scan showed this was correct, but we ensure it stays correct
    css_content = """
@import "tailwindcss";

@theme {
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

:root {
  --background: #09090b; /* Zinc-950 */
  --foreground: #fafafa; /* Zinc-50 */
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: var(--font-sans), sans-serif;
}
"""
    write_file(GLOBALS_CSS_PATH, css_content)

    # 4. CREATE THE MAIN DASHBOARD (page.tsx)
    # This replaces the default "Next.js Welcome" with Aria's Campaign Selector
    dashboard_content = """
import { CampaignBucketCard } from "@app/components/campaign/CampaignBucketCard";

export default function Dashboard() {
  return (
    <main className="min-h-screen p-8 sm:p-12 font-sans">
      <div className="max-w-6xl mx-auto space-y-12">
        
        {/* Header */}
        <div className="space-y-2">
          <h1 className="text-3xl font-bold tracking-tight text-white">Mission Control</h1>
          <p className="text-zinc-400">Select a secure client bucket to begin operations.</p>
        </div>

        {/* Grid of Campaign Buckets */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          
          <CampaignBucketCard 
            name="Smith for Senate"
            role="Lead Strategist"
            securityStatus="Top Secret"
            themeColor="#ef4444" // Red for high stakes
          />

          <CampaignBucketCard 
            name="TechCorp Crisis"
            role="Crisis Manager"
            securityStatus="Restricted"
            themeColor="#f59e0b" // Amber
          />

          <CampaignBucketCard 
            name="GreenEarth Advocacy"
            role="Contributor"
            securityStatus="Open"
            themeColor="#22c55e" // Green
          />

        </div>
      </div>
    </main>
  );
}
"""
    write_file(PAGE_PATH, dashboard_content)

    print("\nðŸš€ REPAIR COMPLETE. Next Step: Run 'npm install lucide-react'")

if __name__ == "__main__":
    fix_structure()

==================================================
FILE: sync_archive_to_vectors.py
==================================================
import psycopg2
import google.generativeai as genai
from qdrant_client import QdrantClient
from qdrant_client.models import PointStruct
from tqdm import tqdm
import os
import json
import time

# --- CONFIGURATION ---
DB_NAME = "riley_archive"
DB_USER = "riley_admin"
DB_PASS = "riley_password" # Ensure this matches the docker setup
DB_HOST = "localhost"

QDRANT_HOST = "localhost"
QDRANT_PORT = 6333
COLLECTION_NAME = "riley_production_v1"

# API KEY (Ensure this is set in your environment or paste here for temporary run)
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
genai.configure(api_key=GOOGLE_API_KEY)

def get_db_connection():
    return psycopg2.connect(
        dbname=DB_NAME, user=DB_USER, password=DB_PASS, host=DB_HOST
    )

def main():
    print("--- STARTING LAZARUS PROTOCOL: SYNC POSTGRES TO QDRANT ---")
    
    # 1. Connect to Services
    try:
        pg_conn = get_db_connection()
        pg_cursor = pg_conn.cursor()
        client = QdrantClient(host=QDRANT_HOST, port=QDRANT_PORT)
        print("[*] Databases Connected.")
    except Exception as e:
        print(f"[!] Connection Failed: {e}")
        return

    # 2. Check how many we have to do
    pg_cursor.execute("SELECT COUNT(*) FROM archive_docs WHERE content IS NOT NULL AND content != '';")
    total_docs = pg_cursor.fetchone()[0]
    print(f"[*] Found {total_docs} valid documents in Archive to sync.")

    # 3. Fetch Data in Batches
    BATCH_SIZE = 50
    pg_cursor.execute("SELECT id, filename, content, metadata, gcs_path FROM archive_docs WHERE content IS NOT NULL AND content != '';")

    pbar = tqdm(total=total_docs, desc="Hydrating Vectors")
    
    while True:
        rows = pg_cursor.fetchmany(BATCH_SIZE)
        if not rows:
            break

        points = []
        for row in rows:
            doc_id, filename, content, metadata, gcs_path = row
            
            # Skip if content is too short to be useful
            if len(content) < 50:
                continue

            try:
                # 4. Generate Embedding
                # We use the text-embedding-004 model
                embedding_result = genai.embed_content(
                    model="models/text-embedding-004",
                    content=content[:9000], # Truncate to avoid token limits
                    task_type="retrieval_document"
                )
                vector = embedding_result['embedding']

                # 5. Prepare Payload
                # We normalize metadata to ensure it's a flat dict for Qdrant
                payload = {
                    "filename": filename,
                    "content": content[:1000], # Store preview text
                    "gcs_path": gcs_path,
                    "client_id": "demo_client_001", # TEMPORARY: Assigning all to a demo client for now
                    "type": "document"
                }
                # Merge existing metadata if it exists
                if metadata:
                    if isinstance(metadata, str):
                        payload.update(json.loads(metadata))
                    else:
                        payload.update(metadata)

                points.append(PointStruct(id=str(doc_id), vector=vector, payload=payload))

            except Exception as e:
                # Rate limit handling or API error
                if "429" in str(e):
                    time.sleep(5)
                continue

        # 6. Upload Batch to Qdrant
        if points:
            try:
                client.upsert(
                    collection_name=COLLECTION_NAME,
                    points=points
                )
            except Exception as e:
                print(f" [!] Insert Error: {e}")

        pbar.update(len(rows))

    print("\n[*] Lazarus Protocol Complete. Qdrant is now in sync with Archive.")
    pg_conn.close()

if __name__ == "__main__":
    main()
